# 3Dæ¨¡å‹å®šåˆ¶æŠ¥ä»·ç³»ç»Ÿ - å…¨æµç¨‹æ¢³ç†

> æœ¬æ–‡æ¡£ç”¨äºå¸®åŠ©æ–°æ¥æ‰‹çš„å¼€å‘è€…å¿«é€Ÿç†è§£æ•´ä¸ªé¡¹ç›®çš„å¤„ç†é€»è¾‘

---

## ğŸ“‹ ç›®å½•

1. [ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ](#ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ)
2. [å®Œæ•´ä¸šåŠ¡æµç¨‹](#å®Œæ•´ä¸šåŠ¡æµç¨‹)
3. [æ ¸å¿ƒåŠŸèƒ½è¯¦è§£](#æ ¸å¿ƒåŠŸèƒ½è¯¦è§£)
4. [æ•°æ®å­˜å‚¨ç»“æ„](#æ•°æ®å­˜å‚¨ç»“æ„)
5. [APIæ¥å£è¯´æ˜](#apiæ¥å£è¯´æ˜)
6. [å…³é”®æŠ€æœ¯ç‚¹](#å…³é”®æŠ€æœ¯ç‚¹)

---

## ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ

### æŠ€æœ¯æ ˆ
- **å‰ç«¯**: Shopify Liquid æ¨¡æ¿ + JavaScript (ES6+)
- **åç«¯**: Vercel Serverless Functions (Node.js)
- **æ•°æ®å­˜å‚¨**: Shopify Metaobjects + Shopify Draft Orders
- **æ–‡ä»¶å­˜å‚¨**: Shopify Files API (Google Cloud Storage CDN)
- **APIé€šä¿¡**: Shopify GraphQL Admin API

### ç³»ç»Ÿç»„æˆ
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ç³»ç»Ÿæ¶æ„                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å®¢æˆ·ç«¯     â”‚         â”‚  Vercel API  â”‚         â”‚   Shopify    â”‚
â”‚  (æµè§ˆå™¨)    â”‚ â—„â”€â”€â”€â”€â–º â”‚  (åç«¯æœåŠ¡)  â”‚ â—„â”€â”€â”€â”€â–º â”‚  (æ•°æ®å­˜å‚¨)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                        â”‚                        â”‚
   å‰ç«¯æ–‡ä»¶                  API ç«¯ç‚¹                æ•°æ®å­˜å‚¨
       â”‚                        â”‚                        â”‚
       â”œâ”€ model-uploader.js    â”œâ”€ submit-quote-real.js â”œâ”€ Draft Orders
       â”œâ”€ admin-dashboard      â”œâ”€ update-quote.js      â”œâ”€ Metaobjects
       â””â”€ my-quotes            â”œâ”€ get-draft-order.js   â””â”€ Files
                               â”œâ”€ store-file-real.js
                               â””â”€ download-file.js
```

---

## å®Œæ•´ä¸šåŠ¡æµç¨‹

### ğŸ”„ æµç¨‹æ€»è§ˆå›¾

```
å®¢æˆ·æäº¤è¯¢ä»· â†’ æ–‡ä»¶ä¸Šä¼  â†’ åˆ›å»ºDraft Order â†’ å®¢æœæŠ¥ä»· â†’ å®¢æˆ·æŸ¥çœ‹ â†’ å®¢æˆ·ä¸‹å• â†’ å®Œæˆæ”¯ä»˜
```

---

### é˜¶æ®µ 1ï¸âƒ£: å®¢æˆ·ä¸Šä¼ æ–‡ä»¶å¹¶æäº¤è¯¢ä»·

#### ç”¨æˆ·æ“ä½œæµç¨‹
1. **è®¿é—®äº§å“é¡µé¢** (ä½¿ç”¨ `model-uploader` section)
2. **ä¸Šä¼ æ–‡ä»¶**
   - ç‚¹å‡»ä¸Šä¼ åŒºåŸŸæˆ–æ‹–æ‹½æ–‡ä»¶
   - æ”¯æŒæ ¼å¼: STEP, STL, OBJ, 3MF, IGES, DWG, DXF, PDF, ZIPç­‰
   - æœ€å¤š20ä¸ªæ–‡ä»¶ï¼Œå•ä¸ªæ–‡ä»¶æœ€å¤§100MB
3. **é…ç½®åŠ å·¥å‚æ•°**
   - ææ–™ç±»å‹ (PLA, ABS, é‡‘å±ç­‰)
   - ç²¾åº¦ç­‰çº§ (æ ‡å‡†, é«˜ç²¾åº¦, è¶…é«˜ç²¾åº¦)
   - å…¬å·®æ ‡å‡† (GB/T 1804, ISO 2768)
   - è¡¨é¢ç²—ç³™åº¦ (Ra3.2, Ra1.6ç­‰)
   - æ˜¯å¦æœ‰èºçº¹
   - æ˜¯å¦æœ‰è£…é…æ ‡è®°
   - ç¼©æ”¾æ¯”ä¾‹
   - æ•°é‡
   - å¤‡æ³¨
4. **å¡«å†™å®¢æˆ·ä¿¡æ¯**
   - å®¢æˆ·å§“å
   - å®¢æˆ·é‚®ç®± (å¿…å¡«)
5. **ç‚¹å‡»"æäº¤è¯¢ä»·"**

#### æŠ€æœ¯å®ç°æµç¨‹

**å‰ç«¯ (`assets/model-uploader.js`)**:
```javascript
// 1. æ–‡ä»¶é€‰æ‹©å¤„ç†
handleFileSelect(event) {
  - éªŒè¯æ–‡ä»¶ç±»å‹å’Œå¤§å°
  - ä½¿ç”¨ FileReader.readAsDataURL() è¯»å–ä¸º Base64
  - æ·»åŠ åˆ°æ–‡ä»¶ç®¡ç†å™¨ (fileManager.files)
  - æ˜¾ç¤º3Dé¢„è§ˆ (å¦‚æœæ”¯æŒ)
}

// 2. æ”¶é›†å‚æ•°
collectParameters() {
  - ä»è¡¨å•æ”¶é›†æ‰€æœ‰åŠ å·¥å‚æ•°
  - è¿”å›å‚æ•°å¯¹è±¡
}

// 3. æäº¤è¯¢ä»·
handleSubmitQuote() {
  - éå†æ‰€æœ‰æ–‡ä»¶
  - å¯¹æ¯ä¸ªæ–‡ä»¶è°ƒç”¨ /api/store-file-real ä¸Šä¼ 
  - æ”¶é›†æ‰€æœ‰æ–‡ä»¶ä¿¡æ¯å’Œå‚æ•°
  - è°ƒç”¨ /api/submit-quote-real åˆ›å»ºè¯¢ä»·å•
  - è·³è½¬åˆ°"æˆ‘çš„è¯¢ä»·"é¡µé¢
}
```

**åç«¯æ–‡ä»¶ä¸Šä¼  (`api/store-file-real.js`)**:
```javascript
// æ­¥éª¤1: æ¥æ”¶Base64æ–‡ä»¶æ•°æ®
const base64Data = fileData.split(',')[1];
const fileBuffer = Buffer.from(base64Data, 'base64');

// æ­¥éª¤2: åˆ›å»ºStaged Upload (è·å–ä¸´æ—¶ä¸Šä¼ åœ°å€)
stagedUploadsCreate {
  - æŒ‡å®šæ–‡ä»¶ç±»å‹ (MODEL_3D æˆ– FILE)
  - è·å–ä¸´æ—¶ä¸Šä¼ URLå’Œå‚æ•°
}

// æ­¥éª¤3: ä¸Šä¼ æ–‡ä»¶åˆ°ä¸´æ—¶åœ°å€
POST åˆ°ä¸´æ—¶URL (multipart/form-data æˆ– PUT)

// æ­¥éª¤4: åˆ›å»ºæ°¸ä¹…æ–‡ä»¶è®°å½•
fileCreate {
  - ä½¿ç”¨ resourceUrl åˆ›å»ºæ°¸ä¹…è®°å½•
  - è¿”å› Shopify File ID å’Œ CDN URL
}

// æ­¥éª¤5: åˆ›å»º uploaded_file Metaobject (å…ƒæ•°æ®)
metaobjectCreate {
  - file_id: å†…éƒ¨æ–‡ä»¶ID
  - file_name: åŸå§‹æ–‡ä»¶å
  - shopify_file_id: Shopify File ID
  - file_url: CDN URL
  - file_size: æ–‡ä»¶å¤§å°
  - upload_time: ä¸Šä¼ æ—¶é—´
}

// è¿”å›: { fileId, shopifyFileId, shopifyFileUrl }
```

**åç«¯åˆ›å»ºè¯¢ä»·å• (`api/submit-quote-real.js`)**:
```javascript
// åˆ›å»º Shopify Draft Order
draftOrderCreate {
  email: customerEmail,
  lineItems: [{
    title: "3Dæ‰“å°æœåŠ¡ - æ–‡ä»¶å",
    quantity: æ•°é‡,
    originalUnitPrice: "0.00",  // åˆå§‹ä»·æ ¼ä¸º0ï¼Œç­‰å¾…å®¢æœæŠ¥ä»·
    customAttributes: [
      { key: "æ–‡ä»¶", value: fileName },
      { key: "ææ–™", value: material },
      { key: "é¢œè‰²", value: color },
      { key: "ç²¾åº¦", value: precision },
      { key: "æ–‡ä»¶ID", value: fileId },
      { key: "æ–‡ä»¶URL", value: fileUrl },
      // ... å…¶ä»–å‚æ•°
    ]
  }],
  note: "è¯¢ä»·å•å·: Q1234567890\nå®¢æˆ·: å¼ ä¸‰\næ–‡ä»¶: model.step"
}

// è¿”å›: { quoteId, draftOrderId, draftOrderName, invoiceUrl }
```

#### æ•°æ®å­˜å‚¨ä½ç½®
- **æ–‡ä»¶**: Shopify Files (Google Cloud Storage CDN)
- **æ–‡ä»¶å…ƒæ•°æ®**: `uploaded_file` Metaobject
- **è¯¢ä»·å•**: Shopify Draft Order (åˆå§‹ä»·æ ¼0.00)
- **å…³è”ä¿¡æ¯**: Draft Order çš„ `customAttributes` ä¸­å­˜å‚¨æ‰€æœ‰å‚æ•°

---

### é˜¶æ®µ 2ï¸âƒ£: å®¢æœæŸ¥çœ‹è®¢å•å¹¶æ·»åŠ æŠ¥ä»·

#### å®¢æœæ“ä½œæµç¨‹
1. **è®¿é—®ç®¡ç†åå°** (`/pages/admin-dashboard`)
2. **æŸ¥çœ‹è®¢å•åˆ—è¡¨**
   - æ˜¾ç¤ºæ‰€æœ‰å¾…æŠ¥ä»·å’Œå·²æŠ¥ä»·è®¢å•
   - æ˜¾ç¤ºè®¢å•å·ã€å®¢æˆ·é‚®ç®±ã€æ–‡ä»¶åã€çŠ¶æ€ã€ä»·æ ¼
3. **ä¸‹è½½æ–‡ä»¶**
   - ç‚¹å‡»"ä¸‹è½½"æŒ‰é’®
   - é€šè¿‡ `/api/download-file?id=fileId` ä¸‹è½½
4. **æŸ¥çœ‹å‚æ•°è¯¦æƒ…**
   - ç‚¹å‡»"é¢„è§ˆ"æŒ‰é’®
   - æ˜¾ç¤ºæ‰€æœ‰åŠ å·¥å‚æ•°
5. **æ·»åŠ æŠ¥ä»·**
   - ç‚¹å‡»"æ·»åŠ æŠ¥ä»·"æŒ‰é’®
   - å¡«å†™æŠ¥ä»·é‡‘é¢
   - å¡«å†™å¤‡æ³¨è¯´æ˜
   - å¡«å†™å‘é€é‚®ç®± (å®¢æœé‚®ç®±)
   - ç‚¹å‡»"æäº¤æŠ¥ä»·"

#### æŠ€æœ¯å®ç°æµç¨‹

**ç®¡ç†åå° (`templates/page.admin-dashboard.liquid`)**:
```javascript
// 1. åŠ è½½è®¢å•åˆ—è¡¨
async function fetchOrders() {
  // æ–¹æ¡ˆA: ä» Metaobject è¯»å– (æ—§æ–¹æ¡ˆ)
  GET /api/quotes
  
  // æ–¹æ¡ˆB: ä» Draft Orders è¯»å– (æ–°æ–¹æ¡ˆï¼Œæ¨è)
  GET /api/get-draft-orders?email=admin@example.com&admin=1
}

// 2. ä¸‹è½½æ–‡ä»¶
function downloadOrderFile(orderId) {
  // ä»è®¢å•çš„ customAttributes ä¸­è·å–æ–‡ä»¶ID
  const fileId = order.customAttributes.find(a => a.key === 'æ–‡ä»¶ID').value;
  
  // è°ƒç”¨ä¸‹è½½API
  window.open(`/api/download-file?id=${fileId}`);
}

// 3. æ·»åŠ æŠ¥ä»·
async function submitQuote(draftOrderId, amount, note) {
  // æ›´æ–° Draft Order ä»·æ ¼
  POST /api/update-quote {
    draftOrderId: "gid://shopify/DraftOrder/123",
    amount: 1500,
    note: "æ ¹æ®æ‚¨çš„è¦æ±‚..."
  }
  
  // ç”Ÿæˆé‚®ä»¶å†…å®¹
  POST /api/send-email {
    customerEmail: "customer@example.com",
    amount: 1500,
    fileName: "model.step"
  }
  
  // æ˜¾ç¤ºé‚®ä»¶å¯¹è¯æ¡†
  showEmailDialog(emailData);
}
```

**åç«¯æ›´æ–°æŠ¥ä»· (`api/update-quote.js`)**:
```javascript
// æ­¥éª¤1: æŸ¥è¯¢ç°æœ‰ Draft Order
draftOrder(id: $draftOrderId) {
  lineItems {
    customAttributes { key value }
  }
}

// æ­¥éª¤2: æ›´æ–° Draft Order ä»·æ ¼
draftOrderUpdate(id: $draftOrderId, input: {
  lineItems: [{
    title: "3Dæ‰“å°æœåŠ¡ - æ–‡ä»¶å",
    quantity: 1,
    originalUnitPrice: "1500.00",  // â† æ›´æ–°ä»·æ ¼
    customAttributes: [
      ...ä¿ç•™åŸæœ‰å±æ€§,
      { key: "çŠ¶æ€", value: "å·²æŠ¥ä»·" },
      { key: "æŠ¥ä»·é‡‘é¢", value: "Â¥1500" },
      { key: "æŠ¥ä»·æ—¶é—´", value: "2025-01-29T10:30:00Z" },
      { key: "å¤‡æ³¨", value: "æ ¹æ®æ‚¨çš„è¦æ±‚..." }
    ]
  }],
  note: "å·²æŠ¥ä»·: Â¥1500\næŠ¥ä»·æ—¶é—´: 2025-01-29\næ ¹æ®æ‚¨çš„è¦æ±‚..."
})

// æ­¥éª¤3: åŒæ­¥æ›´æ–° Metaobject (å¯é€‰)
metaobjectUpdate {
  status: "å·²æŠ¥ä»·",
  amount: "1500",
  note: "...",
  quoted_at: "2025-01-29T10:30:00Z"
}

// è¿”å›: { draftOrderId, invoiceUrl, totalPrice }
```

**é‚®ä»¶ç”Ÿæˆ (`api/send-email.js`)**:
```javascript
// ç”Ÿæˆé‚®ä»¶å†…å®¹
{
  to: customerEmail,
  from: senderEmail,
  subject: "æ‚¨çš„3Dæ¨¡å‹å®šåˆ¶æŠ¥ä»·",
  body: "å°Šæ•¬çš„å®¢æˆ·...",
  html: "<html>...</html>"
}

// è¿”å› mailto: é“¾æ¥
return {
  mailto: "mailto:customer@example.com?subject=...&body=..."
}
```

---

### é˜¶æ®µ 3ï¸âƒ£: å®¢æˆ·æŸ¥çœ‹è¯¢ä»·çŠ¶æ€

#### å®¢æˆ·æ“ä½œæµç¨‹
1. **è®¿é—®"æˆ‘çš„è¯¢ä»·"é¡µé¢** (`/pages/my-quotes?id=D1001`)
2. **æŸ¥çœ‹è¯¢ä»·çŠ¶æ€**
   - **å¾…æŠ¥ä»·**: æ˜¾ç¤º"å®¢æœæ­£åœ¨ä¸ºæ‚¨æŠ¥ä»·ï¼Œè¯·ç¨å€™..."
   - **å·²æŠ¥ä»·**: æ˜¾ç¤ºæŠ¥ä»·é‡‘é¢ã€å¤‡æ³¨ã€ç«‹å³ä¸‹å•æŒ‰é’®
3. **åˆ·æ–°çŠ¶æ€** (å¦‚æœå¾…æŠ¥ä»·)
   - ç‚¹å‡»"åˆ·æ–°çŠ¶æ€"æŒ‰é’®
   - é‡æ–°è·å–æœ€æ–°çŠ¶æ€
4. **ç«‹å³ä¸‹å•** (å¦‚æœå·²æŠ¥ä»·)
   - ç‚¹å‡»"ç«‹å³ä¸‹å•"æŒ‰é’®
   - è·³è½¬åˆ° Shopify ç»“è´¦é¡µé¢

#### æŠ€æœ¯å®ç°æµç¨‹

**å‰ç«¯ (`templates/page.my-quotes.liquid`)**:
```javascript
// 1. åŠ è½½è¯¢ä»·å•è¯¦æƒ…
async function loadQuote() {
  const quoteId = new URLSearchParams(window.location.search).get('id');
  
  // è·å– Draft Order è¯¦æƒ…
  GET /api/get-draft-order-simple?id=${quoteId}&email=${customerEmail}
  
  // è§£ææ•°æ®
  const draftOrder = data.draftOrder;
  const lineItem = draftOrder.lineItems[0];
  const status = lineItem.customAttributes.find(a => a.key === 'çŠ¶æ€').value;
  const amount = lineItem.originalUnitPrice;
  
  // æ¸²æŸ“é¡µé¢
  if (status === 'å·²æŠ¥ä»·') {
    // æ˜¾ç¤ºæŠ¥ä»·é‡‘é¢å’Œç«‹å³ä¸‹å•æŒ‰é’®
    showQuoteDetails(amount, note);
  } else {
    // æ˜¾ç¤ºå¾…æŠ¥ä»·çŠ¶æ€
    showPendingStatus();
  }
}

// 2. ç«‹å³ä¸‹å•
function proceedToCheckout(invoiceUrl) {
  // ç›´æ¥è·³è½¬åˆ° Draft Order çš„ä»˜æ¬¾é¡µé¢
  window.location.href = invoiceUrl;
  // invoiceUrl æ ¼å¼: https://checkout.shopify.com/...
}
```

**åç«¯è·å–è¯¢ä»·å• (`api/get-draft-order-simple.js`)**:
```javascript
// æŸ¥è¯¢ Draft Order
draftOrder(id: $id) {
  name: "#D1001",
  email: "customer@example.com",
  totalPrice: "1500.00",
  lineItems {
    title: "3Dæ‰“å°æœåŠ¡ - model.step",
    quantity: 1,
    originalUnitPrice: "1500.00",
    customAttributes {
      { key: "çŠ¶æ€", value: "å·²æŠ¥ä»·" },
      { key: "æŠ¥ä»·é‡‘é¢", value: "Â¥1500" },
      { key: "å¤‡æ³¨", value: "..." }
    }
  }
}

// é‚®ç®±éªŒè¯ (ç¡®ä¿è®¢å•å±äºå½“å‰å®¢æˆ·)
if (draftOrder.email !== customerEmail) {
  return 403 Forbidden;
}

// è¿”å›æ ¼å¼åŒ–æ•°æ®
```

---

### é˜¶æ®µ 4ï¸âƒ£: å®¢æˆ·ä¸‹å•å’Œæ”¯ä»˜

#### å®¢æˆ·æ“ä½œæµç¨‹
1. **ç‚¹å‡»"ç«‹å³ä¸‹å•"**
   - è·³è½¬åˆ° Shopify ç»“è´¦é¡µé¢ (`invoiceUrl`)
2. **æŸ¥çœ‹è®¢å•è¯¦æƒ…**
   - äº§å“: 3Dæ‰“å°æœåŠ¡ - model.step
   - å•ä»·: Â¥1,500.00
   - æ•°é‡: 1
   - æ€»è®¡: Â¥1,500.00
3. **å®Œæˆæ”¯ä»˜**
   - å¡«å†™æ”¶è´§åœ°å€
   - é€‰æ‹©æ”¯ä»˜æ–¹å¼
   - å®Œæˆæ”¯ä»˜
4. **è®¢å•è‡ªåŠ¨è½¬æ¢**
   - Draft Order è‡ªåŠ¨è½¬ä¸ºæ­£å¼è®¢å•
   - çŠ¶æ€å˜ä¸º"å¾…å‘è´§"

#### æŠ€æœ¯å®ç°æµç¨‹

**Shopify è‡ªåŠ¨å¤„ç†**:
```
Draft Order (open) 
  â†“ å®¢æˆ·æ”¯ä»˜
Order (fulfilled)
  â†“ è‡ªåŠ¨è½¬æ¢
è®¢å•çŠ¶æ€: å¾…å‘è´§
```

**æ— éœ€é¢å¤–ä»£ç ** - Shopify åŸç”ŸåŠŸèƒ½

---

### é˜¶æ®µ 5ï¸âƒ£: æ–‡ä»¶ä¸‹è½½

#### ä¸‹è½½æµç¨‹

**é€šè¿‡æ–‡ä»¶IDä¸‹è½½ (`api/download-file.js`)**:
```javascript
// æ–¹æ¡ˆ1: é€šè¿‡ uploaded_file Metaobject æŸ¥æ‰¾
metaobjectByHandle(handle: $fileId, type: "uploaded_file") {
  fields {
    { key: "file_url", value: "https://cdn.shopify.com/..." },
    { key: "shopify_file_id", value: "gid://shopify/File/123" }
  }
}

// æ–¹æ¡ˆ2: ç›´æ¥ä½¿ç”¨ Shopify File ID
if (shopifyFileId) {
  node(id: $shopifyFileId) {
    ... on GenericFile {
      url  // CDN URL
    }
  }
}

// é‡å®šå‘åˆ° CDN URL
res.writeHead(302, { Location: fileUrl });
```

---

## æ ¸å¿ƒåŠŸèƒ½è¯¦è§£

### 1. æ–‡ä»¶ä¸Šä¼ ç³»ç»Ÿ

#### æ”¯æŒçš„æ–‡ä»¶æ ¼å¼
- **3Dæ–‡ä»¶**: STP, STEP, STL, OBJ, 3MF, IGES, GLB, GLTF
- **2Dæ–‡ä»¶**: DWG, DXF, PDF
- **å‹ç¼©åŒ…**: ZIP, RAR

#### æ–‡ä»¶å¤„ç†é€»è¾‘
- **3Dæ–‡ä»¶**: ä½¿ç”¨ Three.js æˆ– Online3DViewer è¿›è¡Œé¢„è§ˆ
- **2Dæ–‡ä»¶**: æç¤ºéœ€è¦ä¸Šä¼ å¯¹åº”çš„3Dæ–‡ä»¶
- **ZIPæ–‡ä»¶**: è‡ªåŠ¨è§£å‹ï¼ŒæŸ¥æ‰¾å…¶ä¸­çš„3Dæ–‡ä»¶

#### æ–‡ä»¶å­˜å‚¨ä½ç½®
- **å®é™…æ–‡ä»¶**: Shopify Files (Google Cloud Storage CDN)
- **å…ƒæ•°æ®**: `uploaded_file` Metaobject
- **æ–‡ä»¶å¤§å°é™åˆ¶**: å•ä¸ªæ–‡ä»¶æœ€å¤§100MB
- **æ–‡ä»¶æ•°é‡é™åˆ¶**: å•æ¬¡æœ€å¤š20ä¸ªæ–‡ä»¶

---

### 2. å‚æ•°æ”¶é›†ç³»ç»Ÿ

#### å‚æ•°ç±»å‹
- **ææ–™ç›¸å…³**: ææ–™ç±»å‹ã€é¢œè‰²ã€è¡¨é¢å¤„ç†
- **ç²¾åº¦ç›¸å…³**: ç²¾åº¦ç­‰çº§ã€å…¬å·®æ ‡å‡†ã€è¡¨é¢ç²—ç³™åº¦
- **åŠ å·¥ç›¸å…³**: æ˜¯å¦æœ‰èºçº¹ã€æ˜¯å¦æœ‰è£…é…æ ‡è®°ã€ç¼©æ”¾æ¯”ä¾‹
- **æ•°é‡ç›¸å…³**: æ•°é‡
- **å…¶ä»–**: å¤‡æ³¨

#### å‚æ•°å­˜å‚¨æ–¹å¼
æ‰€æœ‰å‚æ•°å­˜å‚¨åœ¨ Draft Order çš„ `customAttributes` ä¸­:
```javascript
customAttributes: [
  { key: "æ–‡ä»¶", value: "model.step" },
  { key: "ææ–™", value: "ABS" },
  { key: "é¢œè‰²", value: "ç™½è‰²" },
  { key: "ç²¾åº¦", value: "é«˜ç²¾åº¦ (Â±0.05mm)" },
  { key: "æ•°é‡", value: "10" },
  { key: "å¤‡æ³¨", value: "..." }
]
```

---

### 3. æŠ¥ä»·ç®¡ç†ç³»ç»Ÿ

#### æŠ¥ä»·çŠ¶æ€æµè½¬
```
å¾…æŠ¥ä»· (Pending) 
  â†“ å®¢æœæ·»åŠ æŠ¥ä»·
å·²æŠ¥ä»· (Quoted)
  â†“ å®¢æˆ·ä¸‹å•æ”¯ä»˜
å·²å®Œæˆ (Completed)
```

#### æŠ¥ä»·å­˜å‚¨
- **ä»·æ ¼**: Draft Order çš„ `lineItems[0].originalUnitPrice`
- **çŠ¶æ€**: `customAttributes` ä¸­çš„ `çŠ¶æ€` å­—æ®µ
- **å¤‡æ³¨**: `customAttributes` ä¸­çš„ `å¤‡æ³¨` å­—æ®µ
- **æŠ¥ä»·æ—¶é—´**: `customAttributes` ä¸­çš„ `æŠ¥ä»·æ—¶é—´` å­—æ®µ

---

### 4. é‚®ä»¶é€šçŸ¥ç³»ç»Ÿ

#### é‚®ä»¶å‘é€æ–¹å¼
- **å½“å‰æ–¹æ¡ˆ**: ä½¿ç”¨ `mailto:` åè®®
  - ç”Ÿæˆé‚®ä»¶å†…å®¹
  - æ‰“å¼€æœ¬åœ°é‚®ä»¶å®¢æˆ·ç«¯
  - å®¢æœæ‰‹åŠ¨å‘é€

#### é‚®ä»¶å†…å®¹
- **æ”¶ä»¶äºº**: å®¢æˆ·é‚®ç®±
- **å‘ä»¶äºº**: å®¢æœé‚®ç®±
- **ä¸»é¢˜**: "æ‚¨çš„3Dæ¨¡å‹å®šåˆ¶æŠ¥ä»·"
- **æ­£æ–‡**: HTMLæ ¼å¼ï¼ŒåŒ…å«æŠ¥ä»·é‡‘é¢ã€å¤‡æ³¨ç­‰

---

## æ•°æ®å­˜å‚¨ç»“æ„

### 1. Draft Order (è¯¢ä»·å•)

```javascript
{
  id: "gid://shopify/DraftOrder/1234567890",
  name: "#D1001",  // è¯¢ä»·å•å·
  email: "customer@example.com",
  status: "open",  // open = è‰ç¨¿, invoice_sent = å·²å‘é€å‘ç¥¨
  totalPrice: "1500.00",
  invoiceUrl: "https://checkout.shopify.com/...",
  createdAt: "2025-01-29T10:00:00Z",
  updatedAt: "2025-01-29T10:30:00Z",
  
  lineItems: [{
    id: "gid://shopify/DraftOrderLineItem/...",
    title: "3Dæ‰“å°æœåŠ¡ - model.step",
    quantity: 1,
    originalUnitPrice: "1500.00",
    customAttributes: [
      { key: "æ–‡ä»¶", value: "model.step" },
      { key: "ææ–™", value: "ABS" },
      { key: "çŠ¶æ€", value: "å·²æŠ¥ä»·" },
      { key: "æŠ¥ä»·é‡‘é¢", value: "Â¥1500" },
      { key: "æŠ¥ä»·æ—¶é—´", value: "2025-01-29T10:30:00Z" },
      { key: "å¤‡æ³¨", value: "æ ¹æ®æ‚¨çš„è¦æ±‚..." }
    ]
  }],
  
  note: "å·²æŠ¥ä»·: Â¥1500\næŠ¥ä»·æ—¶é—´: 2025-01-29\næ ¹æ®æ‚¨çš„è¦æ±‚..."
}
```

---

### 2. uploaded_file Metaobject (æ–‡ä»¶å…ƒæ•°æ®)

```javascript
{
  type: "uploaded_file",
  handle: "file_1759114189482_jt19vrzqj",
  fields: [
    { key: "file_id", value: "file_1759114189482_jt19vrzqj" },
    { key: "file_name", value: "model.STEP" },
    { key: "file_type", value: "model/step" },
    { key: "file_url", value: "https://cdn.shopify.com/s/files/..." },
    { key: "shopify_file_id", value: "gid://shopify/GenericFile/123456" },
    { key: "file_size", value: "683520" },
    { key: "upload_time", value: "2025-01-29T10:00:00.000Z" }
  ]
}
```

---

### 3. quote Metaobject (æŠ¥ä»·è®°å½• - æ—§æ–¹æ¡ˆï¼Œå¯é€‰)

```javascript
{
  type: "quote",
  handle: "zhang-example-com",
  fields: [
    { key: "text", value: "model.STEP" },
    { key: "author", value: "å¼ ä¸‰ (zhang@example.com) | æ•°é‡:10ä»¶ | ææ–™:ABS | ..." },
    { key: "status", value: "Quoted" },
    { key: "price", value: "1500.00" },
    { key: "invoice_url", value: "https://shopify-v587.vercel.app/download-file?id=file_xxx" },
    { key: "draft_order_id", value: "gid://shopify/DraftOrder/1234567890" }
  ]
}
```

**æ³¨æ„**: æ–°æ–¹æ¡ˆä¸»è¦ä½¿ç”¨ Draft Orderï¼ŒMetaobject ä»…ä½œä¸ºè¾…åŠ©å­˜å‚¨ã€‚

---

## APIæ¥å£è¯´æ˜

### æ–‡ä»¶ç›¸å…³

#### POST `/api/store-file-real`
ä¸Šä¼ æ–‡ä»¶åˆ° Shopify Files

**è¯·æ±‚**:
```json
{
  "fileData": "data:application/step;base64,U1RFUCBGSUxF...",
  "fileName": "model.STEP",
  "fileType": "application/step"
}
```

**å“åº”**:
```json
{
  "success": true,
  "fileId": "file_1759114189482_jt19vrzqj",
  "shopifyFileId": "gid://shopify/GenericFile/123456",
  "shopifyFileUrl": "https://cdn.shopify.com/s/files/...",
  "originalFileSize": 683520
}
```

#### GET `/api/download-file?id=fileId`
ä¸‹è½½æ–‡ä»¶

**å“åº”**: 302é‡å®šå‘åˆ°CDN URLï¼Œæˆ–ç›´æ¥è¿”å›æ–‡ä»¶å†…å®¹

---

### è¯¢ä»·å•ç›¸å…³

#### POST `/api/submit-quote-real`
åˆ›å»ºè¯¢ä»·å• (åˆ›å»º Draft Order)

**è¯·æ±‚**:
```json
{
  "customerName": "å¼ ä¸‰",
  "customerEmail": "zhang@example.com",
  "fileName": "model.step",
  "fileUrl": "https://cdn.shopify.com/...",
  "quantity": 1,
  "material": "ABS",
  "color": "ç™½è‰²",
  "precision": "é«˜ç²¾åº¦",
  "lineItems": [
    {
      "title": "3Dæ‰“å°æœåŠ¡ - model.step",
      "quantity": 1,
      "customAttributes": [...]
    }
  ]
}
```

**å“åº”**:
```json
{
  "success": true,
  "quoteId": "Q1234567890",
  "draftOrderId": "gid://shopify/DraftOrder/1234567890",
  "draftOrderName": "#D1001",
  "invoiceUrl": "https://checkout.shopify.com/...",
  "customerEmail": "zhang@example.com"
}
```

#### POST `/api/update-quote`
æ›´æ–°æŠ¥ä»· (æ›´æ–° Draft Order ä»·æ ¼)

**è¯·æ±‚**:
```json
{
  "draftOrderId": "gid://shopify/DraftOrder/1234567890",
  "amount": 1500,
  "note": "æ ¹æ®æ‚¨çš„è¦æ±‚...",
  "senderEmail": "service@company.com"
}
```

**å“åº”**:
```json
{
  "success": true,
  "draftOrderId": "gid://shopify/DraftOrder/1234567890",
  "draftOrderName": "#D1001",
  "invoiceUrl": "https://checkout.shopify.com/...",
  "totalPrice": "1500.00",
  "customerEmail": "customer@example.com"
}
```

#### GET `/api/get-draft-order-simple?id=D1001&email=customer@example.com`
è·å–è¯¢ä»·å•è¯¦æƒ…

**å“åº”**:
```json
{
  "success": true,
  "draftOrder": {
    "id": "gid://shopify/DraftOrder/1234567890",
    "name": "#D1001",
    "email": "customer@example.com",
    "status": "å·²æŠ¥ä»·",
    "totalPrice": "1500.00",
    "lineItems": [...],
    "invoiceUrl": "https://checkout.shopify.com/..."
  }
}
```

#### GET `/api/get-draft-orders?email=admin@example.com&admin=1`
è·å–æ‰€æœ‰è¯¢ä»·å•åˆ—è¡¨ (ç®¡ç†ç«¯)

**å“åº”**:
```json
{
  "success": true,
  "draftOrders": [...],
  "total": 10,
  "pending": 5,
  "quoted": 5
}
```

---

### é‚®ä»¶ç›¸å…³

#### POST `/api/send-email`
ç”Ÿæˆé‚®ä»¶å†…å®¹

**è¯·æ±‚**:
```json
{
  "customerEmail": "customer@example.com",
  "senderEmail": "service@company.com",
  "amount": "1500.00",
  "fileName": "model.step",
  "notes": "é¢„è®¡äº¤ä»˜æ—¶é—´ï¼š3-5ä¸ªå·¥ä½œæ—¥"
}
```

**å“åº”**:
```json
{
  "success": true,
  "mailto": "mailto:customer@example.com?subject=...&body=...",
  "email": {
    "to": "customer@example.com",
    "from": "service@company.com",
    "subject": "æ‚¨çš„3Dæ¨¡å‹å®šåˆ¶æŠ¥ä»·",
    "body": "...",
    "html": "<html>...</html>"
  }
}
```

---

## å…³é”®æŠ€æœ¯ç‚¹

### 1. Shopify Staged Upload

**ä¸ºä»€ä¹ˆä½¿ç”¨ Staged Upload?**
- ç›´æ¥ä¸Šä¼ å¤§æ–‡ä»¶åˆ° Shopify API ä¼šè¶…æ—¶
- Staged Upload åˆ†ä¸¤æ­¥ï¼šå…ˆè·å–ä¸´æ—¶åœ°å€ï¼Œå†ä¸Šä¼ æ–‡ä»¶
- æ–‡ä»¶ä¸Šä¼ åˆ° Google Cloud Storageï¼Œé€Ÿåº¦æ›´å¿«

**æµç¨‹**:
```
1. stagedUploadsCreate â†’ è·å–ä¸´æ—¶URL
2. POST æ–‡ä»¶åˆ°ä¸´æ—¶URL
3. fileCreate â†’ åˆ›å»ºæ°¸ä¹…è®°å½•
4. Shopify è‡ªåŠ¨å°†æ–‡ä»¶ç§»åˆ°æ°¸ä¹…å­˜å‚¨
```

---

### 2. Base64 ç¼–ç 

**ä¸ºä»€ä¹ˆä½¿ç”¨ Base64?**
- æ–‡ä»¶æ˜¯äºŒè¿›åˆ¶æ•°æ®ï¼Œæ— æ³•ç›´æ¥åœ¨ JSON ä¸­ä¼ è¾“
- Base64 å°†äºŒè¿›åˆ¶è½¬æ¢ä¸ºæ–‡æœ¬æ ¼å¼
- å¯ä»¥å®‰å…¨åœ°é€šè¿‡ HTTP ä¼ è¾“

**å‰ç«¯ç¼–ç **:
```javascript
const reader = new FileReader();
reader.onload = function(e) {
  const base64Data = e.target.result; // "data:application/step;base64,U1RFUCBGSUxF..."
  // å‘é€åˆ°åç«¯
};
reader.readAsDataURL(file);
```

**åç«¯è§£ç **:
```javascript
const base64Data = fileData.split(',')[1];
const fileBuffer = Buffer.from(base64Data, 'base64');
```

---

### 3. CORS (è·¨åŸŸèµ„æºå…±äº«)

**ä¸ºä»€ä¹ˆéœ€è¦ CORS?**
- å‰ç«¯åŸŸå: `sain-pdc-test.myshopify.com`
- åç«¯åŸŸå: `shopify-v587.vercel.app`
- æµè§ˆå™¨å®‰å…¨ç­–ç•¥é˜»æ­¢è·¨åŸŸè¯·æ±‚

**è®¾ç½®**:
```javascript
res.setHeader('Access-Control-Allow-Origin', 'https://sain-pdc-test.myshopify.com');
res.setHeader('Access-Control-Allow-Methods', 'GET,POST,PATCH,DELETE,OPTIONS');
res.setHeader('Access-Control-Allow-Headers', 'Content-Type');
```

---

### 4. Draft Order vs Metaobject

**æ–°æ–¹æ¡ˆ (æ¨è)**: ä½¿ç”¨ Draft Order
- âœ… ç¬¦åˆ Shopify è§„åˆ™
- âœ… æ•°æ®ä¸€è‡´æ€§ (Draft Order æ˜¯å”¯ä¸€æ•°æ®æº)
- âœ… åŸç”Ÿç»“è´¦ä½“éªŒ
- âœ… è‡ªåŠ¨è½¬æ¢ä¸ºæ­£å¼è®¢å•
- âœ… åå°å¯è§è‰ç¨¿è®¢å•

**æ—§æ–¹æ¡ˆ**: ä½¿ç”¨ Metaobject
- âš ï¸ éœ€è¦æ‰‹åŠ¨åŒæ­¥
- âš ï¸ éœ€è¦åˆ›å»ºæ–°è®¢å•
- âš ï¸ è‡ªå®šä¹‰ç»“è´¦æµç¨‹

**å½“å‰çŠ¶æ€**: æ–°æ–¹æ¡ˆå·²å®æ–½ï¼Œæ—§æ–¹æ¡ˆä¿ç•™ä½œä¸ºå¤‡ä»½

---

### 5. æ–‡ä»¶ä¸‹è½½ä»£ç†

**ä¸ºä»€ä¹ˆé€šè¿‡ Vercel ä»£ç†?**
- æ–‡ä»¶å®é™…å­˜å‚¨åœ¨ Shopify CDN
- é€šè¿‡ Vercel API (`/api/download-file`) ä»£ç†ä¸‹è½½
- å¥½å¤„ï¼šå¯ä»¥æ·»åŠ æƒé™éªŒè¯ã€æ—¥å¿—è®°å½•ç­‰ä¸­é—´å±‚é€»è¾‘
- æœªæ¥å¯ä»¥æ‰©å±•ä¸ºéœ€è¦ç™»å½•æ‰èƒ½ä¸‹è½½

---

## å¸¸è§é—®é¢˜

### Q1: æ–‡ä»¶ä¸Šä¼ å¤±è´¥æ€ä¹ˆåŠ?
**A**: 
- æ£€æŸ¥æ–‡ä»¶å¤§å° (æœ€å¤§100MB)
- æ£€æŸ¥æ–‡ä»¶æ ¼å¼æ˜¯å¦æ”¯æŒ
- æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°å’Œ Vercel æ—¥å¿—

### Q2: æŠ¥ä»·åå®¢æˆ·çœ‹ä¸åˆ°?
**A**: 
- ç¡®è®¤ Draft Order ä»·æ ¼å·²æ›´æ–°
- ç¡®è®¤ `customAttributes` ä¸­çš„ `çŠ¶æ€` å­—æ®µä¸º"å·²æŠ¥ä»·"
- æ£€æŸ¥å®¢æˆ·é‚®ç®±æ˜¯å¦æ­£ç¡®

### Q3: å®¢æˆ·æ— æ³•ä¸‹å•?
**A**: 
- ç¡®è®¤ Draft Order çŠ¶æ€ä¸º "open"
- ç¡®è®¤ `invoiceUrl` æœ‰æ•ˆ
- æ£€æŸ¥ä»·æ ¼æ˜¯å¦å¤§äº0

### Q4: æ–‡ä»¶ä¸‹è½½å¤±è´¥?
**A**: 
- æ£€æŸ¥æ–‡ä»¶IDæ˜¯å¦æ­£ç¡®
- ç¡®è®¤ `uploaded_file` Metaobject å­˜åœ¨
- ç¡®è®¤ Shopify File ID æœ‰æ•ˆ

---

## ä¸‹ä¸€æ­¥å­¦ä¹ 

1. **é˜…è¯»ä»£ç æ³¨é‡Š**: æ¯ä¸ªæ ¸å¿ƒæ–‡ä»¶éƒ½æœ‰è¯¦ç»†çš„ä¸­æ–‡æ³¨é‡Š
2. **æŸ¥çœ‹æ–‡æ¡£**: 
   - `3.SYSTEM_WORKFLOW.md` - ç³»ç»Ÿå·¥ä½œæµç¨‹
   - `4.CODE_DOCUMENTATION_INDEX.md` - ä»£ç æ–‡æ¡£ç´¢å¼•
   - `FINAL_DRAFT_ORDER_SOLUTION.md` - Draft Order æ–¹æ¡ˆè¯¦è§£
3. **å®è·µæ“ä½œ**: åœ¨æµ‹è¯•ç¯å¢ƒä¸­å°è¯•å®Œæ•´æµç¨‹
4. **è°ƒè¯•æŠ€å·§**: ä½¿ç”¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·æŸ¥çœ‹ç½‘ç»œè¯·æ±‚

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**æœ€åæ›´æ–°**: 2025-01-29  
**ç»´æŠ¤è€…**: AI Assistant

å¦‚æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·éšæ—¶æŸ¥é˜…ç›¸å…³æ–‡æ¡£æˆ–åˆ›å»º Issueã€‚
