{% comment %}
  å®¢æœåå°ç®¡ç†ç•Œé¢
  åªæœ‰é€šè¿‡èº«ä»½éªŒè¯çš„å®¢æœäººå‘˜æ‰èƒ½è®¿é—®
{% endcomment %}

<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>å®¢æœåå° - è®¢å•ç®¡ç†ç³»ç»Ÿ</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f7fa;
      color: #333;
    }
    
    .admin-header {
      background: white;
      padding: 20px 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .admin-title {
      font-size: 24px;
      font-weight: 600;
      color: #333;
    }
    
    .admin-user {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .user-info {
      text-align: right;
    }
    
    .user-name {
      font-weight: 500;
      color: #333;
    }
    
    .user-role {
      font-size: 12px;
      color: #666;
    }
    
    .logout-btn {
      background: #e74c3c;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .logout-btn:hover {
      background: #c0392b;
    }
    
    .admin-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 30px;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      text-align: center;
    }
    
    .stat-icon {
      font-size: 32px;
      margin-bottom: 10px;
    }
    
    .stat-number {
      font-size: 28px;
      font-weight: 600;
      color: #333;
      margin-bottom: 5px;
    }
    
    .stat-label {
      color: #666;
      font-size: 14px;
    }
    
    .main-content {
      display: grid;
      grid-template-columns: 1fr 300px;
      gap: 30px;
    }
    
    .orders-section {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    
    .section-header {
      padding: 20px 25px;
      background: #f8f9fa;
      border-bottom: 1px solid #e9ecef;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .section-title {
      font-size: 18px;
      font-weight: 600;
      color: #333;
    }
    
    .refresh-btn {
      background: #667eea;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .refresh-btn:hover {
      background: #5a6fd8;
    }
    
    .orders-list {
      max-height: 600px;
      overflow-y: auto;
    }
    
    .order-item {
      padding: 20px 25px;
      border-bottom: 1px solid #f0f0f0;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    
    .order-item:hover {
      background: #f8f9fa;
    }
    
    .order-item:last-child {
      border-bottom: none;
    }
    
    .order-actions {
      display: flex;
      gap: 8px;
      margin-top: 15px;
      justify-content: flex-end;
    }
    
    .action-btn {
      width: 32px;
      height: 32px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }
    
    .action-btn.download {
      background: #e3f2fd;
      color: #1976d2;
    }
    
    .action-btn.download:hover {
      background: #bbdefb;
    }
    
    .action-btn.preview {
      background: #f3e5f5;
      color: #7b1fa2;
    }
    
    .action-btn.preview:hover {
      background: #e1bee7;
    }
    
    .action-btn.quote {
      background: #fff3e0;
      color: #f57c00;
    }
    
    .action-btn.quote:hover {
      background: #ffe0b2;
    }
    
    .action-btn.delete {
      background: #ffebee;
      color: #d32f2f;
    }
    
    .action-btn.delete:hover {
      background: #ffcdd2;
    }
    
    .action-btn.guide {
      background: #e8f5e8;
      color: #2e7d32;
    }
    .action-btn.guide:hover {
      background: #c8e6c9;
    }
    
    .order-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .order-id {
      font-weight: 600;
      color: #333;
    }
    
    .order-status {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .status-pending {
      background: #fff3cd;
      color: #856404;
    }
    
    .status-quoted {
      background: #d4edda;
      color: #155724;
    }
    
    .status-completed {
      background: #d1ecf1;
      color: #0c5460;
    }
    
    .order-info {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      font-size: 14px;
      color: #666;
    }
    
    .order-customer {
      font-weight: 500;
      color: #333;
    }
    
    .order-time {
      text-align: right;
    }
    
    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    .quick-actions {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 20px;
    }
    
    .quick-actions h3 {
      margin-bottom: 15px;
      color: #333;
    }
    
    .action-btn {
      width: 100%;
      padding: 12px;
      margin-bottom: 10px;
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 6px;
      cursor: pointer;
      text-align: left;
      transition: all 0.2s ease;
    }
    
    .action-btn:hover {
      background: #e9ecef;
      border-color: #667eea;
    }
    
    .action-btn:last-child {
      margin-bottom: 0;
    }
    
    .empty-state {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    
    .empty-icon {
      font-size: 48px;
      margin-bottom: 15px;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
    }
    
    .modal-content {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border-radius: 12px;
      padding: 30px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .modal-title {
      font-size: 20px;
      font-weight: 600;
      color: #333;
    }
    
    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #666;
    }
    
    .close-btn:hover {
      color: #333;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #333;
    }
    
    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }
    
    .form-group textarea {
      height: 100px;
      resize: vertical;
    }
    
    .modal-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 20px;
    }
    
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
    }
    
    .btn-primary {
      background: #667eea;
      color: white;
    }
    
    .btn-primary:hover {
      background: #5a6fd8;
    }
    
    .btn-secondary {
      background: #6c757d;
      color: white;
    }
    
    .btn-secondary:hover {
      background: #5a6268;
    }
  </style>
</head>
<body>
  <!-- å¤´éƒ¨ -->
  <div class="admin-header">
    <div class="admin-title">ğŸ“‹ è®¢å•ç®¡ç†ç³»ç»Ÿ</div>
    <div class="admin-user">
      <div class="user-info">
        <div class="user-name" id="admin-name">å®¢æœç®¡ç†å‘˜</div>
        <div class="user-role">å®¢æœäººå‘˜</div>
      </div>
      <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
    </div>
  </div>

  <!-- ä¸»è¦å†…å®¹ -->
  <div class="admin-container">
    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon">ğŸ“Š</div>
        <div class="stat-number" id="total-orders">0</div>
        <div class="stat-label">æ€»è®¢å•æ•°</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">â³</div>
        <div class="stat-number" id="pending-orders">0</div>
        <div class="stat-label">å¾…æŠ¥ä»·</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">âœ…</div>
        <div class="stat-number" id="quoted-orders">0</div>
        <div class="stat-label">å·²æŠ¥ä»·</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">ğŸ’°</div>
        <div class="stat-number" id="total-revenue">$0</div>
        <div class="stat-label">æ€»æŠ¥ä»·é‡‘é¢</div>
      </div>
    </div>

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <div class="main-content">
      <!-- è®¢å•åˆ—è¡¨ -->
      <div class="orders-section">
        <div class="section-header">
          <div class="section-title">è®¢å•åˆ—è¡¨</div>
          <button class="refresh-btn" id="refresh-btn">ğŸ”„ åˆ·æ–°</button>
        </div>
        <div class="orders-list" id="orders-list">
          <div class="empty-state">
            <div class="empty-icon">ğŸ“‹</div>
            <div>æš‚æ— è®¢å•æ•°æ®</div>
          </div>
        </div>
      </div>

      <!-- ä¾§è¾¹æ  -->
      <div class="sidebar">
        <div class="quick-actions">
          <h3>å¿«é€Ÿæ“ä½œ</h3>
          <button class="action-btn" onclick="openQuoteModalFromQuickAction()">
            ğŸ’° æ·»åŠ æŠ¥ä»·
          </button>
          <button class="action-btn" onclick="openFileManager()">
            ğŸ“ æ–‡ä»¶ç®¡ç†
          </button>
          <button class="action-btn" onclick="openCustomerList()">
            ğŸ‘¥ å®¢æˆ·åˆ—è¡¨
          </button>
          <button class="action-btn" onclick="exportData()">
            ğŸ“Š å¯¼å‡ºæ•°æ®
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- æŠ¥ä»·æ¨¡æ€æ¡† -->
  <div class="modal" id="quote-modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">æ·»åŠ æŠ¥ä»·</div>
        <button class="close-btn" onclick="closeQuoteModal()">&times;</button>
      </div>
      <form id="quote-form">
        <div class="form-group">
          <label>è®¢å•ID</label>
          <input type="text" id="quote-order-id" readonly>
        </div>
        <div class="form-group">
          <label>å®¢æˆ·é‚®ç®±</label>
          <input type="email" id="quote-email" readonly>
        </div>
        <div class="form-group">
          <label>å‘é€é‚®ç®± <span style="color: #e74c3c;">*</span></label>
          <input type="email" id="quote-sender-email" placeholder="è¯·è¾“å…¥æ‚¨çš„é‚®ç®±åœ°å€" required>
          <small style="color: #666; font-size: 12px;">ç”¨äºå‘é€æŠ¥ä»·é‚®ä»¶ç»™å®¢æˆ·</small>
        </div>
        <div class="form-group">
          <label>æ–‡ä»¶ä¿¡æ¯</label>
          <input type="text" id="quote-files" readonly>
        </div>
        <div class="form-group">
          <label>æŠ¥ä»·é‡‘é¢ ($)</label>
          <input type="number" id="quote-amount" step="0.01" required placeholder="è¯·è¾“å…¥æŠ¥ä»·é‡‘é¢">
        </div>
        <div class="form-group">
          <label>æŠ¥ä»·å¤‡æ³¨</label>
          <textarea id="quote-note" placeholder="è¯·è¾“å…¥æŠ¥ä»·å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰..."></textarea>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="closeQuoteModal()">å–æ¶ˆ</button>
          <button type="submit" class="btn btn-primary">ğŸ“§ ç«‹å³å‘é€æŠ¥ä»·</button>
        </div>
      </form>
    </div>
  </div>

  <!-- åŠ è½½ç™»å½•ç®¡ç†ç³»ç»Ÿ -->
  <script src="{{ 'login-manager.js' | asset_url }}" defer></script>
  
  <!-- åŠ è½½æ–‡ä»¶å­˜å‚¨ç®¡ç†å™¨ -->
  <script src="{{ 'file-storage.js' | asset_url }}" defer></script>
  
  <!-- æŠ¥ä»·ä¸­å¿ƒAPIå®¢æˆ·ç«¯ï¼ˆApp Proxyï¼‰ -->
  <script src="{{ 'quote-api.js' | asset_url }}" defer></script>
  
  <script>
    // æ¥å…¥ä½ éƒ¨ç½²åœ¨ Vercel çš„åç«¯æ¥å£ï¼ˆçº¯åç«¯å¯¹ Admin APIï¼‰
    const QUOTES_API_BASE = 'https://shopify-13s4.vercel.app/api';
    // æ£€æŸ¥ç™»å½•çŠ¶æ€
    function checkAuth() {
      if (!window.loginManager) {
        console.error('ç™»å½•ç®¡ç†ç³»ç»ŸæœªåŠ è½½');
        return false;
      }
      
      const hasAccess = window.loginManager.checkAndRedirect('admin');
      
      if (hasAccess) {
        // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
        const currentUser = window.loginManager.getCurrentUser();
        if (currentUser && currentUser.type === 'admin') {
          document.getElementById('admin-name').textContent = currentUser.data.name || 'å®¢æœç®¡ç†å‘˜';
        }
      }
      
      return hasAccess;
    }
    
    // é€€å‡ºç™»å½•
    function logout() {
      if (window.loginManager) {
        window.loginManager.logout();
      }
      window.location.href = '/pages/admin-login';
    }
    
    // è·å–è®¢å•æ•°æ®
    async function fetchOrders() {
      // 1) ä¼˜å…ˆä» Vercel åç«¯è¯»å– Metaobject: quote åˆ—è¡¨
      try {
        console.log('å¼€å§‹è·å–è®¢å•åˆ—è¡¨...');
        const res = await fetch(`${QUOTES_API_BASE}/quotes`, { headers: { 'Accept': 'application/json' } });
        if (res.ok) {
          const data = await res.json();
          const records = Array.isArray(data) ? data : (data.records || []);
          console.log('è·å–åˆ°è®°å½•æ•°é‡:', records.length);
          
          const orders = records
            .filter(r => {
              // è¿‡æ»¤æ‰å·²åˆ é™¤çš„è®°å½•
              // æš‚æ—¶ä¸è¿‡æ»¤ä»»ä½•è®°å½•ï¼Œæ˜¾ç¤ºæ‰€æœ‰è®¢å•
              return true;
            })
            .map(r => {
              const field = (key) => {
                const f = (r.fields || []).find(x => x.key === key);
                return f ? f.value : '';
              };
              const order = {
                id: r.handle || r.id,                    // ç”¨ handle ä½œä¸ºå”¯ä¸€æ ‡è¯†
                customer: field('author') || 'æœªçŸ¥å®¢æˆ·',
                email: field('email') || '',
                files: field('text') || 'â€”',
                status: field('status') || 'Pending',
                amount: field('price') || 0,
                time: new Date().toLocaleString('zh-CN'),
                properties: r
              };
              console.log('å¤„ç†è®¢å•:', order.id, 'status:', order.status);
              return order;
            });
          
          console.log('æœ€ç»ˆè®¢å•æ•°é‡:', orders.length);
          return orders.sort((a, b) => new Date(b.time) - new Date(a.time));
        }
      } catch (error) {
        console.warn('ä» Vercel åç«¯è·å–å¤±è´¥ï¼Œå›é€€åˆ°è´­ç‰©è½¦ï¼š', error);
      }
      // 2) å¤±è´¥æ—¶é™çº§è¯»å–æœ¬åœ°è´­ç‰©è½¦
      try {
        const response = await fetch('/cart.js');
        const cart = await response.json();
        const orders = [];
        cart.items.forEach(item => {
          if (item.properties && item.properties['Order Type'] === '3D Model Quote') {
            orders.push({
              id: item.properties._uuid || item.key,
              customer: item.properties['å®¢æˆ·å§“å'] || 'æœªçŸ¥å®¢æˆ·',
              email: item.properties['å®¢æˆ·é‚®ç®±'] || '',
              files: item.properties['é›¶ä»¶åç§°'] || 'æœªçŸ¥æ–‡ä»¶',
              status: item.properties['Quote Status'] || 'Pending',
              amount: item.properties['Quoted Price'] || 0,
              time: item.properties._uuid ? new Date(parseInt(item.properties._uuid.split('-')[0])).toLocaleString('zh-CN') : new Date().toLocaleString('zh-CN'),
              cartItemKey: item.key,
              properties: item.properties
            });
          }
        });
        return orders.sort((a, b) => new Date(b.time) - new Date(a.time));
      } catch (error) {
        console.error('è·å–è®¢å•å¤±è´¥:', error);
        return [];
      }
    }
    
    // æ¸²æŸ“è®¢å•åˆ—è¡¨
    function renderOrders(orders) {
      // ä¿å­˜è®¢å•æ•°æ®åˆ°å…¨å±€å˜é‡ï¼Œä¾›å…¶ä»–å‡½æ•°ä½¿ç”¨
      window.currentOrders = orders;
      
      const ordersList = document.getElementById('orders-list');
      
      if (orders.length === 0) {
        ordersList.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">ğŸ“‹</div>
            <div>æš‚æ— è®¢å•æ•°æ®</div>
          </div>
        `;
        return;
      }
      
      ordersList.innerHTML = orders.map(order => `
        <div class="order-item">
          <div class="order-header">
            <div class="order-id">è®¢å• #${order.id.substring(0, 8)}</div>
            <div class="order-status status-${order.status.toLowerCase()}">
              ${getStatusText(order.status)}
            </div>
          </div>
          <div class="order-info">
            <div>
              <div class="order-customer">${order.customer}</div>
              <div>${order.email}</div>
            </div>
            <div>
              <div>${order.files}</div>
              <div class="order-time">${order.time}</div>
            </div>
          </div>
          <div class="order-actions">
            <button class="action-btn download" onclick="downloadOrderFile('${order.id}')" title="ä¸‹è½½æ–‡ä»¶">
              â¬‡ï¸
            </button>
            <button class="action-btn preview" onclick="previewOrderFile('${order.id}')" title="é¢„è§ˆæ–‡ä»¶">
              ğŸ‘ï¸
            </button>
            <button class="action-btn quote" onclick="openQuoteModal('${order.id}', '${order.customer}', '${order.email}', '${order.files}')" title="æ·»åŠ æŠ¥ä»·">
              ğŸ’°
            </button>
            <button class="action-btn guide" onclick="showCustomerGuide('${order.id}', '${order.email}')" title="å®¢æˆ·æ“ä½œæŒ‡å—">
              ğŸ“‹
            </button>
            <button class="action-btn delete" onclick="deleteQuote('${order.id}')" title="åˆ é™¤">
              ğŸ—‘ï¸
            </button>
          </div>
        </div>
      `).join('');
    }
    
    // è·å–çŠ¶æ€æ–‡æœ¬
    function getStatusText(status) {
      const statusMap = {
        'Pending': 'å¾…æŠ¥ä»·',
        'Quoted': 'å·²æŠ¥ä»·',
        'Completed': 'å·²å®Œæˆ'
      };
      return statusMap[status] || status;
    }
    
    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
    function updateStats(orders) {
      const totalOrders = orders.length;
      const pendingOrders = orders.filter(o => o.status === 'Pending').length;
      const quotedOrders = orders.filter(o => o.status === 'Quoted').length;
      const totalRevenue = orders
        .filter(o => o.amount > 0)
        .reduce((sum, o) => sum + parseFloat(o.amount), 0);
      
      document.getElementById('total-orders').textContent = totalOrders;
      document.getElementById('pending-orders').textContent = pendingOrders;
      document.getElementById('quoted-orders').textContent = quotedOrders;
      document.getElementById('total-revenue').textContent = `$${totalRevenue.toFixed(2)}`;
    }
    
    // åˆ·æ–°è®¢å•
    async function refreshOrders() {
      const orders = await fetchOrders();
      renderOrders(orders);
      updateStats(orders);
    }

    // æ·»åŠ åˆ·æ–°æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
    document.addEventListener('DOMContentLoaded', function() {
      const refreshBtn = document.getElementById('refresh-btn');
      if (refreshBtn) {
        refreshBtn.addEventListener('click', refreshOrders);
      }
    });
    
    // é€‰æ‹©è®¢å•
    function selectOrder(orderId) {
      // è¿™é‡Œå¯ä»¥æ·»åŠ è®¢å•è¯¦æƒ…æŸ¥çœ‹åŠŸèƒ½
      console.log('é€‰æ‹©è®¢å•:', orderId);
    }
    
    // ä»å¿«é€Ÿæ“ä½œæ‰“å¼€æŠ¥ä»·æ¨¡æ€æ¡†
    function openQuoteModalFromQuickAction() {
      const currentOrders = window.currentOrders || [];
      if (currentOrders.length === 0) {
        alert('æš‚æ— è®¢å•æ•°æ®');
        return;
      }
      
      // é€‰æ‹©ç¬¬ä¸€ä¸ªå¾…æŠ¥ä»·çš„è®¢å•ï¼Œæˆ–è€…ç¬¬ä¸€ä¸ªè®¢å•
      const pendingOrder = currentOrders.find(o => o.status === 'Pending') || currentOrders[0];
      if (pendingOrder) {
        openQuoteModal(pendingOrder.id);
      } else {
        alert('æ²¡æœ‰å¯æŠ¥ä»·çš„è®¢å•');
      }
    }

    // æ‰“å¼€æŠ¥ä»·æ¨¡æ€æ¡†
    function openQuoteModal(orderId, customer, email, files) {
      // å¦‚æœå‚æ•°ä¸ºç©ºï¼Œä»å½“å‰è®¢å•åˆ—è¡¨è·å–æ•°æ®
      if (!orderId) {
        alert('è¯·å…ˆé€‰æ‹©è¦æŠ¥ä»·çš„è®¢å•');
        return;
      }
      
      // ä»å½“å‰è®¢å•åˆ—è¡¨è·å–è¯¦ç»†ä¿¡æ¯
      const currentOrders = window.currentOrders || [];
      const order = currentOrders.find(o => o.id === orderId);
      
      if (order) {
        // ä» order å¯¹è±¡ä¸­æå–é‚®ç®±åœ°å€
        let extractedEmail = order.email || email || '';
        
        // å¦‚æœ order.email ä¸ºç©ºï¼Œå°è¯•ä» order.customer æˆ– order.properties ä¸­æå–
        if (!extractedEmail && order.properties && order.properties.fields) {
          const authorField = order.properties.fields.find(f => f.key === 'author');
          if (authorField && authorField.value && authorField.value.includes('@')) {
            const emailMatch = authorField.value.match(/([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/);
            if (emailMatch) {
              extractedEmail = emailMatch[1];
              console.log('ğŸ“§ åœ¨ openQuoteModal ä¸­æå–åˆ°é‚®ç®±:', extractedEmail);
            }
          }
        }
        
        document.getElementById('quote-order-id').value = order.id;
        document.getElementById('quote-email').value = extractedEmail;
        document.getElementById('quote-files').value = order.files || files || '';
        document.getElementById('quote-amount').value = '';
        document.getElementById('quote-note').value = '';
      } else {
        // ä½¿ç”¨ä¼ å…¥çš„å‚æ•°
        document.getElementById('quote-order-id').value = orderId;
        document.getElementById('quote-email').value = email || '';
        document.getElementById('quote-files').value = files || '';
        document.getElementById('quote-amount').value = '';
        document.getElementById('quote-note').value = '';
      }
      
      document.getElementById('quote-modal').style.display = 'block';
    }
    
    // å…³é—­æŠ¥ä»·æ¨¡æ€æ¡†
    function closeQuoteModal() {
      document.getElementById('quote-modal').style.display = 'none';
    }
    
    // æ˜¾ç¤ºå®¢æˆ·æ“ä½œæŒ‡å—
    function showCustomerGuide(orderId, email) {
      const guideContent = `
        <div style="padding: 20px; max-width: 500px;">
          <h3 style="margin-top: 0; color: #333;">å®¢æˆ·æ“ä½œæŒ‡å—</h3>
          
          <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
            <h4 style="margin: 0 0 12px 0; color: #333;">è®¢å•ä¿¡æ¯</h4>
            <div style="font-size: 14px; line-height: 1.5;">
              <div><strong>è®¢å•å·ï¼š</strong>${orderId}</div>
              <div><strong>å®¢æˆ·é‚®ç®±ï¼š</strong>${email}</div>
            </div>
          </div>
          
          <div style="background: #fff3e0; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
            <h4 style="margin: 0 0 12px 0; color: #333;">å®¢æˆ·éœ€è¦æ‰§è¡Œçš„æ“ä½œ</h4>
            <div style="font-size: 14px; line-height: 1.6;">
              <div style="margin-bottom: 8px;"><strong>1. é€šçŸ¥å®¢æˆ·</strong></div>
              <div style="margin-left: 16px; margin-bottom: 12px;">
                è¯·é€šè¿‡ä»¥ä¸‹æ–¹å¼è”ç³»å®¢æˆ·ï¼š<br>
                ğŸ“§ é‚®ç®±ï¼š${email}<br>
                ğŸ“± ç”µè¯æˆ–å…¶ä»–è”ç³»æ–¹å¼
              </div>
              
              <div style="margin-bottom: 8px;"><strong>2. å‘ŠçŸ¥å®¢æˆ·æ“ä½œæ­¥éª¤</strong></div>
              <div style="margin-left: 16px; margin-bottom: 12px;">
                â€¢ åˆ·æ–°è´­ç‰©è½¦é¡µé¢<br>
                â€¢ æŸ¥çœ‹æŠ¥ä»·çŠ¶æ€æ˜¯å¦æ›´æ–°<br>
                â€¢ å¦‚æœæœªæ›´æ–°ï¼Œé‡æ–°æäº¤è¯¢ä»·<br>
                â€¢ æˆ–ç›´æ¥è”ç³»å®¢æœç¡®è®¤
              </div>
              
              <div style="margin-bottom: 8px;"><strong>3. ç³»ç»Ÿé™åˆ¶è¯´æ˜</strong></div>
              <div style="margin-left: 16px; color: #666; font-size: 13px;">
                ç”±äºå®¢æˆ·å’Œå®¢æœä½¿ç”¨ä¸åŒçš„æµè§ˆå™¨ä¼šè¯ï¼Œè´­ç‰©è½¦çŠ¶æ€æ— æ³•è‡ªåŠ¨åŒæ­¥æ›´æ–°ã€‚
              </div>
            </div>
          </div>
          
          <div style="background: #e3f2fd; padding: 12px; border-radius: 6px; border-left: 4px solid #1976d2;">
            <p style="margin: 0; color: #1976d2; font-size: 14px;">
              <strong>å»ºè®®ï¼š</strong>å®ŒæˆæŠ¥ä»·åï¼Œä¸»åŠ¨è”ç³»å®¢æˆ·ç¡®è®¤å¹¶æŒ‡å¯¼æ“ä½œã€‚
            </p>
          </div>
        </div>
      `;
      
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
      `;
      
      modal.innerHTML = `
        <div style="
          background: white;
          border-radius: 12px;
          padding: 0;
          max-width: 600px;
          width: 90%;
          max-height: 80vh;
          overflow-y: auto;
          position: relative;
        ">
          <div style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
          ">
            <h3 style="margin: 0; color: #333;">å®¢æˆ·æ“ä½œæŒ‡å—</h3>
            <button onclick="this.closest('.guide-modal').remove()" style="
              background: none;
              border: none;
              font-size: 24px;
              cursor: pointer;
              color: #666;
            ">&times;</button>
          </div>
          <div>${guideContent}</div>
        </div>
      `;
      
      modal.className = 'guide-modal';
      document.body.appendChild(modal);
      
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          modal.remove();
        }
      });
    }
    
    // æ‰“å¼€æ–‡ä»¶ç®¡ç†
    function openFileManager() {
      window.open('/pages/admin-file-manager', '_blank');
    }
    
    // æ‰“å¼€å®¢æˆ·åˆ—è¡¨
    function openCustomerList() {
      alert('å®¢æˆ·åˆ—è¡¨åŠŸèƒ½å¼€å‘ä¸­...');
    }
    
    // å¯¼å‡ºæ•°æ®
    function exportData() {
      alert('æ•°æ®å¯¼å‡ºåŠŸèƒ½å¼€å‘ä¸­...');
    }
    
    // ä¸‹è½½è®¢å•æ–‡ä»¶
    async function downloadOrderFile(orderId) {
      try {
        console.log('å¼€å§‹ä¸‹è½½æ–‡ä»¶ï¼Œè®¢å•ID:', orderId);
        
        // ä»å½“å‰è®¢å•åˆ—è¡¨è·å–æ–‡ä»¶ä¿¡æ¯
        const currentOrders = await fetchOrders();
        const order = currentOrders.find(o => o.id === orderId);
        
        if (!order || !order.properties) {
          alert('æœªæ‰¾åˆ°è®¢å•ä¿¡æ¯');
          return;
        }
        
        // ä» Metaobject è·å–æ–‡ä»¶ä¿¡æ¯
        const field = (key) => {
          const f = (order.properties.fields || []).find(x => x.key === key);
          return f ? f.value : '';
        };
        
        const invoiceUrl = field('invoice_url');
        const fileName = field('text') || 'æœªçŸ¥æ–‡ä»¶';
        
        console.log('æ–‡ä»¶ä¿¡æ¯:', { invoiceUrl, fileName });
        console.log('å®Œæ•´è®¢å•ä¿¡æ¯:', order);
        
        // æ³¨æ„ï¼šç”±äº Metaobject å­—æ®µé™åˆ¶ï¼Œæ–‡ä»¶æ•°æ®å¯èƒ½æ— æ³•ç›´æ¥å­˜å‚¨
        // ä¼˜å…ˆå°è¯•ä»è´­ç‰©è½¦è·å–æ–‡ä»¶æ•°æ®
        
        if (invoiceUrl && (invoiceUrl.startsWith('http://') || invoiceUrl.startsWith('https://')) && !invoiceUrl.includes('placeholder.com')) {
          // æœ‰æ•ˆçš„ URLï¼Œç›´æ¥ä¸‹è½½
          console.log('ä½¿ç”¨ HTTP URL ä¸‹è½½:', invoiceUrl);
          const link = document.createElement('a');
          link.href = invoiceUrl;
          link.download = fileName;
          link.target = '_blank';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        } else if (invoiceUrl && invoiceUrl.includes('/api/download-file?id=')) {
          // Vercel æ–‡ä»¶ä¸‹è½½é“¾æ¥ï¼Œç›´æ¥æ‰“å¼€
          console.log('ä½¿ç”¨ Vercel æ–‡ä»¶ä¸‹è½½é“¾æ¥:', invoiceUrl);
          window.open(invoiceUrl, '_blank');
        } else if (invoiceUrl === 'data:stored') {
          // æ–‡ä»¶å·²å­˜å‚¨ä½†æ— æ³•ç›´æ¥ä¸‹è½½
          console.log('æ–‡ä»¶å·²å­˜å‚¨ä½†æ— æ³•ç›´æ¥ä¸‹è½½');
          alert(`æ–‡ä»¶å·²å­˜å‚¨ä½†æ— æ³•ç›´æ¥ä¸‹è½½\n\nåŸå› ï¼šç”±äºæŠ€æœ¯é™åˆ¶ï¼Œæ–‡ä»¶æ•°æ®æ— æ³•åœ¨å®¢æœç«¯ç›´æ¥è®¿é—®ã€‚\n\nè§£å†³æ–¹æ¡ˆï¼š\n1. è”ç³»å®¢æˆ·é‡æ–°ä¸Šä¼ æ–‡ä»¶\n2. æˆ–è¯·å®¢æˆ·é€šè¿‡é‚®ä»¶å‘é€æ–‡ä»¶\n3. æˆ–æŒ‡å¯¼å®¢æˆ·åœ¨è´­ç‰©è½¦é¡µé¢ä¸‹è½½æ–‡ä»¶åå‘é€ç»™æ‚¨\n\nè®¢å•ä¿¡æ¯ï¼š\n- æ–‡ä»¶åï¼š${fileName}\n- è®¢å•IDï¼š${orderId}`);
        } else if (invoiceUrl === 'data:upload_failed' || invoiceUrl === 'data:processing_error' || invoiceUrl === 'data:invalid_url') {
          // æ–‡ä»¶ä¸Šä¼ å¤±è´¥æˆ–å¤„ç†é”™è¯¯
          console.log('æ–‡ä»¶ä¸Šä¼ å¤±è´¥æˆ–å¤„ç†é”™è¯¯:', invoiceUrl);
          const statusText = {
            'data:upload_failed': 'æ–‡ä»¶ä¸Šä¼ å¤±è´¥',
            'data:processing_error': 'æ–‡ä»¶å¤„ç†å¼‚å¸¸',
            'data:invalid_url': 'æ–‡ä»¶URLæ— æ•ˆ'
          }[invoiceUrl] || 'æ–‡ä»¶çŠ¶æ€å¼‚å¸¸';
          alert(`æ–‡ä»¶ä¸‹è½½ä¸å¯ç”¨\n\nåŸå› ï¼š${statusText}ã€‚\n\nè§£å†³æ–¹æ¡ˆï¼š\n1. è”ç³»å®¢æˆ·é‡æ–°ä¸Šä¼ æ–‡ä»¶\n2. æˆ–è¯·å®¢æˆ·é€šè¿‡é‚®ä»¶å‘é€æ–‡ä»¶\n3. æˆ–æŒ‡å¯¼å®¢æˆ·åœ¨è´­ç‰©è½¦é¡µé¢ä¸‹è½½æ–‡ä»¶åå‘é€ç»™æ‚¨\n\nè®¢å•ä¿¡æ¯ï¼š\n- æ–‡ä»¶åï¼š${fileName}\n- è®¢å•IDï¼š${orderId}\n- çŠ¶æ€ï¼š${statusText}`);
        } else if (invoiceUrl === 'data:unavailable' || invoiceUrl.includes('placeholder.com')) {
          // æ–‡ä»¶æ•°æ®ä¸å¯ç”¨æˆ–ä¸ºå ä½ç¬¦
          console.log('æ–‡ä»¶æ•°æ®ä¸å¯ç”¨æˆ–ä¸ºå ä½ç¬¦:', invoiceUrl);
          alert(`æ–‡ä»¶ä¸‹è½½ä¸å¯ç”¨\n\nåŸå› ï¼šæ–‡ä»¶æ•°æ®æœªæ­£ç¡®å­˜å‚¨æˆ–ä¸ºå ä½ç¬¦é“¾æ¥ã€‚\n\nè§£å†³æ–¹æ¡ˆï¼š\n1. è”ç³»å®¢æˆ·é‡æ–°ä¸Šä¼ æ–‡ä»¶\n2. æˆ–è¯·å®¢æˆ·é€šè¿‡é‚®ä»¶å‘é€æ–‡ä»¶\n3. æˆ–æŒ‡å¯¼å®¢æˆ·åœ¨è´­ç‰©è½¦é¡µé¢ä¸‹è½½æ–‡ä»¶åå‘é€ç»™æ‚¨\n\nè®¢å•ä¿¡æ¯ï¼š\n- æ–‡ä»¶åï¼š${fileName}\n- è®¢å•IDï¼š${orderId}\n- å½“å‰é“¾æ¥ï¼š${invoiceUrl}`);
        } else {
          // å…¶ä»–æƒ…å†µï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
          console.log('æ–‡ä»¶æ•°æ®ä¸å¯ç”¨ï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯:', invoiceUrl);
          alert(`æ–‡ä»¶ä¸‹è½½ä¸å¯ç”¨\n\nåŸå› ï¼šå®¢æœå’Œå®¢æˆ·ä½¿ç”¨ä¸åŒçš„æµè§ˆå™¨ä¼šè¯ï¼Œæ— æ³•ç›´æ¥è®¿é—®å®¢æˆ·è´­ç‰©è½¦ä¸­çš„æ–‡ä»¶ã€‚\n\nè§£å†³æ–¹æ¡ˆï¼š\n1. è”ç³»å®¢æˆ·é‡æ–°ä¸Šä¼ æ–‡ä»¶\n2. æˆ–è¯·å®¢æˆ·é€šè¿‡é‚®ä»¶å‘é€æ–‡ä»¶\n3. æˆ–æŒ‡å¯¼å®¢æˆ·åœ¨è´­ç‰©è½¦é¡µé¢ä¸‹è½½æ–‡ä»¶åå‘é€ç»™æ‚¨\n\nè®¢å•ä¿¡æ¯ï¼š\n- æ–‡ä»¶åï¼š${fileName}\n- è®¢å•IDï¼š${orderId}\n- å½“å‰é“¾æ¥ï¼š${invoiceUrl}`);
        }
      } catch (error) {
        console.error('ä¸‹è½½æ–‡ä»¶å¤±è´¥:', error);
        alert('ä¸‹è½½æ–‡ä»¶å¤±è´¥: ' + error.message);
      }
    }
    
    // é¢„è§ˆè®¢å•æ–‡ä»¶
    async function previewOrderFile(orderId) {
      try {
        // ä»å½“å‰è®¢å•åˆ—è¡¨è·å–æ–‡ä»¶ä¿¡æ¯
        const currentOrders = await fetchOrders();
        const order = currentOrders.find(o => o.id === orderId);
        
        if (!order || !order.properties) {
          alert('æœªæ‰¾åˆ°è®¢å•ä¿¡æ¯');
          return;
        }
        
        // ä» Metaobject è·å–æ–‡ä»¶ä¿¡æ¯
        const field = (key) => {
          const f = (order.properties.fields || []).find(x => x.key === key);
          return f ? f.value : '';
        };
        
        const fileName = field('text') || 'æœªçŸ¥æ–‡ä»¶';
        const customer = field('author') || 'æœªçŸ¥å®¢æˆ·';
        
        // ä» author å­—æ®µæå–é‚®ç®±åœ°å€
        let email = '';
        const authorField = field('author') || '';
        console.log('ğŸ“§ åŸå§‹ author å­—æ®µ:', authorField);
        
        if (authorField.includes('@')) {
          // æå–é‚®ç®±åœ°å€ï¼ˆé€šå¸¸åœ¨æ‹¬å·å‰æˆ–å­—æ®µå¼€å§‹ï¼‰
          const emailMatch = authorField.match(/([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/);
          if (emailMatch) {
            email = emailMatch[1];
            console.log('âœ… æå–åˆ°é‚®ç®±åœ°å€:', email);
          } else {
            console.warn('âš ï¸ æœªæ‰¾åˆ°é‚®ç®±åœ°å€æ ¼å¼');
          }
        } else {
          console.warn('âš ï¸ author å­—æ®µä¸­æ²¡æœ‰ @ ç¬¦å·');
        }
        
        const status = field('status') || 'Pending';
        const price = field('price') || '';
        const uploadTime = order.time || new Date().toLocaleString('zh-CN');
        
        // ä» author å­—æ®µè§£æå‚æ•°ä¿¡æ¯ï¼ˆé‡ç”¨å·²å£°æ˜çš„ authorField å˜é‡ï¼‰
        let detailedParams = {
          quantity: '1',
          unit: 'ä»¶',
          material: 'æœªæŒ‡å®š',
          finish: 'æœªæŒ‡å®š',
          precision: 'æœªæŒ‡å®š',
          tolerance: 'æœªæŒ‡å®š',
          roughness: 'æœªæŒ‡å®š',
          hasThread: 'å¦',
          hasAssembly: 'å¦',
          scale: '100',
          note: 'æ— '
        };
        
        // å°è¯•ä» author å­—æ®µè§£æå‚æ•°
        if (authorField.includes('|')) {
          try {
            const parts = authorField.split('|');
            if (parts.length > 1) {
              const paramPart = parts[1].trim();
              const params = paramPart.split(' | ');
              
              params.forEach(param => {
                if (param.includes('æ•°é‡:')) {
                  const match = param.match(/æ•°é‡:(\d+)(\w+)/);
                  if (match) {
                    detailedParams.quantity = match[1];
                    detailedParams.unit = match[2];
                  }
                } else if (param.includes('ææ–™:')) {
                  detailedParams.material = param.replace('ææ–™:', '');
                } else if (param.includes('ç²¾åº¦:')) {
                  detailedParams.precision = param.replace('ç²¾åº¦:', '');
                } else if (param.includes('å…¬å·®:')) {
                  detailedParams.tolerance = param.replace('å…¬å·®:', '');
                } else if (param.includes('ç²—ç³™åº¦:')) {
                  detailedParams.roughness = param.replace('ç²—ç³™åº¦:', '');
                } else if (param.includes('èºçº¹:')) {
                  detailedParams.hasThread = param.replace('èºçº¹:', '');
                } else if (param.includes('è£…é…:')) {
                  detailedParams.hasAssembly = param.replace('è£…é…:', '');
                } else if (param.includes('ç¼©æ”¾:')) {
                  detailedParams.scale = param.replace('ç¼©æ”¾:', '').replace('%', '');
                } else if (param.includes('å¤‡æ³¨:')) {
                  detailedParams.note = param.replace('å¤‡æ³¨:', '');
                }
              });
            }
          } catch (parseError) {
            console.warn('è§£æå‚æ•°å¤±è´¥:', parseError);
          }
        }
        
        // å¦‚æœè§£æå¤±è´¥ï¼Œå°è¯•ä»è´­ç‰©è½¦è·å–ï¼ˆå…¼å®¹æ—§æ•°æ®ï¼‰
        if (detailedParams.material === 'æœªæŒ‡å®š') {
          try {
            const response = await fetch('/cart.js');
            const cart = await response.json();
            const cartItem = cart.items.find(item => 
              item.properties && item.properties._uuid === orderId
            );
            if (cartItem && cartItem.properties) {
              Object.assign(detailedParams, cartItem.properties);
            }
          } catch (cartError) {
            console.warn('ä»è´­ç‰©è½¦è·å–å‚æ•°å¤±è´¥:', cartError);
          }
        }
        
        // æ˜¾ç¤ºæ–‡ä»¶é¢„è§ˆä¿¡æ¯
        const previewContent = `
          <div style="padding: 20px;">
            <div style="text-align: center; margin-bottom: 20px;">
              <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“</div>
              <h3 style="margin: 0 0 8px 0;">${fileName}</h3>
              <p style="margin: 0; color: #666;">3Dæ¨¡å‹æ–‡ä»¶</p>
            </div>
            
            <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
              <h4 style="margin: 0 0 12px 0; color: #333;">è®¢å•ä¿¡æ¯</h4>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 14px;">
                <div><strong>è®¢å•ID:</strong> ${orderId}</div>
                <div><strong>å®¢æˆ·:</strong> ${customer}</div>
                <div><strong>é‚®ç®±:</strong> ${email}</div>
                <div><strong>çŠ¶æ€:</strong> ${getStatusText(status)}</div>
                <div><strong>ä¸Šä¼ æ—¶é—´:</strong> ${uploadTime}</div>
                ${price ? `<div><strong>æŠ¥ä»·:</strong> $${price}</div>` : ''}
              </div>
            </div>
            
            <div style="background: #fff3e0; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
              <h4 style="margin: 0 0 12px 0; color: #333;">åŠ å·¥å‚æ•°</h4>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 14px;">
                <div><strong>æ•°é‡:</strong> ${detailedParams.quantity || detailedParams['æ•°é‡'] || 1}</div>
                <div><strong>å•ä½:</strong> ${detailedParams.unit || detailedParams['å•ä½'] || 'ä»¶'}</div>
                <div><strong>ææ–™:</strong> ${detailedParams.material || detailedParams['ææ–™'] || 'æœªæŒ‡å®š'}</div>
                <div><strong>è¡¨é¢å¤„ç†:</strong> ${detailedParams.finish || detailedParams['é¢œè‰²ä¸è¡¨é¢'] || 'æœªæŒ‡å®š'}</div>
                <div><strong>ç²¾åº¦ç­‰çº§:</strong> ${detailedParams.precision || detailedParams['ç²¾åº¦ç­‰çº§'] || 'æœªæŒ‡å®š'}</div>
                <div><strong>å…¬å·®æ ‡å‡†:</strong> ${detailedParams.tolerance || detailedParams['å…¬å·®æ ‡å‡†'] || 'æœªæŒ‡å®š'}</div>
                <div><strong>è¡¨é¢ç²—ç³™åº¦:</strong> ${detailedParams.roughness || detailedParams['è¡¨é¢ç²—ç³™åº¦'] || 'æœªæŒ‡å®š'}</div>
                <div><strong>æ˜¯å¦æœ‰èºçº¹:</strong> ${detailedParams.hasThread || detailedParams['æ˜¯å¦æœ‰èºçº¹'] || 'å¦'}</div>
                <div><strong>è£…é…æ ‡è®°:</strong> ${detailedParams.hasAssembly || detailedParams['æ˜¯å¦æœ‰è£…é…æ ‡è®°'] || 'å¦'}</div>
                <div><strong>ç¼©æ”¾æ¯”ä¾‹:</strong> ${detailedParams.scale || detailedParams['ç¼©æ”¾æ¯”ä¾‹'] || 100}%</div>
                <div><strong>å¤‡æ³¨:</strong> ${detailedParams.note || detailedParams['å¤‡æ³¨'] || 'æ— '}</div>
              </div>
            </div>
            
            <div style="background: #e3f2fd; padding: 12px; border-radius: 6px; border-left: 4px solid #1976d2;">
              <p style="margin: 0; color: #1976d2; font-size: 14px;">
                <strong>æ³¨æ„ï¼š</strong>æ–‡ä»¶ä¿¡æ¯æ¥è‡ªæŠ¥ä»·ç³»ç»Ÿã€‚ç‚¹å‡»ä¸‹è½½æŒ‰é’®å¯ä»¥ä¸‹è½½å®é™…æ–‡ä»¶ã€‚
              </p>
            </div>
          </div>
        `;
        
        // åˆ›å»ºé¢„è§ˆæ¨¡æ€æ¡†
        const modal = document.createElement('div');
        modal.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0,0,0,0.5);
          z-index: 1000;
          display: flex;
          align-items: center;
          justify-content: center;
        `;
        
        modal.innerHTML = `
          <div style="
            background: white;
            border-radius: 12px;
            padding: 0;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
          ">
            <div style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              padding: 20px;
              border-bottom: 1px solid #e9ecef;
            ">
              <h3 style="margin: 0; color: #333;">æ–‡ä»¶é¢„è§ˆ</h3>
              <button onclick="this.closest('.modal').remove()" style="
                background: none;
                border: none;
                font-size: 24px;
                cursor: pointer;
                color: #666;
              ">&times;</button>
            </div>
            <div>${previewContent}</div>
          </div>
        `;
        
        modal.className = 'modal';
        document.body.appendChild(modal);
        
        // ç‚¹å‡»å¤–éƒ¨å…³é—­
        modal.addEventListener('click', function(e) {
          if (e.target === modal) {
            modal.remove();
          }
        });
        
      } catch (error) {
        console.error('é¢„è§ˆæ–‡ä»¶å¤±è´¥:', error);
        alert('é¢„è§ˆæ–‡ä»¶å¤±è´¥: ' + error.message);
      }
    }
    
    // å¤„ç†æŠ¥ä»·è¡¨å•æäº¤
    document.getElementById('quote-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const orderId = document.getElementById('quote-order-id').value;
      const customerEmail = document.getElementById('quote-email').value;
      const senderEmail = document.getElementById('quote-sender-email').value;
      const files = document.getElementById('quote-files').value;
      const amount = document.getElementById('quote-amount').value;
      const note = document.getElementById('quote-note').value;
      
      if (!amount || parseFloat(amount) <= 0) {
        alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æŠ¥ä»·é‡‘é¢');
        return;
      }
      
      if (!senderEmail || !senderEmail.includes('@')) {
        alert('è¯·è¾“å…¥æœ‰æ•ˆçš„å‘é€é‚®ç®±åœ°å€');
        document.getElementById('quote-sender-email').focus();
        return;
      }
      
      if (!customerEmail || !customerEmail.includes('@')) {
        alert('å®¢æˆ·é‚®ç®±åœ°å€æ— æ•ˆï¼Œæ— æ³•å‘é€é‚®ä»¶');
        return;
      }
      
      try {
        // æ˜¾ç¤ºæäº¤ä¸­çŠ¶æ€
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.textContent = 'æäº¤ä¸­...';
        
        // 1) æ›´æ–° Vercel åç«¯ï¼ˆMetaobjectï¼šquoteï¼‰
        let updateSuccess = false;
        try {
          const res = await fetch(`${QUOTES_API_BASE}/quotes?handle=${encodeURIComponent(orderId)}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
            body: JSON.stringify({ 
              status: 'Quoted', 
              price: String(amount)
            })
          });
          if (res.ok) {
            updateSuccess = true;
            console.log('åç«¯æ›´æ–°æˆåŠŸ');
          } else {
            console.warn('åç«¯æ›´æ–°å¤±è´¥:', await res.text());
          }
        } catch (err) {
          console.warn('åç«¯æ›´æ–°å¼‚å¸¸:', err);
        }

        // 2) è·³è¿‡è´­ç‰©è½¦æ›´æ–°ï¼ˆå®¢æœå’Œå®¢æˆ·ä½¿ç”¨ä¸åŒæµè§ˆå™¨ï¼‰
        let cartUpdateSuccess = false;
        console.log('è·³è¿‡è´­ç‰©è½¦æ›´æ–° - å®¢æœå’Œå®¢æˆ·ä½¿ç”¨ä¸åŒæµè§ˆå™¨ä¼šè¯');
        
        // 3) å‘é€æŠ¥ä»·é‚®ä»¶ç»™å®¢æˆ·
        let emailSuccess = false;
        if (customerEmail) {
          try {
            console.log('å¼€å§‹å‘é€é‚®ä»¶:', { from: senderEmail, to: customerEmail });
            await sendQuoteEmail(orderId, customerEmail, senderEmail, files, amount, note);
            emailSuccess = true;
            console.log('âœ… é‚®ä»¶å‘é€æˆåŠŸ');
          } catch (err) {
            console.warn('âŒ é‚®ä»¶å‘é€å¤±è´¥:', err);
          }
        } else {
          console.warn('âš ï¸ æ²¡æœ‰å®¢æˆ·é‚®ç®±åœ°å€ï¼Œè·³è¿‡é‚®ä»¶å‘é€');
        }
        
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
        
        // æ˜¾ç¤ºç»“æœ
        let message = 'æŠ¥ä»·å·²æäº¤ï¼\n\n';
        if (updateSuccess) message += 'âœ… åç«¯æ•°æ®åº“å·²æ›´æ–°\n';
        if (cartUpdateSuccess) message += 'âœ… è´­ç‰©è½¦çŠ¶æ€å·²æ›´æ–°\n';
        if (emailSuccess) message += 'âœ… é‚®ä»¶å†…å®¹å·²ç”Ÿæˆ\n';
        
        message += '\nğŸ“§ é‚®ä»¶å‘é€è¯´æ˜ï¼š\n';
        message += 'é‚®ä»¶å†…å®¹å·²ç”Ÿæˆï¼Œè¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤å‘é€ç»™å®¢æˆ·ï¼š\n\n';
        message += '1. ç‚¹å‡»"ğŸ“¤ æ‰“å¼€é‚®ä»¶å®¢æˆ·ç«¯"æŒ‰é’®\n';
        message += '2. åœ¨æ‰“å¼€çš„é‚®ä»¶å®¢æˆ·ç«¯ä¸­ç‚¹å‡»"å‘é€"\n';
        message += '3. æˆ–ç‚¹å‡»"ğŸ“‹ å¤åˆ¶é‚®ä»¶å†…å®¹"æ‰‹åŠ¨å‘é€\n\n';
        
        if (!cartUpdateSuccess) {
          message += 'âš ï¸ é‡è¦æç¤ºï¼š\n';
          message += 'ç”±äºå®¢æœå’Œå®¢æˆ·ä½¿ç”¨ä¸åŒçš„æµè§ˆå™¨ä¼šè¯ï¼Œ\n';
          message += 'æ— æ³•ç›´æ¥æ›´æ–°å®¢æˆ·è´­ç‰©è½¦çŠ¶æ€ã€‚è¯·å‘ŠçŸ¥å®¢æˆ·ï¼š\n\n';
          message += '1. åˆ·æ–°è´­ç‰©è½¦é¡µé¢æŸ¥çœ‹æŠ¥ä»·\n';
          message += '2. æˆ–é‡æ–°æäº¤è¯¢ä»·è·å–æœ€æ–°çŠ¶æ€\n';
          message += '3. æŸ¥çœ‹é‚®ä»¶ä¸­çš„æŠ¥ä»·è¯¦æƒ…\n';
          message += '4. å¦‚éœ€æ–‡ä»¶ï¼Œè¯·è”ç³»å®¢æˆ·é‡æ–°ä¸Šä¼ \n';
        }
        
        alert(message);
        closeQuoteModal();
        refreshOrders();
        
      } catch (error) {
        console.error('æäº¤æŠ¥ä»·å¤±è´¥:', error);
        alert('æäº¤æŠ¥ä»·å¤±è´¥: ' + error.message);
        
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        const submitBtn = this.querySelector('button[type="submit"]');
        submitBtn.disabled = false;
        submitBtn.textContent = 'å‘é€æŠ¥ä»·é‚®ä»¶';
      }
    });
    
    // å‘é€æŠ¥ä»·é‚®ä»¶
    async function sendQuoteEmail(orderId, customerEmail, senderEmail, files, amount, note) {
      try {
        console.log('ğŸ“§ è°ƒç”¨é‚®ä»¶APIï¼Œå‚æ•°:', { orderId, customerEmail, senderEmail, files, amount, note });
        
        // è°ƒç”¨é‚®ä»¶ API ç”Ÿæˆé‚®ä»¶å†…å®¹
        const response = await fetch(`${QUOTES_API_BASE}/send-email`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify({
            orderId: orderId,
            email: customerEmail,  // ä¿æŒå‘åå…¼å®¹
            customerEmail: customerEmail,
            senderEmail: senderEmail,
            files: files,
            amount: amount,
            note: note
          })
        });

        console.log('ğŸ“§ é‚®ä»¶APIå“åº”çŠ¶æ€:', response.status);

        if (response.ok) {
          const result = await response.json();
          console.log('âœ… é‚®ä»¶å†…å®¹ç”ŸæˆæˆåŠŸ:', result);
          
          // æ˜¾ç¤ºé‚®ä»¶å†…å®¹å¯¹è¯æ¡†ï¼Œè®©å®¢æœé€‰æ‹©å‘é€æ–¹å¼
          showEmailDialog(result);
          
          return result;
        } else {
          const errorText = await response.text();
          console.error('âŒ é‚®ä»¶APIå“åº”é”™è¯¯:', response.status, errorText);
          throw new Error(`é‚®ä»¶å†…å®¹ç”Ÿæˆå¤±è´¥: ${response.status}`);
        }
      } catch (error) {
        console.warn('âš ï¸ é‚®ä»¶ API è°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ:', error);
        
        // å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨å‘é€é‚®ç®±çš„ mailto
        const subject = `æŠ¥ä»·é€šçŸ¥ - è®¢å• #${orderId ? orderId.substring(0, 8) : 'N/A'}`;
        const body = `
å°Šæ•¬çš„å®¢æˆ·ï¼Œ

æ‚¨å¥½ï¼æ‚¨çš„å®šåˆ¶åŠ å·¥è¯¢ä»·å·²å®ŒæˆæŠ¥ä»·ï¼Œè¯¦æƒ…å¦‚ä¸‹ï¼š

ğŸ“‹ è®¢å•ä¿¡æ¯ï¼š
- è®¢å•å·ï¼š${orderId || 'N/A'}
- æ–‡ä»¶ï¼š${files || 'N/A'}
- æŠ¥ä»·é‡‘é¢ï¼š$${amount}
${note ? `- å¤‡æ³¨ï¼š${note}` : ''}

æ„Ÿè°¢æ‚¨é€‰æ‹©æˆ‘ä»¬çš„æœåŠ¡ï¼

æ­¤è‡´
å®šåˆ¶åŒ–åŠ å·¥æœåŠ¡å›¢é˜Ÿ
        `.trim();
        
        const mailtoUrl = `mailto:${customerEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        console.log('ğŸ“§ å¤‡ç”¨æ–¹æ¡ˆ - æ‰“å¼€é‚®ä»¶å®¢æˆ·ç«¯:', mailtoUrl);
        window.open(mailtoUrl, '_blank');
        
        console.log('âœ… å·²æ‰“å¼€é‚®ä»¶å®¢æˆ·ç«¯ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰');
      }
    }

    // æ˜¾ç¤ºé‚®ä»¶å†…å®¹å¯¹è¯æ¡†
    function showEmailDialog(emailResult) {
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
      `;

      modal.innerHTML = `
        <div style="
          background: white;
          border-radius: 12px;
          padding: 30px;
          max-width: 600px;
          max-height: 80vh;
          overflow-y: auto;
          box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        ">
          <h2 style="margin: 0 0 20px 0; color: #333; text-align: center;">ğŸ“§ æŠ¥ä»·é‚®ä»¶</h2>
          
          <div style="margin-bottom: 20px;">
            <strong>æ”¶ä»¶äººï¼š</strong> ${emailResult.email.to}
          </div>
          
          <div style="margin-bottom: 20px;">
            <strong>ä¸»é¢˜ï¼š</strong> ${emailResult.email.subject}
          </div>
          
          <div style="margin-bottom: 20px;">
            <strong>é‚®ä»¶å†…å®¹ï¼š</strong>
            <textarea readonly style="
              width: 100%;
              height: 200px;
              border: 1px solid #ddd;
              border-radius: 6px;
              padding: 12px;
              font-family: monospace;
              font-size: 12px;
              resize: vertical;
            ">${emailResult.email.textBody}</textarea>
          </div>
          
          <div style="text-align: center;">
            <button id="open-mail-btn" style="
              background: #007bff;
              color: white;
              border: none;
              padding: 12px 24px;
              border-radius: 6px;
              margin: 0 10px;
              cursor: pointer;
              font-size: 14px;
            ">ğŸ“¤ æ‰“å¼€é‚®ä»¶å®¢æˆ·ç«¯</button>
            
            <button id="copy-email-btn" style="
              background: #28a745;
              color: white;
              border: none;
              padding: 12px 24px;
              border-radius: 6px;
              margin: 0 10px;
              cursor: pointer;
              font-size: 14px;
            ">ğŸ“‹ å¤åˆ¶é‚®ä»¶å†…å®¹</button>
            
            <button onclick="this.closest('.email-modal').remove()" style="
              background: #6c757d;
              color: white;
              border: none;
              padding: 12px 24px;
              border-radius: 6px;
              margin: 0 10px;
              cursor: pointer;
              font-size: 14px;
            ">å…³é—­</button>
          </div>
        </div>
      `;

      modal.className = 'email-modal';
      document.body.appendChild(modal);

      // æ·»åŠ é‚®ä»¶å®¢æˆ·ç«¯æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
      const mailBtn = modal.querySelector('#open-mail-btn');
      mailBtn.addEventListener('click', () => {
        openMailClient(emailResult.mailto, emailResult.email);
      });

      // æ·»åŠ å¤åˆ¶æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
      const copyBtn = modal.querySelector('#copy-email-btn');
      copyBtn.addEventListener('click', () => {
        copyEmailToClipboard(emailResult.email.textBody);
      });

      // ç‚¹å‡»èƒŒæ™¯å…³é—­
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.remove();
        }
      });
    }

    // æ‰“å¼€é‚®ä»¶å®¢æˆ·ç«¯
    function openMailClient(mailtoUrl, emailData = null) {
      try {
        console.log('ğŸ“§ å°è¯•æ‰“å¼€é‚®ä»¶å®¢æˆ·ç«¯:', mailtoUrl);
        
        // å°è¯•æ‰“å¼€ mailto é“¾æ¥
        const mailWindow = window.open(mailtoUrl, '_blank');
        
        // æ£€æŸ¥æ˜¯å¦æˆåŠŸæ‰“å¼€
        setTimeout(() => {
          if (!mailWindow || mailWindow.closed || mailWindow.location.href === 'about:blank') {
            console.warn('âš ï¸ mailto é“¾æ¥å¯èƒ½æœªæˆåŠŸæ‰“å¼€é‚®ä»¶å®¢æˆ·ç«¯');
            
            const emailInfo = emailData ? 
              `ğŸ“§ é‚®ä»¶ä¿¡æ¯ï¼š
æ”¶ä»¶äººï¼š${emailData.to}
ä¸»é¢˜ï¼š${emailData.subject}` : 
              '';
              
            alert(`âš ï¸ æ— æ³•è‡ªåŠ¨æ‰“å¼€é‚®ä»¶å®¢æˆ·ç«¯ã€‚

ğŸ”§ è§£å†³æ–¹æ¡ˆï¼š
1. ç‚¹å‡»"ğŸ“‹ å¤åˆ¶é‚®ä»¶å†…å®¹"æŒ‰é’®
2. æ‰‹åŠ¨æ‰“å¼€æ‚¨çš„é‚®ä»¶å®¢æˆ·ç«¯ï¼ˆGmailã€Outlookç­‰ï¼‰
3. åˆ›å»ºæ–°é‚®ä»¶ï¼Œç²˜è´´å†…å®¹å¹¶å‘é€

${emailInfo}

æˆ–è€…æ‚¨å¯ä»¥å°è¯•é…ç½®æµè§ˆå™¨çš„é»˜è®¤é‚®ä»¶å®¢æˆ·ç«¯ã€‚`);
          } else {
            console.log('âœ… é‚®ä»¶å®¢æˆ·ç«¯å·²æ‰“å¼€');
            alert('âœ… é‚®ä»¶å®¢æˆ·ç«¯å·²æ‰“å¼€ï¼\n\nè¯·åœ¨æ‰“å¼€çš„é‚®ä»¶å®¢æˆ·ç«¯ä¸­ç‚¹å‡»"å‘é€"æŒ‰é’®ã€‚');
          }
        }, 1000);
        
      } catch (error) {
        console.error('âŒ æ‰“å¼€é‚®ä»¶å®¢æˆ·ç«¯å¤±è´¥:', error);
        alert('âŒ æ— æ³•æ‰“å¼€é‚®ä»¶å®¢æˆ·ç«¯ã€‚\n\nè¯·ä½¿ç”¨"å¤åˆ¶é‚®ä»¶å†…å®¹"åŠŸèƒ½ï¼Œç„¶åæ‰‹åŠ¨å‘é€é‚®ä»¶ã€‚');
      }
    }

    // å¤åˆ¶é‚®ä»¶å†…å®¹åˆ°å‰ªè´´æ¿
    function copyEmailToClipboard(text) {
      try {
        navigator.clipboard.writeText(text).then(() => {
          alert('âœ… é‚®ä»¶å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼\n\nè¯·æ‰“å¼€æ‚¨çš„é‚®ä»¶å®¢æˆ·ç«¯ï¼Œç²˜è´´å†…å®¹å¹¶å‘é€ç»™å®¢æˆ·ã€‚');
        }).catch(err => {
          console.error('å¤åˆ¶å¤±è´¥:', err);
          // å¤‡ç”¨æ–¹æ¡ˆï¼šåˆ›å»ºä¸´æ—¶æ–‡æœ¬åŒºåŸŸ
          const textArea = document.createElement('textarea');
          textArea.value = text;
          document.body.appendChild(textArea);
          textArea.select();
          document.execCommand('copy');
          document.body.removeChild(textArea);
          alert('âœ… é‚®ä»¶å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼\n\nè¯·æ‰“å¼€æ‚¨çš„é‚®ä»¶å®¢æˆ·ç«¯ï¼Œç²˜è´´å†…å®¹å¹¶å‘é€ç»™å®¢æˆ·ã€‚');
        });
      } catch (error) {
        console.error('âŒ å¤åˆ¶é‚®ä»¶å†…å®¹å¤±è´¥:', error);
        alert('âŒ å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©å¹¶å¤åˆ¶é‚®ä»¶å†…å®¹ã€‚');
      }
    }
    
    // åˆ é™¤åç«¯æŠ¥ä»·è®°å½•
    async function deleteQuote(handle) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¯¥æŠ¥ä»·è®°å½•å—ï¼Ÿ')) return;
      try {
        console.log('å¼€å§‹åˆ é™¤è®°å½•:', handle);
        
        // ä½¿ç”¨ DELETE æ–¹æ³•ï¼ˆåç«¯å·²æ”¯æŒéƒ¨åˆ†åŒ¹é…ï¼‰
        const res = await fetch(`${QUOTES_API_BASE}/quotes?handle=${encodeURIComponent(handle)}`, {
          method: 'DELETE',
          headers: { 
            'Accept': 'application/json' 
          }
        });
        
        console.log('DELETE å“åº”çŠ¶æ€:', res.status);
        
        if (!res.ok) {
          const t = await res.text();
          console.error('DELETE å¤±è´¥:', res.status, t);
          
          // å°è¯•è§£æé”™è¯¯ä¿¡æ¯
          let errorMsg = t;
          try {
            const errorObj = JSON.parse(t);
            errorMsg = errorObj.error || errorObj.message || t;
            
            // å¦‚æœæ˜¯éªŒè¯å¤±è´¥ï¼Œæ˜¾ç¤ºæ›´è¯¦ç»†çš„ä¿¡æ¯
            if (errorObj.expected && errorObj.actual) {
              errorMsg = `çŠ¶æ€æ›´æ–°éªŒè¯å¤±è´¥ï¼šæœŸæœ› ${errorObj.expected}ï¼Œå®é™… ${errorObj.actual}`;
            }
          } catch (e) {
            // ä¿æŒåŸå§‹é”™è¯¯ä¿¡æ¯
          }
          
          alert('åˆ é™¤å¤±è´¥ï¼š' + errorMsg);
          return;
        }
        
        const result = await res.text();
        console.log('åˆ é™¤æˆåŠŸ:', result);
        
        // å¼ºåˆ¶åˆ·æ–°è®¢å•åˆ—è¡¨
        console.log('å¼€å§‹åˆ·æ–°è®¢å•åˆ—è¡¨...');
        await refreshOrders();
        console.log('è®¢å•åˆ—è¡¨åˆ·æ–°å®Œæˆ');
        
        alert('åˆ é™¤æˆåŠŸï¼');
      } catch (e) {
        console.error('åˆ é™¤å¼‚å¸¸:', e);
        alert('åˆ é™¤å¤±è´¥ï¼š' + (e?.message || e));
      }
    }

    // æ›´æ–°è®¢å•çŠ¶æ€
    async function updateOrderStatus(orderId, status, amount) {
      try {
        // ä»è´­ç‰©è½¦è·å–è®¢å•é¡¹
        const response = await fetch('/cart.js');
        const cart = await response.json();
        
        // å°è¯•å¤šç§åŒ¹é…æ–¹å¼
        let item = cart.items.find(item => 
          item.properties && item.properties._uuid === orderId
        );
        
        // å¦‚æœæ²¡æ‰¾åˆ°ï¼Œå°è¯•å…¶ä»–å¯èƒ½çš„åŒ¹é…æ–¹å¼
        if (!item) {
          // å°è¯•åŒ¹é…è®¢å•IDçš„éƒ¨åˆ†
          const orderIdParts = orderId.split('-');
          const shortId = orderIdParts[orderIdParts.length - 1]; // è·å–æœ€åä¸€éƒ¨åˆ†
          
          item = cart.items.find(item => 
            item.properties && (
              item.properties['Order Type'] === '3D Model Quote' &&
              (item.properties['é›¶ä»¶åç§°'] === orderId || 
               item.properties['æ–‡ä»¶åç§°'] === orderId ||
               item.properties._uuid === orderId ||
               item.properties._uuid && item.properties._uuid.includes(shortId) ||
               item.key === orderId)
            )
          );
        }
        
        // å¦‚æœè¿˜æ˜¯æ²¡æ‰¾åˆ°ï¼Œå°è¯•åŒ¹é…æ–‡ä»¶å
        if (!item && cart.items.length > 0) {
          item = cart.items.find(item => 
            item.properties && 
            item.properties['Order Type'] === '3D Model Quote'
          );
        }
        
        if (!item) {
          console.warn('è´­ç‰©è½¦ä¸­æœªæ‰¾åˆ°å¯¹åº”è®¢å•ï¼Œå¯èƒ½å®¢æˆ·å·²æ¸…ç©ºè´­ç‰©è½¦');
          console.log('æŸ¥æ‰¾çš„è®¢å•ID:', orderId);
          console.log('è´­ç‰©è½¦ä¸­çš„é¡¹ç›®:', cart.items.map(i => ({
            key: i.key,
            properties: i.properties
          })));
          
          // æ˜¾ç¤ºè·¨æµè§ˆå™¨æç¤º
          console.log('æ³¨æ„ï¼šå®¢æœå’Œå®¢æˆ·ä½¿ç”¨ä¸åŒçš„æµè§ˆå™¨ä¼šè¯ï¼Œæ— æ³•ç›´æ¥æ›´æ–°å®¢æˆ·è´­ç‰©è½¦');
          return; // ä¸æŠ›å‡ºé”™è¯¯ï¼Œå› ä¸ºè¿™æ˜¯æ­£å¸¸æƒ…å†µ
        }
        
        console.log('æ‰¾åˆ°è´­ç‰©è½¦é¡¹ç›®:', item);
        
        // æ›´æ–°è®¢å•çŠ¶æ€
        const updateResponse = await fetch('/cart/update.js', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify({
            updates: {
              [item.key]: {
                properties: {
                  ...item.properties,
                  'Quote Status': status,
                  'Quoted Price': amount,
                  'Quote Completed': 'true',
                  'Quote Date': new Date().toISOString()
                }
              }
            }
          })
        });
        
        if (!updateResponse.ok) {
          const errorText = await updateResponse.text();
          throw new Error(`æ›´æ–°è®¢å•çŠ¶æ€å¤±è´¥: ${errorText}`);
        }
        
        console.log('è´­ç‰©è½¦çŠ¶æ€æ›´æ–°æˆåŠŸ');
        
      } catch (error) {
        console.error('æ›´æ–°è®¢å•çŠ¶æ€å¤±è´¥:', error);
        throw error;
      }
    }

    // é¡µé¢åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
      if (checkAuth()) {
        refreshOrders();
      }
    });
  </script>
</body>
</html>
