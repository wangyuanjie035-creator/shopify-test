{% comment %}
  æµ‹è¯•åˆ›å»ºè®¢å•é¡µé¢
  ç”¨äºå¿«é€Ÿåˆ›å»ºæµ‹è¯•è‰ç¨¿è®¢å•ï¼ŒéªŒè¯ç³»ç»ŸåŠŸèƒ½
{% endcomment %}

<style>
  .test-container {
    max-width: 600px;
    margin: 40px auto;
    padding: 20px;
    font-family: system-ui, -apple-system, sans-serif;
  }
  
  .test-form {
    background: white;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  }
  
  .form-group {
    margin-bottom: 20px;
  }
  
  .form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: #333;
  }
  
  .form-group input,
  .form-group textarea,
  .form-group select {
    width: 100%;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 14px;
  }
  
  .form-group textarea {
    height: 80px;
    resize: vertical;
  }
  
  .btn {
    padding: 14px 28px;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 500;
    cursor: pointer;
    border: none;
    transition: all 0.3s ease;
  }
  
  .btn-primary {
    background: #e91e63;
    color: white;
  }
  
  .btn-primary:hover {
    background: #c2185b;
  }
  
  .btn-primary:disabled {
    background: #ccc;
    cursor: not-allowed;
  }
  
  .result {
    margin-top: 20px;
    padding: 20px;
    border-radius: 8px;
    display: none;
  }
  
  .result.success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
  }
  
  .result.error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
  }
  
  .loading {
    text-align: center;
    padding: 20px;
  }
  
  .loading-spinner {
    width: 32px;
    height: 32px;
    border: 3px solid #f0f0f0;
    border-top: 3px solid #e91e63;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 16px;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
</style>

<div class="test-container">
  <div class="test-form">
    <h1 style="margin-top: 0; color: #333;">ğŸ§ª åˆ›å»ºæµ‹è¯•è‰ç¨¿è®¢å•</h1>
    <p style="color: #666; margin-bottom: 30px;">æ­¤é¡µé¢ç”¨äºå¿«é€Ÿåˆ›å»ºæµ‹è¯•è®¢å•ï¼ŒéªŒè¯ç³»ç»ŸåŠŸèƒ½æ˜¯å¦æ­£å¸¸ã€‚</p>
    
    <form id="test-form">
      <div class="form-group">
        <label for="customerName">å®¢æˆ·å§“å:</label>
        <input type="text" id="customerName" value="å¼ ä¸‰" required>
      </div>
      
      <div class="form-group">
        <label for="customerEmail">å®¢æˆ·é‚®ç®±:</label>
        <input type="email" id="customerEmail" value="zhangsan@example.com" required>
      </div>
      
      <div class="form-group">
        <label for="fileName">æ–‡ä»¶å:</label>
        <input type="text" id="fileName" value="test-part.stp" required>
      </div>
      
      <div class="form-group">
        <label for="quantity">æ•°é‡:</label>
        <input type="number" id="quantity" value="1" min="1" required>
      </div>
      
      <div class="form-group">
        <label for="material">ææ–™:</label>
        <select id="material">
          <option value="PLA">PLA</option>
          <option value="ABS">ABS</option>
          <option value="PETG">PETG</option>
          <option value="TPU">TPU</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="finish">è¡¨é¢å¤„ç†:</label>
        <select id="finish">
          <option value="è‡ªç„¶è‰²">è‡ªç„¶è‰²</option>
          <option value="æŠ›å…‰">æŠ›å…‰</option>
          <option value="å–·æ¼†">å–·æ¼†</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="precision">ç²¾åº¦ç­‰çº§:</label>
        <select id="precision">
          <option value="æ ‡å‡† (Â±0.1mm)">æ ‡å‡† (Â±0.1mm)</option>
          <option value="é«˜ç²¾åº¦ (Â±0.05mm)">é«˜ç²¾åº¦ (Â±0.05mm)</option>
          <option value="è¶…é«˜ç²¾åº¦ (Â±0.02mm)">è¶…é«˜ç²¾åº¦ (Â±0.02mm)</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="note">å¤‡æ³¨:</label>
        <textarea id="note" placeholder="è¯·è¾“å…¥å¤‡æ³¨ä¿¡æ¯...">è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•è®¢å•ï¼Œç”¨äºéªŒè¯ç³»ç»ŸåŠŸèƒ½ã€‚</textarea>
      </div>
      
      <button type="submit" class="btn btn-primary" id="submit-btn">
        åˆ›å»ºæµ‹è¯•è®¢å•
      </button>
    </form>
    
    <div id="loading" class="loading" style="display: none;">
      <div class="loading-spinner"></div>
      <p>æ­£åœ¨åˆ›å»ºæµ‹è¯•è®¢å•...</p>
    </div>
    
    <div id="result" class="result">
      <p id="result-message"></p>
      <a id="view-order-link" href="#" style="display: none; color: #e91e63; text-decoration: none; font-weight: 500;">
        æŸ¥çœ‹è®¢å•è¯¦æƒ… â†’
      </a>
    </div>
  </div>
</div>

<script>
const API_BASE = 'https://shopify-13s4.vercel.app/api';

document.getElementById('test-form').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const submitBtn = document.getElementById('submit-btn');
  const loading = document.getElementById('loading');
  const result = document.getElementById('result');
  const resultMessage = document.getElementById('result-message');
  const viewOrderLink = document.getElementById('view-order-link');
  
  // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
  submitBtn.disabled = true;
  loading.style.display = 'block';
  result.style.display = 'none';
  
  try {
    // æ”¶é›†è¡¨å•æ•°æ®
    const formData = {
      customerName: document.getElementById('customerName').value,
      customerEmail: document.getElementById('customerEmail').value,
      fileName: document.getElementById('fileName').value,
      quantity: document.getElementById('quantity').value,
      material: document.getElementById('material').value,
      finish: document.getElementById('finish').value,
      precision: document.getElementById('precision').value,
      note: document.getElementById('note').value
    };
    
    console.log('æäº¤æµ‹è¯•æ•°æ®:', formData);
    
    // è°ƒç”¨APIåˆ›å»ºæµ‹è¯•è®¢å•
    const response = await fetch(`${API_BASE}/create-test-draft-order`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(formData)
    });
    
    const data = await response.json();
    console.log('APIå“åº”:', data);
    
    if (data.success) {
      // æˆåŠŸ
      result.className = 'result success';
      resultMessage.textContent = `âœ… ${data.message}`;
      
      if (data.redirectUrl) {
        viewOrderLink.href = data.redirectUrl;
        viewOrderLink.style.display = 'inline';
      }
      
      // 3ç§’åè‡ªåŠ¨è·³è½¬
      if (data.redirectUrl) {
        setTimeout(() => {
          window.location.href = data.redirectUrl;
        }, 3000);
      }
    } else {
      // å¤±è´¥
      result.className = 'result error';
      resultMessage.textContent = `âŒ ${data.message || 'åˆ›å»ºå¤±è´¥'}`;
    }
    
    result.style.display = 'block';
    
  } catch (error) {
    console.error('åˆ›å»ºæµ‹è¯•è®¢å•å¤±è´¥:', error);
    
    result.className = 'result error';
    resultMessage.textContent = `âŒ åˆ›å»ºå¤±è´¥: ${error.message}`;
    result.style.display = 'block';
  } finally {
    // éšè—åŠ è½½çŠ¶æ€
    submitBtn.disabled = false;
    loading.style.display = 'none';
  }
});
</script>
