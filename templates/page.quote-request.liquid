<!--
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  è¯¢ä»·è¯·æ±‚é¡µé¢ - å®Œæ•´ç‰ˆï¼ˆç±»ä¼¼å›¾2æ ·å¼ï¼‰
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  åŠŸèƒ½ï¼š
  1. 3D æ¨¡å‹ä¸Šä¼ å’Œé¢„è§ˆ
  2. å®Œæ•´çš„é…ç½®é€‰é¡¹ï¼ˆæè´¨ã€é¢œè‰²ã€ç²¾åº¦ç­‰ï¼‰
  3. æäº¤è¯¢ä»·ï¼ˆè°ƒç”¨æ–°çš„ submit-quote APIï¼‰
  4. è·³è½¬åˆ°"æˆ‘çš„è¯¢ä»·"é¡µé¢æŸ¥çœ‹çŠ¶æ€
-->

<div class="quote-request-container">
  <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
  <div class="main-content">
    
    <!-- å·¦ä¾§ï¼š3D æ¨¡å‹ä¸Šä¼ å’Œé¢„è§ˆ -->
    <div class="upload-section">
      <h2>ğŸ“ ä¸Šä¼  3D æ¨¡å‹</h2>
      
      <!-- 3D é¢„è§ˆåŒºåŸŸ -->
      <div class="model-viewer-container">
        <div id="model-viewer" class="model-viewer">
          <div class="viewer-placeholder">
            <div class="viewer-icon">ğŸ¯</div>
            <p>ä¸Šä¼ æ–‡ä»¶åå°†æ˜¾ç¤º 3D æ¨¡å‹é¢„è§ˆ</p>
          </div>
        </div>
        
        <!-- é¢„è§ˆå·¥å…·æŒ‰é’® -->
        <div class="viewer-tools">
          <button class="tool-btn" title="æŸ¥çœ‹è§†å›¾">
            <span class="icon">ğŸ‘ï¸</span>
            <span class="text">æŸ¥çœ‹è§†å›¾</span>
          </button>
          <button class="tool-btn" title="æµ‹é‡">
            <span class="icon">ğŸ“</span>
            <span class="text">æµ‹é‡</span>
          </button>
          <button class="tool-btn" title="æ ‡æ³¨">
            <span class="icon">âœï¸</span>
            <span class="text">æ ‡æ³¨</span>
          </button>
          <button class="tool-btn" title="å¯¼å‡º">
            <span class="icon">ğŸ“¤</span>
            <span class="text">å¯¼å‡º</span>
          </button>
        </div>
      </div>
      
      <!-- ä¸Šä¼ åŒºåŸŸ -->
      <div class="upload-area" id="dropzone">
        <div class="upload-info">
          <div class="upload-icon">ğŸ“</div>
          <h3>ä¸Šä¼ æ‚¨çš„3Dæ¨¡å‹</h3>
          <p class="supported-formats">æ”¯æŒæ ¼å¼: STP / STEP æ–‡ä»¶, ä»¥åŠå¯¹åº”çš„2Då›¾çº¸ (DWG / DXF / PDF)</p>
          <p class="file-limit">å•æ¬¡ä¸Šä¼ æ–‡ä»¶â‰¤20ä¸ª, å•ä¸ªæ–‡ä»¶å¤§å°<100M</p>
        </div>
        <input type="file" id="file-input" accept=".step,.stp,.stl,.obj,.3ds,.fbx,.dae,.gltf,.glb,.dwg,.dxf,.pdf" style="display: none;" multiple>
        <button type="button" class="upload-btn" onclick="document.getElementById('file-input').click()">
          é€‰æ‹©æ–‡ä»¶
        </button>
      </div>
      
      <!-- æ–‡ä»¶é¢„è§ˆ -->
      <div id="file-preview" class="file-preview" style="display: none;">
        <h3>å·²é€‰æ‹©çš„æ–‡ä»¶</h3>
        <div id="file-list"></div>
      </div>
    </div>
    
    <!-- å³ä¾§ï¼šé…ç½®é€‰é¡¹ -->
    <div class="config-section">
      <h2>âš™ï¸ é…ç½®é€‰é¡¹</h2>
      
      <form id="quote-form" class="config-form">
        
        <!-- å•ä½é€‰æ‹© -->
        <div class="form-group">
          <label>å•ä½</label>
          <div class="radio-group">
            <label class="radio-item">
              <input type="radio" name="unit" value="mm" checked>
              <span class="radio-text">æ¯«ç±³ (mm)</span>
            </label>
            <label class="radio-item">
              <input type="radio" name="unit" value="in">
              <span class="radio-text">è‹±å¯¸ (in)</span>
            </label>
          </div>
        </div>
        
        <!-- æè´¨é€‰æ‹© -->
        <div class="form-group">
          <label for="material">æè´¨ *</label>
          <select id="material" name="material" required>
            <option value="">è¯·é€‰æ‹©æè´¨</option>
            <option value="PLA">PLA</option>
            <option value="ABS" selected>ABS</option>
            <option value="PETG">PETG</option>
            <option value="å°¼é¾™">å°¼é¾™</option>
            <option value="æ ‘è„‚">æ ‘è„‚</option>
            <option value="é‡‘å±">é‡‘å±</option>
            <option value="å…¶ä»–">å…¶ä»–</option>
          </select>
        </div>
        
        <!-- é¢œè‰²å’Œè¡¨é¢ -->
        <div class="form-group">
          <label for="color">é¢œè‰²å’Œè¡¨é¢</label>
          <select id="color" name="color">
            <option value="è‡ªç„¶è‰²" selected>è‡ªç„¶è‰²</option>
            <option value="ç™½è‰²">ç™½è‰²</option>
            <option value="é»‘è‰²">é»‘è‰²</option>
            <option value="é€æ˜">é€æ˜</option>
            <option value="å…¶ä»–">å…¶ä»–</option>
          </select>
        </div>
        
        <!-- ç²¾åº¦ç­‰çº§ -->
        <div class="form-group">
          <label for="precision">ç²¾åº¦ç­‰çº§</label>
          <select id="precision" name="precision">
            <option value="æ ‡å‡† (Â±0.1mm)" selected>æ ‡å‡† (Â±0.1mm)</option>
            <option value="é«˜ç²¾åº¦ (Â±0.05mm)">é«˜ç²¾åº¦ (Â±0.05mm)</option>
            <option value="è¶…é«˜ç²¾åº¦ (Â±0.02mm)">è¶…é«˜ç²¾åº¦ (Â±0.02mm)</option>
          </select>
        </div>
        
        <!-- å…¬å·®æ ‡å‡† -->
        <div class="form-group">
          <label for="tolerance">å…¬å·®æ ‡å‡†</label>
          <select id="tolerance" name="tolerance">
            <option value="GB/T 1804-2000 mçº§" selected>GB/T 1804-2000 mçº§</option>
            <option value="GB/T 1804-2000 fçº§">GB/T 1804-2000 fçº§</option>
            <option value="GB/T 1804-2000 cçº§">GB/T 1804-2000 cçº§</option>
          </select>
        </div>
        
        <!-- æœ€å°ç²—ç³™åº¦ -->
        <div class="form-group">
          <label for="roughness">æœ€å°ç²—ç³™åº¦</label>
          <select id="roughness" name="roughness">
            <option value="Ra3.2" selected>Ra3.2</option>
            <option value="Ra1.6">Ra1.6</option>
            <option value="Ra0.8">Ra0.8</option>
            <option value="Ra0.4">Ra0.4</option>
          </select>
        </div>
        
        <!-- èºçº¹ -->
        <div class="form-group">
          <label>æœ‰èºçº¹ï¼Ÿ</label>
          <div class="radio-group">
            <label class="radio-item">
              <input type="radio" name="hasThread" value="yes">
              <span class="radio-text">æ˜¯</span>
            </label>
            <label class="radio-item">
              <input type="radio" name="hasThread" value="no" checked>
              <span class="radio-text">å¦</span>
            </label>
          </div>
        </div>
        
        <!-- è£…é…æ ‡è®° -->
        <div class="form-group">
          <label>æœ‰è£…é…æ ‡è®°ï¼Ÿ</label>
          <div class="radio-group">
            <label class="radio-item">
              <input type="radio" name="hasAssembly" value="yes">
              <span class="radio-text">æ˜¯</span>
            </label>
            <label class="radio-item">
              <input type="radio" name="hasAssembly" value="no" checked>
              <span class="radio-text">å¦</span>
            </label>
          </div>
        </div>
        
        <!-- ç¼©æ”¾ -->
        <div class="form-group">
          <label for="scale">ç¼©æ”¾: <span id="scale-value">100%</span></label>
          <input type="range" id="scale" name="scale" min="10" max="500" value="100" class="slider">
        </div>
        
        <!-- æ•°é‡ -->
        <div class="form-group">
          <label for="quantity">æ•°é‡ *</label>
          <div class="quantity-input">
            <button type="button" class="qty-btn" onclick="changeQuantity(-1)">-</button>
            <input type="number" id="quantity" name="quantity" min="1" value="1" required>
            <button type="button" class="qty-btn" onclick="changeQuantity(1)">+</button>
          </div>
        </div>
        
        <!-- å®¢æˆ·ä¿¡æ¯ -->
        <div class="form-group">
          <label for="customer-name">æ‚¨çš„å§“å</label>
          <input type="text" id="customer-name" name="customer-name" placeholder="è¯·è¾“å…¥æ‚¨çš„å§“å">
        </div>
        
        <div class="form-group">
          <label for="customer-email">è”ç³»é‚®ç®± *</label>
          <input type="email" id="customer-email" name="customer-email" placeholder="ç”¨äºæ¥æ”¶æŠ¥ä»·é€šçŸ¥" required>
          <span class="hint">æˆ‘ä»¬å°†é€šè¿‡é‚®ç®±é€šçŸ¥æ‚¨æŠ¥ä»·ç»“æœ</span>
        </div>
        
        <!-- å¤‡æ³¨ -->
        <div class="form-group">
          <label for="note">å¤‡æ³¨</label>
          <textarea id="note" name="note" rows="4" placeholder="è¯·è¾“å…¥ç‰¹æ®Šè¦æ±‚æˆ–å¤‡æ³¨ä¿¡æ¯..." maxlength="200"></textarea>
          <div class="char-count">
            <span id="char-count">0</span>/200
          </div>
        </div>
        
      </form>
    </div>
  </div>
  
  <!-- åº•éƒ¨åŒºåŸŸ -->
  <div class="bottom-section">
    
    <!-- é‡è¦æé†’ -->
    <div class="warning-box">
      <div class="warning-icon">âš ï¸</div>
      <div class="warning-text">
        é‡è¦æé†’: å¦‚æœæ‚¨çš„3Dæ¨¡å‹åŒ…å«èºçº¹æˆ–è£…é…æ ‡è®°, è¯·ç¡®ä¿ä¸ºæ¯ä¸ª3Dæ–‡ä»¶ä¸Šä¼ å¯¹åº”çš„2Då›¾çº¸æ–‡ä»¶ (DWG/DXF/PDF), ä»¥ä¾¿æˆ‘ä»¬æä¾›å‡†ç¡®çš„åŠ å·¥æŠ¥ä»·ã€‚
      </div>
    </div>
    
    <!-- æäº¤æŒ‰é’® -->
    <div class="submit-section">
      <button type="button" id="submit-btn" class="submit-btn" onclick="submitQuote()" disabled>
        <span id="btn-text">ç«‹å³è¯¢ä»·</span>
        <span id="btn-loading" style="display: none;">
          <span class="spinner"></span> æäº¤ä¸­...
        </span>
      </button>
      
      <!-- äº¤ä»˜å’Œè´¨é‡ä¿¡æ¯ -->
      <div class="info-cards">
        <div class="info-card">
          <span class="info-icon">â°</span>
          <span class="info-text">é¢„è®¡äº¤ä»˜: 3-5ä¸ªå·¥ä½œæ—¥</span>
        </div>
        <div class="info-card">
          <span class="info-icon">âœ…</span>
          <span class="info-text">è´¨é‡ä¿è¯: 100%åˆæ ¼</span>
        </div>
      </div>
    </div>
  </div>
  
  <!-- æˆåŠŸæ¶ˆæ¯ -->
  <div id="success-message" class="success-message" style="display: none;">
    <div class="success-icon">
      <div class="checkmark">
        <div class="checkmark-stem"></div>
        <div class="checkmark-kick"></div>
      </div>
    </div>
    <h3>è¯¢ä»·æäº¤æˆåŠŸï¼</h3>
    <p id="success-text"></p>
    <div class="success-actions">
      <button class="btn-primary" onclick="viewQuote()">æŸ¥çœ‹è¯¢ä»·å•</button>
      <button class="btn-secondary" onclick="closeSuccessMessage()">ç»§ç»­è¯¢ä»·</button>
    </div>
  </div>
  
  <!-- é”™è¯¯æ¶ˆæ¯ -->
  <div id="error-message" class="error-message" style="display: none;">
    <div class="error-icon">âŒ</div>
    <h3>æäº¤å¤±è´¥</h3>
    <p id="error-text"></p>
    <button class="btn-secondary" onclick="hideError()">å…³é—­</button>
  </div>
</div>

<style>
  .quote-request-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: #f8f9fa;
    min-height: 100vh;
  }
  
  .main-content {
    display: grid;
    grid-template-columns: 1fr 400px;
    gap: 30px;
    margin-bottom: 30px;
  }
  
  /* å·¦ä¾§ä¸Šä¼ åŒºåŸŸ */
  .upload-section {
    background: white;
    border-radius: 12px;
    padding: 25px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  
  .upload-section h2 {
    margin: 0 0 20px 0;
    font-size: 20px;
    color: #333;
  }
  
  /* 3D é¢„è§ˆåŒºåŸŸ */
  .model-viewer-container {
    position: relative;
    margin-bottom: 25px;
  }
  
  .model-viewer {
    width: 100%;
    height: 400px;
    background: #f5f5f5;
    border: 2px dashed #ddd;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
  }
  
  .viewer-placeholder {
    text-align: center;
    color: #666;
  }
  
  .viewer-icon {
    font-size: 48px;
    margin-bottom: 10px;
  }
  
  .viewer-tools {
    position: absolute;
    top: 10px;
    right: 10px;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  
  .tool-btn {
    background: white;
    border: 1px solid #ddd;
    border-radius: 6px;
    padding: 8px 12px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    transition: all 0.3s;
  }
  
  .tool-btn:hover {
    background: #f0f0f0;
  }
  
  .tool-btn .icon {
    font-size: 14px;
  }
  
  /* ä¸Šä¼ åŒºåŸŸ */
  .upload-area {
    border: 2px dashed #ddd;
    border-radius: 12px;
    padding: 40px 20px;
    text-align: center;
    background: #fafafa;
    transition: all 0.3s;
  }
  
  .upload-area:hover {
    border-color: #667eea;
    background: #f0f0ff;
  }
  
  .upload-area.dragover {
    border-color: #667eea;
    background: #e6e6ff;
  }
  
  .upload-icon {
    font-size: 48px;
    margin-bottom: 15px;
  }
  
  .upload-area h3 {
    margin: 0 0 10px 0;
    font-size: 18px;
    color: #333;
  }
  
  .supported-formats {
    margin: 5px 0;
    color: #666;
    font-size: 14px;
  }
  
  .file-limit {
    margin: 5px 0 20px 0;
    color: #999;
    font-size: 12px;
  }
  
  .upload-btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 8px;
    padding: 12px 30px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
  }
  
  .upload-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
  }
  
  /* æ–‡ä»¶é¢„è§ˆ */
  .file-preview {
    margin-top: 20px;
  }
  
  .file-preview h3 {
    margin: 0 0 15px 0;
    font-size: 16px;
    color: #333;
  }
  
  #file-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  
  .file-item {
    display: flex;
    align-items: center;
    padding: 12px;
    background: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #e0e0e0;
  }
  
  .file-icon {
    font-size: 24px;
    margin-right: 12px;
  }
  
  .file-info {
    flex: 1;
  }
  
  .file-name {
    font-weight: 600;
    color: #333;
    margin-bottom: 4px;
  }
  
  .file-size {
    color: #666;
    font-size: 12px;
  }
  
  .remove-file {
    background: #f44336;
    color: white;
    border: none;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    cursor: pointer;
    font-size: 14px;
  }
  
  /* å³ä¾§é…ç½®åŒºåŸŸ */
  .config-section {
    background: white;
    border-radius: 12px;
    padding: 25px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    height: fit-content;
  }
  
  .config-section h2 {
    margin: 0 0 20px 0;
    font-size: 20px;
    color: #333;
  }
  
  .config-form {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }
  
  .form-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  
  .form-group label {
    font-weight: 600;
    color: #333;
    font-size: 14px;
  }
  
  .form-group input,
  .form-group select,
  .form-group textarea {
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 14px;
    font-family: inherit;
  }
  
  .form-group input:focus,
  .form-group select:focus,
  .form-group textarea:focus {
    outline: none;
    border-color: #667eea;
  }
  
  /* å•é€‰æŒ‰é’®ç»„ */
  .radio-group {
    display: flex;
    gap: 15px;
  }
  
  .radio-item {
    display: flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
  }
  
  .radio-item input[type="radio"] {
    margin: 0;
  }
  
  .radio-text {
    font-weight: normal;
  }
  
  /* æ•°é‡è¾“å…¥ */
  .quantity-input {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .qty-btn {
    width: 32px;
    height: 32px;
    border: 1px solid #ddd;
    background: white;
    border-radius: 4px;
    cursor: pointer;
    font-size: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .qty-btn:hover {
    background: #f0f0f0;
  }
  
  .quantity-input input {
    width: 80px;
    text-align: center;
  }
  
  /* æ»‘å— */
  .slider {
    width: 100%;
    height: 6px;
    background: #ddd;
    border-radius: 3px;
    outline: none;
    -webkit-appearance: none;
  }
  
  .slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 20px;
    height: 20px;
    background: #667eea;
    border-radius: 50%;
    cursor: pointer;
  }
  
  .slider::-moz-range-thumb {
    width: 20px;
    height: 20px;
    background: #667eea;
    border-radius: 50%;
    cursor: pointer;
    border: none;
  }
  
  /* å­—ç¬¦è®¡æ•° */
  .char-count {
    text-align: right;
    font-size: 12px;
    color: #666;
  }
  
  .hint {
    font-size: 12px;
    color: #666;
  }
  
  /* åº•éƒ¨åŒºåŸŸ */
  .bottom-section {
    background: white;
    border-radius: 12px;
    padding: 25px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  
  /* è­¦å‘Šæ¡† */
  .warning-box {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 20px;
  }
  
  .warning-icon {
    font-size: 20px;
    flex-shrink: 0;
  }
  
  .warning-text {
    color: #856404;
    font-size: 14px;
    line-height: 1.5;
  }
  
  /* æäº¤åŒºåŸŸ */
  .submit-section {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 20px;
  }
  
  .submit-btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 8px;
    padding: 15px 40px;
    font-size: 18px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s;
    min-width: 200px;
  }
  
  .submit-btn:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
  }
  
  .submit-btn:disabled {
    background: #ccc;
    cursor: not-allowed;
    transform: none;
  }
  
  /* ä¿¡æ¯å¡ç‰‡ */
  .info-cards {
    display: flex;
    gap: 30px;
  }
  
  .info-card {
    display: flex;
    align-items: center;
    gap: 8px;
    color: #28a745;
    font-size: 14px;
  }
  
  .info-icon {
    font-size: 16px;
  }
  
  /* åŠ è½½åŠ¨ç”» */
  .spinner {
    display: inline-block;
    width: 14px;
    height: 14px;
    border: 2px solid white;
    border-top: 2px solid transparent;
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  /* æˆåŠŸ/é”™è¯¯æ¶ˆæ¯ */
  .success-message,
  .error-message {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    padding: 48px 40px;
    border-radius: 20px;
    box-shadow: 
      0 20px 60px rgba(0,0,0,0.15),
      0 0 0 1px rgba(255,255,255,0.05);
    text-align: center;
    z-index: 1000;
    max-width: 480px;
    width: 90%;
    backdrop-filter: blur(10px);
    animation: successModalIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
  }
  
  @keyframes successModalIn {
    0% {
      opacity: 0;
      transform: translate(-50%, -50%) scale(0.8);
    }
    100% {
      opacity: 1;
      transform: translate(-50%, -50%) scale(1);
    }
  }
  
  .success-message {
    border: 2px solid #e8f5e8;
    background: linear-gradient(135deg, #ffffff 0%, #f0f9f0 100%);
  }
  
  .success-icon {
    position: relative;
    width: 80px;
    height: 80px;
    margin: 0 auto 24px auto;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .checkmark {
    position: relative;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    animation: checkmarkPop 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
  }
  
  @keyframes checkmarkPop {
    0% {
      transform: scale(0);
    }
    50% {
      transform: scale(1.2);
    }
    100% {
      transform: scale(1);
    }
  }
  
  .checkmark-stem {
    position: absolute;
    width: 3px;
    height: 16px;
    background: white;
    border-radius: 2px;
    transform: rotate(45deg);
    left: 50%;
    top: 50%;
    margin-left: -1px;
    margin-top: -8px;
  }
  
  .checkmark-kick {
    position: absolute;
    width: 3px;
    height: 8px;
    background: white;
    border-radius: 2px;
    transform: rotate(-45deg);
    left: 50%;
    top: 50%;
    margin-left: -6px;
    margin-top: -2px;
  }
  
  .error-icon {
    font-size: 64px;
    margin-bottom: 20px;
  }
  
  .success-message h3,
  .error-message h3 {
    margin: 0 0 16px 0;
    color: #1f2937;
    font-size: 24px;
    font-weight: 600;
    letter-spacing: -0.025em;
  }
  
  .success-message p,
  .error-message p {
    margin: 0 0 32px 0;
    color: #6b7280;
    line-height: 1.6;
    font-size: 16px;
  }
  
  .success-actions {
    display: flex;
    gap: 12px;
    justify-content: center;
    flex-wrap: wrap;
  }
  
  .btn-primary,
  .btn-secondary {
    padding: 14px 28px;
    border: none;
    border-radius: 12px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
    min-width: 120px;
  }
  
  .btn-primary {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    box-shadow: 0 4px 14px rgba(16, 185, 129, 0.3);
  }
  
  .btn-primary:hover {
    background: linear-gradient(135deg, #059669 0%, #047857 100%);
    box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
    transform: translateY(-2px);
  }
  
  .btn-secondary {
    background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
    color: #374151;
    border: 1px solid #d1d5db;
  }
  
  .btn-secondary:hover {
    background: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }
  
  /* å“åº”å¼è®¾è®¡ */
  @media (max-width: 1024px) {
    .main-content {
      grid-template-columns: 1fr;
      gap: 20px;
    }
    
    .config-section {
      order: -1;
    }
  }
  
  @media (max-width: 768px) {
    .quote-request-container {
      padding: 15px;
    }
    
    .upload-section,
    .config-section,
    .bottom-section {
      padding: 20px;
    }
    
    .model-viewer {
      height: 300px;
    }
    
    .viewer-tools {
      flex-direction: row;
      top: auto;
      bottom: 10px;
      right: 10px;
    }
    
    .tool-btn .text {
      display: none;
    }
    
    .info-cards {
      flex-direction: column;
      gap: 15px;
    }
  }
</style>

<!-- å¼•å…¥Three.jsç”¨äº3Dé¢„è§ˆ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/STLLoader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/OBJLoader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

<script>
  const API_BASE = 'https://shopify-13s4.vercel.app/api';  // â† è¯·ä¿®æ”¹ä¸ºä½ çš„å®é™… Vercel åŸŸå
  
  let selectedFiles = [];
  let quoteResult = null;
  
  // 3DæŸ¥çœ‹å™¨ç›¸å…³å˜é‡
  let scene = null;
  let camera = null;
  let renderer = null;
  let controls = null;
  let currentModel = null;
  
  // åˆå§‹åŒ–
  document.addEventListener('DOMContentLoaded', function() {
    init3DViewer();
    initFileUpload();
    initForm();
    updateSubmitButton();
  });
  
  /**
   * åˆå§‹åŒ–3DæŸ¥çœ‹å™¨
   */
  function init3DViewer() {
    const viewer = document.getElementById('model-viewer');
    if (!viewer) return;
    
    // åˆ›å»ºåœºæ™¯
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0xf5f5f5);
    
    // åˆ›å»ºç›¸æœº
    camera = new THREE.PerspectiveCamera(75, viewer.clientWidth / viewer.clientHeight, 0.1, 1000);
    camera.position.set(0, 0, 50);
    
    // åˆ›å»ºæ¸²æŸ“å™¨
    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(viewer.clientWidth, viewer.clientHeight);
    renderer.shadowMap.enabled = true;
    renderer.shadowMap.type = THREE.PCFSoftShadowMap;
    
    // æ¸…ç©ºå ä½ç¬¦å¹¶æ·»åŠ æ¸²æŸ“å™¨
    viewer.innerHTML = '';
    viewer.appendChild(renderer.domElement);
    
    // æ·»åŠ å…‰æº
    const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
    scene.add(ambientLight);
    
    const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
    directionalLight.position.set(50, 50, 50);
    directionalLight.castShadow = true;
    scene.add(directionalLight);
    
    // æ·»åŠ è½¨é“æ§åˆ¶å™¨
    if (typeof THREE.OrbitControls !== 'undefined') {
      controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.05;
    }
    
    // æ¸²æŸ“å¾ªç¯
    animate();
    
    // çª—å£å¤§å°è°ƒæ•´
    window.addEventListener('resize', onWindowResize);
  }
  
  /**
   * æ¸²æŸ“å¾ªç¯
   */
  function animate() {
    requestAnimationFrame(animate);
    
    if (controls) {
      controls.update();
    }
    
    if (renderer && scene && camera) {
      renderer.render(scene, camera);
    }
  }
  
  /**
   * çª—å£å¤§å°è°ƒæ•´
   */
  function onWindowResize() {
    const viewer = document.getElementById('model-viewer');
    if (!viewer || !camera || !renderer) return;
    
    camera.aspect = viewer.clientWidth / viewer.clientHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(viewer.clientWidth, viewer.clientHeight);
  }
  
  /**
   * åŠ è½½3Dæ¨¡å‹
   */
  async function load3DModel(file) {
    if (!scene || !renderer) return;
    
    // æ¸…é™¤å½“å‰æ¨¡å‹
    if (currentModel) {
      scene.remove(currentModel);
      currentModel = null;
    }
    
    const fileName = file.name.toLowerCase();
    
    try {
      if (fileName.endsWith('.stl')) {
        await loadSTLModel(file);
      } else if (fileName.endsWith('.obj')) {
        await loadOBJModel(file);
      } else if (fileName.endsWith('.step') || fileName.endsWith('.stp')) {
        // å¯¹äºSTEPæ–‡ä»¶ï¼Œæ˜¾ç¤ºå ä½ç¬¦ä¿¡æ¯
        showStepFileInfo(file);
      } else {
        showUnsupportedFileInfo(file);
      }
    } catch (error) {
      console.error('åŠ è½½3Dæ¨¡å‹å¤±è´¥:', error);
      showErrorInfo('æ¨¡å‹åŠ è½½å¤±è´¥: ' + error.message);
    }
  }
  
  /**
   * åŠ è½½STLæ¨¡å‹
   */
  function loadSTLModel(file) {
    return new Promise((resolve, reject) => {
      const loader = new THREE.STLLoader();
      const url = URL.createObjectURL(file);
      
      loader.load(
        url,
        function (geometry) {
          // è®¡ç®—å‡ ä½•ä½“ä¸­å¿ƒ
          geometry.computeBoundingBox();
          const center = geometry.boundingBox.getCenter(new THREE.Vector3());
          geometry.translate(-center.x, -center.y, -center.z);
          
          // åˆ›å»ºæè´¨
          const material = new THREE.MeshPhongMaterial({
            color: 0x888888,
            shininess: 100,
            side: THREE.DoubleSide
          });
          
          // åˆ›å»ºç½‘æ ¼
          currentModel = new THREE.Mesh(geometry, material);
          currentModel.castShadow = true;
          currentModel.receiveShadow = true;
          
          scene.add(currentModel);
          
          // è°ƒæ•´ç›¸æœºä½ç½®
          const box = new THREE.Box3().setFromObject(currentModel);
          const size = box.getSize(new THREE.Vector3());
          const maxDim = Math.max(size.x, size.y, size.z);
          const fov = camera.fov * (Math.PI / 180);
          let cameraZ = Math.abs(maxDim / 2 / Math.tan(fov / 2));
          cameraZ *= 1.5; // æ·»åŠ ä¸€äº›è¾¹è·
          
          camera.position.set(cameraZ, cameraZ, cameraZ);
          camera.lookAt(0, 0, 0);
          
          if (controls) {
            controls.target.set(0, 0, 0);
            controls.update();
          }
          
          URL.revokeObjectURL(url);
          resolve();
        },
        function (progress) {
          console.log('STLåŠ è½½è¿›åº¦:', (progress.loaded / progress.total * 100) + '%');
        },
        function (error) {
          URL.revokeObjectURL(url);
          reject(error);
        }
      );
    });
  }
  
  /**
   * åŠ è½½OBJæ¨¡å‹
   */
  function loadOBJModel(file) {
    return new Promise((resolve, reject) => {
      const loader = new THREE.OBJLoader();
      const url = URL.createObjectURL(file);
      
      loader.load(
        url,
        function (object) {
          // è®¡ç®—å¯¹è±¡ä¸­å¿ƒ
          const box = new THREE.Box3().setFromObject(object);
          const center = box.getCenter(new THREE.Vector3());
          object.position.sub(center);
          
          // è®¾ç½®æè´¨
          object.traverse(function (child) {
            if (child instanceof THREE.Mesh) {
              child.material = new THREE.MeshPhongMaterial({
                color: 0x888888,
                shininess: 100
              });
              child.castShadow = true;
              child.receiveShadow = true;
            }
          });
          
          currentModel = object;
          scene.add(currentModel);
          
          // è°ƒæ•´ç›¸æœºä½ç½®
          const size = box.getSize(new THREE.Vector3());
          const maxDim = Math.max(size.x, size.y, size.z);
          const fov = camera.fov * (Math.PI / 180);
          let cameraZ = Math.abs(maxDim / 2 / Math.tan(fov / 2));
          cameraZ *= 1.5;
          
          camera.position.set(cameraZ, cameraZ, cameraZ);
          camera.lookAt(0, 0, 0);
          
          if (controls) {
            controls.target.set(0, 0, 0);
            controls.update();
          }
          
          URL.revokeObjectURL(url);
          resolve();
        },
        function (progress) {
          console.log('OBJåŠ è½½è¿›åº¦:', (progress.loaded / progress.total * 100) + '%');
        },
        function (error) {
          URL.revokeObjectURL(url);
          reject(error);
        }
      );
    });
  }
  
  /**
   * æ˜¾ç¤ºSTEPæ–‡ä»¶ä¿¡æ¯
   */
  function showStepFileInfo(file) {
    const viewer = document.getElementById('model-viewer');
    if (!viewer) return;
    
    viewer.innerHTML = `
      <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; text-align: center; color: #666;">
        <div style="font-size: 48px; margin-bottom: 20px;">ğŸ“</div>
        <h3 style="margin: 0 0 10px 0; color: #333;">STEPæ–‡ä»¶å·²ä¸Šä¼ </h3>
        <p style="margin: 0; font-size: 14px;">æ–‡ä»¶: ${file.name}</p>
        <p style="margin: 10px 0 0 0; font-size: 12px; color: #999;">STEPæ ¼å¼éœ€è¦ä¸“ä¸šCADè½¯ä»¶æŸ¥çœ‹</p>
      </div>
    `;
  }
  
  /**
   * æ˜¾ç¤ºä¸æ”¯æŒçš„æ–‡ä»¶ä¿¡æ¯
   */
  function showUnsupportedFileInfo(file) {
    const viewer = document.getElementById('model-viewer');
    if (!viewer) return;
    
    viewer.innerHTML = `
      <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; text-align: center; color: #666;">
        <div style="font-size: 48px; margin-bottom: 20px;">ğŸ“„</div>
        <h3 style="margin: 0 0 10px 0; color: #333;">æ–‡ä»¶å·²ä¸Šä¼ </h3>
        <p style="margin: 0; font-size: 14px;">æ–‡ä»¶: ${file.name}</p>
        <p style="margin: 10px 0 0 0; font-size: 12px; color: #999;">æ­¤æ–‡ä»¶æ ¼å¼æš‚ä¸æ”¯æŒ3Dé¢„è§ˆ</p>
      </div>
    `;
  }
  
  /**
   * æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
   */
  function showErrorInfo(message) {
    const viewer = document.getElementById('model-viewer');
    if (!viewer) return;
    
    viewer.innerHTML = `
      <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; text-align: center; color: #f44336;">
        <div style="font-size: 48px; margin-bottom: 20px;">âš ï¸</div>
        <h3 style="margin: 0 0 10px 0; color: #f44336;">åŠ è½½å¤±è´¥</h3>
        <p style="margin: 0; font-size: 14px;">${message}</p>
      </div>
    `;
  }
  
  /**
   * åˆå§‹åŒ–æ–‡ä»¶ä¸Šä¼ 
   */
  function initFileUpload() {
    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('file-input');
    
    // ç‚¹å‡»ä¸Šä¼ åŒºåŸŸ
    dropzone.addEventListener('click', function(e) {
      if (e.target.tagName !== 'BUTTON') {
        fileInput.click();
      }
    });
    
    // æ–‡ä»¶é€‰æ‹©
    fileInput.addEventListener('change', function(e) {
      if (e.target.files.length > 0) {
        handleFiles(Array.from(e.target.files));
      }
    });
    
    // æ‹–æ‹½ä¸Šä¼ 
    dropzone.addEventListener('dragover', function(e) {
      e.preventDefault();
      dropzone.classList.add('dragover');
    });
    
    dropzone.addEventListener('dragleave', function(e) {
      e.preventDefault();
      dropzone.classList.remove('dragover');
    });
    
    dropzone.addEventListener('drop', function(e) {
      e.preventDefault();
      dropzone.classList.remove('dragover');
      
      if (e.dataTransfer.files.length > 0) {
        handleFiles(Array.from(e.dataTransfer.files));
      }
    });
    
    // ç¼©æ”¾æ»‘å—
    const scaleSlider = document.getElementById('scale');
    const scaleValue = document.getElementById('scale-value');
    scaleSlider.addEventListener('input', function() {
      scaleValue.textContent = this.value + '%';
    });
    
    // å¤‡æ³¨å­—ç¬¦è®¡æ•°
    const noteTextarea = document.getElementById('note');
    const charCount = document.getElementById('char-count');
    noteTextarea.addEventListener('input', function() {
      charCount.textContent = this.value.length;
    });
  }
  
  /**
   * åˆå§‹åŒ–è¡¨å•
   */
  function initForm() {
    const form = document.getElementById('quote-form');
    
    // ç›‘å¬æ‰€æœ‰è¡¨å•å˜åŒ–
    form.addEventListener('change', updateSubmitButton);
    form.addEventListener('input', updateSubmitButton);
    
    // è‡ªåŠ¨å¡«å……å®¢æˆ·ä¿¡æ¯
    const customerEmail = getCustomerEmail();
    if (customerEmail) {
      document.getElementById('customer-email').value = customerEmail;
    }
    
    const customerName = getCustomerName();
    if (customerName) {
      document.getElementById('customer-name').value = customerName;
    }
  }
  
  /**
   * å¤„ç†é€‰æ‹©çš„æ–‡ä»¶
   */
  async function handleFiles(files) {
    // éªŒè¯æ–‡ä»¶
    const validFiles = files.filter(file => {
      const validExtensions = ['.step', '.stp', '.stl', '.obj', '.3ds', '.fbx', '.dae', '.gltf', '.glb', '.dwg', '.dxf', '.pdf'];
      const fileName = file.name.toLowerCase();
      const isValid = validExtensions.some(ext => fileName.endsWith(ext));
      
      if (!isValid) {
        alert(`ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼: ${file.name}`);
        return false;
      }
      
      // éªŒè¯æ–‡ä»¶å¤§å°ï¼ˆ100MBï¼‰
      const maxSize = 100 * 1024 * 1024;
      if (file.size > maxSize) {
        alert(`æ–‡ä»¶è¿‡å¤§: ${file.name} (${formatFileSize(file.size)})`);
        return false;
      }
      
      return true;
    });
    
    // æ·»åŠ åˆ°å·²é€‰æ–‡ä»¶åˆ—è¡¨
    selectedFiles = [...selectedFiles, ...validFiles];
    
    // æ›´æ–°æ–‡ä»¶é¢„è§ˆ
    updateFilePreview();
    updateSubmitButton();
    
    // åŠ è½½ç¬¬ä¸€ä¸ª3Dæ–‡ä»¶è¿›è¡Œé¢„è§ˆ
    if (validFiles.length > 0) {
      const firstFile = validFiles[0];
      await load3DModel(firstFile);
    }
  }
  
  /**
   * æ›´æ–°æ–‡ä»¶é¢„è§ˆ
   */
  function updateFilePreview() {
    const filePreview = document.getElementById('file-preview');
    const fileList = document.getElementById('file-list');
    
    if (selectedFiles.length === 0) {
      filePreview.style.display = 'none';
      return;
    }
    
    filePreview.style.display = 'block';
    
    fileList.innerHTML = selectedFiles.map((file, index) => `
      <div class="file-item" onclick="selectFileForPreview(${index})">
        <div class="file-icon">${getFileIcon(file.name)}</div>
        <div class="file-info">
          <div class="file-name">${file.name}</div>
          <div class="file-size">${formatFileSize(file.size)}</div>
        </div>
        <button class="remove-file" onclick="event.stopPropagation(); removeFile(${index})">âœ•</button>
      </div>
    `).join('');
  }
  
  /**
   * é€‰æ‹©æ–‡ä»¶è¿›è¡Œé¢„è§ˆ
   */
  async function selectFileForPreview(index) {
    if (index >= 0 && index < selectedFiles.length) {
      const file = selectedFiles[index];
      await load3DModel(file);
      
      // é«˜äº®é€‰ä¸­çš„æ–‡ä»¶
      const fileItems = document.querySelectorAll('.file-item');
      fileItems.forEach((item, i) => {
        if (i === index) {
          item.style.backgroundColor = '#e3f2fd';
          item.style.borderColor = '#2196f3';
        } else {
          item.style.backgroundColor = '#f8f9fa';
          item.style.borderColor = '#e0e0e0';
        }
      });
    }
  }
  
  /**
   * ç§»é™¤æ–‡ä»¶
   */
  function removeFile(index) {
    selectedFiles.splice(index, 1);
    updateFilePreview();
    updateSubmitButton();
  }
  
  /**
   * è·å–æ–‡ä»¶å›¾æ ‡
   */
  function getFileIcon(fileName) {
    const ext = fileName.toLowerCase().split('.').pop();
    const iconMap = {
      'step': 'ğŸ“', 'stp': 'ğŸ“', 'stl': 'ğŸ”º', 'obj': 'ğŸ“¦',
      '3ds': 'ğŸ¯', 'fbx': 'ğŸ®', 'dae': 'ğŸŒŸ', 'gltf': 'âœ¨', 'glb': 'âœ¨',
      'dwg': 'ğŸ“', 'dxf': 'ğŸ“', 'pdf': 'ğŸ“„'
    };
    return iconMap[ext] || 'ğŸ“„';
  }
  
  /**
   * æ•°é‡å˜åŒ–
   */
  function changeQuantity(delta) {
    const qtyInput = document.getElementById('quantity');
    const newValue = Math.max(1, parseInt(qtyInput.value) + delta);
    qtyInput.value = newValue;
    updateSubmitButton();
  }
  
  /**
   * æ›´æ–°æäº¤æŒ‰é’®çŠ¶æ€
   */
  function updateSubmitButton() {
    const submitBtn = document.getElementById('submit-btn');
    
    // æ£€æŸ¥å¿…å¡«é¡¹
    const hasFiles = selectedFiles.length > 0;
    const hasMaterial = document.getElementById('material').value;
    const hasEmail = document.getElementById('customer-email').value;
    
    submitBtn.disabled = !(hasFiles && hasMaterial && hasEmail);
  }
  
  /**
   * æäº¤è¯¢ä»·
   */
  async function submitQuote() {
    if (selectedFiles.length === 0) {
      showError('è¯·å…ˆä¸Šä¼ æ–‡ä»¶');
      return;
    }
    
    const submitBtn = document.getElementById('submit-btn');
    const btnText = document.getElementById('btn-text');
    const btnLoading = document.getElementById('btn-loading');
    
    // ç¦ç”¨æŒ‰é’®
    submitBtn.disabled = true;
    btnText.style.display = 'none';
    btnLoading.style.display = 'inline';
    
    try {
      // è·å–è¡¨å•æ•°æ®
      const formData = getFormData();
      
      // éªŒè¯å¿…å¡«é¡¹
      if (!formData.material || !formData.customerEmail) {
        throw new Error('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«é¡¹');
      }
      
      // å‡†å¤‡æ‰€æœ‰æ–‡ä»¶æ•°æ®
      const mainFile = selectedFiles.find(f => is3DFile(f.name)) || selectedFiles[0];
      const mainFileData = await readFileAsBase64(mainFile);
      
      // å‡†å¤‡æ‰€æœ‰æ–‡ä»¶çš„æ•°æ®
      const allFilesData = [];
      for (const file of selectedFiles) {
        const fileData = await readFileAsBase64(file);
        allFilesData.push({
          name: file.name,
          size: file.size,
          type: file.type,
          data: fileData
        });
      }
      
       // è°ƒç”¨ API æäº¤è¯¢ä»·
       console.log('æäº¤è¯¢ä»·æ•°æ®:', {
         fileName: mainFile.name,
         customerEmail: formData.customerEmail,
         customerName: formData.customerName,
         quantity: parseInt(formData.quantity),
         material: formData.material,
         color: formData.color,
         precision: formData.precision,
         tolerance: formData.tolerance,
         roughness: formData.roughness,
         hasThread: formData.hasThread,
         hasAssembly: formData.hasAssembly,
         scale: formData.scale,
         note: formData.note,
         allFiles: selectedFiles.map(f => f.name),
         fileCount: selectedFiles.length
       });
       
       const response = await fetch(`${API_BASE}/submit-quote-real`, {
         method: 'POST',
         headers: {
           'Content-Type': 'application/json'
         },
         body: JSON.stringify({
           fileName: mainFile.name,
           fileUrl: mainFileData, // ä¸»æ–‡ä»¶æ•°æ®
           customerEmail: formData.customerEmail,
           customerName: formData.customerName,
           quantity: parseInt(formData.quantity),
           material: formData.material,
           color: formData.color,
           precision: formData.precision,
           tolerance: formData.tolerance,
           roughness: formData.roughness,
           hasThread: formData.hasThread,
           hasAssembly: formData.hasAssembly,
           scale: formData.scale,
           note: formData.note,
           allFiles: allFilesData, // å‘é€æ‰€æœ‰æ–‡ä»¶æ•°æ®
           lineItems: [{
             customAttributes: [
               { key: 'ææ–™', value: formData.material },
               { key: 'é¢œè‰²', value: formData.color },
               { key: 'ç²¾åº¦', value: formData.precision },
               { key: 'å…¬å·®æ ‡å‡†', value: formData.tolerance },
               { key: 'è¡¨é¢ç²—ç³™åº¦', value: formData.roughness },
               { key: 'æ˜¯å¦æœ‰èºçº¹', value: formData.hasThread ? 'æ˜¯' : 'å¦' },
               { key: 'æ˜¯å¦æœ‰è£…é…æ ‡è®°', value: formData.hasAssembly ? 'æ˜¯' : 'å¦' },
               { key: 'ç¼©æ”¾æ¯”ä¾‹', value: formData.scale + '%' },
               { key: 'å¤‡æ³¨', value: formData.note || '' },
               { key: 'ä¸Šä¼ æ–‡ä»¶æ•°é‡', value: selectedFiles.length.toString() },
               { key: 'æ–‡ä»¶åˆ—è¡¨', value: selectedFiles.map(f => f.name).join(', ') },
               ...selectedFiles.map((file, index) => ({
                 key: `æ–‡ä»¶${index + 1}_åç§°`,
                 value: file.name
               }))
             ]
           }]
         })
       });
       
       console.log('APIå“åº”çŠ¶æ€:', response.status);
       console.log('APIå“åº”å¤´:', response.headers);
      
      const result = await response.json();
      
      if (response.ok && result.success) {
        quoteResult = result;
        showSuccess(result);
      } else {
        throw new Error(result.message || result.error || 'æäº¤å¤±è´¥');
      }
      
    } catch (error) {
      console.error('æäº¤è¯¢ä»·å¤±è´¥:', error);
      showError(error.message);
    } finally {
      submitBtn.disabled = false;
      btnText.style.display = 'inline';
      btnLoading.style.display = 'none';
    }
  }
  
  /**
   * è·å–è¡¨å•æ•°æ®
   */
  function getFormData() {
    const form = document.getElementById('quote-form');
    const formData = new FormData(form);
    
    return {
      unit: formData.get('unit'),
      material: formData.get('material'),
      color: formData.get('color'),
      precision: formData.get('precision'),
      tolerance: formData.get('tolerance'),
      roughness: formData.get('roughness'),
      hasThread: formData.get('hasThread'),
      hasAssembly: formData.get('hasAssembly'),
      scale: formData.get('scale'),
      quantity: formData.get('quantity'),
      customerName: formData.get('customer-name'),
      customerEmail: formData.get('customer-email'),
      note: formData.get('note')
    };
  }
  
  /**
   * åˆ¤æ–­æ˜¯å¦ä¸º 3D æ–‡ä»¶
   */
  function is3DFile(fileName) {
    const ext = fileName.toLowerCase().split('.').pop();
    return ['step', 'stp', 'stl', 'obj', '3ds', 'fbx', 'dae', 'gltf', 'glb'].includes(ext);
  }
  
  /**
   * è¯»å–æ–‡ä»¶ä¸º Base64
   */
  function readFileAsBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }
  
  /**
   * æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
   */
  function showSuccess(result) {
    const successMessage = document.getElementById('success-message');
    const successText = document.getElementById('success-text');
    
    successText.innerHTML = `
      è¯¢ä»·å•å·: <strong>${result.quoteId}</strong><br>
      ${result.message || 'æˆ‘ä»¬å°†å°½å¿«ä¸ºæ‚¨æŠ¥ä»·ï¼Œè¯·ç•™æ„é‚®ä»¶é€šçŸ¥ã€‚'}
    `;
    
    successMessage.style.display = 'block';
  }
  
  /**
   * æŸ¥çœ‹è¯¢ä»·å•
   */
  function viewQuote() {
    if (quoteResult && quoteResult.viewUrl) {
      window.location.href = quoteResult.viewUrl;
    }
  }
  
  /**
   * å…³é—­æˆåŠŸæç¤º
   */
  function closeSuccessMessage() {
    const successMessage = document.getElementById('success-message');
    successMessage.style.display = 'none';
    
    // é‡ç½®è¡¨å•
    document.getElementById('quote-form').reset();
    selectedFiles = [];
    updateFileList();
    updateSubmitButton();
    hideError();
  }
  
  /**
   * æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
   */
  function showError(message) {
    const errorMessage = document.getElementById('error-message');
    const errorText = document.getElementById('error-text');
    
    errorText.textContent = message;
    errorMessage.style.display = 'block';
  }
  
  /**
   * éšè—é”™è¯¯æ¶ˆæ¯
   */
  function hideError() {
    document.getElementById('error-message').style.display = 'none';
  }
  
  /**
   * æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
   */
  function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
  }
  
  /**
   * è·å–å®¢æˆ·é‚®ç®±ï¼ˆä» Shopifyï¼‰
   */
  function getCustomerEmail() {
    if (window.Shopify && window.Shopify.customer && window.Shopify.customer.email) {
      return window.Shopify.customer.email;
    }
    return '';
  }
  
  /**
   * è·å–å®¢æˆ·å§“åï¼ˆä» Shopifyï¼‰
   */
  function getCustomerName() {
    if (window.Shopify && window.Shopify.customer) {
      const customer = window.Shopify.customer;
      if (customer.firstName && customer.lastName) {
        return `${customer.firstName} ${customer.lastName}`;
      } else if (customer.firstName) {
        return customer.firstName;
      }
    }
    return '';
  }
</script>
