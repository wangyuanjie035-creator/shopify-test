{% comment %}
  Draft Order Management Page - View and manage Shopify Draft Orders
  Security: admin password required
{% endcomment %}

<!-- å½“å‰ç™»å½•é‚®ç®±ï¼ˆç”¨äºå‰ç«¯æ ¡éªŒï¼‰ -->
<div id="customer-email" data-email="{{ customer.email | downcase | escape }}" data-tags="{{ customer.tags | join: ',' | downcase | escape }}"></div>

<!-- ç®¡ç†å‘˜ç™»å½•éªŒè¯ç•Œé¢ -->
<div id="admin-login-screen" class="admin-login-screen">
  <div class="login-card">
    <div class="login-header">
      <span class="login-icon">ğŸ”</span>
      <h2>Admin Verification</h2>
      <p>Enter the admin password to access Draft Order Management.</p>
    </div>
    <div class="login-body">
      <input 
        type="password" 
        id="admin-password-input" 
        class="password-input" 
        placeholder="Enter admin password"
        onkeypress="if(event.key==='Enter') verifyAdminPassword()"
      >
      <button class="login-btn" onclick="verifyAdminPassword()">
        <span class="btn-icon">ğŸ”“</span>
        Sign in
      </button>
      <div id="login-error" class="login-error" style="display: none;"></div>
    </div>
  </div>
</div>

<div class="admin-dashboard" id="admin-content" style="display: none;">
  <!-- é¡µé¢æ ‡é¢˜ -->
  <div class="page-header">
    <h1 class="page-title">
      <span class="title-icon">ğŸ“‹</span>
      Draft Order Quote Management
    </h1>
    <div class="header-actions">
      <button class="refresh-btn" onclick="refreshOrders()">
        <span class="btn-icon">ğŸ”„</span>
        Refresh
      </button>
    </div>
  </div>

  <!-- ç»Ÿè®¡å¡ç‰‡ -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-icon">â³</div>
      <div class="stat-number" id="pending-count">0</div>
      <div class="stat-label">Pending</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">âœ…</div>
      <div class="stat-number" id="quoted-count">0</div>
      <div class="stat-label">Quoted</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">ğŸ“Š</div>
      <div class="stat-number" id="total-count">0</div>
      <div class="stat-label">Total</div>
    </div>
  </div>

  <!-- è¿‡æ»¤å™¨ -->
  <div class="filter-section">
    <div class="filter-group">
      <span class="filter-label">Status:</span>
      <button class="filter-btn active" data-status="all">All</button>
      <button class="filter-btn" data-status="pending">Pending</button>
      <button class="filter-btn" data-status="quoted">Quoted</button>
    </div>
    <div class="filter-group">
      <span class="filter-label">Time:</span>
      <button class="time-filter-btn active" data-time="all">All time</button>
      <button class="time-filter-btn" data-time="today">Today</button>
      <button class="time-filter-btn" data-time="week">Last 7 days</button>
      <button class="time-filter-btn" data-time="month">Last 30 days</button>
    </div>
  </div>

  <!-- è®¢å•åˆ—è¡¨ -->
  <div class="orders-container">
    <div id="orders-list" class="orders-list">
      <!-- è®¢å•å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
    </div>
  </div>

  <!-- æŠ¥ä»·æ¨¡æ€æ¡† -->
  <div id="quote-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Add Quote</h3>
        <span class="close" onclick="closeQuoteModal()">&times;</span>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Quote ID:</label>
          <input type="text" id="quote-id" readonly>
        </div>
        <div class="form-group">
          <label>Customer email:</label>
          <input type="text" id="customer-email" readonly>
        </div>
        <div class="form-group">
          <label>Quoted amount ($):</label>
          <input type="number" id="quote-amount" placeholder="Enter amount" step="0.01">
        </div>
        <div class="form-group">
          <label>Notes:</label>
          <textarea id="quote-note" placeholder="Add notes (optional)" rows="3"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeQuoteModal()">Cancel</button>
        <button class="btn btn-primary" onclick="submitQuote()">Submit Quote</button>
      </div>
    </div>
  </div>
</div>

<style>
  /* ç®¡ç†å‘˜ç™»å½•ç•Œé¢æ ·å¼ */
  .admin-login-screen {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding: 20px;
  }

  .login-card {
    background: white;
    border-radius: 16px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    padding: 40px;
    max-width: 400px;
    width: 100%;
    animation: slideIn 0.3s ease-out;
  }

  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(-20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .login-header {
    text-align: center;
    margin-bottom: 30px;
  }

  .login-icon {
    font-size: 48px;
    display: block;
    margin-bottom: 15px;
  }

  .login-header h2 {
    color: #333;
    margin: 0 0 10px 0;
    font-size: 24px;
  }

  .login-header p {
    color: #666;
    font-size: 14px;
    margin: 0;
  }

  .login-body {
    display: flex;
    flex-direction: column;
    gap: 15px;
  }

  .password-input {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid #e1e5e9;
    border-radius: 8px;
    font-size: 16px;
    transition: all 0.2s ease;
    box-sizing: border-box;
  }

  .password-input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
  }

  .login-btn {
    width: 100%;
    padding: 12px 24px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }

  .login-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(102,126,234,0.4);
  }

  .login-btn:active {
    transform: translateY(0);
  }

  .login-error {
    color: #dc3545;
    font-size: 14px;
    padding: 10px;
    background: #fee;
    border-radius: 6px;
    text-align: center;
  }

  .admin-dashboard {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  }

  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 2px solid #e1e5e9;
  }

  .page-title {
    display: flex;
    align-items: center;
    margin: 0;
    font-size: 28px;
    color: #2c3e50;
  }

  .title-icon {
    margin-right: 10px;
    font-size: 32px;
  }

  .refresh-btn {
    display: flex;
    align-items: center;
    padding: 10px 20px;
    background: #3498db;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    transition: background 0.3s;
  }

  .refresh-btn:hover {
    background: #2980b9;
  }


  .btn-icon {
    margin-right: 5px;
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
  }

  .stat-card {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    text-align: center;
  }

  .stat-icon {
    font-size: 24px;
    margin-bottom: 10px;
  }

  .stat-number {
    font-size: 32px;
    font-weight: bold;
    color: #2c3e50;
    margin-bottom: 5px;
  }

  .stat-label {
    color: #7f8c8d;
    font-size: 14px;
  }

  .filter-section {
    margin-bottom: 20px;
    display: flex;
    flex-direction: column;
    gap: 15px;
  }

  .filter-group {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 10px;
  }

  .filter-label {
    font-weight: 500;
    color: #2c3e50;
    margin-right: 5px;
    display: inline-block;
    width: 64px;
  }

  .filter-btn,
  .time-filter-btn {
    padding: 8px 16px;
    background: #ecf0f1;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: background 0.3s;
    font-size: 14px;
  }

  .filter-btn.active,
  .time-filter-btn.active {
    background: #3498db;
    color: white;
  }

  .filter-btn:hover,
  .time-filter-btn:hover {
    background: #d5dbdb;
  }

  .filter-btn.active:hover,
  .time-filter-btn.active:hover {
    background: #2980b9;
  }

  .orders-container {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    overflow: hidden;
  }

  .orders-list {
    min-height: 200px;
  }

  .order-item {
    padding: 20px;
    border-bottom: 1px solid #ecf0f1;
    transition: background 0.3s;
  }

  .order-item:hover {
    background: #f8f9fa;
  }

  .order-item:last-child {
    border-bottom: none;
  }

  .order-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
  }

  .order-id {
    font-weight: bold;
    color: #2c3e50;
  }

  .order-status {
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: bold;
  }

  .status-pending {
    background: #fff3cd;
    color: #856404;
  }

  .status-quoted {
    background: #d4edda;
    color: #155724;
  }

  .status-unprocessable {
    background: #fff3cd;
    color: #856404;
  }


  .order-info {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 15px;
    color: #7f8c8d;
  }
  
  .order-params {
    background: #f8f9fa;
    padding: 12px;
    border-radius: 6px;
    margin-bottom: 15px;
    font-size: 13px;
  }
  
  .param-item {
    display: inline-block;
    margin-right: 15px;
    margin-bottom: 5px;
    color: #555;
  }
  
  .param-item strong {
    color: #333;
    margin-right: 5px;
  }

  .order-actions {
    display: flex;
    gap: 10px;
  }

  .action-btn {
    padding: 8px 12px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    transition: background 0.3s;
  }

  .action-btn.quote {
    background: #28a745;
    color: white;
  }

  .action-btn.quote:hover {
    background: #218838;
  }

  .action-btn.download {
    background: #17a2b8;
    color: white;
  }

  .action-btn.download:hover {
    background: #138496;
  }

  .action-btn.preview {
    background: #6c757d;
    color: white;
  }

  .action-btn.preview:hover {
    background: #545b62;
  }

  .action-btn.guide {
    background: #ffc107;
    color: #212529;
  }

  .action-btn.guide:hover {
    background: #e0a800;
  }

  .action-btn.delete {
    background: #dc3545;
    color: white;
  }

  .action-btn.delete:hover {
    background: #c82333;
  }

  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #7f8c8d;
  }

  .empty-icon {
    font-size: 48px;
    margin-bottom: 20px;
  }

  /* æ¨¡æ€æ¡†æ ·å¼ */
  .modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
  }

  .modal-content {
    background-color: white;
    margin: 5% auto;
    padding: 0;
    border-radius: 8px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
  }

  .modal-header {
    padding: 20px;
    border-bottom: 1px solid #ecf0f1;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .modal-header h3 {
    margin: 0;
    color: #2c3e50;
  }

  .close {
    color: #aaa;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
  }

  .close:hover {
    color: #000;
  }

  .modal-body {
    padding: 20px;
  }

  .form-group {
    margin-bottom: 20px;
  }

  .form-group label {
    display: block;
    margin-bottom: 5px;
    color: #2c3e50;
    font-weight: 500;
  }

  .form-group input,
  .form-group textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
  }

  .modal-footer {
    padding: 20px;
    border-top: 1px solid #ecf0f1;
    text-align: right;
  }

  .btn {
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    margin-left: 10px;
  }

  .btn-primary {
    background: #3498db;
    color: white;
  }

  .btn-secondary {
    background: #95a5a6;
    color: white;
  }

  .btn:hover {
    opacity: 0.9;
  }

  .action-btn.email {
    background: #27ae60;
    color: white;
    font-size: 12px;
    padding: 8px 12px;
  }

  .action-btn.email:hover {
    background: #219a52;
  }

  .action-btn.reject {
    background: #ff9800;
    color: white;
  }

  .action-btn.reject:hover {
    background: #f57c00;
  }
</style>

<script>
  // ç®¡ç†å‘˜ç™½åå•ï¼ˆå¦‚éœ€æ–°å¢ï¼Œè¿½åŠ é‚®ç®±å³å¯ï¼‰
  const ADMIN_EMAILS = ['jonathan.wang@sainstore.com', 'jonthan.wang@gmail.com', 'issac.yu@sainstore.com','kitto.chen@sainstore.com','cherry@sain3.com', 'keihen.luo@sain3.com','nancy.lin@sainstore.com'];
  const customerEl = document.getElementById('customer-email');
  const customerEmail = (customerEl?.dataset.email || '').trim().toLowerCase();
  const customerTags = (customerEl?.dataset.tags || '').split(',').map(t => t.trim());
  const isAdminUser = ADMIN_EMAILS.includes(customerEmail) || customerTags.includes('admin');
  const SESSION_KEY = 'admin_authenticated';
  const SESSION_EXPIRY_KEY = 'admin_session_expiry';

  // æ£€æŸ¥ä¼šè¯æ˜¯å¦æœ‰æ•ˆ
  function checkAdminSession() {
    const isAuth = sessionStorage.getItem(SESSION_KEY);
    const expiry = sessionStorage.getItem(SESSION_EXPIRY_KEY);
    
    if (isAuth === 'true' && expiry && Date.now() < parseInt(expiry)) {
      // ä¼šè¯æœ‰æ•ˆ
      showAdminContent();
      return true;
    }
    
    // ä¼šè¯æ— æ•ˆæˆ–è¿‡æœŸ
    sessionStorage.removeItem(SESSION_KEY);
    sessionStorage.removeItem(SESSION_EXPIRY_KEY);
    showLoginScreen();
    return false;
  }

  // éªŒè¯ç®¡ç†å‘˜å¯†ç ï¼ˆå½“å‰ç‰ˆæœ¬ç›´æ¥ä¾èµ–é‚®ç®±ç™½åå•ï¼Œä¸å†ä½¿ç”¨å¯†ç ï¼‰
  function verifyAdminPassword() {
    // å·²ç”±é‚®ç®±æ ¡éªŒä¿æŠ¤ï¼Œè¿™é‡Œç›´æ¥æ”¾è¡Œ
    const expiry = Date.now() + (2 * 60 * 60 * 1000);
    sessionStorage.setItem(SESSION_KEY, 'true');
    sessionStorage.setItem(SESSION_EXPIRY_KEY, expiry.toString());
    showAdminContent();
    loadOrders();
  }

  // æ˜¾ç¤ºç™»å½•ç•Œé¢
  function showLoginScreen() {
    document.getElementById('admin-login-screen').style.display = 'flex';
    document.getElementById('admin-content').style.display = 'none';
    setTimeout(() => {
      document.getElementById('admin-password-input').focus();
    }, 300);
  }

  // æ˜¾ç¤ºç®¡ç†å†…å®¹
  function showAdminContent() {
    document.getElementById('admin-login-screen').style.display = 'none';
    document.getElementById('admin-content').style.display = 'block';
  }

  // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ä¼šè¯
  document.addEventListener('DOMContentLoaded', function() {
    // å¿…é¡»å…ˆç™»å½•å®¢æˆ·è´¦å·
    if (!customerEmail) {
      document.getElementById('admin-login-screen').style.display = 'none';
      document.getElementById('admin-content').style.display = 'none';
      const warn = document.createElement('div');
      warn.style.cssText = 'padding:40px;text-align:center;color:#c00;font-size:16px;';
      warn.innerHTML = 'Please log in to an admin account before accessing this page.';
      document.body.prepend(warn);
      return;
    }

    // éç™½åå•è´¦å·ç›´æ¥æ‹’ç»
    if (!isAdminUser) {
      document.getElementById('admin-login-screen').style.display = 'none';
      document.getElementById('admin-content').style.display = 'none';
      const warn = document.createElement('div');
      warn.style.cssText = 'padding:40px;text-align:center;color:#c00;font-size:16px;';
      warn.innerHTML = 'Current account does not have permission to access draft order management.';
      document.body.prepend(warn);
      return;
    }

    // ç®¡ç†å‘˜ç›´æ¥é€šè¿‡ï¼ˆä¸å†è¦æ±‚è¾“å…¥å¯†ç ï¼‰
    const expiry = Date.now() + (2 * 60 * 60 * 1000);
    sessionStorage.setItem(SESSION_KEY, 'true');
    sessionStorage.setItem(SESSION_EXPIRY_KEY, expiry.toString());
    showAdminContent();
    
    // ç¡®ä¿ DOM å…ƒç´ å·²æ˜¾ç¤ºåå†ç»‘å®šäº‹ä»¶å’ŒåŠ è½½æ•°æ®
    setTimeout(() => {
      setupEventListeners();
      loadOrders();
    }, 100);
  });

  // APIé…ç½®
  const API_BASE = 'https://shopify-v587.vercel.app/api';
  
  // å…¨å±€å˜é‡
  let currentOrders = [];
  let currentFilter = 'all';
  let currentTimeFilter = 'all';
  
  // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
  function setupEventListeners() {
    // ä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼Œé¿å…é‡å¤ç»‘å®šé—®é¢˜
    const filterSection = document.querySelector('.filter-section');
    if (!filterSection) {
      console.error('Filter section not found');
      return;
    }
    
    // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    const newFilterSection = filterSection.cloneNode(true);
    filterSection.parentNode.replaceChild(newFilterSection, filterSection);
    
    // çŠ¶æ€è¿‡æ»¤å™¨æŒ‰é’® - ä½¿ç”¨äº‹ä»¶å§”æ‰˜
    newFilterSection.addEventListener('click', function(e) {
      if (e.target.classList.contains('filter-btn')) {
        newFilterSection.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
        currentFilter = e.target.dataset.status;
        renderOrders();
      }
      
      // æ—¶é—´è¿‡æ»¤å™¨æŒ‰é’®
      if (e.target.classList.contains('time-filter-btn')) {
        newFilterSection.querySelectorAll('.time-filter-btn').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
        currentTimeFilter = e.target.dataset.time;
        renderOrders();
      }
    });
  }
  
  // Normalize status (backward compatible: supports both CN and EN values)
  function normalizeStatusValue(v) {
    const raw = (v || '').toString().trim();
    if (raw === 'å·²æŠ¥ä»·' || raw === 'Quoted') return 'Quoted';
    if (raw === 'æ— æ³•åŠ å·¥' || raw === 'Not manufacturable') return 'Not manufacturable';
    if (raw === 'å¾…æŠ¥ä»·' || raw === 'Pending') return 'Pending';
    return raw || 'Pending';
  }

  // Status label for UI
  function getOrderStatusText(order) {
    // First check customAttributes for status (this is the source of truth)
    if (order.lineItems && order.lineItems.length > 0) {
      const attrs = order.lineItems[0].customAttributes || [];
      const statusAttr = attrs.find(a => a.key === 'Status' || a.key === 'çŠ¶æ€');
      if (statusAttr && statusAttr.value) {
        const statusValue = statusAttr.value.toString().trim();
        // Check for not manufacturable status FIRST (both Chinese and English)
        if (statusValue === 'æ— æ³•åŠ å·¥' || statusValue === 'Not manufacturable') {
          return 'Not manufacturable';
        }
        if (statusValue === 'å·²æŠ¥ä»·' || statusValue === 'Quoted') {
          return 'Quoted';
        }
        if (statusValue === 'å¾…æŠ¥ä»·' || statusValue === 'Pending') {
          return 'Pending';
        }
        return statusValue; // Return original value
      }
    }
    // Fallback: only use order.status if no customAttribute status found
    // But never return 'Quoted' if we haven't checked customAttributes
    return order.status === 'pending' ? 'Pending' : 'Pending';
  }


  // åŠ è½½è®¢å•åˆ—è¡¨
  async function loadOrders() {
    try {
      // è°ƒç”¨APIè·å–Draft Orders
      const response = await fetch(`${API_BASE}/get-draft-orders?admin=1&email=${encodeURIComponent(customerEmail)}`);
      
      if (!response.ok) {
        throw new Error(`API call failed: ${response.status}`);
      }
      
      const data = await response.json();
      
      if (data.success && data.draftOrders) {
        currentOrders = data.draftOrders.map(order => {
          // Determine order status (including not manufacturable)
          let orderStatus = 'pending';
          if (order.lineItems && order.lineItems.length > 0) {
            const attrs = order.lineItems[0].customAttributes || [];
            const statusAttr = attrs.find(a => a.key === 'Status' || a.key === 'çŠ¶æ€');
            if (statusAttr) {
              const normalizedStatus = normalizeStatusValue(statusAttr.value);
              if (normalizedStatus === 'Quoted') {
                orderStatus = 'quoted'; // Only "Quoted" is classified as processed
              } else if (normalizedStatus === 'Not manufacturable') {
                orderStatus = 'pending'; // "Not manufacturable" counts as pending for statistics
              }
              // Not manufacturable stays pending (not quoted)
            } else if (order.status === 'quoted') {
              orderStatus = 'quoted';
            }
          } else if (order.status === 'quoted') {
            orderStatus = 'quoted';
          }
          
          return {
            id: order.id,
            name: order.name,
            email: order.email,
            status: orderStatus,
            totalPrice: order.totalPrice,
            createdAt: order.createdAt,
            invoiceUrl: order.invoiceUrl,
            fileId: order.fileId,
            fileData: order.fileData,
            note: order.note,
            lineItems: order.lineItems
          };
        });
        
      } else {
        currentOrders = [];
      }
      
      renderOrders();
      updateStats();
      
    } catch (error) {
      console.error('Failed to load orders:', error);
      
      // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
      document.getElementById('orders-list').innerHTML = `
        <div class="empty-state">
          <div class="empty-icon">âŒ</div>
          <div>Load failed: ${error.message}</div>
          <button class="refresh-btn" onclick="loadOrders()" style="margin-top: 20px;">
            <span class="btn-icon">ğŸ”„</span>
            Retry
          </button>
        </div>
      `;
    }
  }
  
  // æ¸²æŸ“è®¢å•åˆ—è¡¨
  function renderOrders() {
    const ordersList = document.getElementById('orders-list');
    
    // å…ˆæŒ‰æ—¶é—´å€’åºæ’åºï¼ˆæœ€æ–°çš„åœ¨æœ€ä¸Šé¢ï¼‰
    let sortedOrders = [...currentOrders].sort((a, b) => {
      const dateA = new Date(a.createdAt).getTime();
      const dateB = new Date(b.createdAt).getTime();
      return dateB - dateA; // å€’åºï¼šæœ€æ–°çš„åœ¨å‰
    });
    
    // çŠ¶æ€è¿‡æ»¤
    let filteredOrders = sortedOrders;
    if (currentFilter !== 'all') {
      filteredOrders = sortedOrders.filter(order => order.status === currentFilter);
    }
    
    // æ—¶é—´è¿‡æ»¤
    if (currentTimeFilter !== 'all') {
      const now = new Date();
      const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0, 0);
      const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
      const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
      
      filteredOrders = filteredOrders.filter(order => {
        const orderDate = new Date(order.createdAt);
        let match = false;
        
        switch (currentTimeFilter) {
          case 'today':
            match = orderDate >= todayStart;
            break;
          case 'week':
            match = orderDate >= weekAgo;
            break;
          case 'month':
            match = orderDate >= monthAgo;
            break;
          default:
            match = true;
        }
        
        return match;
      });
    }
    
    if (filteredOrders.length === 0) {
      ordersList.innerHTML = `
        <div class="empty-state">
          <div class="empty-icon">ğŸ“‹</div>
          <div>æš‚æ— è®¢å•</div>
        </div>
      `;
      return;
    }
    
    ordersList.innerHTML = filteredOrders.map(order => `
      <div class="order-item">
        <div class="order-header">
          <div class="order-id">${order.name}</div>
          <div class="order-status ${(() => {
            const statusText = getOrderStatusText(order);
            if (statusText === 'æ— æ³•åŠ å·¥' || statusText === 'Not manufacturable') return 'status-unprocessable';
            return order.status === 'pending' ? 'status-pending' : 'status-quoted';
          })()}">
            ${getOrderStatusText(order)}
          </div>
        </div>
        <div class="order-info">
          <div>
            <div><strong>Customer email:</strong> ${order.email || 'Not provided'}</div>
            <div><strong>Created:</strong> ${new Date(order.createdAt).toLocaleString('en-US')}</div>
          </div>
          <div>
            <div><strong>Item:</strong> ${order.lineItems?.[0]?.title || 'Not specified'}</div>
            <div><strong>Qty:</strong> ${order.lineItems?.[0]?.quantity || 1}</div>
            <div><strong>Total:</strong> $${order.totalPrice || '0.00'}</div>
          </div>
        </div>
        ${order.lineItems?.[0]?.customAttributes ? `
        <div class="order-params">
          ${(() => {
            // Prefer the main 3D line item (some orders include 2D drawings as separate line items)
            const findAttr = (attrs, keys) => {
              for (const k of keys) {
                const a = attrs.find(x => x.key === k);
                if (a && a.value !== undefined && a.value !== null) return a;
              }
              return null;
            };

            const pickMainItem = (items) => {
              if (!Array.isArray(items) || items.length === 0) return items?.[0] || null;
              const is3D = (it) => {
                const attrs = it.customAttributes || [];
                const t = findAttr(attrs, ['File Type', 'æ–‡ä»¶ç±»å‹']);
                const v = (t?.value || '').toString().trim();
                if (v === '3D') return true;
                const orderType = findAttr(attrs, ['Order Type', 'è®¢å•ç±»å‹']);
                return (orderType?.value || '').toString().toLowerCase().includes('3d');
              };
              return items.find(is3D) || items[0];
            };

            const mainItem = pickMainItem(order.lineItems);
            const customAttributes = mainItem?.customAttributes || [];
            const params = [];
            
            // Display parameters in the same order as the customer upload UI (EN + CN compatible)
            const paramOrder = [
              { keys: ['Material Category', 'ææ–™å¤§ç±»'], label: 'Material category' },
              { keys: ['Material', 'ææ–™'], label: 'Material' },
              { keys: ['Surface Finish', 'è¡¨é¢å¤„ç†'], label: 'Surface finish' },
              { keys: ['Tightest Tolerance', 'æœ€ä¸¥å…¬å·®', 'ç²¾åº¦', 'ç²¾åº¦ç­‰çº§', 'å…¬å·®æ ‡å‡†'], label: 'Tightest tolerance' },
              { keys: ['Surface Roughness', 'è¡¨é¢ç²—ç³™åº¦'], label: 'Surface roughness' },
              { keys: ['Threads', 'æ˜¯å¦æœ‰èºçº¹'], label: 'Threads' },
              { keys: ['Assembly Features', 'æ˜¯å¦æœ‰è£…é…å…³ç³»', 'æ˜¯å¦æœ‰è£…é…æ ‡è®°'], label: 'Assembly features' },
              { keys: ['Notes', 'å¤‡æ³¨'], label: 'Notes' }
            ];
            
            paramOrder.forEach(cfg => {
              const attr = findAttr(customAttributes, cfg.keys);
              if (!attr || !attr.value) return;
              const v = String(attr.value);
              if (!v || v === 'æœªæŒ‡å®š' || v === 'æœªæä¾›' || v === 'Not specified' || v === 'Not provided') return;
              let displayValue = v;
              if (cfg.label === 'Threads' || cfg.label === 'Assembly features') {
                const vv = v.toLowerCase();
                displayValue = (vv === 'yes' || vv === 'true' || v === 'æ˜¯') ? 'Yes' : 'No';
              }
              params.push(`<div class="param-item"><strong>${cfg.label}:</strong> ${displayValue}</div>`);
            });
            
            return params.join('');
          })()}
        </div>
        ` : ''}
        <div class="order-actions">
          <button class="action-btn download" onclick="downloadOrderFile('${order.id}')" title="Download files">
            ğŸ“„
          </button>
          <button class="action-btn preview" onclick="previewOrderFile('${order.id}')" title="Preview">
            ğŸ‘ï¸
          </button>
          ${order.status === 'pending' ? `
            <button class="action-btn quote" onclick="openQuoteModal('${order.id}', '${order.email}', '${order.name}')">
              ğŸ’° Add Quote
            </button>
            <button class="action-btn reject" onclick="markAsUnprocessable('${order.id}', '${order.email}', '${order.name}')" title="Mark as not manufacturable">
              âš ï¸ Not manufacturable
            </button>
          ` : (() => {
            const statusText = getOrderStatusText(order);
            const isUnprocessable = statusText === 'Not manufacturable';
            return `
              <button class="action-btn" onclick="viewQuote('${order.id}')">
                ğŸ‘ï¸ View quote
              </button>
              ${!isUnprocessable ? `
                <button class="action-btn email" onclick="sendInvoiceEmail('${order.id}', '${order.email}', '${order.name}')" title="Send invoice email">
                  ğŸ“§ Send email
                </button>
              ` : ''}
            `;
          })()}
          <button class="action-btn guide" onclick="showCustomerGuide('${order.id}', '${order.email}')" title="Customer guide">
            ğŸ“‹
          </button>
          <button class="action-btn delete" onclick="deleteQuote('${order.id}')" title="Delete">
            ğŸ—‘ï¸
          </button>
        </div>
      </div>
    `).join('');
  }
  
  // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
  function updateStats() {
    const pendingCount = currentOrders.filter(o => o.status === 'pending').length;
    const quotedCount = currentOrders.filter(o => o.status === 'quoted').length;
    const totalCount = currentOrders.length;
    
    document.getElementById('pending-count').textContent = pendingCount;
    document.getElementById('quoted-count').textContent = quotedCount;
    document.getElementById('total-count').textContent = totalCount;
  }
  
  // åˆ·æ–°è®¢å•
  function refreshOrders() {
    loadOrders();
  }

  
  // æ‰“å¼€æŠ¥ä»·æ¨¡æ€æ¡†
  function openQuoteModal(orderId, email, orderName) {
    document.getElementById('quote-id').value = orderName;
    document.getElementById('customer-email').value = email;
    document.getElementById('quote-amount').value = '';
    document.getElementById('quote-note').value = '';
    
    // ä¿å­˜å½“å‰è®¢å•ID
    window.currentQuoteOrderId = orderId;
    
    document.getElementById('quote-modal').style.display = 'block';
  }
  
  // å…³é—­æŠ¥ä»·æ¨¡æ€æ¡†
  function closeQuoteModal() {
    document.getElementById('quote-modal').style.display = 'none';
    window.currentQuoteOrderId = null;
  }
  
  // æäº¤æŠ¥ä»·
  async function submitQuote() {
    const amount = document.getElementById('quote-amount').value;
    const note = document.getElementById('quote-note').value;
    
    if (!amount || parseFloat(amount) <= 0) {
      alert('Please enter a valid quote amount');
      return;
    }
    
    if (!window.currentQuoteOrderId) {
      alert('Order ID is missing, please try again');
      return;
    }
    
    try {
      const response = await fetch(`${API_BASE}/update-quote`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          draftOrderId: window.currentQuoteOrderId,
          amount: parseFloat(amount),
          note: note
        })
      });
      
      const data = await response.json();
      
      if (data.success) {
        alert('Quote submitted successfully!');
        closeQuoteModal();
        loadOrders(); // Reload order list
      } else {
        alert('Failed to submit quote: ' + (data.message || 'Unknown error'));
      }
      
    } catch (error) {
      console.error('Failed to submit quote:', error);
      alert('Failed to submit quote: ' + error.message);
    }
  }
  
  // æŸ¥çœ‹æŠ¥ä»·
  function viewQuote(orderId) {
    // è·³è½¬åˆ°è¯¢ä»·è¯¦æƒ…é¡µé¢
    window.open(`/pages/my-quotes?id=${orderId}`, '_blank');
  }

  // Mark order as not manufacturable
  async function markAsUnprocessable(orderId, customerEmail, orderName) {
    try {
      // å¼¹å‡ºå¯¹è¯æ¡†è®©ç®¡ç†å‘˜è¾“å…¥åŸå› å’Œä¿®æ”¹å»ºè®®
      const reason = prompt('Enter the reason (e.g., part size out of range, unsupported material):');
      if (!reason || reason.trim() === '') {
        return;
      }
      
      const suggestion = prompt('Enter suggested changes (e.g., reduce size to X, change material to Y):');
      if (!suggestion || suggestion.trim() === '') {
        return;
      }
      
      // ç¡®è®¤æ“ä½œ
      if (!confirm(`Mark this order as "Not manufacturable"?\n\nCustomer email: ${customerEmail}\nOrder: ${orderName}\n\nReason: ${reason}\nSuggested changes: ${suggestion}`)) {
        return;
      }
      
      // æ­¥éª¤1: æ›´æ–°è®¢å•çŠ¶æ€ä¸º"æ— æ³•åŠ å·¥"
      const updateResponse = await fetch(`${API_BASE}/update-quote`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          draftOrderId: orderId,
          amount: 0, // not manufacturable: set amount to 0
          note: `Not manufacturable\n\nReason: ${reason}\nSuggested changes: ${suggestion}`,
          status: 'Not manufacturable'
        })
      });
      
      const updateData = await updateResponse.json();
      
      if (!updateData.success) {
        alert('âŒ Failed to update order status: ' + (updateData.message || 'Unknown error'));
        return;
      }
      
      // åˆ·æ–°è®¢å•åˆ—è¡¨ï¼Œæ›´æ–°ç•Œé¢çŠ¶æ€
      loadOrders();
      
      // æ˜¾ç¤ºæˆåŠŸæç¤º
      alert(`âœ… Marked as "Not manufacturable".\n\nğŸ“‹ Order: ${orderName}\nğŸ“§ Customer: ${customerEmail}\n\nThe customer can view the reason and suggested changes in My Quotes.`);
      
    } catch (error) {
      console.error('Failed to mark as not manufacturable:', error);
      alert('âŒ Operation failed: ' + error.message);
    }
  }

  // Send invoice email (quoted orders only)
  async function sendInvoiceEmail(orderId, customerEmail, orderName) {
    try {
      // ç¡®è®¤å‘é€
      if (!confirm(`Send invoice email?\n\nCustomer email: ${customerEmail}\nOrder: ${orderName}\n\nThe email will include the checkout link and order details.`)) {
        return;
      }
      
      const response = await fetch(`${API_BASE}/send-invoice-email`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          draftOrderId: orderId,
          customMessage: `Your quote is ready.\n\nOrder: ${orderName}\nPlease use the checkout link below to review and complete payment.\n\nIf you have any questions, please contact our support team.\n\nThank you for choosing us!`
        })
      });
      
      const data = await response.json();
      
      if (data.success) {
        alert(`âœ… Invoice email sent.\n\nğŸ“§ To: ${customerEmail}\nğŸ“‹ Order: ${orderName}\nğŸ’° Amount: $${data.totalPrice}\nğŸ”— Checkout: ${data.invoiceUrl}`);
      } else {
        alert('âŒ Failed to send email: ' + (data.message || 'Unknown error'));
      }
      
    } catch (error) {
      console.error('Failed to send email:', error);
      alert('âŒ Failed to send email: ' + error.message);
    }
  }

  // ä¸‹è½½è®¢å•æ‰€æœ‰æ–‡ä»¶ï¼ˆ3D + 2Dï¼Œä¼˜å…ˆä½¿ç”¨ Shopify æ–‡ä»¶ URL / IDï¼‰
  async function downloadOrderFile(orderId) {
    try {
      const order = currentOrders.find(o => o.id === orderId);
      if (!order) {
        alert('Order information not found');
        return;
      }
      if (!order.lineItems || order.lineItems.length === 0) {
        alert('No product information in order');
        return;
      }

      // æ”¶é›†æ‰€æœ‰éœ€è¦ä¸‹è½½çš„æ–‡ä»¶ä¿¡æ¯
      const filesToDownload = [];
      
      // è°ƒè¯•ä¿¡æ¯ï¼šæ˜¾ç¤ºè®¢å•ä¸­æœ‰å¤šå°‘ä¸ª lineItems
      const totalLineItems = order.lineItems.length;
      
      for (const item of order.lineItems) {
        const attrs = item.customAttributes || [];
        const fileIdAttr = attrs.find(a => a.key === 'File ID' || a.key === 'æ–‡ä»¶ID');
        const fileNameAttr = attrs.find(a => a.key === 'File' || a.key === 'æ–‡ä»¶') || attrs.find(a => a.key === 'File Name' || a.key === 'æ–‡ä»¶å');
        const shopifyFileUrlAttr = attrs.find(a => a.key === 'Shopify File URL' || a.key === 'Shopifyæ–‡ä»¶URL');
        const shopifyFileIdAttr = attrs.find(a => a.key === 'Shopify File ID' || a.key === 'Shopifyæ–‡ä»¶ID');
        const fileTypeAttr = attrs.find(a => a.key === 'File Type' || a.key === 'æ–‡ä»¶ç±»å‹');

        const shopifyFileUrl = shopifyFileUrlAttr ? shopifyFileUrlAttr.value : null;
        const shopifyFileId = shopifyFileIdAttr ? shopifyFileIdAttr.value : null;
        let fileName = (fileNameAttr && fileNameAttr.value) || item.title || 'Unknown file';
        const fileTypeLabel = fileTypeAttr && fileTypeAttr.value === '2D' ? '2D' : '3D';

        // æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•æ–‡ä»¶æ ‡è¯†ç¬¦
        // æ³¨æ„ï¼šfileIdAttr æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œéœ€è¦æ£€æŸ¥ value å±æ€§
        const hasFileId = fileIdAttr && fileIdAttr.value;
        const hasShopifyFileUrl = shopifyFileUrl && shopifyFileUrl.trim() !== '';
        const hasShopifyFileId = shopifyFileId && shopifyFileId.trim() !== '';
        
        if (!hasFileId && !hasShopifyFileUrl && !hasShopifyFileId) {
          // è¿™ä¸ª lineItem æ²¡æœ‰æ–‡ä»¶ä¿¡æ¯ï¼Œè·³è¿‡
          continue;
        }

        // ç¡®å®šä¸‹è½½æ–¹å¼å’ŒURL
        let downloadMethod = 'unknown';
        let downloadUrl = null;
        
        if (hasShopifyFileId && shopifyFileId.startsWith('gid://')) {
          downloadMethod = 'shopifyFileId';
          downloadUrl = `${API_BASE}/download-file?shopifyFileId=${encodeURIComponent(shopifyFileId)}&fileName=${encodeURIComponent(fileName)}`;
        } else if (hasShopifyFileUrl && shopifyFileUrl.startsWith('https://') && 
                   !shopifyFileUrl.includes('shopify-staged-uploads.storage.googleapis.com')) {
          downloadMethod = 'shopifyFileUrl';
          downloadUrl = `${API_BASE}/download-file?shopifyFileUrl=${encodeURIComponent(shopifyFileUrl)}&fileName=${encodeURIComponent(fileName)}`;
        } else if (hasFileId) {
          downloadMethod = 'fileId';
          downloadUrl = `${API_BASE}/download-file?id=${encodeURIComponent(fileIdAttr.value)}&fileName=${encodeURIComponent(fileName)}`;
        }

        if (downloadUrl) {
          filesToDownload.push({
            fileName,
            downloadUrl,
            downloadMethod,
            fileType: fileTypeLabel,
            shopifyFileUrl: shopifyFileUrl // ä¿ç•™åŸå§‹URLç”¨äºé™çº§æ–¹æ¡ˆ
          });
        }
      }
      
      // å¦‚æœæ£€æµ‹åˆ°çš„æ–‡ä»¶æ•°é‡å°‘äº lineItems æ•°é‡ï¼Œæ˜¾ç¤ºæç¤º
      if (filesToDownload.length < totalLineItems && totalLineItems > 1) {
        const skippedCount = totalLineItems - filesToDownload.length;
        alert(`âš ï¸ Order has ${totalLineItems} items, but only found ${filesToDownload.length} downloadable file(s).\n\n${skippedCount} item(s) have no file identifier and were skipped.`);
      }

      if (filesToDownload.length === 0) {
        alert('No downloadable files found');
        return;
      }

      // æ˜¾ç¤ºä¸‹è½½ç¡®è®¤æç¤º
      if (filesToDownload.length > 1) {
        const fileList = filesToDownload.map((f, idx) => `  ${idx + 1}. ${f.fileName}`).join('\n');
        const confirmMsg = `Detected ${filesToDownload.length} file(s), will download one by one:\n\n${fileList}\n\nThe browser may ask for permission to allow multiple downloads, please click "Allow".\n\nContinue?`;
        if (!confirm(confirmMsg)) {
          return;
        }
      } else {
        // å•ä¸ªæ–‡ä»¶ä¹Ÿæ˜¾ç¤ºæç¤º
        const singleFileMsg = `Ready to download file: ${filesToDownload[0].fileName}`;
        if (!confirm(singleFileMsg + '\n\nContinue?')) {
          return;
        }
      }

      // ä¸‹è½½ç»Ÿè®¡
      const downloadStats = {
        total: filesToDownload.length,
        success: 0,
        failed: 0,
        failedFiles: []
      };

      // é€ä¸ªä¸‹è½½æ–‡ä»¶ï¼ˆä½¿ç”¨æ›´é•¿çš„å»¶è¿Ÿï¼Œé¿å…æµè§ˆå™¨é˜»æ­¢ï¼‰
      for (let i = 0; i < filesToDownload.length; i++) {
        const file = filesToDownload[i];
        const progress = `[${i + 1}/${filesToDownload.length}]`;

        try {
          if (file.downloadMethod === 'shopifyFileId') {
            // ä½¿ç”¨ window.openï¼ˆéœ€è¦ç”¨æˆ·äº¤äº’ï¼‰
            // æ³¨æ„ï¼šshopifyFileId éœ€è¦é€šè¿‡ API ä¸­è½¬ï¼Œæ‰€ä»¥ä½¿ç”¨ window.open æ‰“å¼€æ–°æ ‡ç­¾é¡µ
            window.open(file.downloadUrl, '_blank');
            downloadStats.success++;
            // å¢åŠ å»¶è¿Ÿæ—¶é—´ï¼Œé¿å…æµè§ˆå™¨é˜»æ­¢
            await new Promise(resolve => setTimeout(resolve, 800));
          } else {
            // ä¼˜å…ˆä½¿ç”¨ fetch + blob ä¸‹è½½ï¼ˆæ›´å¯é ï¼Œé¿å…æµè§ˆå™¨é˜»æ­¢ï¼‰
            const response = await fetch(file.downloadUrl);
            if (!response.ok) {
              // å¦‚æœæ˜¯ shopifyFileUrl ä¸”å¤±è´¥ï¼Œå°è¯•é™çº§åˆ°ç›´æ¥ä¸‹è½½
              if (file.downloadMethod === 'shopifyFileUrl' && file.shopifyFileUrl) {
                try {
                  const link = document.createElement('a');
                  link.href = file.shopifyFileUrl;
                  link.download = file.fileName;
                  link.target = '_blank';
                  document.body.appendChild(link);
                  link.click();
                  document.body.removeChild(link);
                  downloadStats.success++;
                  await new Promise(resolve => setTimeout(resolve, 500));
                  continue;
                } catch (fallbackError) {
                  throw new Error(`API download failed (${response.status}), fallback also failed`);
                }
              }
              throw new Error(`Download failed: HTTP ${response.status}`);
            }
            
            // è¯»å–æ–‡ä»¶å†…å®¹ä¸º blob
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = file.fileName;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            a.remove();
            downloadStats.success++;
            
            // å»¶è¿Ÿï¼Œé¿å…æµè§ˆå™¨é˜»æ­¢å¤šä¸ªä¸‹è½½
            await new Promise(resolve => setTimeout(resolve, 500));
          }
        } catch (error) {
          console.error(`${progress} âŒ ä¸‹è½½æ–‡ä»¶å¤±è´¥ ${file.fileName}:`, error);
          downloadStats.failed++;
          downloadStats.failedFiles.push({
            fileName: file.fileName,
            error: error.message
          });
          // ç»§ç»­ä¸‹è½½å…¶ä»–æ–‡ä»¶ï¼Œä¸ä¸­æ–­
        }
      }

      // æ˜¾ç¤ºä¸‹è½½å®Œæˆæ€»ç»“ï¼ˆä»…åœ¨æœ‰å¤±è´¥æ—¶æ˜¾ç¤ºï¼‰
      if (downloadStats.failed > 0) {
        setTimeout(() => {
          if (downloadStats.total > 1) {
            let summaryMsg = `âŒ Some files failed to download\n\nTotal: ${downloadStats.total} file(s)\nSuccess: ${downloadStats.success}\nFailed: ${downloadStats.failed}`;
            summaryMsg += `\n\nFailed files:\n${downloadStats.failedFiles.map(f => `  â€¢ ${f.fileName}: ${f.error}`).join('\n')}`;
            summaryMsg += `\n\nIf some files were not downloaded, please check your browser's download settings to ensure multiple downloads are allowed.`;
            alert(summaryMsg);
          } else {
            // å•ä¸ªæ–‡ä»¶å¤±è´¥
            alert(`âŒ File download failed: ${filesToDownload[0].fileName}\n\nError: ${downloadStats.failedFiles[0]?.error || 'Unknown error'}`);
          }
        }, 1000);
      }
    } catch (error) {
      console.error('Failed to download file:', error);
      alert('Failed to download file: ' + error.message);
    }
  }

  // æ ‡å‡†æ–‡ä»¶ä¸‹è½½å‡½æ•° - æŒ‰ç…§æ–‡æ¡£æµç¨‹ï¼ˆåŸºäºä¹‹å‰å·¥ä½œç‰ˆæœ¬ï¼‰
  async function downloadFile(url, fileName) {
    try {
      // æ£€æŸ¥ URL ç±»å‹ï¼ˆdata:ã€http://ã€https://ï¼‰
      if (url && url.startsWith('data:')) {
        // Base64 æ•°æ®ï¼Œç›´æ¥ä¸‹è½½
        const link = document.createElement('a');
        link.href = url;
        link.download = fileName;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        return;
      }
      
      if (url && (url.startsWith('http://') || url.startsWith('https://'))) {
        // HTTP/HTTPS URLï¼Œç›´æ¥ä¸‹è½½
        const link = document.createElement('a');
        link.href = url;
        link.download = fileName;
        link.target = '_blank';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        return;
      }
      
      // å…¶ä»–æƒ…å†µï¼Œé€šè¿‡APIä¸‹è½½
      if (url) {
        const response = await fetch(`${API_BASE}/download-file?id=${encodeURIComponent(url)}`);
        
        if (response.ok) {
          const blob = await response.blob();
          const downloadUrl = window.URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = downloadUrl;
          link.download = fileName;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          window.URL.revokeObjectURL(downloadUrl);
          return;
        } else {
          throw new Error(`API download failed: ${response.status}`);
        }
      }
      
      throw new Error('No available file data or URL');
      
    } catch (error) {
      console.error('downloadFile failed:', error);
      alert('File download failed: ' + error.message);
    }
  }



  // é¢„è§ˆè®¢å•æ–‡ä»¶
  async function previewOrderFile(orderId) {
    try {
      const order = currentOrders.find(o => o.id === orderId);
      if (!order) {
        alert('Order information not found');
        return;
      }

      // Prefer main 3D line item for params/file preview
      const findAttr = (attrs, keys) => {
        for (const k of keys) {
          const a = attrs.find(x => x.key === k);
          if (a && a.value !== undefined && a.value !== null) return a;
        }
        return null;
      };
      const pickMainItem = (items) => {
        if (!Array.isArray(items) || items.length === 0) return items?.[0] || null;
        const is3D = (it) => {
          const attrs = it.customAttributes || [];
          const t = findAttr(attrs, ['File Type', 'æ–‡ä»¶ç±»å‹']);
          const v = (t?.value || '').toString().trim();
          return v === '3D';
        };
        return items.find(is3D) || items[0];
      };
      const lineItem = pickMainItem(order.lineItems);
      const customAttributes = lineItem?.customAttributes || [];
      
      let fileName = 'Unknown file';
      let fileData = '';
      
      customAttributes.forEach(attr => {
        if (attr.key === 'File' || attr.key === 'æ–‡ä»¶') {
          fileName = attr.value;
        }
        if (attr.key === 'File Data' || attr.key === 'æ–‡ä»¶æ•°æ®') {
          fileData = attr.value;
        }
      });

      // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
      const modal = document.createElement('div');
      const modalId = 'preview-modal-' + Date.now();
      modal.id = modalId;
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
      `;
      
      // Build parameter information (consistent with customer upload UI - EN + CN compatible)
      let paramsHtml = '';
      
      // Display parameters in the same order as the customer upload UI (EN + CN compatible)
      const paramOrder = [
        { keys: ['Material Category', 'ææ–™å¤§ç±»'], label: 'Material category' },
        { keys: ['Material', 'ææ–™'], label: 'Material' },
        { keys: ['Surface Finish', 'è¡¨é¢å¤„ç†'], label: 'Surface finish' },
        { keys: ['Tightest Tolerance', 'æœ€ä¸¥å…¬å·®', 'ç²¾åº¦', 'ç²¾åº¦ç­‰çº§', 'å…¬å·®æ ‡å‡†'], label: 'Tightest tolerance' },
        { keys: ['Surface Roughness', 'è¡¨é¢ç²—ç³™åº¦'], label: 'Surface roughness' },
        { keys: ['Threads', 'æ˜¯å¦æœ‰èºçº¹'], label: 'Threads' },
        { keys: ['Assembly Features', 'æ˜¯å¦æœ‰è£…é…å…³ç³»', 'æ˜¯å¦æœ‰è£…é…æ ‡è®°'], label: 'Assembly features' },
        { keys: ['Unit', 'å•ä½'], label: 'Unit' },
        { keys: ['Quantity', 'æ•°é‡'], label: 'Quantity' },
        { keys: ['Notes', 'å¤‡æ³¨'], label: 'Notes' }
      ];
      
      paramOrder.forEach(cfg => {
        const attr = findAttr(customAttributes, cfg.keys);
        if (!attr || !attr.value) return;
        const v = String(attr.value);
        if (!v || v === 'æœªæŒ‡å®š' || v === 'æœªæä¾›' || v === 'Not specified' || v === 'Not provided') return;
        let displayValue = v;
        if (cfg.label === 'Threads' || cfg.label === 'Assembly features') {
          const vv = v.toLowerCase();
          displayValue = (vv === 'yes' || vv === 'true' || v === 'æ˜¯') ? 'Yes' : 'No';
        }
        paramsHtml += `<p><strong>${cfg.label}:</strong> ${displayValue}</p>`;
      });
      
      // Display scale (if exists)
      const scaleAttr = findAttr(customAttributes, ['Scale', 'ç¼©æ”¾æ¯”ä¾‹']);
      if (scaleAttr && scaleAttr.value) {
        const v = String(scaleAttr.value);
        if (v && v !== 'æœªæŒ‡å®š' && v !== 'æœªæä¾›' && v !== 'Not specified' && v !== 'Not provided') {
          let displayValue = v.includes('%') ? v : v + '%';
          paramsHtml += `<p><strong>Scale:</strong> ${displayValue}</p>`;
        }
      }
      
      // æ•°é‡å·²åœ¨ä¸Šé¢é€šè¿‡fieldMappingæ˜¾ç¤ºï¼Œè¿™é‡Œä¸éœ€è¦é‡å¤æ˜¾ç¤º
      
      modal.innerHTML = `
        <div style="
          background: white;
          border-radius: 8px;
          padding: 20px;
          max-width: 600px;
          width: 90%;
          max-height: 80vh;
          overflow-y: auto;
        ">
          <h3>File Preview</h3>
          <p><strong>File Name:</strong> ${fileName}</p>
          <p><strong>Quote ID:</strong> ${order.name}</p>
          <p><strong>Customer Email:</strong> ${order.email}</p>
          <p><strong>Created:</strong> ${new Date(order.createdAt).toLocaleString()}</p>
          
          ${paramsHtml ? `
          <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 6px;">
            <h4 style="margin-top: 0; color: #333;">Order Parameters</h4>
            ${paramsHtml}
          </div>
          ` : ''}
          
          <div style="text-align: right; margin-top: 20px;">
            <button onclick="document.getElementById('${modalId}').remove()" style="
              background: #007bff;
              color: white;
              border: none;
              padding: 8px 16px;
              border-radius: 4px;
              cursor: pointer;
            ">Close</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          modal.remove();
        }
      });
      
    } catch (error) {
      console.error('Failed to preview file:', error);
      alert('Failed to preview file: ' + error.message);
    }
  }

  // æ˜¾ç¤ºå®¢æˆ·æ“ä½œæŒ‡å—
  function showCustomerGuide(orderId, email) {
    const order = currentOrders.find(o => o.id === orderId);
    const customerEmail = email || order?.email || 'Not provided';
    
    const guideContent = `
      <div style="padding: 20px;">
        <div style="margin-bottom: 20px;">
          <div style="margin-bottom: 8px;"><strong>1. Contact Customer</strong></div>
          <div style="margin-left: 16px; margin-bottom: 12px;">
            Please contact the customer through:<br>
            ğŸ“§ Email: ${customerEmail}<br>
            ğŸ“± Phone or other contact methods
          </div>
          
          <div style="margin-bottom: 8px;"><strong>2. Inform Customer Steps</strong></div>
          <div style="margin-left: 16px; margin-bottom: 12px;">
            â€¢ Visit the quote page to check the latest status<br>
            â€¢ If quoted, click the "Place Order" button<br>
            â€¢ Complete the payment process<br>
            â€¢ Or contact customer service directly
          </div>
          
          <div style="margin-bottom: 8px;"><strong>3. System Instructions</strong></div>
          <div style="margin-left: 16px; color: #666; font-size: 13px;">
            Customers can view quote status and place orders in real-time on the quote page.
          </div>
        </div>
        
        <div style="background: #e3f2fd; padding: 12px; border-radius: 6px; border-left: 4px solid #1976d2;">
          <p style="margin: 0; color: #1976d2; font-size: 14px;">
            <strong>Recommendation:</strong> After completing the quote, proactively contact the customer to confirm and guide them through the process.
          </p>
        </div>
      </div>
    `;
    
    const modal = document.createElement('div');
    modal.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
    `;
    
    modal.innerHTML = `
      <div style="
        background: white;
        border-radius: 12px;
        padding: 0;
        max-width: 600px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        position: relative;
      ">
        <div style="
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 20px;
          border-bottom: 1px solid #e9ecef;
        ">
          <h3 style="margin: 0; color: #333;">Customer Guide</h3>
          <button onclick="this.closest('.guide-modal').remove()" style="
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
          ">&times;</button>
        </div>
        <div>${guideContent}</div>
      </div>
    `;
    
    modal.className = 'guide-modal';
    document.body.appendChild(modal);
    
    modal.addEventListener('click', function(e) {
      if (e.target === modal) {
        modal.remove();
      }
    });
  }

  // åˆ é™¤æŠ¥ä»·
  async function deleteQuote(orderId) {
    if (!confirm('Are you sure you want to delete this quote? This action cannot be undone.')) {
      return;
    }

    try {
      const order = currentOrders.find(o => o.id === orderId);
      let fileId = '';
      
      // æŸ¥æ‰¾æ–‡ä»¶ID
      if (order && order.lineItems && order.lineItems.length > 0) {
        const customAttributes = order.lineItems[0].customAttributes || [];
        customAttributes.forEach(attr => {
          if (attr.key === 'File ID' || attr.key === 'æ–‡ä»¶ID' || attr.key === 'fileId') {
            fileId = attr.value;
          }
        });
      }
      
      // åˆ é™¤Draft Orderï¼ˆæ–‡ä»¶ä¼šéšè®¢å•ä¸€èµ·åˆ é™¤ï¼‰
      const response = await fetch(`${API_BASE}/delete-draft-order`, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          draftOrderId: orderId
        })
      });

      const data = await response.json();

      if (data.success) {
        alert('Quote deleted successfully!');
        loadOrders(); // Reload order list
      } else {
        alert('Delete failed: ' + (data.message || 'Unknown error'));
      }

    } catch (error) {
      console.error('Failed to delete quote:', error);
      alert('Delete failed: ' + error.message);
    }
  }
</script>
</script>