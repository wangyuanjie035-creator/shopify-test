{% comment %}
  Draft Order ç®¡ç†é¡µé¢ - æ˜¾ç¤ºå’Œç®¡ç†Shopify Draft Orders
  å®‰å…¨ï¼šéœ€è¦ç®¡ç†å‘˜å¯†ç éªŒè¯
{% endcomment %}

<!-- å½“å‰ç™»å½•é‚®ç®±ï¼ˆç”¨äºå‰ç«¯æ ¡éªŒï¼‰ -->
<div id="customer-email" data-email="{{ customer.email | downcase | escape }}" data-tags="{{ customer.tags | join: ',' | downcase | escape }}"></div>

<!-- ç®¡ç†å‘˜ç™»å½•éªŒè¯ç•Œé¢ -->
<div id="admin-login-screen" class="admin-login-screen">
  <div class="login-card">
    <div class="login-header">
      <span class="login-icon">ğŸ”</span>
      <h2>ç®¡ç†å‘˜éªŒè¯</h2>
      <p>è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ä»¥è®¿é—®è‰ç¨¿è®¢å•ç®¡ç†</p>
    </div>
    <div class="login-body">
      <input 
        type="password" 
        id="admin-password-input" 
        class="password-input" 
        placeholder="è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç "
        onkeypress="if(event.key==='Enter') verifyAdminPassword()"
      >
      <button class="login-btn" onclick="verifyAdminPassword()">
        <span class="btn-icon">ğŸ”“</span>
        éªŒè¯ç™»å½•
      </button>
      <div id="login-error" class="login-error" style="display: none;"></div>
    </div>
  </div>
</div>

<div class="admin-dashboard" id="admin-content" style="display: none;">
  <!-- é¡µé¢æ ‡é¢˜ -->
  <div class="page-header">
    <h1 class="page-title">
      <span class="title-icon">ğŸ“‹</span>
      Draft Order æŠ¥ä»·ç®¡ç†
    </h1>
    <div class="header-actions">
      <button class="refresh-btn" onclick="refreshOrders()">
        <span class="btn-icon">ğŸ”„</span>
        åˆ·æ–°
      </button>
    </div>
  </div>

  <!-- ç»Ÿè®¡å¡ç‰‡ -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-icon">â³</div>
      <div class="stat-number" id="pending-count">0</div>
      <div class="stat-label">å¾…æŠ¥ä»·</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">âœ…</div>
      <div class="stat-number" id="quoted-count">0</div>
      <div class="stat-label">å·²æŠ¥ä»·</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">ğŸ“Š</div>
      <div class="stat-number" id="total-count">0</div>
      <div class="stat-label">æ€»è®¡</div>
    </div>
  </div>

  <!-- è¿‡æ»¤å™¨ -->
  <div class="filter-section">
    <button class="filter-btn active" data-status="all">å…¨éƒ¨</button>
    <button class="filter-btn" data-status="pending">å¾…æŠ¥ä»·</button>
    <button class="filter-btn" data-status="quoted">å·²æŠ¥ä»·</button>
  </div>

  <!-- è®¢å•åˆ—è¡¨ -->
  <div class="orders-container">
    <div id="orders-list" class="orders-list">
      <!-- è®¢å•å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
    </div>
  </div>

  <!-- æŠ¥ä»·æ¨¡æ€æ¡† -->
  <div id="quote-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>æ·»åŠ æŠ¥ä»·</h3>
        <span class="close" onclick="closeQuoteModal()">&times;</span>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>è¯¢ä»·å•å·:</label>
          <input type="text" id="quote-id" readonly>
        </div>
        <div class="form-group">
          <label>å®¢æˆ·é‚®ç®±:</label>
          <input type="text" id="customer-email" readonly>
        </div>
        <div class="form-group">
          <label>æŠ¥ä»·é‡‘é¢ ($):</label>
          <input type="number" id="quote-amount" placeholder="è¯·è¾“å…¥æŠ¥ä»·é‡‘é¢" step="0.01">
        </div>
        <div class="form-group">
          <label>å¤‡æ³¨:</label>
          <textarea id="quote-note" placeholder="è¯·è¾“å…¥æŠ¥ä»·å¤‡æ³¨" rows="3"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeQuoteModal()">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="submitQuote()">ç¡®è®¤æŠ¥ä»·</button>
      </div>
    </div>
  </div>
</div>

<style>
  /* ç®¡ç†å‘˜ç™»å½•ç•Œé¢æ ·å¼ */
  .admin-login-screen {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding: 20px;
  }

  .login-card {
    background: white;
    border-radius: 16px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    padding: 40px;
    max-width: 400px;
    width: 100%;
    animation: slideIn 0.3s ease-out;
  }

  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(-20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .login-header {
    text-align: center;
    margin-bottom: 30px;
  }

  .login-icon {
    font-size: 48px;
    display: block;
    margin-bottom: 15px;
  }

  .login-header h2 {
    color: #333;
    margin: 0 0 10px 0;
    font-size: 24px;
  }

  .login-header p {
    color: #666;
    font-size: 14px;
    margin: 0;
  }

  .login-body {
    display: flex;
    flex-direction: column;
    gap: 15px;
  }

  .password-input {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid #e1e5e9;
    border-radius: 8px;
    font-size: 16px;
    transition: all 0.2s ease;
    box-sizing: border-box;
  }

  .password-input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
  }

  .login-btn {
    width: 100%;
    padding: 12px 24px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }

  .login-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(102,126,234,0.4);
  }

  .login-btn:active {
    transform: translateY(0);
  }

  .login-error {
    color: #dc3545;
    font-size: 14px;
    padding: 10px;
    background: #fee;
    border-radius: 6px;
    text-align: center;
  }

  .admin-dashboard {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  }

  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 2px solid #e1e5e9;
  }

  .page-title {
    display: flex;
    align-items: center;
    margin: 0;
    font-size: 28px;
    color: #2c3e50;
  }

  .title-icon {
    margin-right: 10px;
    font-size: 32px;
  }

  .refresh-btn {
    display: flex;
    align-items: center;
    padding: 10px 20px;
    background: #3498db;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    transition: background 0.3s;
  }

  .refresh-btn:hover {
    background: #2980b9;
  }


  .btn-icon {
    margin-right: 5px;
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
  }

  .stat-card {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    text-align: center;
  }

  .stat-icon {
    font-size: 24px;
    margin-bottom: 10px;
  }

  .stat-number {
    font-size: 32px;
    font-weight: bold;
    color: #2c3e50;
    margin-bottom: 5px;
  }

  .stat-label {
    color: #7f8c8d;
    font-size: 14px;
  }

  .filter-section {
    margin-bottom: 20px;
  }

  .filter-btn {
    padding: 8px 16px;
    margin-right: 10px;
    background: #ecf0f1;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: background 0.3s;
  }

  .filter-btn.active {
    background: #3498db;
    color: white;
  }

  .orders-container {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    overflow: hidden;
  }

  .orders-list {
    min-height: 200px;
  }

  .order-item {
    padding: 20px;
    border-bottom: 1px solid #ecf0f1;
    transition: background 0.3s;
  }

  .order-item:hover {
    background: #f8f9fa;
  }

  .order-item:last-child {
    border-bottom: none;
  }

  .order-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
  }

  .order-id {
    font-weight: bold;
    color: #2c3e50;
  }

  .order-status {
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: bold;
  }

  .status-pending {
    background: #fff3cd;
    color: #856404;
  }

  .status-quoted {
    background: #d4edda;
    color: #155724;
  }


  .order-info {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 15px;
    color: #7f8c8d;
  }
  
  .order-params {
    background: #f8f9fa;
    padding: 12px;
    border-radius: 6px;
    margin-bottom: 15px;
    font-size: 13px;
  }
  
  .param-item {
    display: inline-block;
    margin-right: 15px;
    margin-bottom: 5px;
    color: #555;
  }
  
  .param-item strong {
    color: #333;
    margin-right: 5px;
  }

  .order-actions {
    display: flex;
    gap: 10px;
  }

  .action-btn {
    padding: 8px 12px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    transition: background 0.3s;
  }

  .action-btn.quote {
    background: #28a745;
    color: white;
  }

  .action-btn.quote:hover {
    background: #218838;
  }

  .action-btn.download {
    background: #17a2b8;
    color: white;
  }

  .action-btn.download:hover {
    background: #138496;
  }

  .action-btn.preview {
    background: #6c757d;
    color: white;
  }

  .action-btn.preview:hover {
    background: #545b62;
  }

  .action-btn.guide {
    background: #ffc107;
    color: #212529;
  }

  .action-btn.guide:hover {
    background: #e0a800;
  }

  .action-btn.delete {
    background: #dc3545;
    color: white;
  }

  .action-btn.delete:hover {
    background: #c82333;
  }

  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #7f8c8d;
  }

  .empty-icon {
    font-size: 48px;
    margin-bottom: 20px;
  }

  /* æ¨¡æ€æ¡†æ ·å¼ */
  .modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
  }

  .modal-content {
    background-color: white;
    margin: 5% auto;
    padding: 0;
    border-radius: 8px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
  }

  .modal-header {
    padding: 20px;
    border-bottom: 1px solid #ecf0f1;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .modal-header h3 {
    margin: 0;
    color: #2c3e50;
  }

  .close {
    color: #aaa;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
  }

  .close:hover {
    color: #000;
  }

  .modal-body {
    padding: 20px;
  }

  .form-group {
    margin-bottom: 20px;
  }

  .form-group label {
    display: block;
    margin-bottom: 5px;
    color: #2c3e50;
    font-weight: 500;
  }

  .form-group input,
  .form-group textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
  }

  .modal-footer {
    padding: 20px;
    border-top: 1px solid #ecf0f1;
    text-align: right;
  }

  .btn {
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    margin-left: 10px;
  }

  .btn-primary {
    background: #3498db;
    color: white;
  }

  .btn-secondary {
    background: #95a5a6;
    color: white;
  }

  .btn:hover {
    opacity: 0.9;
  }

  .action-btn.email {
    background: #27ae60;
    color: white;
    font-size: 12px;
    padding: 8px 12px;
  }

  .action-btn.email:hover {
    background: #219a52;
  }
</style>

<script>
  // ç®¡ç†å‘˜ç™½åå•ï¼ˆå¦‚éœ€æ–°å¢ï¼Œè¿½åŠ é‚®ç®±å³å¯ï¼‰
  const ADMIN_EMAILS = ['jonathan.wang@sainstore.com', 'jonthan.wang@gmail.com'];
  const customerEl = document.getElementById('customer-email');
  const customerEmail = (customerEl?.dataset.email || '').trim().toLowerCase();
  const customerTags = (customerEl?.dataset.tags || '').split(',').map(t => t.trim());
  const isAdminUser = ADMIN_EMAILS.includes(customerEmail) || customerTags.includes('admin');
  const SESSION_KEY = 'admin_authenticated';
  const SESSION_EXPIRY_KEY = 'admin_session_expiry';

  // æ£€æŸ¥ä¼šè¯æ˜¯å¦æœ‰æ•ˆ
  function checkAdminSession() {
    const isAuth = sessionStorage.getItem(SESSION_KEY);
    const expiry = sessionStorage.getItem(SESSION_EXPIRY_KEY);
    
    if (isAuth === 'true' && expiry && Date.now() < parseInt(expiry)) {
      // ä¼šè¯æœ‰æ•ˆ
      showAdminContent();
      return true;
    }
    
    // ä¼šè¯æ— æ•ˆæˆ–è¿‡æœŸ
    sessionStorage.removeItem(SESSION_KEY);
    sessionStorage.removeItem(SESSION_EXPIRY_KEY);
    showLoginScreen();
    return false;
  }

  // éªŒè¯ç®¡ç†å‘˜å¯†ç ï¼ˆå½“å‰ç‰ˆæœ¬ç›´æ¥ä¾èµ–é‚®ç®±ç™½åå•ï¼Œä¸å†ä½¿ç”¨å¯†ç ï¼‰
  function verifyAdminPassword() {
    // å·²ç”±é‚®ç®±æ ¡éªŒä¿æŠ¤ï¼Œè¿™é‡Œç›´æ¥æ”¾è¡Œ
    const expiry = Date.now() + (2 * 60 * 60 * 1000);
    sessionStorage.setItem(SESSION_KEY, 'true');
    sessionStorage.setItem(SESSION_EXPIRY_KEY, expiry.toString());
    showAdminContent();
    loadOrders();
  }

  // æ˜¾ç¤ºç™»å½•ç•Œé¢
  function showLoginScreen() {
    document.getElementById('admin-login-screen').style.display = 'flex';
    document.getElementById('admin-content').style.display = 'none';
    setTimeout(() => {
      document.getElementById('admin-password-input').focus();
    }, 300);
  }

  // æ˜¾ç¤ºç®¡ç†å†…å®¹
  function showAdminContent() {
    document.getElementById('admin-login-screen').style.display = 'none';
    document.getElementById('admin-content').style.display = 'block';
  }

  // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ä¼šè¯
  document.addEventListener('DOMContentLoaded', function() {
    // å¿…é¡»å…ˆç™»å½•å®¢æˆ·è´¦å·
    if (!customerEmail) {
      document.getElementById('admin-login-screen').style.display = 'none';
      document.getElementById('admin-content').style.display = 'none';
      const warn = document.createElement('div');
      warn.style.cssText = 'padding:40px;text-align:center;color:#c00;font-size:16px;';
      warn.innerHTML = 'è¯·å…ˆç™»å½•ç®¡ç†å‘˜è´¦æˆ·åè®¿é—®æ­¤é¡µé¢ã€‚';
      document.body.prepend(warn);
      return;
    }

    // éç™½åå•è´¦å·ç›´æ¥æ‹’ç»
    if (!isAdminUser) {
      document.getElementById('admin-login-screen').style.display = 'none';
      document.getElementById('admin-content').style.display = 'none';
      const warn = document.createElement('div');
      warn.style.cssText = 'padding:40px;text-align:center;color:#c00;font-size:16px;';
      warn.innerHTML = 'å½“å‰è´¦æˆ·æ— æƒé™è®¿é—®è‰ç¨¿è®¢å•ç®¡ç†ã€‚';
      document.body.prepend(warn);
      return;
    }

    // ç®¡ç†å‘˜ç›´æ¥é€šè¿‡ï¼ˆä¸å†è¦æ±‚è¾“å…¥å¯†ç ï¼‰
    const expiry = Date.now() + (2 * 60 * 60 * 1000);
    sessionStorage.setItem(SESSION_KEY, 'true');
    sessionStorage.setItem(SESSION_EXPIRY_KEY, expiry.toString());
    showAdminContent();
    loadOrders();
  });

  // APIé…ç½®
  const API_BASE = 'https://shopify-13s4.vercel.app/api';
  
  // å…¨å±€å˜é‡
  let currentOrders = [];
  let currentFilter = 'all';
  

  // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
  document.addEventListener('DOMContentLoaded', function() {
    loadOrders();
    setupEventListeners();
  });
  
  // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
  function setupEventListeners() {
    // è¿‡æ»¤å™¨æŒ‰é’®
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        currentFilter = this.dataset.status;
        renderOrders();
      });
    });
  }
  
  // è·å–è®¢å•çŠ¶æ€æ–‡æœ¬
  function getOrderStatusText(order) {
    return order.status === 'pending' ? 'å¾…æŠ¥ä»·' : 'å·²æŠ¥ä»·';
  }


  // åŠ è½½è®¢å•åˆ—è¡¨
  async function loadOrders() {
    try {
      console.log('å¼€å§‹åŠ è½½Draft Orders...');
      
      // è°ƒç”¨APIè·å–Draft Orders
      const response = await fetch(`${API_BASE}/get-draft-orders?admin=1&email=${encodeURIComponent(customerEmail)}`);
      
      if (!response.ok) {
        throw new Error(`APIè°ƒç”¨å¤±è´¥: ${response.status}`);
      }
      
      const data = await response.json();
      console.log('APIå“åº”æ•°æ®:', data);
      console.log('data.success:', data.success);
      console.log('data.draftOrders:', data.draftOrders);
      console.log('draftOrdersé•¿åº¦:', data.draftOrders ? data.draftOrders.length : 'undefined');
      
      if (data.success && data.draftOrders) {
        currentOrders = data.draftOrders.map(order => ({
          id: order.id,
          name: order.name,
          email: order.email,
          status: order.status === 'pending' ? 'pending' : 'quoted',
          totalPrice: order.totalPrice,
          createdAt: order.createdAt,
          invoiceUrl: order.invoiceUrl,
          fileId: order.fileId,
          fileData: order.fileData,
          note: order.note,
          lineItems: order.lineItems
        }));
        
        console.log('å¤„ç†åçš„è®¢å•:', currentOrders);
        console.log('å®é™…æ¸²æŸ“çš„è®¢å•æ•°é‡:', currentOrders.length);
        
      } else {
        currentOrders = [];
        console.log('æ²¡æœ‰æ‰¾åˆ°Draft Orders');
      }
      
      renderOrders();
      updateStats();
      
    } catch (error) {
      console.error('åŠ è½½è®¢å•å¤±è´¥:', error);
      
      // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
      document.getElementById('orders-list').innerHTML = `
        <div class="empty-state">
          <div class="empty-icon">âŒ</div>
          <div>åŠ è½½å¤±è´¥: ${error.message}</div>
          <button class="refresh-btn" onclick="loadOrders()" style="margin-top: 20px;">
            <span class="btn-icon">ğŸ”„</span>
            é‡è¯•
          </button>
        </div>
      `;
    }
  }
  
  // æ¸²æŸ“è®¢å•åˆ—è¡¨
  function renderOrders() {
    const ordersList = document.getElementById('orders-list');
    
    // è¿‡æ»¤è®¢å•
    let filteredOrders = currentOrders;
    if (currentFilter !== 'all') {
      filteredOrders = currentOrders.filter(order => order.status === currentFilter);
    }
    
    if (filteredOrders.length === 0) {
      ordersList.innerHTML = `
        <div class="empty-state">
          <div class="empty-icon">ğŸ“‹</div>
          <div>æš‚æ— è®¢å•</div>
        </div>
      `;
      return;
    }
    
    console.log('å‡†å¤‡æ¸²æŸ“çš„è®¢å•æ•°é‡:', filteredOrders.length);
    console.log('è¿‡æ»¤åçš„è®¢å•:', filteredOrders);
    
    ordersList.innerHTML = filteredOrders.map(order => `
      <div class="order-item">
        <div class="order-header">
          <div class="order-id">${order.name}</div>
          <div class="order-status status-${order.status}">
            ${getOrderStatusText(order)}
          </div>
        </div>
        <div class="order-info">
          <div>
            <div><strong>å®¢æˆ·é‚®ç®±:</strong> ${order.email || 'æœªæä¾›'}</div>
            <div><strong>åˆ›å»ºæ—¶é—´:</strong> ${new Date(order.createdAt).toLocaleString('zh-CN')}</div>
          </div>
          <div>
            <div><strong>å•†å“:</strong> ${order.lineItems?.[0]?.title || 'æœªæŒ‡å®š'}</div>
            <div><strong>ä»·æ ¼:</strong> $${order.totalPrice || '0.00'}</div>
          </div>
        </div>
        ${order.lineItems?.[0]?.customAttributes ? `
        <div class="order-params">
          ${order.lineItems[0].customAttributes.map(attr => {
            const importantParams = [
              'ææ–™', 'é¢œè‰²', 'ç²¾åº¦', 'è¡¨é¢ç²—ç³™åº¦', 'ç²¾åº¦ç­‰çº§', 'å…¬å·®æ ‡å‡†', 'é¢œè‰²ä¸è¡¨é¢',
              'æ˜¯å¦æœ‰èºçº¹', 'æ˜¯å¦æœ‰è£…é…æ ‡è®°', 'ç¼©æ”¾æ¯”ä¾‹'
            ];
            
            if (importantParams.includes(attr.key)) {
              let displayValue = attr.value || 'æœªæŒ‡å®š';
              
              // ç‰¹æ®Šå¤„ç†æŸäº›å­—æ®µçš„æ˜¾ç¤º
              if (attr.key === 'æ˜¯å¦æœ‰èºçº¹' || attr.key === 'æ˜¯å¦æœ‰è£…é…æ ‡è®°') {
                displayValue = attr.value === 'yes' ? 'æ˜¯' : 'å¦';
              } else if (attr.key === 'ç¼©æ”¾æ¯”ä¾‹') {
                displayValue = attr.value ? attr.value + '%' : 'æœªæŒ‡å®š';
              }
              
              return `<div class="param-item"><strong>${attr.key}:</strong> ${displayValue}</div>`;
            }
            return '';
          }).filter(item => item).join('')}
        </div>
        ` : ''}
        <div class="order-actions">
          <button class="action-btn download" onclick="downloadOrderFile('${order.id}')" title="ä¸‹è½½æ–‡ä»¶">
            ğŸ“„
          </button>
          <button class="action-btn preview" onclick="previewOrderFile('${order.id}')" title="é¢„è§ˆæ–‡ä»¶">
            ğŸ‘ï¸
          </button>
          ${order.status === 'pending' ? `
            <button class="action-btn quote" onclick="openQuoteModal('${order.id}', '${order.email}', '${order.name}')">
              ğŸ’° æ·»åŠ æŠ¥ä»·
            </button>
          ` : `
            <button class="action-btn" onclick="viewQuote('${order.id}')">
              ğŸ‘ï¸ æŸ¥çœ‹æŠ¥ä»·
            </button>
            <button class="action-btn email" onclick="sendInvoiceEmail('${order.id}', '${order.email}', '${order.name}')" title="å‘é€å‘ç¥¨é‚®ä»¶">
              ğŸ“§ å‘é€é‚®ä»¶
            </button>
          `}
          <button class="action-btn guide" onclick="showCustomerGuide('${order.id}', '${order.email}')" title="å®¢æˆ·æ“ä½œæŒ‡å—">
            ğŸ“‹
          </button>
          <button class="action-btn delete" onclick="deleteQuote('${order.id}')" title="åˆ é™¤">
            ğŸ—‘ï¸
          </button>
        </div>
      </div>
    `).join('');
  }
  
  // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
  function updateStats() {
    const pendingCount = currentOrders.filter(o => o.status === 'pending').length;
    const quotedCount = currentOrders.filter(o => o.status === 'quoted').length;
    const totalCount = currentOrders.length;
    
    document.getElementById('pending-count').textContent = pendingCount;
    document.getElementById('quoted-count').textContent = quotedCount;
    document.getElementById('total-count').textContent = totalCount;
  }
  
  // åˆ·æ–°è®¢å•
  function refreshOrders() {
    loadOrders();
  }

  
  // æ‰“å¼€æŠ¥ä»·æ¨¡æ€æ¡†
  function openQuoteModal(orderId, email, orderName) {
    document.getElementById('quote-id').value = orderName;
    document.getElementById('customer-email').value = email;
    document.getElementById('quote-amount').value = '';
    document.getElementById('quote-note').value = '';
    
    // ä¿å­˜å½“å‰è®¢å•ID
    window.currentQuoteOrderId = orderId;
    
    document.getElementById('quote-modal').style.display = 'block';
  }
  
  // å…³é—­æŠ¥ä»·æ¨¡æ€æ¡†
  function closeQuoteModal() {
    document.getElementById('quote-modal').style.display = 'none';
    window.currentQuoteOrderId = null;
  }
  
  // æäº¤æŠ¥ä»·
  async function submitQuote() {
    const amount = document.getElementById('quote-amount').value;
    const note = document.getElementById('quote-note').value;
    
    if (!amount || parseFloat(amount) <= 0) {
      alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æŠ¥ä»·é‡‘é¢');
      return;
    }
    
    if (!window.currentQuoteOrderId) {
      alert('è®¢å•IDä¸¢å¤±ï¼Œè¯·é‡æ–°æ“ä½œ');
      return;
    }
    
    try {
      console.log('æäº¤æŠ¥ä»·:', { orderId: window.currentQuoteOrderId, amount, note });
      
      const response = await fetch(`${API_BASE}/update-quote`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          draftOrderId: window.currentQuoteOrderId,
          amount: parseFloat(amount),
          note: note
        })
      });
      
      const data = await response.json();
      console.log('æŠ¥ä»·æäº¤å“åº”:', data);
      
      if (data.success) {
        alert('æŠ¥ä»·æäº¤æˆåŠŸï¼');
        closeQuoteModal();
        loadOrders(); // é‡æ–°åŠ è½½è®¢å•åˆ—è¡¨
      } else {
        alert('æŠ¥ä»·æäº¤å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
      }
      
    } catch (error) {
      console.error('æŠ¥ä»·æäº¤å¤±è´¥:', error);
      alert('æŠ¥ä»·æäº¤å¤±è´¥: ' + error.message);
    }
  }
  
  // æŸ¥çœ‹æŠ¥ä»·
  function viewQuote(orderId) {
    // è·³è½¬åˆ°è¯¢ä»·è¯¦æƒ…é¡µé¢
    window.open(`/pages/my-quotes?id=${orderId}`, '_blank');
  }

  // å‘é€å‘ç¥¨é‚®ä»¶
  async function sendInvoiceEmail(orderId, customerEmail, orderName) {
    try {
      console.log('å¼€å§‹å‘é€å‘ç¥¨é‚®ä»¶:', { orderId, customerEmail, orderName });
      
      // ç¡®è®¤å‘é€
      if (!confirm(`ç¡®è®¤å‘å®¢æˆ·å‘é€å‘ç¥¨é‚®ä»¶ï¼Ÿ\n\nå®¢æˆ·é‚®ç®±: ${customerEmail}\nè®¢å•å·: ${orderName}\n\né‚®ä»¶å°†åŒ…å«ç»“è´¦é“¾æ¥å’Œè®¢å•è¯¦æƒ…ã€‚`)) {
        return;
      }
      
      const response = await fetch(`${API_BASE}/send-invoice-email`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          draftOrderId: orderId,
          customMessage: `æ‚¨çš„3Dæ‰“å°æŠ¥ä»·å·²å®Œæˆï¼\n\nè®¢å•å·: ${orderName}\nè¯·ç‚¹å‡»ä¸‹æ–¹çš„ç»“è´¦é“¾æ¥æŸ¥çœ‹è¯¦æƒ…å¹¶å®Œæˆä»˜æ¬¾ã€‚\n\nå¦‚æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·è”ç³»æˆ‘ä»¬çš„å®¢æœå›¢é˜Ÿã€‚\n\næ„Ÿè°¢æ‚¨é€‰æ‹©æˆ‘ä»¬çš„æœåŠ¡ï¼`
        })
      });
      
      const data = await response.json();
      console.log('å‘é€é‚®ä»¶å“åº”:', data);
      
      if (data.success) {
        alert(`âœ… å‘ç¥¨é‚®ä»¶å‘é€æˆåŠŸï¼\n\nğŸ“§ å·²å‘é€è‡³: ${customerEmail}\nğŸ“‹ è®¢å•å·: ${orderName}\nğŸ’° é‡‘é¢: $${data.totalPrice}\nğŸ”— ç»“è´¦é“¾æ¥: ${data.invoiceUrl}`);
      } else {
        alert('âŒ å‘é€é‚®ä»¶å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
      }
      
    } catch (error) {
      console.error('å‘é€é‚®ä»¶å¤±è´¥:', error);
      alert('âŒ å‘é€é‚®ä»¶å¤±è´¥: ' + error.message);
    }
  }

  // ä¸‹è½½è®¢å•æ–‡ä»¶ï¼ˆåŸºäºä¹‹å‰å·¥ä½œç‰ˆæœ¬çš„å®ç°ï¼‰
  async function downloadOrderFile(orderId) {
    try {
      console.log('å¼€å§‹ä¸‹è½½æ–‡ä»¶ï¼Œè®¢å•ID:', orderId);
      
      const order = currentOrders.find(o => o.id === orderId);
      if (!order) {
        alert('æœªæ‰¾åˆ°è®¢å•ä¿¡æ¯');
        return;
      }

      console.log('è®¢å•è¯¦æƒ…:', order);
      console.log('lineItems:', order.lineItems);

      if (!order.lineItems || order.lineItems.length === 0) {
        alert('è®¢å•ä¸­æ²¡æœ‰å•†å“ä¿¡æ¯');
        return;
      }

      // ä»è®¢å•è·å–æ–‡ä»¶ä¿¡æ¯
      const fileName = order.lineItems?.[0]?.title || 'æœªçŸ¥æ–‡ä»¶';
      const invoiceUrl = order.invoiceUrl;
      const fileId = order.fileId;
      const fileData = order.fileData;
      
      // è·å–æ–‡ä»¶å­˜å‚¨æ–¹å¼ä¿¡æ¯
      const storageMethod = order.lineItems?.[0]?.customAttributes?.find(attr => attr.key === 'æ–‡ä»¶å­˜å‚¨æ–¹å¼')?.value;
      const shopifyFileId = order.lineItems?.[0]?.customAttributes?.find(attr => attr.key === 'Shopifyæ–‡ä»¶ID')?.value;
      
      console.log('è®¢å•æ–‡ä»¶ä¿¡æ¯:', { 
        fileName, 
        invoiceUrl, 
        fileId, 
        fileData: fileData ? 'æœ‰æ•°æ®' : 'æ— æ•°æ®',
        storageMethod,
        shopifyFileId
      });

      // æŒ‰ç…§æ–‡æ¡£æ ‡å‡†æµç¨‹ï¼šä½¿ç”¨æ ‡å‡†çš„downloadFileå‡½æ•°
      await downloadFile(fileData || fileId, fileName);
    } catch (error) {
      console.error('ä¸‹è½½æ–‡ä»¶å¤±è´¥:', error);
      alert('ä¸‹è½½æ–‡ä»¶å¤±è´¥: ' + error.message);
    }
  }

  // æ ‡å‡†æ–‡ä»¶ä¸‹è½½å‡½æ•° - æŒ‰ç…§æ–‡æ¡£æµç¨‹ï¼ˆåŸºäºä¹‹å‰å·¥ä½œç‰ˆæœ¬ï¼‰
  async function downloadFile(url, fileName) {
    try {
      console.log('downloadFileè°ƒç”¨:', { url: url ? url.substring(0, 100) + '...' : 'null', fileName });
      
      // æ£€æŸ¥ URL ç±»å‹ï¼ˆdata:ã€http://ã€https://ï¼‰
      if (url && url.startsWith('data:')) {
        // Base64 æ•°æ®ï¼Œç›´æ¥ä¸‹è½½
        console.log('âœ… æ£€æµ‹åˆ°Base64æ•°æ®ï¼Œç›´æ¥ä¸‹è½½');
        const link = document.createElement('a');
        link.href = url;
        link.download = fileName;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        console.log('âœ… Base64æ–‡ä»¶ä¸‹è½½å®Œæˆ:', fileName);
        return;
      }
      
      if (url && (url.startsWith('http://') || url.startsWith('https://'))) {
        // HTTP/HTTPS URLï¼Œç›´æ¥ä¸‹è½½
        console.log('âœ… æ£€æµ‹åˆ°HTTP URLï¼Œç›´æ¥ä¸‹è½½');
        const link = document.createElement('a');
        link.href = url;
        link.download = fileName;
        link.target = '_blank';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        console.log('âœ… HTTPæ–‡ä»¶ä¸‹è½½å®Œæˆ:', fileName);
        return;
      }
      
      // å…¶ä»–æƒ…å†µï¼Œé€šè¿‡APIä¸‹è½½
      if (url) {
        console.log('âœ… é€šè¿‡APIä¸‹è½½æ–‡ä»¶');
        const response = await fetch(`${API_BASE}/download-file?id=${encodeURIComponent(url)}`);
        
        if (response.ok) {
          const blob = await response.blob();
          const downloadUrl = window.URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = downloadUrl;
          link.download = fileName;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          window.URL.revokeObjectURL(downloadUrl);
          console.log('âœ… APIæ–‡ä»¶ä¸‹è½½å®Œæˆ:', fileName);
          return;
        } else {
          throw new Error(`APIä¸‹è½½å¤±è´¥: ${response.status}`);
        }
      }
      
      throw new Error('æ²¡æœ‰å¯ç”¨çš„æ–‡ä»¶æ•°æ®æˆ–URL');
      
    } catch (error) {
      console.error('downloadFileå¤±è´¥:', error);
      alert('æ–‡ä»¶ä¸‹è½½å¤±è´¥: ' + error.message);
    }
  }



  // é¢„è§ˆè®¢å•æ–‡ä»¶
  async function previewOrderFile(orderId) {
    try {
      const order = currentOrders.find(o => o.id === orderId);
      if (!order) {
        alert('æœªæ‰¾åˆ°è®¢å•ä¿¡æ¯');
        return;
      }

      const lineItem = order.lineItems[0];
      const customAttributes = lineItem.customAttributes || [];
      
      let fileName = 'æœªçŸ¥æ–‡ä»¶';
      let fileData = '';
      
      customAttributes.forEach(attr => {
        if (attr.key === 'æ–‡ä»¶') {
          fileName = attr.value;
        }
        if (attr.key === 'æ–‡ä»¶æ•°æ®') {
          fileData = attr.value;
        }
      });

      // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
      `;
      
      // æ„å»ºå‚æ•°ä¿¡æ¯
      let paramsHtml = '';
      const paramKeys = [
        'ææ–™', 
        'é¢œè‰²', 
        'ç²¾åº¦', 
        'è¡¨é¢ç²—ç³™åº¦', 
        'ç²¾åº¦ç­‰çº§', 
        'å…¬å·®æ ‡å‡†', 
        'é¢œè‰²ä¸è¡¨é¢',
        'æ˜¯å¦æœ‰èºçº¹',
        'æ˜¯å¦æœ‰è£…é…æ ‡è®°',
        'ç¼©æ”¾æ¯”ä¾‹',
        'å¤‡æ³¨'
      ];
      
      paramKeys.forEach(key => {
        const attr = customAttributes.find(a => a.key === key);
        if (attr && attr.value) {
          let displayValue = attr.value;
          
          // ç‰¹æ®Šå¤„ç†æŸäº›å­—æ®µçš„æ˜¾ç¤º
          if (key === 'æ˜¯å¦æœ‰èºçº¹' || key === 'æ˜¯å¦æœ‰è£…é…æ ‡è®°') {
            displayValue = attr.value === 'yes' ? 'æ˜¯' : 'å¦';
          } else if (key === 'ç¼©æ”¾æ¯”ä¾‹') {
            displayValue = attr.value + '%';
          }
          
          paramsHtml += `<p><strong>${key}:</strong> ${displayValue}</p>`;
        }
      });
      
      modal.innerHTML = `
        <div style="
          background: white;
          border-radius: 8px;
          padding: 20px;
          max-width: 600px;
          width: 90%;
          max-height: 80vh;
          overflow-y: auto;
        ">
          <h3>æ–‡ä»¶é¢„è§ˆ</h3>
          <p><strong>æ–‡ä»¶å:</strong> ${fileName}</p>
          <p><strong>è¯¢ä»·å•å·:</strong> ${order.name}</p>
          <p><strong>å®¢æˆ·é‚®ç®±:</strong> ${order.email}</p>
          <p><strong>åˆ›å»ºæ—¶é—´:</strong> ${new Date(order.createdAt).toLocaleString('zh-CN')}</p>
          
          ${paramsHtml ? `
          <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 6px;">
            <h4 style="margin-top: 0; color: #333;">è®¢å•å‚æ•°ä¿¡æ¯</h4>
            ${paramsHtml}
          </div>
          ` : ''}
          
          <div style="text-align: right; margin-top: 20px;">
            <button onclick="this.closest('div').parentElement.remove()" style="
              background: #007bff;
              color: white;
              border: none;
              padding: 8px 16px;
              border-radius: 4px;
              cursor: pointer;
            ">å…³é—­</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          modal.remove();
        }
      });
      
    } catch (error) {
      console.error('é¢„è§ˆæ–‡ä»¶å¤±è´¥:', error);
      alert('é¢„è§ˆæ–‡ä»¶å¤±è´¥: ' + error.message);
    }
  }

  // æ˜¾ç¤ºå®¢æˆ·æ“ä½œæŒ‡å—
  function showCustomerGuide(orderId, email) {
    const order = currentOrders.find(o => o.id === orderId);
    const customerEmail = email || order?.email || 'æœªæä¾›';
    
    const guideContent = `
      <div style="padding: 20px;">
        <div style="margin-bottom: 20px;">
          <div style="margin-bottom: 8px;"><strong>1. è”ç³»å®¢æˆ·</strong></div>
          <div style="margin-left: 16px; margin-bottom: 12px;">
            è¯·é€šè¿‡ä»¥ä¸‹æ–¹å¼è”ç³»å®¢æˆ·ï¼š<br>
            ğŸ“§ é‚®ç®±ï¼š${customerEmail}<br>
            ğŸ“± ç”µè¯æˆ–å…¶ä»–è”ç³»æ–¹å¼
          </div>
          
          <div style="margin-bottom: 8px;"><strong>2. å‘ŠçŸ¥å®¢æˆ·æ“ä½œæ­¥éª¤</strong></div>
          <div style="margin-left: 16px; margin-bottom: 12px;">
            â€¢ è®¿é—®è¯¢ä»·é¡µé¢æŸ¥çœ‹æœ€æ–°çŠ¶æ€<br>
            â€¢ å¦‚æœå·²æŠ¥ä»·ï¼Œç‚¹å‡»"ç«‹å³ä¸‹å•"æŒ‰é’®<br>
            â€¢ å®Œæˆæ”¯ä»˜æµç¨‹<br>
            â€¢ æˆ–ç›´æ¥è”ç³»å®¢æœç¡®è®¤
          </div>
          
          <div style="margin-bottom: 8px;"><strong>3. ç³»ç»Ÿè¯´æ˜</strong></div>
          <div style="margin-left: 16px; color: #666; font-size: 13px;">
            å®¢æˆ·å¯ä»¥é€šè¿‡è¯¢ä»·é¡µé¢å®æ—¶æŸ¥çœ‹æŠ¥ä»·çŠ¶æ€å’Œä¸‹å•ã€‚
          </div>
        </div>
        
        <div style="background: #e3f2fd; padding: 12px; border-radius: 6px; border-left: 4px solid #1976d2;">
          <p style="margin: 0; color: #1976d2; font-size: 14px;">
            <strong>å»ºè®®ï¼š</strong>å®ŒæˆæŠ¥ä»·åï¼Œä¸»åŠ¨è”ç³»å®¢æˆ·ç¡®è®¤å¹¶æŒ‡å¯¼æ“ä½œã€‚
          </p>
        </div>
      </div>
    `;
    
    const modal = document.createElement('div');
    modal.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
    `;
    
    modal.innerHTML = `
      <div style="
        background: white;
        border-radius: 12px;
        padding: 0;
        max-width: 600px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        position: relative;
      ">
        <div style="
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 20px;
          border-bottom: 1px solid #e9ecef;
        ">
          <h3 style="margin: 0; color: #333;">å®¢æˆ·æ“ä½œæŒ‡å—</h3>
          <button onclick="this.closest('.guide-modal').remove()" style="
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
          ">&times;</button>
        </div>
        <div>${guideContent}</div>
      </div>
    `;
    
    modal.className = 'guide-modal';
    document.body.appendChild(modal);
    
    modal.addEventListener('click', function(e) {
      if (e.target === modal) {
        modal.remove();
      }
    });
  }

  // åˆ é™¤æŠ¥ä»·
  async function deleteQuote(orderId) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè¯¢ä»·å•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
      return;
    }

    try {
      console.log('åˆ é™¤è¯¢ä»·å•:', orderId);
      
      const order = currentOrders.find(o => o.id === orderId);
      let fileId = '';
      
      // æŸ¥æ‰¾æ–‡ä»¶ID
      if (order && order.lineItems && order.lineItems.length > 0) {
        const customAttributes = order.lineItems[0].customAttributes || [];
        customAttributes.forEach(attr => {
          if (attr.key === 'æ–‡ä»¶ID' || attr.key === 'fileId') {
            fileId = attr.value;
          }
        });
      }
      
      // å…ˆæ¸…ç†æ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
      if (fileId) {
        try {
          console.log('æ¸…ç†å…³è”æ–‡ä»¶:', fileId);
          await fetch(`${API_BASE}/cleanup-files`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              orderId: orderId,
              fileId: fileId
            })
          });
        } catch (cleanupError) {
          console.warn('æ–‡ä»¶æ¸…ç†å¤±è´¥ï¼Œç»§ç»­åˆ é™¤è®¢å•:', cleanupError);
        }
      }
      
      // åˆ é™¤Draft Order
      const response = await fetch(`${API_BASE}/delete-draft-order`, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          draftOrderId: orderId
        })
      });

      const data = await response.json();
      console.log('åˆ é™¤å“åº”:', data);

      if (data.success) {
        alert('è¯¢ä»·å•åˆ é™¤æˆåŠŸï¼');
        loadOrders(); // é‡æ–°åŠ è½½è®¢å•åˆ—è¡¨
      } else {
        alert('åˆ é™¤å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
      }

    } catch (error) {
      console.error('åˆ é™¤è¯¢ä»·å•å¤±è´¥:', error);
      alert('åˆ é™¤å¤±è´¥: ' + error.message);
    }
  }
</script>
</script>