{% comment %}
  Shopify App Proxy for Quotes API
  Path: /apps/quotes-api
  Returns a JSON-only response
{% endcomment %}

{% comment %} Response headers {% endcomment %}
{% assign response_headers = 'Content-Type: application/json' %}

{% comment %} Handle OPTIONS preflight {% endcomment %}
{% if request.method == 'OPTIONS' %}
  {% assign response_body = '{"message": "CORS preflight", "status": "success"}' %}
  {% assign response_status = 200 %}
{% else %}

  {% comment %} Handle methods {% endcomment %}
  {% if request.method == 'GET' %}
    {% comment %} GET - list quotes {% endcomment %}
    {% assign quotes_data = shop.metafields.custom.quotes_data %}
    {% if quotes_data == blank %}
      {% assign quotes_data = '[]' %}
    {% endif %}
    {% assign response_body = '{"records":' | append: quotes_data | append: ', "status": "success", "count": ' | append: quotes_data | parse_json | size | append: ', "message": "Quotes retrieved successfully"}' %}
    {% assign response_status = 200 %}

  {% elsif request.method == 'POST' %}
    {% comment %} POST - create quote {% endcomment %}
    {% assign request_body = request.body %}
    {% if request_body == blank %}
      {% assign response_body = '{"error": "Request body is required", "status": "error", "code": 400}' %}
      {% assign response_status = 400 %}
    {% else %}
      {% assign new_quote = request_body | parse_json %}
      {% if new_quote == blank %}
        {% assign response_body = '{"error": "Invalid JSON in request body", "status": "error", "code": 400}' %}
        {% assign response_status = 400 %}
      {% else %}
        {% comment %} Generate new id {% endcomment %}
        {% assign new_id = 'now' | date: '%s' %}
        {% assign new_quote_with_id = new_quote | json | prepend: '{"id":"' | append: new_id | append: '",' | append: new_quote | json | slice: 1 %}
        {% assign response_body = new_quote_with_id %}
        {% assign response_status = 201 %}
      {% endif %}
    {% endif %}

  {% elsif request.method == 'PUT' %}
    {% comment %} PUT - update quote {% endcomment %}
    {% assign request_body = request.body %}
    {% if request_body == blank %}
      {% assign response_body = '{"error": "Request body is required", "status": "error", "code": 400}' %}
      {% assign response_status = 400 %}
    {% else %}
      {% assign updated_quote = request_body | parse_json %}
      {% if updated_quote == blank %}
        {% assign response_body = '{"error": "Invalid JSON in request body", "status": "error", "code": 400}' %}
        {% assign response_status = 400 %}
      {% else %}
        {% assign quote_id = request.path | split: '/' | last %}
        {% if quote_id == blank %}
          {% assign response_body = '{"error": "Quote ID is required", "status": "error", "code": 400}' %}
          {% assign response_status = 400 %}
        {% else %}
          {% assign updated_quote_with_id = updated_quote | json | prepend: '{"id":"' | append: quote_id | append: '",' | append: updated_quote | json | slice: 1 %}
          {% assign response_body = updated_quote_with_id %}
          {% assign response_status = 200 %}
        {% endif %}
      {% endif %}
    {% endif %}

  {% elsif request.method == 'DELETE' %}
    {% comment %} DELETE - delete quote {% endcomment %}
    {% assign quote_id = request.path | split: '/' | last %}
    {% if quote_id == blank %}
      {% assign response_body = '{"error": "Quote ID is required", "status": "error", "code": 400}' %}
      {% assign response_status = 400 %}
    {% else %}
      {% assign response_body = '{"message": "Quote deleted successfully", "id": "' | append: quote_id | append: '", "status": "success"}' %}
      {% assign response_status = 200 %}
    {% endif %}

  {% else %}
    {% comment %} Other methods {% endcomment %}
    {% assign response_body = '{"error": "Method not allowed", "status": "error", "code": 405, "allowed_methods": ["GET", "POST", "PUT", "DELETE", "OPTIONS"]}' %}
    {% assign response_status = 405 %}
  {% endif %}

{% endif %}

{% comment %} Output response {% endcomment %}
{{ response_body }}
