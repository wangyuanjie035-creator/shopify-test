{% comment %}
  Shopify App Proxy for Quotes API
  Path: /apps/quotes
{% endcomment %}

{% comment %} Set CORS headers {% endcomment %}
{% assign cors_headers = 'Access-Control-Allow-Origin: *' | split: ', ' %}
{% assign cors_headers = cors_headers | concat: 'Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS' | split: ', ' %}
{% assign cors_headers = cors_headers | concat: 'Access-Control-Allow-Headers: Content-Type, Authorization' | split: ', ' %}

{% comment %} Handle OPTIONS preflight {% endcomment %}
{% if request.method == 'OPTIONS' %}
  {% assign response_headers = cors_headers %}
  {% assign response_body = '' %}
  {% assign response_status = 200 %}
{% else %}

  {% comment %} GET - list quotes {% endcomment %}
  {% if request.method == 'GET' %}
    {% comment %} Read quotes from Shopify metafields {% endcomment %}
    {% assign quotes_data = shop.metafields.custom.quotes_data %}
    {% if quotes_data == blank %}
      {% assign quotes_data = '[]' %}
    {% endif %}
    
    {% assign response_body = '{"records":' | append: quotes_data | append: '}' %}
    {% assign response_headers = cors_headers | concat: 'Content-Type: application/json' | split: ', ' %}
    {% assign response_status = 200 %}

  {% comment %} POST - create quote {% endcomment %}
  {% elsif request.method == 'POST' %}
    {% comment %} Parse request body {% endcomment %}
    {% assign request_body = request.body %}
    {% assign new_quote = request_body | parse_json %}
    
    {% comment %} Generate new id {% endcomment %}
    {% assign new_id = 'now' | date: '%s' %}
    {% assign new_quote_with_id = new_quote | json | prepend: '{"id":"' | append: new_id | append: '",' | append: new_quote | json | slice: 1 %}
    
    {% comment %} Read existing quotes {% endcomment %}
    {% assign existing_quotes = shop.metafields.custom.quotes_data %}
    {% if existing_quotes == blank %}
      {% assign existing_quotes = '[]' %}
    {% endif %}
    
    {% comment %} Append new quote {% endcomment %}
    {% assign quotes_array = existing_quotes | parse_json %}
    {% assign quotes_array = quotes_array | concat: new_quote_with_id | parse_json %}
    {% assign updated_quotes = quotes_array | json %}
    
    {% comment %} Persisting to metafields requires Shopify Admin API (not implemented here) {% endcomment %}
    {% comment %} Return the new quote for now {% endcomment %}
    {% assign response_body = new_quote_with_id %}
    {% assign response_headers = cors_headers | concat: 'Content-Type: application/json' | split: ', ' %}
    {% assign response_status = 201 %}

  {% comment %} PUT - update quote {% endcomment %}
  {% elsif request.method == 'PUT' %}
    {% assign quote_id = request.path | split: '/' | last %}
    {% assign request_body = request.body %}
    {% assign updated_quote = request_body | parse_json %}
    {% assign updated_quote_with_id = updated_quote | json | prepend: '{"id":"' | append: quote_id | append: '",' | append: updated_quote | json | slice: 1 %}
    
    {% assign response_body = updated_quote_with_id %}
    {% assign response_headers = cors_headers | concat: 'Content-Type: application/json' | split: ', ' %}
    {% assign response_status = 200 %}

  {% comment %} DELETE - delete quote {% endcomment %}
  {% elsif request.method == 'DELETE' %}
    {% assign quote_id = request.path | split: '/' | last %}
    
    {% assign response_body = 'Quote deleted' %}
    {% assign response_headers = cors_headers | concat: 'Content-Type: text/plain' | split: ', ' %}
    {% assign response_status = 200 %}

  {% comment %} Other methods {% endcomment %}
  {% else %}
    {% assign response_body = 'Method not allowed' %}
    {% assign response_headers = cors_headers | concat: 'Content-Type: text/plain' | split: ', ' %}
    {% assign response_status = 405 %}
  {% endif %}

{% endif %}

{% comment %} Output response {% endcomment %}
{{ response_body }}
