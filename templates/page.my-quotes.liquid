{% comment %}
  è‰ç¨¿è®¢å•è¯¦æƒ…é¡µ
  URL: /pages/my-quotes?id=<draftOrderId>
  åŠŸèƒ½ï¼šæ˜¾ç¤ºè‰ç¨¿è®¢å•è¯¦æƒ…ï¼Œå®¢æˆ·å¯ä»¥æŸ¥çœ‹æŠ¥ä»·å¹¶ç‚¹å‡»"ç«‹å³ä¸‹å•"æ·»åŠ åˆ°è´­ç‰©è½¦
  å®‰å…¨ï¼šéœ€è¦å®¢æˆ·ç™»å½•æ‰èƒ½æŸ¥çœ‹
{% endcomment %}

<!-- å®¢æˆ·ç™»å½•æ£€æŸ¥ -->
{% unless customer %}
<div class="customer-login-required">
  <div class="login-prompt-card">
    <div class="login-prompt-icon">ğŸ”’</div>
    <h2>éœ€è¦ç™»å½•</h2>
    <p>è¯·å…ˆç™»å½•æ‚¨çš„è´¦æˆ·ä»¥æŸ¥çœ‹æ‚¨çš„è¯¢ä»·å•</p>
    <div class="login-actions">
      <a href="/account/login?return_url={{ request.path | url_encode }}" class="login-link-btn primary">
        <span class="btn-icon">ğŸ”</span>
        ç™»å½•è´¦æˆ·
      </a>
      <a href="/account/register?return_url={{ request.path | url_encode }}" class="login-link-btn secondary">
        <span class="btn-icon">âœ¨</span>
        æ³¨å†Œæ–°è´¦æˆ·
      </a>
    </div>
  </div>
</div>

<style>
  .customer-login-required {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding: 20px;
  }

  .login-prompt-card {
    background: white;
    border-radius: 16px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    padding: 50px 40px;
    max-width: 450px;
    width: 100%;
    text-align: center;
    animation: slideIn 0.3s ease-out;
  }

  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(-20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .login-prompt-icon {
    font-size: 64px;
    margin-bottom: 20px;
  }

  .login-prompt-card h2 {
    color: #333;
    font-size: 28px;
    margin: 0 0 15px 0;
  }

  .login-prompt-card p {
    color: #666;
    font-size: 16px;
    margin: 0 0 30px 0;
    line-height: 1.6;
  }

  .login-actions {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .login-link-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    padding: 14px 28px;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    text-decoration: none;
    transition: all 0.2s ease;
    cursor: pointer;
  }

  .login-link-btn.primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
  }

  .login-link-btn.primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(102,126,234,0.4);
  }

  .login-link-btn.secondary {
    background: white;
    color: #667eea;
    border: 2px solid #667eea;
  }

  .login-link-btn.secondary:hover {
    background: #f8f9ff;
    transform: translateY(-2px);
  }
</style>

{% else %}
<!-- å®¢æˆ·å·²ç™»å½•ï¼Œæ˜¾ç¤ºè¯¢ä»·å†…å®¹ -->
<div class="customer-authenticated" data-customer-email="{{ customer.email }}">

<style>
  .quote-detail-container {
    max-width: 1200px;
    margin: 40px auto;
    padding: 0 20px;
  }
  
  .quote-header {
    background: white;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 24px;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
  }
  
  .quote-actions {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .refresh-btn {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    padding: 8px 12px;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .refresh-btn:hover {
    background: #e9ecef;
    border-color: #adb5bd;
  }
  
    .refresh-btn:active {
      transform: rotate(180deg);
    }
    
    /* è®¢å•åˆ—è¡¨æ ·å¼ */
    .orders-list-container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .orders-list-header {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .orders-list-header h2 {
      color: #333;
      margin-bottom: 10px;
    }
    
    .orders-list-header p {
      color: #666;
      font-size: 14px;
    }
    
    .orders-list {
      display: grid;
      gap: 20px;
    }
    
    .order-card {
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .order-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      border-color: #007bff;
    }
    
    .order-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .order-number {
      font-weight: bold;
      font-size: 16px;
      color: #333;
    }
    
    .order-status {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .order-card-body {
      margin-bottom: 15px;
    }
    
    .order-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .order-date {
      color: #666;
      font-size: 14px;
    }
    
    .order-total {
      font-weight: bold;
      color: #e74c3c;
      font-size: 16px;
    }
    
    .order-items {
      margin-top: 10px;
    }
    
    .order-item {
      color: #666;
      font-size: 14px;
      margin-bottom: 5px;
    }
    
    .order-item-more {
      color: #999;
      font-size: 12px;
      font-style: italic;
    }
    
    .order-card-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }
    
    .order-card-actions .btn {
      padding: 8px 16px;
      font-size: 14px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .order-card-actions .btn-primary {
      background: #007bff;
      color: white;
    }
    
    .order-card-actions .btn-primary:hover {
      background: #0056b3;
    }
    
    .order-card-actions .btn-danger {
      background: #dc3545;
      color: white;
    }
    
    .order-card-actions .btn-danger:hover {
      background: #c82333;
    }
    
    /* ç©ºçŠ¶æ€æ ·å¼ */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
    }
    
    .empty-state-content {
      max-width: 400px;
      margin: 0 auto;
    }
    
    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 20px;
    }
    
    .empty-state h3 {
      color: #333;
      margin-bottom: 10px;
    }
    
    .empty-state p {
      color: #666;
      margin-bottom: 30px;
    }
    
    .empty-state .btn {
      padding: 12px 24px;
      background: #007bff;
      color: white;
      text-decoration: none;
      border-radius: 6px;
      font-weight: 500;
      transition: background 0.2s ease;
    }
    
    .empty-state .btn:hover {
      background: #0056b3;
      color: white;
    }
  
  .quote-title {
    font-size: 28px;
    font-weight: 600;
    color: #333;
    margin-bottom: 12px;
  }
  
  .quote-meta {
    display: flex;
    gap: 24px;
    flex-wrap: wrap;
    color: #666;
    font-size: 14px;
  }
  
  .quote-meta-item {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .quote-status {
    padding: 6px 16px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: 500;
  }
  
  .status-pending {
    background: #fff3cd;
    color: #856404;
  }
  
  .status-quoted {
    background: #d4edda;
    color: #155724;
  }
  
  
  .quote-items {
    background: white;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 24px;
  }
  
  .section-title {
    font-size: 20px;
    font-weight: 600;
    color: #333;
    margin-bottom: 20px;
    padding-bottom: 12px;
    border-bottom: 2px solid #f0f0f0;
  }
  
  .item-card {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 16px;
  }
  
  .item-card:last-child {
    margin-bottom: 0;
  }
  
  .item-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
  }
  
  .item-name {
    font-size: 18px;
    font-weight: 600;
    color: #333;
  }
  
  .item-price {
    font-size: 24px;
    font-weight: 600;
    color: #e91e63;
  }
  
  .item-details {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 12px;
    font-size: 14px;
    color: #666;
  }
  
  .item-detail {
    display: flex;
    flex-direction: column;
  }
  
  .detail-label {
    font-weight: 500;
    color: #333;
    margin-bottom: 4px;
  }
  
  .quote-summary {
    background: white;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 24px;
  }
  
  .summary-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid #f0f0f0;
  }
  
  .summary-row:last-child {
    border-bottom: none;
    padding-top: 20px;
    margin-top: 12px;
    border-top: 2px solid #333;
  }
  
  .summary-label {
    font-size: 16px;
    color: #666;
  }
  
  .summary-value {
    font-size: 16px;
    font-weight: 500;
    color: #333;
  }
  
  .summary-total {
    font-size: 24px !important;
    font-weight: 600 !important;
    color: #e91e63 !important;
  }
  
  .quote-actions {
    display: flex;
    gap: 16px;
    justify-content: flex-end;
  }
  
  .btn {
    padding: 14px 28px;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 500;
    cursor: pointer;
    border: none;
    transition: all 0.3s ease;
  }
  
  .btn-secondary {
    background: #f5f5f5;
    color: #333;
    border: 1px solid #e0e0e0;
  }
  
  .btn-secondary:hover {
    background: #e0e0e0;
  }
  
  .btn-primary {
    background: #e91e63;
    color: white;
  }
  
  .btn-primary:hover {
    background: #c2185b;
  }
  
  .btn-primary:disabled {
    background: #ccc;
    cursor: not-allowed;
  }
  
  .loading {
    text-align: center;
    padding: 60px 20px;
    color: #666;
  }
  
  .loading-spinner {
    width: 48px;
    height: 48px;
    border: 4px solid #f0f0f0;
    border-top: 4px solid #e91e63;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 20px;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  .error {
    background: #ffebee;
    color: #c62828;
    padding: 20px;
    border-radius: 8px;
    border: 1px solid #ef5350;
    margin: 20px 0;
  }
  
  @media (max-width: 768px) {
    .quote-meta {
      flex-direction: column;
      gap: 12px;
    }
    
    .item-details {
      grid-template-columns: 1fr;
    }
    
    .quote-actions {
      flex-direction: column;
    }
    
    .btn {
      width: 100%;
    }
  }
</style>

<div class="quote-detail-container">
  <div id="loading-state" class="loading">
    <div class="loading-spinner"></div>
    <p>æ­£åœ¨åŠ è½½è®¢å•è¯¦æƒ…...</p>
  </div>
  
  <div id="error-state" style="display: none;">
    <div class="error">
      <p id="error-message"></p>
    </div>
    <div class="quote-actions">
      <a href="/pages/model-uploader" class="btn btn-secondary">è¿”å›ä¸Šä¼ é¡µé¢</a>
      <button id="retry-create-btn" class="btn btn-primary" onclick="retryCreateOrder()" style="display: none;">é‡æ–°åˆ›å»ºè®¢å•</button>
    </div>
  </div>
  
  <div id="quote-detail" style="display: none;">
    <div class="quote-header">
      <div class="quote-title" id="order-number">è®¢å• #--</div>
      <div class="quote-actions">
        <button id="refreshBtn" class="refresh-btn" onclick="refreshOrderStatus()" title="åˆ·æ–°è®¢å•çŠ¶æ€">
          ğŸ”„ åˆ·æ–°
        </button>
      </div>
      <div class="quote-meta">
        <div class="quote-meta-item">
          <strong>çŠ¶æ€:</strong>
          <span class="quote-status" id="order-status">å¾…æŠ¥ä»·</span>
        </div>
        <div class="quote-meta-item">
          <strong>åˆ›å»ºæ—¶é—´:</strong>
          <span id="order-date">--</span>
        </div>
        <div class="quote-meta-item">
          <strong>å®¢æˆ·:</strong>
          <span id="customer-name">--</span>
        </div>
      </div>
    </div>
    
    <div class="quote-items">
      <div class="section-title">è®¢å•é¡¹ç›®</div>
      <div id="items-list"></div>
    </div>
    
    <div class="quote-summary">
      <div class="section-title">è´¹ç”¨æ±‡æ€»</div>
      <div class="summary-row">
        <span class="summary-label">å°è®¡</span>
        <span class="summary-value" id="subtotal">$0.00</span>
      </div>
      <div class="summary-row">
        <span class="summary-label">è¿è´¹</span>
        <span class="summary-value">å¾…ç¡®å®š</span>
      </div>
      <div class="summary-row">
        <span class="summary-label summary-total">æ€»è®¡</span>
        <span class="summary-value summary-total" id="total">$0.00</span>
      </div>
    </div>
    
    <div class="quote-actions">
      <button class="btn btn-secondary" onclick="downloadAllFiles()">ğŸ“¥ ä¸‹è½½æ–‡ä»¶</button>
      <a href="/pages/model-uploader" class="btn btn-secondary">ç»§ç»­ä¸Šä¼ </a>
      <button id="place-order-btn" class="btn btn-primary" onclick="placeOrder()">ç«‹å³ä¸‹å•</button>
    </div>
  </div>
</div>

<script>
// APIé…ç½®
const API_BASE = 'https://shopify-13s4.vercel.app/api';
const customerEmail = (document.querySelector('.customer-authenticated')?.dataset.customerEmail || '').toLowerCase();
const ADMIN_EMAILS = ['jonathan.wang@sainstore.com'];
const isAdmin = ADMIN_EMAILS.some(e => e.toLowerCase() === customerEmail);
const authParams = () => isAdmin
  ? `admin=1&email=${encodeURIComponent(customerEmail)}`
  : `email=${encodeURIComponent(customerEmail)}`;
const authQuery = authParams();

// ä»URLè·å–è®¢å•ID
const urlParams = new URLSearchParams(window.location.search);
const draftOrderId = urlParams.get('id');

console.log('è‰ç¨¿è®¢å•ID:', draftOrderId);

// é¡µé¢åŠ è½½æ—¶è·å–è®¢å•è¯¦æƒ…
document.addEventListener('DOMContentLoaded', async function() {
  if (!customerEmail) {
    showError('æœªèƒ½è·å–å½“å‰è´¦æˆ·é‚®ç®±ï¼Œæ— æ³•åŠ è½½è¯¢ä»·å•ã€‚è¯·é‡æ–°ç™»å½•ã€‚');
    return;
  }
  if (!draftOrderId) {
    // å¦‚æœæ²¡æœ‰æŒ‡å®šè®¢å•IDï¼Œæ˜¾ç¤ºæ‰€æœ‰è®¢å•åˆ—è¡¨
    console.log('æœªæŒ‡å®šè®¢å•IDï¼ŒåŠ è½½æ‰€æœ‰è®¢å•åˆ—è¡¨');
    await loadAllOrders();
    return;
  }
  
  try {
    await loadOrderDetails();
    
    // è®¾ç½®å®šæ—¶åˆ·æ–°ï¼Œæ¯30ç§’æ£€æŸ¥ä¸€æ¬¡è®¢å•çŠ¶æ€æ›´æ–°
    setInterval(() => {
      console.log('â° å®šæ—¶åˆ·æ–°è®¢å•çŠ¶æ€...');
      refreshOrderStatus();
    }, 30000); // 30ç§’åˆ·æ–°ä¸€æ¬¡
  } catch (error) {
    console.error('åŠ è½½è®¢å•è¯¦æƒ…å¤±è´¥:', error);
    showError('åŠ è½½è®¢å•è¯¦æƒ…å¤±è´¥: ' + error.message);
  }
});

// åˆ·æ–°è®¢å•çŠ¶æ€å‡½æ•°
async function refreshOrderStatus() {
  try {
    console.log('ğŸ”„ åˆ·æ–°è®¢å•çŠ¶æ€:', draftOrderId);
    
    // ç›´æ¥æŸ¥è¯¢æœ€æ–°çš„è®¢å•è¯¦æƒ…
    const response = await fetch(`${API_BASE}/get-draft-order-simple?id=${encodeURIComponent(draftOrderId)}&${authQuery}`);
    
    if (response.ok) {
      const data = await response.json();
      
      if (data.success && data.draftOrder) {
        const newOrder = data.draftOrder;
        const currentOrder = window.currentDraftOrder;
        
        // æ£€æŸ¥æ˜¯å¦æœ‰çŠ¶æ€æˆ–ä»·æ ¼å˜åŒ–
        if (currentOrder) {
          // è·å–å½“å‰çŠ¶æ€
          const currentStatus = getOrderStatus(currentOrder);
          const newStatus = getOrderStatus(newOrder);
          
          const statusChanged = currentStatus.text !== newStatus.text;
          const priceChanged = currentOrder.totalPrice !== newOrder.totalPrice;
          
          // ä¹Ÿæ£€æŸ¥è‡ªå®šä¹‰å±æ€§ä¸­çš„çŠ¶æ€å˜åŒ–
          let customStatusChanged = false;
          if (currentOrder.lineItems && newOrder.lineItems && 
              currentOrder.lineItems.length > 0 && newOrder.lineItems.length > 0) {
            const currentCustomStatus = currentOrder.lineItems[0].customAttributes?.find(a => a.key === 'çŠ¶æ€')?.value;
            const newCustomStatus = newOrder.lineItems[0].customAttributes?.find(a => a.key === 'çŠ¶æ€')?.value;
            customStatusChanged = currentCustomStatus !== newCustomStatus;
          }
          
          if (statusChanged || priceChanged || customStatusChanged) {
            console.log('ğŸ“Š æ£€æµ‹åˆ°è®¢å•æ›´æ–°:', {
              statusChanged,
              priceChanged,
              customStatusChanged,
              oldStatus: currentStatus.text,
              newStatus: newStatus.text,
              oldPrice: currentOrder.totalPrice,
              newPrice: newOrder.totalPrice
            });
            
            // æ›´æ–°å½“å‰è®¢å•æ•°æ®
            window.currentDraftOrder = newOrder;
            
            // é‡æ–°æ¸²æŸ“è®¢å•è¯¦æƒ…
            renderOrderDetails(newOrder);
            
            // æ˜¾ç¤ºæ›´æ–°é€šçŸ¥
            showSuccessMessage('è®¢å•çŠ¶æ€å·²æ›´æ–°ï¼', 3000);
          }
        } else {
          // å¦‚æœæ²¡æœ‰å½“å‰è®¢å•æ•°æ®ï¼Œç›´æ¥åŠ è½½
          window.currentDraftOrder = newOrder;
          renderOrderDetails(newOrder);
        }
      }
    }
  } catch (error) {
    console.warn('âš ï¸ åˆ·æ–°è®¢å•çŠ¶æ€å¤±è´¥:', error);
  }
}

// åŠ è½½è®¢å•è¯¦æƒ…
async function loadOrderDetails() {
  console.log('å¼€å§‹åŠ è½½è®¢å•è¯¦æƒ…...');
  console.log('è‰ç¨¿è®¢å•ID:', draftOrderId);
  
  try {
    // å…ˆæ£€æŸ¥æ‰€æœ‰è‰ç¨¿è®¢å•
    console.log('æ£€æŸ¥æ‰€æœ‰è‰ç¨¿è®¢å•...');
    const listResponse = await fetch(`${API_BASE}/get-draft-orders?${authQuery}`);
    const listData = await listResponse.json();
    console.log('è‰ç¨¿è®¢å•åˆ—è¡¨:', listData);
    
    if (listData.success && listData.draftOrders.length === 0) {
      console.log('è‰ç¨¿è®¢å•åˆ—è¡¨ä¸ºç©ºï¼Œç»§ç»­å°è¯•ç›´æ¥æŸ¥è¯¢...');
      // ä¸è¦ç›´æ¥æŠ›å‡ºé”™è¯¯ï¼Œç»§ç»­å°è¯•ç›´æ¥æŸ¥è¯¢
    }
    
    // æŸ¥æ‰¾åŒ¹é…çš„è®¢å•
    let foundOrder = null;
    if (listData.success && listData.draftOrders.length > 0) {
      console.log('æœç´¢è®¢å•ID:', draftOrderId);
      console.log('è®¢å•åˆ—è¡¨:', listData.draftOrders.map(o => ({ id: o.id, name: o.name })));
      
      foundOrder = listData.draftOrders.find(order => {
        // å¤šç§åŒ¹é…æ–¹å¼
        const matches = [
          order.id === draftOrderId,
          order.id === decodeURIComponent(draftOrderId),
          order.name === draftOrderId,
          order.name === decodeURIComponent(draftOrderId),
          // å¦‚æœdraftOrderIdæ˜¯æ•°å­—IDï¼Œå°è¯•åŒ¹é…GID
          order.id === `gid://shopify/DraftOrder/${draftOrderId}`,
          order.id === `gid://shopify/DraftOrder/${decodeURIComponent(draftOrderId)}`,
          // æå–GIDä¸­çš„æ•°å­—éƒ¨åˆ†è¿›è¡ŒåŒ¹é…
          order.id && order.id.includes(draftOrderId.replace(/\D/g, '')),
          order.id && order.id.includes(decodeURIComponent(draftOrderId).replace(/\D/g, ''))
        ];
        
        const isMatch = matches.some(match => match);
        if (isMatch) {
          console.log('âœ… æ‰¾åˆ°åŒ¹é…è®¢å•:', { 
            searchId: draftOrderId, 
            orderId: order.id, 
            orderName: order.name 
          });
        }
        return isMatch;
      });
      
      if (foundOrder) {
        console.log('åœ¨åˆ—è¡¨ä¸­æ‰¾åˆ°è®¢å•:', foundOrder);
        // ä½¿ç”¨æ‰¾åˆ°çš„è®¢å•æ•°æ®
        window.currentDraftOrder = foundOrder;
        renderOrderDetails(foundOrder);
        return;
      } else {
        console.log('âŒ åœ¨è®¢å•åˆ—è¡¨ä¸­æœªæ‰¾åˆ°åŒ¹é…çš„è®¢å•');
      }
    }
    
    // å¦‚æœåˆ—è¡¨ä¸­æ²¡æœ‰æ‰¾åˆ°ï¼Œå°è¯•ç›´æ¥æŸ¥è¯¢
    console.log('å°è¯•ç›´æ¥æŸ¥è¯¢è®¢å•è¯¦æƒ…...');
    const response = await fetch(`${API_BASE}/get-draft-order-simple?id=${encodeURIComponent(draftOrderId)}&${authQuery}`);
    
    if (!response.ok) {
      if (response.status === 404) {
        throw new Error('è‰ç¨¿è®¢å•ä¸å­˜åœ¨ï¼Œå¯èƒ½å·²è¢«åˆ é™¤æˆ–ä»æœªåˆ›å»ºã€‚è¯·é‡æ–°æäº¤è¯¢ä»·ã€‚');
      }
      throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
    }
    
    const data = await response.json();
    console.log('è®¢å•è¯¦æƒ…:', data);
    
    if (!data.draftOrder) {
      throw new Error('è®¢å•æ•°æ®ä¸ºç©º');
    }
    
    // ä¿å­˜è®¢å•æ•°æ®åˆ°å…¨å±€å˜é‡
    window.currentDraftOrder = data.draftOrder;
    
    // è·å–æ‰©å±•çŠ¶æ€ä¿¡æ¯
    
    // æ¸²æŸ“è®¢å•è¯¦æƒ…
    renderOrderDetails(data.draftOrder);
    
  } catch (error) {
    console.error('åŠ è½½è®¢å•è¯¦æƒ…å¤±è´¥:', error);
    throw error;
  }
}


// æ¸²æŸ“è®¢å•è¯¦æƒ…
function renderOrderDetails(order) {
  console.log('æ¸²æŸ“è®¢å•è¯¦æƒ…:', order);
  
  // æ›´æ–°è®¢å•å·
  const orderNumberEl = document.getElementById('order-number');
  orderNumberEl.textContent = `è®¢å• #${order.name || order.id}`;
  
  // æ›´æ–°çŠ¶æ€
  const statusEl = document.getElementById('order-status');
  const status = getOrderStatus(order);
  statusEl.textContent = status.text;
  statusEl.className = `quote-status ${status.className}`;
  
  // æ›´æ–°æ—¥æœŸ
  const dateEl = document.getElementById('order-date');
  dateEl.textContent = formatDate(order.createdAt);
  
  // æ›´æ–°å®¢æˆ·åç§°
  const customerEl = document.getElementById('customer-name');
  customerEl.textContent = order.email || 'æœªçŸ¥å®¢æˆ·';
  
  // æ¸²æŸ“è®¢å•é¡¹ç›®
  const itemsList = document.getElementById('items-list');
  itemsList.innerHTML = '';
  
  if (order.lineItems && order.lineItems.length > 0) {
    order.lineItems.forEach(item => {
      const itemCard = createItemCard(item);
      itemsList.appendChild(itemCard);
    });
  }
  
  // æ›´æ–°ä»·æ ¼
  updatePrices(order);
  
  // æ›´æ–°æŒ‰é’®çŠ¶æ€
  updateButtonState(order);
  
  // æ˜¾ç¤ºè®¢å•è¯¦æƒ…ï¼Œéšè—åŠ è½½çŠ¶æ€
  document.getElementById('loading-state').style.display = 'none';
  document.getElementById('quote-detail').style.display = 'block';
}

// åˆ›å»ºè®¢å•é¡¹ç›®å¡ç‰‡
function createItemCard(item) {
  const card = document.createElement('div');
  card.className = 'item-card';
  
  // è·å–ä»·æ ¼ï¼šä¼˜å…ˆä» originalUnitPriceï¼Œå…¶æ¬¡ä» price
  let price = 0;
  if (item.originalUnitPrice) {
    price = parseFloat(item.originalUnitPrice);
  } else if (item.price) {
    price = parseFloat(item.price);
  }
  
  const quantity = item.quantity || 1;
  const itemTotal = price * quantity;
  
  console.log('é¡¹ç›®ä»·æ ¼:', { 
    originalUnitPrice: item.originalUnitPrice, 
    price: item.price, 
    calculatedPrice: price,
    quantity,
    itemTotal
  });
  
  // è·å–è‡ªå®šä¹‰å±æ€§
  const attrs = item.customAttributes || [];
  const getAttribute = (key) => {
    const attr = attrs.find(a => a.key === key);
    return attr ? attr.value : '';
  };
  
  card.innerHTML = `
    <div class="item-header">
      <div class="item-name">${item.title || 'æœªå‘½åé¡¹ç›®'}</div>
      <div class="item-price">${price > 0 ? `$${itemTotal.toFixed(2)}` : 'å¾…æŠ¥ä»·'}</div>
    </div>
    <div class="item-details">
      <div class="item-detail">
        <span class="detail-label">æ•°é‡</span>
        <span>${quantity}</span>
      </div>
      <div class="item-detail">
        <span class="detail-label">ææ–™</span>
        <span>${getAttribute('ææ–™') || 'æœªæŒ‡å®š'}</span>
      </div>
      <div class="item-detail">
        <span class="detail-label">é¢œè‰²ä¸è¡¨é¢</span>
        <span>${getAttribute('é¢œè‰²ä¸è¡¨é¢') || 'è‡ªç„¶è‰²'}</span>
      </div>
      <div class="item-detail">
        <span class="detail-label">ç²¾åº¦ç­‰çº§</span>
        <span>${getAttribute('ç²¾åº¦ç­‰çº§') || 'æ ‡å‡†'}</span>
      </div>
      <div class="item-detail">
        <span class="detail-label">å…¬å·®æ ‡å‡†</span>
        <span>${getAttribute('å…¬å·®æ ‡å‡†') || 'GB/T 1804-2000 mçº§'}</span>
      </div>
      <div class="item-detail">
        <span class="detail-label">è¡¨é¢ç²—ç³™åº¦</span>
        <span>${getAttribute('è¡¨é¢ç²—ç³™åº¦') || 'Ra3.2'}</span>
      </div>
      ${getAttribute('å¤‡æ³¨') ? `
      <div class="item-detail" style="grid-column: 1 / -1;">
        <span class="detail-label">å¤‡æ³¨</span>
        <span>${getAttribute('å¤‡æ³¨')}</span>
      </div>
      ` : ''}
    </div>
  `;
  
  return card;
}

// æ›´æ–°ä»·æ ¼
function updatePrices(order) {
  let subtotal = 0;
  
  // ä¼˜å…ˆä»totalPriceè·å–
  if (order.totalPrice) {
    subtotal = parseFloat(order.totalPrice);
    console.log('ä»order.totalPriceè·å–ä»·æ ¼:', subtotal);
  } 
  // å¦‚æœæ²¡æœ‰totalPriceï¼Œå°è¯•ä»lineItemsè®¡ç®—
  else if (order.lineItems && order.lineItems.length > 0) {
    order.lineItems.forEach(item => {
      const price = parseFloat(item.originalUnitPrice || item.price || 0);
      const quantity = item.quantity || 1;
      subtotal += price * quantity;
    });
    console.log('ä»lineItemsè®¡ç®—ä»·æ ¼:', subtotal);
  }
  
  const formattedPrice = subtotal > 0 ? `$${subtotal.toFixed(2)}` : 'å¾…æŠ¥ä»·';
  
  document.getElementById('subtotal').textContent = formattedPrice;
  document.getElementById('total').textContent = formattedPrice;
  
  console.log('ä»·æ ¼æ˜¾ç¤º:', formattedPrice);
}

// æ›´æ–°æŒ‰é’®çŠ¶æ€
function updateButtonState(order) {
  const placeOrderBtn = document.getElementById('place-order-btn');
  
  // æ£€æŸ¥æ˜¯å¦å·²æŠ¥ä»·
  let isQuoted = false;
  
  // ä¼˜å…ˆæ£€æŸ¥è‡ªå®šä¹‰å±æ€§ä¸­çš„çŠ¶æ€
  if (order.lineItems && order.lineItems.length > 0) {
    const firstItem = order.lineItems[0];
    const attrs = firstItem.customAttributes || [];
    const statusAttr = attrs.find(a => a.key === 'çŠ¶æ€');
    
    if (statusAttr && statusAttr.value === 'å·²æŠ¥ä»·') {
      isQuoted = true;
      console.log('âœ… ä»è‡ªå®šä¹‰å±æ€§ç¡®è®¤å·²æŠ¥ä»·');
    }
  }
  
  // å›é€€åˆ°æ£€æŸ¥totalPrice
  if (!isQuoted) {
    const totalPrice = parseFloat(order.totalPrice || 0);
    if (totalPrice > 0) {
      isQuoted = true;
      console.log('âœ… ä»totalPriceç¡®è®¤å·²æŠ¥ä»·:', totalPrice);
    }
  }
  
  if (!isQuoted) {
    placeOrderBtn.disabled = true;
    placeOrderBtn.textContent = 'ç­‰å¾…æŠ¥ä»·';
    placeOrderBtn.style.opacity = '0.6';
    placeOrderBtn.style.cursor = 'not-allowed';
    console.log('â³ æŒ‰é’®çŠ¶æ€: ç­‰å¾…æŠ¥ä»·ï¼ˆç¦ç”¨ï¼‰');
  } else {
    placeOrderBtn.disabled = false;
    placeOrderBtn.textContent = 'ç«‹å³ä¸‹å•';
    placeOrderBtn.style.opacity = '1';
    placeOrderBtn.style.cursor = 'pointer';
    console.log('âœ… æŒ‰é’®çŠ¶æ€: ç«‹å³ä¸‹å•ï¼ˆå¯ç”¨ï¼‰');
  }
}

// è·å–è®¢å•çŠ¶æ€
function getOrderStatus(order) {
  // ä¼˜å…ˆæ£€æŸ¥è‡ªå®šä¹‰å±æ€§ä¸­çš„çŠ¶æ€
  if (order.lineItems && order.lineItems.length > 0) {
    const firstItem = order.lineItems[0];
    const attrs = firstItem.customAttributes || [];
    const statusAttr = attrs.find(a => a.key === 'çŠ¶æ€');
    
    if (statusAttr) {
      const status = statusAttr.value;
      console.log('ä»è‡ªå®šä¹‰å±æ€§è·å–çŠ¶æ€:', status);
      
      if (status === 'å·²æŠ¥ä»·') {
        return {
          text: 'å·²æŠ¥ä»·',
          className: 'status-quoted'
        };
      }
    }
  }
  
  // å›é€€åˆ°æ£€æŸ¥totalPrice
  const totalPrice = parseFloat(order.totalPrice || 0);
  console.log('ä»totalPriceåˆ¤æ–­çŠ¶æ€:', totalPrice);
  
  if (totalPrice > 0) {
    return {
      text: 'å·²æŠ¥ä»·',
      className: 'status-quoted'
    };
  } else {
    return {
      text: 'å¾…æŠ¥ä»·',
      className: 'status-pending'
    };
  }
}

// æ ¼å¼åŒ–æ—¥æœŸ
function formatDate(dateString) {
  if (!dateString) return '--';
  
  try {
    const date = new Date(dateString);
    return date.toLocaleString('zh-CN', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit'
    });
  } catch (error) {
    console.error('æ—¥æœŸæ ¼å¼åŒ–å¤±è´¥:', error);
    return '--';
  }
}

// ç«‹å³ä¸‹å•ï¼ˆæ·»åŠ åˆ°è´­ç‰©è½¦ï¼‰
async function placeOrder() {
  const order = window.currentDraftOrder;
  
  if (!order) {
    alert('è®¢å•æ•°æ®æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
    return;
  }
  
  const totalPrice = parseFloat(order.totalPrice || 0);
  
  if (totalPrice <= 0) {
    alert('è®¢å•å°šæœªæŠ¥ä»·ï¼Œè¯·ç­‰å¾…å®¢æœæŠ¥ä»·åå†ä¸‹å•');
    return;
  }

  // å¦‚æœå·²æœ‰æ”¯ä»˜é“¾æ¥ï¼ˆå¯èƒ½å·²ç”Ÿæˆ/å·²æ”¯ä»˜ï¼‰ï¼Œç›´æ¥è·³è½¬ï¼Œé¿å…é‡å¤å®Œæˆè‰ç¨¿è®¢å•
  if (order.invoiceUrl) {
    if (confirm('æ£€æµ‹åˆ°è¯¥è®¢å•å·²æœ‰æ”¯ä»˜é“¾æ¥ï¼Œæ˜¯å¦ç›´æ¥å‰å¾€ç»“è´¦ï¼Ÿ')) {
      window.location.href = order.invoiceUrl;
      return;
    }
  }
  
  // ç¡®è®¤ä¸‹å•
  if (!confirm(`ç¡®è®¤å°†è®¢å•æ·»åŠ åˆ°è´­ç‰©è½¦ï¼Ÿ\n\næ€»é‡‘é¢: $${totalPrice.toFixed(2)}\n\nç‚¹å‡»ç¡®å®šåå°†è·³è½¬åˆ°è´­ç‰©è½¦é¡µé¢ã€‚`)) {
    return;
  }
  
  try {
    console.log('å¼€å§‹æ·»åŠ åˆ°è´­ç‰©è½¦...', order);
    
    // å‡†å¤‡è´­ç‰©è½¦é¡¹ç›®
    const cartItems = [];
    
    if (order.lineItems && order.lineItems.length > 0) {
      for (const item of order.lineItems) {
        const attrs = item.customAttributes || [];
        
        // æ„å»ºpropertieså¯¹è±¡
        const properties = {
          'Order Type': '3D Model Quote',
          'Draft Order ID': draftOrderId,
          'Quote Status': 'Quoted'
        };
        
        // æ·»åŠ æ‰€æœ‰è‡ªå®šä¹‰å±æ€§
        attrs.forEach(attr => {
          properties[attr.key] = attr.value;
        });
        
        // æ·»åŠ æŠ¥ä»·ä»·æ ¼
        properties['Quoted Price'] = String(item.price || 0);
        
        cartItems.push({
          id: 0, // ä½¿ç”¨æ— æ•ˆçš„äº§å“IDï¼Œè§¦å‘è·å–çœŸå®äº§å“IDçš„é€»è¾‘
          quantity: item.quantity || 1,
          properties: properties
        });
      }
    }
    
    console.log('å‡†å¤‡æ·»åŠ åˆ°è´­ç‰©è½¦:', cartItems);
    
    // æ£€æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„äº§å“ID
    const hasValidProductId = cartItems.some(item => item.id && item.id !== 0);
    
    if (!hasValidProductId) {
      console.log('æ²¡æœ‰æœ‰æ•ˆçš„äº§å“IDï¼Œä½¿ç”¨è‡ªå®šä¹‰æŠ¥ä»·æ–¹æ¡ˆ');
      
      // ä½¿ç”¨ç®€å•çš„æ–¹æ³•è·å–äº§å“IDï¼Œå‚è€ƒé¡¹ç›®çš„åšæ³•
      console.log('è·å–äº§å“ID...');
      
      let genericProductId = null;
      
      // æ–¹æ³•1: ä»å…¨å±€å˜é‡è·å–
      if (window.theme && window.theme.defaultVariantId) {
        genericProductId = window.theme.defaultVariantId;
        console.log('âœ… ä½¿ç”¨ä¸»é¢˜é»˜è®¤äº§å“ID:', genericProductId);
      }
      
      // æ–¹æ³•2: ä»é¡µé¢æ•°æ®è·å–
      if (!genericProductId) {
        const productData = document.querySelector('[data-product-json]');
        if (productData) {
          try {
            const product = JSON.parse(productData.textContent);
            if (product && product.selected_or_first_available_variant) {
              genericProductId = product.selected_or_first_available_variant.id.toString();
              console.log('âœ… ä½¿ç”¨é¡µé¢äº§å“ID:', genericProductId);
            }
          } catch (e) {
            console.log('è§£æäº§å“æ•°æ®å¤±è´¥:', e);
          }
        }
      }
      
      // æ–¹æ³•3: ä½¿ç”¨ç¡¬ç¼–ç çš„äº§å“IDï¼ˆæ‚¨çš„å®é™…äº§å“IDï¼‰
      if (!genericProductId) {
        // ä½¿ç”¨æ‚¨å•†åº—ä¸­çš„3Dæ¨¡å‹ä¸Šä¼ ä¸æŠ¥ä»·æœåŠ¡äº§å“å˜ä½“ID
        genericProductId = '51217840308511'; // æ‚¨çš„å®é™…äº§å“å˜ä½“ID
        console.log('âœ… ä½¿ç”¨å•†åº—äº§å“ID:', genericProductId);
      }
      
      if (!genericProductId) {
        alert('ç³»ç»Ÿé…ç½®é”™è¯¯ï¼šæ— æ³•è·å–äº§å“IDã€‚è¯·è”ç³»å®¢æœå®Œæˆä¸‹å•ã€‚');
        return;
      }
      
      // ç›´æ¥ä½¿ç”¨ complete-draft-order APIï¼Œé¿å…è´­ç‰©è½¦ä»·æ ¼é—®é¢˜
      console.log('ğŸ”„ ç›´æ¥å®Œæˆè‰ç¨¿è®¢å•ï¼Œé¿å…è´­ç‰©è½¦ä»·æ ¼é—®é¢˜...');
      
      try {
        const completeResponse = await fetch(`${API_BASE}/complete-draft-order`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            draftOrderId: draftOrderId
          })
        });
        
        console.log('ğŸ“¡ å®Œæˆè‰ç¨¿è®¢å•å“åº”:', completeResponse.status);
        
        if (completeResponse.ok) {
          const completeResult = await completeResponse.json();
          console.log('ğŸ“¦ å®Œæˆç»“æœ:', completeResult);
          
          if (completeResult.success) {
            alert(`è®¢å•å·²å‡†å¤‡å°±ç»ªï¼\n\nè®¢å•å·ï¼š${completeResult.draftOrder.name}\né‡‘é¢ï¼š$${totalPrice}\n\nå³å°†è·³è½¬åˆ°ä»˜æ¬¾é¡µé¢...`);
            
            if (completeResult.draftOrder.invoiceUrl) {
              window.location.href = completeResult.draftOrder.invoiceUrl;
            } else {
              window.location.href = `/account/orders`;
            }
            return;
          }
        }
        
        // å¦‚æœå®Œæˆå¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        throw new Error('å®Œæˆè®¢å•å¤±è´¥');
        
      } catch (error) {
        console.error('âŒ å®Œæˆè‰ç¨¿è®¢å•å¤±è´¥:', error);
        
        // æä¾›å¤‡ç”¨æ–¹æ¡ˆ
        const orderInfo = `
æ— æ³•è‡ªåŠ¨å®Œæˆè®¢å•ï¼Œè¯·è”ç³»å®¢æœå®Œæˆä¸‹å•ï¼š

è®¢å•è¯¦æƒ…ï¼š
- è¯¢ä»·å•å·ï¼š${order.name}
- å®¢æˆ·é‚®ç®±ï¼š${order.email}
- è®¢å•é‡‘é¢ï¼š$${totalPrice}
- æ–‡ä»¶ä¿¡æ¯ï¼š${order.lineItems?.[0]?.title || '3Dæ¨¡å‹'}

å®¢æœé‚®ç®±ï¼šsupport@example.com
        `;
        
        alert(orderInfo);
        return;
      }
    }
    
  } catch (error) {
    console.error('ä¸‹å•å¤±è´¥:', error);
    alert('ä¸‹å•å¤±è´¥: ' + error.message);
  }
}

// åŠ è½½æ‰€æœ‰è®¢å•åˆ—è¡¨
async function loadAllOrders() {
  try {
    console.log('åŠ è½½æ‰€æœ‰è®¢å•åˆ—è¡¨...');
    const response = await fetch(`${API_BASE}/get-draft-orders?${authQuery}`);
    
    if (!response.ok) {
      throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
    }
    
    const data = await response.json();
    console.log('è®¢å•åˆ—è¡¨æ•°æ®:', data);
    
    if (data.success && data.draftOrders.length > 0) {
      renderOrdersList(data.draftOrders);
    } else {
      showEmptyState();
    }
  } catch (error) {
    console.error('åŠ è½½è®¢å•åˆ—è¡¨å¤±è´¥:', error);
    showError('åŠ è½½è®¢å•åˆ—è¡¨å¤±è´¥: ' + error.message);
  }
}

// æ¸²æŸ“è®¢å•åˆ—è¡¨
function renderOrdersList(orders) {
  console.log('æ¸²æŸ“è®¢å•åˆ—è¡¨:', orders);
  
  // éšè—å•ä¸ªè®¢å•è¯¦æƒ…
  document.getElementById('quote-detail').style.display = 'none';
  document.getElementById('loading-state').style.display = 'none';
  
  // æ˜¾ç¤ºè®¢å•åˆ—è¡¨å®¹å™¨
  let ordersListContainer = document.getElementById('orders-list-container');
  if (!ordersListContainer) {
    ordersListContainer = document.createElement('div');
    ordersListContainer.id = 'orders-list-container';
    ordersListContainer.className = 'orders-list-container';
    
    // æ’å…¥åˆ°é¡µé¢ä¸­
    const mainContent = document.querySelector('.quote-detail-container');
    if (mainContent) {
      mainContent.appendChild(ordersListContainer);
    } else {
      console.error('æœªæ‰¾åˆ° .quote-detail-container å…ƒç´ ');
      document.body.appendChild(ordersListContainer);
    }
  }
  
  ordersListContainer.innerHTML = `
    <div class="orders-list-header">
      <h2>æˆ‘çš„è¯¢ä»·è®¢å•</h2>
      <p>ç‚¹å‡»è®¢å•æŸ¥çœ‹è¯¦æƒ…</p>
    </div>
    <div class="orders-list">
      ${orders.map(order => createOrderCard(order)).join('')}
    </div>
  `;
  
  ordersListContainer.style.display = 'block';
}

// åˆ›å»ºè®¢å•å¡ç‰‡
function createOrderCard(order) {
  const status = getOrderStatus(order);
  const date = formatDate(order.createdAt);
  
  return `
    <div class="order-card" onclick="viewOrder('${order.id}')">
      <div class="order-card-header">
        <div class="order-number">${order.name}</div>
        <div class="order-status ${status.className}">${status.text}</div>
      </div>
      <div class="order-card-body">
        <div class="order-info">
          <div class="order-date">åˆ›å»ºæ—¶é—´: ${date}</div>
          <div class="order-total">${order.totalPrice ? `$${parseFloat(order.totalPrice).toFixed(2)}` : 'å¾…æŠ¥ä»·'}</div>
        </div>
        ${order.lineItems && order.lineItems.length > 0 ? `
          <div class="order-items">
            ${order.lineItems.slice(0, 2).map(item => `
              <div class="order-item">
                ${item.title} ${item.quantity > 1 ? `Ã—${item.quantity}` : ''}
              </div>
            `).join('')}
            ${order.lineItems.length > 2 ? `<div class="order-item-more">...è¿˜æœ‰${order.lineItems.length - 2}ä¸ªé¡¹ç›®</div>` : ''}
          </div>
        ` : ''}
      </div>
      <div class="order-card-actions">
        <button class="btn btn-primary" onclick="event.stopPropagation(); viewOrder('${order.id}')">
          æŸ¥çœ‹è¯¦æƒ…
        </button>
        <button class="btn btn-danger" onclick="event.stopPropagation(); deleteOrder('${order.id}')">
          åˆ é™¤è®¢å•
        </button>
      </div>
    </div>
  `;
}

// æŸ¥çœ‹è®¢å•è¯¦æƒ…
function viewOrder(orderId) {
  console.log('æŸ¥çœ‹è®¢å•:', orderId);
  window.location.href = `${window.location.pathname}?id=${encodeURIComponent(orderId)}`;
}

// åˆ é™¤è®¢å•
async function deleteOrder(orderId) {
  if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè®¢å•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
    return;
  }
  
  try {
    console.log('åˆ é™¤è®¢å•:', orderId);
    const response = await fetch(`${API_BASE}/delete-draft-order`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ 
        draftOrderId: orderId,
        email: customerEmail,
        admin: isAdmin ? '1' : '0'
      })
    });
    
    const data = await response.json();
    
    if (data.success) {
      showSuccessMessage('è®¢å•åˆ é™¤æˆåŠŸï¼');
      // é‡æ–°åŠ è½½è®¢å•åˆ—è¡¨
      setTimeout(() => {
        loadAllOrders();
      }, 1000);
    } else {
      throw new Error(data.error || 'åˆ é™¤å¤±è´¥');
    }
  } catch (error) {
    console.error('åˆ é™¤è®¢å•å¤±è´¥:', error);
    showError('åˆ é™¤è®¢å•å¤±è´¥: ' + error.message);
  }
}

// æ˜¾ç¤ºç©ºçŠ¶æ€
function showEmptyState() {
  // éšè—å…¶ä»–å†…å®¹
  document.getElementById('quote-detail').style.display = 'none';
  document.getElementById('loading-state').style.display = 'none';
  
  let emptyState = document.getElementById('empty-state');
  if (!emptyState) {
    emptyState = document.createElement('div');
    emptyState.id = 'empty-state';
    emptyState.className = 'empty-state';
    
    const mainContent = document.querySelector('.quote-detail-container');
    if (mainContent) {
      mainContent.appendChild(emptyState);
    } else {
      console.error('æœªæ‰¾åˆ° .quote-detail-container å…ƒç´ ');
      document.body.appendChild(emptyState);
    }
  }
  
  emptyState.innerHTML = `
    <div class="empty-state-content">
      <div class="empty-state-icon">ğŸ“‹</div>
      <h3>æš‚æ— è¯¢ä»·è®¢å•</h3>
      <p>æ‚¨è¿˜æ²¡æœ‰æäº¤è¿‡è¯¢ä»·è¯·æ±‚</p>
      <a href="/pages/quote-request" class="btn btn-primary">
        ç«‹å³è¯¢ä»·
      </a>
    </div>
  `;
  
  emptyState.style.display = 'block';
}

// æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
function showSuccessMessage(message, duration = 3000) {
  // åˆ›å»ºæˆåŠŸæ¶ˆæ¯å…ƒç´ 
  const successMsg = document.createElement('div');
  successMsg.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: #28a745;
    color: white;
    padding: 12px 20px;
    border-radius: 6px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 10000;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.3s ease;
  `;
  successMsg.textContent = message;
  
  document.body.appendChild(successMsg);
  
  // è‡ªåŠ¨ç§»é™¤
  setTimeout(() => {
    successMsg.style.opacity = '0';
    successMsg.style.transform = 'translateX(100%)';
    setTimeout(() => {
      if (successMsg.parentNode) {
        successMsg.parentNode.removeChild(successMsg);
      }
    }, 300);
  }, duration);
}

// æ˜¾ç¤ºé”™è¯¯
function showError(message) {
  document.getElementById('loading-state').style.display = 'none';
  document.getElementById('quote-detail').style.display = 'none';
  document.getElementById('error-state').style.display = 'block';
  document.getElementById('error-message').textContent = message;
  
  // å¦‚æœæ˜¯è®¢å•ä¸å­˜åœ¨é”™è¯¯ï¼Œæ˜¾ç¤ºé‡æ–°åˆ›å»ºæŒ‰é’®
  if (message.includes('è‰ç¨¿è®¢å•ä¸å­˜åœ¨') || message.includes('æ²¡æœ‰è‰ç¨¿è®¢å•')) {
    document.getElementById('retry-create-btn').style.display = 'inline-block';
  }
}

// é‡æ–°åˆ›å»ºè®¢å•
async function retryCreateOrder() {
  const retryBtn = document.getElementById('retry-create-btn');
  retryBtn.disabled = true;
  retryBtn.textContent = 'åˆ›å»ºä¸­...';
  
  try {
    // è·³è½¬åˆ°ä¸Šä¼ é¡µé¢ï¼Œè®©ç”¨æˆ·é‡æ–°æäº¤
    alert('è®¢å•ä¸å­˜åœ¨ï¼Œå°†è·³è½¬åˆ°ä¸Šä¼ é¡µé¢é‡æ–°åˆ›å»ºè®¢å•ã€‚\n\nè¯·é‡æ–°ä¸Šä¼ æ–‡ä»¶å¹¶å¡«å†™é…ç½®å‚æ•°ã€‚');
    window.location.href = '/pages/model-uploader';
  } catch (error) {
    console.error('é‡è¯•åˆ›å»ºè®¢å•å¤±è´¥:', error);
    retryBtn.disabled = false;
    retryBtn.textContent = 'é‡æ–°åˆ›å»ºè®¢å•';
    alert('è·³è½¬å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨è®¿é—®ä¸Šä¼ é¡µé¢');
  }
}

// ä¸‹è½½æ‰€æœ‰æ–‡ä»¶
async function downloadAllFiles() {
  if (!window.currentDraftOrder || !window.currentDraftOrder.lineItems) {
    alert('æ²¡æœ‰å¯ä¸‹è½½çš„æ–‡ä»¶ã€‚');
    return;
  }

  console.log('å¼€å§‹ä¸‹è½½æ–‡ä»¶...');
  
  for (const item of window.currentDraftOrder.lineItems) {
    const fileIdAttr = item.customAttributes.find(attr => attr.key === 'æ–‡ä»¶ID');
    const fileNameAttr = item.customAttributes.find(attr => attr.key === 'æ–‡ä»¶');
    
    if (fileIdAttr && fileIdAttr.value) {
      const fileId = fileIdAttr.value;
      const fileName = fileNameAttr ? fileNameAttr.value : item.title;
      
      console.log('ä¸‹è½½æ–‡ä»¶:', fileName, 'ID:', fileId);
      
      try {
        // æ£€æŸ¥æ˜¯å¦æ˜¯æœ¬åœ°å­˜å‚¨çš„æ–‡ä»¶
        if (fileId.startsWith('file_') && window.fileStorageManager) {
          const fileInfo = window.fileStorageManager.getFileInfo(fileId);
          if (fileInfo && fileInfo.url) {
            // ä»æœ¬åœ°å­˜å‚¨ä¸‹è½½
            window.fileStorageManager.downloadFile(fileInfo.url, fileName);
            console.log('âœ… æœ¬åœ°æ–‡ä»¶ä¸‹è½½å®Œæˆ:', fileName);
          } else {
            console.warn('âš ï¸ æœ¬åœ°æ–‡ä»¶ä¸å­˜åœ¨:', fileId);
            alert(`æ–‡ä»¶ "${fileName}" åœ¨æœ¬åœ°å­˜å‚¨ä¸­ä¸å­˜åœ¨ï¼Œå¯èƒ½å·²è¢«æ¸…ç†ã€‚`);
          }
        } else {
          // å°è¯•ä»APIä¸‹è½½
          const response = await fetch(`${API_BASE}/download-file?id=${encodeURIComponent(fileId)}`);
          if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            a.remove();
            console.log('âœ… APIæ–‡ä»¶ä¸‹è½½å®Œæˆ:', fileName);
          } else {
            throw new Error(`ä¸‹è½½å¤±è´¥: ${response.status}`);
          }
        }
      } catch (error) {
        console.error(`ä¸‹è½½æ–‡ä»¶ ${fileName} å¤±è´¥:`, error);
        alert(`ä¸‹è½½æ–‡ä»¶ "${fileName}" å¤±è´¥: ${error.message}`);
      }
    } else {
      console.warn('æ–‡ä»¶æ²¡æœ‰æ–‡ä»¶ID:', item.title);
      alert(`æ–‡ä»¶ "${item.title}" æ²¡æœ‰æ‰¾åˆ°æ–‡ä»¶IDï¼Œæ— æ³•ä¸‹è½½ã€‚`);
    }
  }
  
  console.log('æ–‡ä»¶ä¸‹è½½å®Œæˆ');
}

// åœ¨ JavaScript ä¸­æ·»åŠ é‚®ç®±éªŒè¯ï¼Œç¡®ä¿åªæ˜¾ç¤ºå½“å‰å®¢æˆ·çš„è®¢å•
function filterOrdersByCustomerEmail() {
  const customerEmailDiv = document.querySelector('.customer-authenticated');
  if (!customerEmailDiv) return null;
  
  const customerEmail = customerEmailDiv.getAttribute('data-customer-email');
  console.log('å½“å‰ç™»å½•å®¢æˆ·é‚®ç®±:', customerEmail);
  return customerEmail;
}

// ä¿®æ”¹ loadDraftOrders å‡½æ•°ï¼Œæ·»åŠ é‚®ç®±è¿‡æ»¤
const originalLoadDraftOrders = window.loadDraftOrders;
if (originalLoadDraftOrders) {
  window.loadDraftOrders = async function() {
    const customerEmail = filterOrdersByCustomerEmail();
    if (!customerEmail) {
      console.error('æœªæ‰¾åˆ°å®¢æˆ·é‚®ç®±ï¼Œæ— æ³•åŠ è½½è®¢å•');
      return;
    }
    
    // è°ƒç”¨åŸå‡½æ•°åŠ è½½è®¢å•
    await originalLoadDraftOrders();
    
    // è¿‡æ»¤è®¢å•ï¼Œåªæ˜¾ç¤ºå½“å‰å®¢æˆ·çš„
    const allOrders = document.querySelectorAll('.order-card');
    allOrders.forEach(orderCard => {
      const emailElement = orderCard.querySelector('[data-order-email]');
      if (emailElement) {
        const orderEmail = emailElement.getAttribute('data-order-email');
        if (orderEmail !== customerEmail) {
          // éšè—ä¸å±äºå½“å‰å®¢æˆ·çš„è®¢å•
          orderCard.style.display = 'none';
        }
      }
    });
  };
}
</script>

</div>
<!-- å…³é—­å®¢æˆ·å·²ç™»å½•çš„div -->
{% endunless %}
