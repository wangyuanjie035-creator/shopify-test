{% comment %}
  Draft Order / Quote Details Page
  URL: /pages/my-quotes?id=<draftOrderId>
  Purpose: show draft order details; customer can review quote and proceed to checkout
  Security: customer must be logged in
{% endcomment %}

<!-- Customer login check -->
{% unless customer %}
<div class="customer-login-required">
  <div class="login-prompt-card">
    <div class="login-prompt-icon">üîí</div>
    <h2>Sign in required</h2>
    <p>Please sign in to view your quotes.</p>
    <div class="login-actions">
      <a href="/account/login?return_url={{ request.path | url_encode }}" class="login-link-btn primary">
        <span class="btn-icon">üîê</span>
        Sign in
      </a>
      <a href="/account/register?return_url={{ request.path | url_encode }}" class="login-link-btn secondary">
        <span class="btn-icon">‚ú®</span>
        Create account
      </a>
    </div>
  </div>
</div>

<style>
  .customer-login-required {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding: 20px;
  }

  .login-prompt-card {
    background: white;
    border-radius: 16px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    padding: 50px 40px;
    max-width: 450px;
    width: 100%;
    text-align: center;
    animation: slideIn 0.3s ease-out;
  }

  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(-20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .login-prompt-icon {
    font-size: 64px;
    margin-bottom: 20px;
  }

  .login-prompt-card h2 {
    color: #333;
    font-size: 28px;
    margin: 0 0 15px 0;
  }

  .login-prompt-card p {
    color: #666;
    font-size: 16px;
    margin: 0 0 30px 0;
    line-height: 1.6;
  }

  .login-actions {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .login-link-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    padding: 14px 28px;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    text-decoration: none;
    transition: all 0.2s ease;
    cursor: pointer;
  }

  .login-link-btn.primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
  }

  .login-link-btn.primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(102,126,234,0.4);
  }

  .login-link-btn.secondary {
    background: white;
    color: #667eea;
    border: 2px solid #667eea;
  }

  .login-link-btn.secondary:hover {
    background: #f8f9ff;
    transform: translateY(-2px);
  }
</style>

{% else %}
<!-- Customer signed in: show quotes -->
<div class="customer-authenticated" data-customer-email="{{ customer.email }}">

<style>
  .quote-detail-container {
    max-width: 1200px;
    margin: 40px auto;
    padding: 0 20px;
  }
  
  .quote-header {
    background: white;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 24px;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
  }
  
  .quote-actions {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .refresh-btn {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    padding: 8px 12px;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .refresh-btn:hover {
    background: #e9ecef;
    border-color: #adb5bd;
  }
  
    .refresh-btn:active {
      transform: rotate(180deg);
    }
    
    /* Orders list styles */
    .orders-list-container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .orders-list-header {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .orders-list-header h2 {
      color: #333;
      margin-bottom: 10px;
    }
    
    .orders-list-header p {
      color: #666;
      font-size: 14px;
    }
    
    .orders-list {
      display: grid;
      gap: 20px;
    }
    
    .order-card {
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .order-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      border-color: #007bff;
    }
    
    .order-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .order-number {
      font-weight: bold;
      font-size: 16px;
      color: #333;
    }
    
    .order-status {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .order-card-body {
      margin-bottom: 15px;
    }
    
    .order-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .order-date {
      color: #666;
      font-size: 14px;
    }
    
    .order-total {
      font-weight: bold;
      color: #e74c3c;
      font-size: 16px;
    }
    
    .order-items {
      margin-top: 10px;
    }
    
    .order-item {
      color: #666;
      font-size: 14px;
      margin-bottom: 5px;
    }
    
    .order-item-more {
      color: #999;
      font-size: 12px;
      font-style: italic;
    }
    
    .order-card-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }
    
    .order-card-actions .btn {
      padding: 8px 16px;
      font-size: 14px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .order-card-actions .btn-primary {
      background: #007bff;
      color: white;
    }
    
    .order-card-actions .btn-primary:hover {
      background: #0056b3;
    }
    
    .order-card-actions .btn-danger {
      background: #dc3545;
      color: white;
    }
    
    .order-card-actions .btn-danger:hover {
      background: #c82333;
    }
    
    /* Empty state styles */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
    }
    
    .empty-state-content {
      max-width: 400px;
      margin: 0 auto;
    }
    
    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 20px;
    }
    
    .empty-state h3 {
      color: #333;
      margin-bottom: 10px;
    }
    
    .empty-state p {
      color: #666;
      margin-bottom: 30px;
    }
    
    .empty-state .btn {
      padding: 12px 24px;
      background: #007bff;
      color: white;
      text-decoration: none;
      border-radius: 6px;
      font-weight: 500;
      transition: background 0.2s ease;
    }
    
    .empty-state .btn:hover {
      background: #0056b3;
      color: white;
    }
  
  .quote-title {
    font-size: 28px;
    font-weight: 600;
    color: #333;
    margin-bottom: 12px;
  }
  
  .quote-meta {
    display: flex;
    gap: 24px;
    flex-wrap: wrap;
    color: #666;
    font-size: 14px;
  }
  
  .quote-meta-item {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .quote-status {
    padding: 6px 16px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: 500;
  }
  
  .status-pending {
    background: #fff3cd;
    color: #856404;
  }
  
  .status-quoted {
    background: #d4edda;
    color: #155724;
  }

  .status-rejected {
    background: #f8d7da;
    color: #721c24;
  }

  /* Not-manufacturable banner */
  .unprocessable-banner {
    background: #f8d7da;
    border: 1px solid #f5c6cb;
    color: #721c24;
    padding: 16px 20px;
    border-radius: 8px;
    margin-bottom: 24px;
    line-height: 1.6;
    font-size: 14px;
  }

  .unprocessable-banner-title {
    font-weight: 600;
    margin-bottom: 6px;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .unprocessable-banner-title span.icon {
    font-size: 18px;
  }

  .unprocessable-banner p {
    margin: 2px 0;
  }
  
  .quote-items {
    background: white;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 24px;
  }
  
  .section-title {
    font-size: 20px;
    font-weight: 600;
    color: #333;
    margin-bottom: 20px;
    padding-bottom: 12px;
    border-bottom: 2px solid #f0f0f0;
  }
  
  .item-card {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 16px;
  }
  
  .item-card:last-child {
    margin-bottom: 0;
  }
  
  .item-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
  }
  
  .item-name {
    font-size: 18px;
    font-weight: 600;
    color: #333;
  }
  
  .item-price {
    font-size: 24px;
    font-weight: 600;
    color: #e91e63;
  }
  
  .item-details {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 12px;
    font-size: 14px;
    color: #666;
  }
  
  .item-detail {
    display: flex;
    flex-direction: column;
  }
  
  .detail-label {
    font-weight: 500;
    color: #333;
    margin-bottom: 4px;
  }
  
  .quote-summary {
    background: white;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 24px;
  }
  
  .summary-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid #f0f0f0;
  }
  
  .summary-row:last-child {
    border-bottom: none;
    padding-top: 20px;
    margin-top: 12px;
    border-top: 2px solid #333;
  }
  
  .summary-label {
    font-size: 16px;
    color: #666;
  }
  
  .summary-value {
    font-size: 16px;
    font-weight: 500;
    color: #333;
  }
  
  .summary-total {
    font-size: 24px !important;
    font-weight: 600 !important;
    color: #e91e63 !important;
  }
  
  .quote-actions {
    display: flex;
    gap: 16px;
    justify-content: flex-end;
  }
  
  .btn {
    padding: 14px 28px;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 500;
    cursor: pointer;
    border: none;
    transition: all 0.3s ease;
  }
  
  .btn-secondary {
    background: #f5f5f5;
    color: #333;
    border: 1px solid #e0e0e0;
  }
  
  .btn-secondary:hover {
    background: #e0e0e0;
  }
  
  .btn-primary {
    background: #e91e63;
    color: white;
  }
  
  .btn-primary:hover {
    background: #c2185b;
  }
  
  .btn-primary:disabled {
    background: #ccc;
    cursor: not-allowed;
  }
  
  .loading {
    text-align: center;
    padding: 60px 20px;
    color: #666;
  }
  
  .loading-spinner {
    width: 48px;
    height: 48px;
    border: 4px solid #f0f0f0;
    border-top: 4px solid #e91e63;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 20px;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  .error {
    background: #ffebee;
    color: #c62828;
    padding: 20px;
    border-radius: 8px;
    border: 1px solid #ef5350;
    margin: 20px 0;
  }
  
  @media (max-width: 768px) {
    .quote-meta {
      flex-direction: column;
      gap: 12px;
    }
    
    .item-details {
      grid-template-columns: 1fr;
    }
    
    .quote-actions {
      flex-direction: column;
    }
    
    .btn {
      width: 100%;
    }
  }
</style>

<div class="quote-detail-container">
  <div id="loading-state" class="loading">
    <div class="loading-spinner"></div>
    <p>Loading quote details...</p>
  </div>
  
  <div id="error-state" style="display: none;">
    <div class="error">
      <p id="error-message"></p>
    </div>
    <div class="quote-actions">
      <a href="/pages/model-uploader" class="btn btn-secondary">Back to upload</a>
      <button id="retry-create-btn" class="btn btn-primary" onclick="retryCreateOrder()" style="display: none;">Recreate quote</button>
    </div>
  </div>
  
  <div id="quote-detail" style="display: none;">
    <div class="quote-header">
      <div class="quote-title" id="order-number">Quote #--</div>
      <div class="quote-actions">
        <button id="refreshBtn" class="refresh-btn" onclick="refreshOrderStatus()" title="Refresh status">
          üîÑ Refresh
        </button>
      </div>
      <div class="quote-meta">
        <div class="quote-meta-item">
          <strong>Status:</strong>
          <span class="quote-status" id="order-status">Pending</span>
        </div>
        <div class="quote-meta-item">
          <strong>Created:</strong>
          <span id="order-date">--</span>
        </div>
        <div class="quote-meta-item">
          <strong>Customer:</strong>
          <span id="customer-name">--</span>
        </div>
      </div>
    </div>

    <!-- Not-manufacturable reason & suggestions -->
    <div id="unprocessable-reason" class="unprocessable-banner" style="display:none;"></div>
    
    <div class="quote-items">
      <div class="section-title">Line items</div>
      <div id="items-list"></div>
    </div>
    
    <div class="quote-summary">
      <div class="section-title">Summary</div>
      <div class="summary-row">
        <span class="summary-label">Subtotal</span>
        <span class="summary-value" id="subtotal">$0.00</span>
      </div>
      <div class="summary-row">
        <span class="summary-label">Shipping</span>
        <span class="summary-value">TBD</span>
      </div>
      <div class="summary-row">
        <span class="summary-label summary-total">Total</span>
        <span class="summary-value summary-total" id="total">$0.00</span>
      </div>
    </div>
    
    <div class="quote-actions">
      <a href="/pages/model-uploader" class="btn btn-secondary">Upload another</a>
      <button id="place-order-btn" class="btn btn-primary" onclick="placeOrder()">Proceed to checkout</button>
    </div>
  </div>
</div>

<script>
// API config
const API_BASE = 'https://shopify-v587.vercel.app/api';
const customerEmail = (document.querySelector('.customer-authenticated')?.dataset.customerEmail || '').toLowerCase();
const ADMIN_EMAILS = ['jonathan.wang@sainstore.com', 'issac.yu@sainstore.com','kitto.chen@sainstore.com','cherry@sain3.com', 'keihen.luo@sain3.com','nancy.lin@sainstore.com'];
const isAdmin = ADMIN_EMAILS.some(e => e.toLowerCase() === customerEmail);
const authParams = () => isAdmin
  ? `admin=1&email=${encodeURIComponent(customerEmail)}`
  : `email=${encodeURIComponent(customerEmail)}`;
const authQuery = authParams();

// Get draft order id from URL
const urlParams = new URLSearchParams(window.location.search);
const draftOrderId = urlParams.get('id');

// Load on page ready
document.addEventListener('DOMContentLoaded', async function() {
  if (!customerEmail) {
    showError('We couldn‚Äôt read your account email. Please sign in again.');
    return;
  }
  if (!draftOrderId) {
    // If no id is specified, show list
    await loadAllOrders();
    return;
  }
  
  try {
    await loadOrderDetails();
    
    // Auto-refresh every 30 seconds
    setInterval(() => {
      refreshOrderStatus();
    }, 30000);
  } catch (error) {
    console.error('Failed to load quote details:', error);
    showError('Failed to load quote: ' + error.message);
  }
});

// Refresh quote status
async function refreshOrderStatus() {
  try {
    // Fetch latest order data
    const response = await fetch(`${API_BASE}/get-draft-order-simple?id=${encodeURIComponent(draftOrderId)}&${authQuery}`);
    
    if (response.ok) {
      const data = await response.json();
      
      if (data.success && data.draftOrder) {
        const newOrder = data.draftOrder;
        const currentOrder = window.currentDraftOrder;
        
        // Detect status/price changes
        if (currentOrder) {
          // Get current status
          const currentStatus = getOrderStatus(currentOrder);
          const newStatus = getOrderStatus(newOrder);
          
          const statusChanged = currentStatus.text !== newStatus.text;
          const priceChanged = currentOrder.totalPrice !== newOrder.totalPrice;
          
          // Also check custom attribute status changes
          let customStatusChanged = false;
          if (currentOrder.lineItems && newOrder.lineItems && 
              currentOrder.lineItems.length > 0 && newOrder.lineItems.length > 0) {
            const currentCustomStatus = currentOrder.lineItems[0].customAttributes?.find(a => a.key === 'Status')?.value;
            const newCustomStatus = newOrder.lineItems[0].customAttributes?.find(a => a.key === 'Status')?.value;
            customStatusChanged = currentCustomStatus !== newCustomStatus;
          }
          
          if (statusChanged || priceChanged || customStatusChanged) {
            // Update current order
            window.currentDraftOrder = newOrder;
            
            // Re-render details
            renderOrderDetails(newOrder);
            
            // Show toast
            showSuccessMessage('Quote updated.', 3000);
          }
        } else {
          // If no current order, render directly
          window.currentDraftOrder = newOrder;
          renderOrderDetails(newOrder);
        }
      }
    }
  } catch (error) {
    console.warn('‚ö†Ô∏è Failed to refresh quote status:', error);
  }
}

// Load quote details
async function loadOrderDetails() {
  try {
    // List draft orders first
    const listResponse = await fetch(`${API_BASE}/get-draft-orders?${authQuery}`);
    const listData = await listResponse.json();
    
    // Find matching order
    let foundOrder = null;
    if (listData.success && listData.draftOrders.length > 0) {
      foundOrder = listData.draftOrders.find(order => {
        // Multiple matching strategies
        const matches = [
          order.id === draftOrderId,
          order.id === decodeURIComponent(draftOrderId),
          order.name === draftOrderId,
          order.name === decodeURIComponent(draftOrderId),
          // If numeric, also try matching GID
          order.id === `gid://shopify/DraftOrder/${draftOrderId}`,
          order.id === `gid://shopify/DraftOrder/${decodeURIComponent(draftOrderId)}`,
          // Match numeric part of GID
          order.id && order.id.includes(draftOrderId.replace(/\D/g, '')),
          order.id && order.id.includes(decodeURIComponent(draftOrderId).replace(/\D/g, ''))
        ];
        
        return matches.some(match => match);
      });
      
      if (foundOrder) {
        // Use the found order
        window.currentDraftOrder = foundOrder;
        renderOrderDetails(foundOrder);
        return;
      }
    }
    
    // Fallback: direct fetch
    const response = await fetch(`${API_BASE}/get-draft-order-simple?id=${encodeURIComponent(draftOrderId)}&${authQuery}`);
    
    if (!response.ok) {
      if (response.status === 404) {
        throw new Error('This quote no longer exists. It may have been deleted. Please submit a new RFQ.');
      }
      throw new Error(`API request failed: ${response.status}`);
    }
    
    const data = await response.json();
    
    if (!data.draftOrder) {
      throw new Error('Empty order data');
    }
    
    // Save globally
    window.currentDraftOrder = data.draftOrder;
    
    // Reserved: extended status
    
    // Render
    renderOrderDetails(data.draftOrder);
    
  } catch (error) {
    console.error('Failed to load quote details:', error);
    throw error;
  }
}


// Render quote details
function renderOrderDetails(order) {
  // Order number
  const orderNumberEl = document.getElementById('order-number');
  orderNumberEl.textContent = `Quote ${order.name || order.id}`;
  
  // Status
  const statusEl = document.getElementById('order-status');
  const status = getOrderStatus(order);
  statusEl.textContent = status.text;
  statusEl.className = `quote-status ${status.className}`;

  // If not manufacturable, show reason/suggestions from Notes
  const unprocessableEl = document.getElementById('unprocessable-reason');
  if (status.text === 'Not manufacturable' && order.lineItems && order.lineItems.length > 0) {
    const firstItem = order.lineItems[0];
    const attrs = firstItem.customAttributes || [];
    const noteAttr = attrs.find(a => a.key === 'Notes' || a.key === 'Â§áÊ≥®');

    if (noteAttr && noteAttr.value) {
      // Notes format example:
      // Not manufacturable
      //
      // Reason: xxx
      // Suggested changes: yyy
      const raw = noteAttr.value;
      let reasonText = '';
      let suggestionText = '';

      try {
        const lines = raw.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
        // Support both English and Chinese labels
        const reasonLine = lines.find(l => /^(Reason|ÂéüÂõ†)[:Ôºö]?\s*/i.test(l));
        const suggestionLine = lines.find(l => /^(Suggested changes?|‰øÆÊîπÂª∫ËÆÆ|Âª∫ËÆÆ)[:Ôºö]?\s*/i.test(l));
        if (reasonLine) {
          reasonText = reasonLine.replace(/^(Reason|ÂéüÂõ†)[:Ôºö]?\s*/i, '');
        }
        if (suggestionLine) {
          suggestionText = suggestionLine.replace(/^(Suggested changes?|‰øÆÊîπÂª∫ËÆÆ|Âª∫ËÆÆ)[:Ôºö]?\s*/i, '');
        }
        // If no structured format found, try to extract from "Not manufacturable\n\nReason: ...\nSuggested changes: ..." format
        if (!reasonText && !suggestionText) {
          const reasonMatch = raw.match(/(?:Reason|ÂéüÂõ†)[:Ôºö]?\s*(.+?)(?:\n|$)/i);
          const suggestionMatch = raw.match(/(?:Suggested changes?|‰øÆÊîπÂª∫ËÆÆ|Âª∫ËÆÆ)[:Ôºö]?\s*(.+?)(?:\n|$)/i);
          if (reasonMatch) reasonText = reasonMatch[1].trim();
          if (suggestionMatch) suggestionText = suggestionMatch[1].trim();
        }
      } catch (e) {
        console.warn('Failed to parse Notes for not-manufacturable banner; using raw text:', e);
      }

      const finalReason = reasonText || raw;

      unprocessableEl.innerHTML = `
        <div class="unprocessable-banner-title">
          <span class="icon">‚ö†Ô∏è</span>
          <span>This quote is currently not manufacturable</span>
        </div>
        <p><strong>Reason:</strong> ${finalReason}</p>
        ${suggestionText ? `<p><strong>Suggested changes:</strong> ${suggestionText}</p>` : ''}
        <p>If you have questions, please contact support or reply to our email.</p>
      `;
      unprocessableEl.style.display = 'block';
    } else {
      unprocessableEl.style.display = 'none';
      unprocessableEl.innerHTML = '';
    }
  } else {
    // Other statuses: hide banner
    if (unprocessableEl) {
      unprocessableEl.style.display = 'none';
      unprocessableEl.innerHTML = '';
    }
  }
  
  // Date
  const dateEl = document.getElementById('order-date');
  dateEl.textContent = formatDate(order.createdAt);
  
  // Customer
  const customerEl = document.getElementById('customer-name');
  customerEl.textContent = order.email || 'Unknown';
  
  // Render line items (hide 2D drawing lines)
  const itemsList = document.getElementById('items-list');
  itemsList.innerHTML = '';
  
  if (order.lineItems && order.lineItems.length > 0) {
    const mainItems = order.lineItems.filter(item => {
      const attrs = item.customAttributes || [];
      const typeAttr = attrs.find(a => a.key === 'File Type');
      // Default: treat as 3D unless explicitly marked as 2D
      return !typeAttr || typeAttr.value !== '2D';
    });

    mainItems.forEach(item => {
      const itemCard = createItemCard(item);
      if (itemCard) itemsList.appendChild(itemCard);
    });
  }
  
  // Prices
  updatePrices(order);
  
  // CTA state
  updateButtonState(order);
  
  // Show details, hide loading state
  document.getElementById('loading-state').style.display = 'none';
  document.getElementById('quote-detail').style.display = 'block';
}

// Create line item card
function createItemCard(item) {
  const card = document.createElement('div');
  card.className = 'item-card';
  
  // Price: prefer originalUnitPrice, fallback to price
  let price = 0;
  if (item.originalUnitPrice) {
    price = parseFloat(item.originalUnitPrice);
  } else if (item.price) {
    price = parseFloat(item.price);
  }
  
  const quantity = item.quantity || 1;
  const itemTotal = price * quantity;
  
  // Custom attributes
  const attrs = item.customAttributes || [];
  const getAttribute = (key) => {
    const attr = attrs.find(a => a.key === key);
    return attr ? attr.value : '';
  };
  
  card.innerHTML = `
    <div class="item-header">
      <div class="item-name">${item.title || 'Untitled item'}</div>
      <div class="item-price">${price > 0 ? `$${itemTotal.toFixed(2)}` : 'Pending'}</div>
    </div>
    <div class="item-details">
      <div class="item-detail">
        <span class="detail-label">Qty</span>
        <span>${quantity}</span>
      </div>
      <div class="item-detail">
        <span class="detail-label">Material</span>
        <span>${getAttribute('Material') || 'Not specified'}</span>
      </div>
      <div class="item-detail">
        <span class="detail-label">Finish</span>
        <span>${getAttribute('Surface Finish') || 'Natural'}</span>
      </div>
      <div class="item-detail">
        <span class="detail-label">Precision</span>
        <span>${getAttribute('Precision') || 'Standard'}</span>
      </div>
      <div class="item-detail">
        <span class="detail-label">Tolerance</span>
        <span>${getAttribute('Tightest Tolerance') || 'GB/T 1804-2000 m'}</span>
      </div>
      <div class="item-detail">
        <span class="detail-label">Roughness</span>
        <span>${getAttribute('Surface Roughness') || 'Ra3.2'}</span>
      </div>
      ${getAttribute('Notes') ? `
      <div class="item-detail" style="grid-column: 1 / -1;">
        <span class="detail-label">Notes</span>
        <span>${getAttribute('Notes')}</span>
      </div>
      ` : ''}
    </div>
  `;
  
  return card;
}

// Update prices
function updatePrices(order) {
  let subtotal = 0;
  
  // Prefer totalPrice
  if (order.totalPrice) {
    subtotal = parseFloat(order.totalPrice);
  } 
  // Fallback: compute from lineItems
  else if (order.lineItems && order.lineItems.length > 0) {
    order.lineItems.forEach(item => {
      const price = parseFloat(item.originalUnitPrice || item.price || 0);
      const quantity = item.quantity || 1;
      subtotal += price * quantity;
    });
  }
  
  const formattedPrice = subtotal > 0 ? `$${subtotal.toFixed(2)}` : 'Pending';
  
  document.getElementById('subtotal').textContent = formattedPrice;
  document.getElementById('total').textContent = formattedPrice;
}

  // Update CTA state
function updateButtonState(order) {
  const placeOrderBtn = document.getElementById('place-order-btn');
  
  // Prefer custom attribute Status
  let orderStatus = null;
  if (order.lineItems && order.lineItems.length > 0) {
    const firstItem = order.lineItems[0];
    const attrs = firstItem.customAttributes || [];
    const statusAttr = attrs.find(a => a.key === 'Status' || a.key === 'Áä∂ÊÄÅ');
    
    if (statusAttr) {
      orderStatus = statusAttr.value;
    }
  }
  
  // Not manufacturable
  if (orderStatus === 'Êó†Ê≥ïÂä†Â∑•' || orderStatus === 'Not manufacturable') {
    placeOrderBtn.disabled = true;
    placeOrderBtn.textContent = 'Not manufacturable';
    placeOrderBtn.style.opacity = '0.6';
    placeOrderBtn.style.cursor = 'not-allowed';
    return;
  }
  
  // Determine if quoted
  let isQuoted = false;
  
  if (orderStatus === 'Quoted' || orderStatus === 'Â∑≤Êä•‰ª∑') {
    isQuoted = true;
  }
  
  // Fallback to totalPrice
  if (!isQuoted) {
    const totalPrice = parseFloat(order.totalPrice || 0);
    if (totalPrice > 0) {
      isQuoted = true;
    }
  }
  
  if (!isQuoted) {
    placeOrderBtn.disabled = true;
    placeOrderBtn.textContent = 'Waiting for quote';
    placeOrderBtn.style.opacity = '0.6';
    placeOrderBtn.style.cursor = 'not-allowed';
  } else {
    placeOrderBtn.disabled = false;
    placeOrderBtn.textContent = 'Proceed to checkout';
    placeOrderBtn.style.opacity = '1';
    placeOrderBtn.style.cursor = 'pointer';
  }
}

  // Derive order status
function getOrderStatus(order) {
  // Prefer custom Status
  if (order.lineItems && order.lineItems.length > 0) {
    const firstItem = order.lineItems[0];
    const attrs = firstItem.customAttributes || [];
    const statusAttr = attrs.find(a => a.key === 'Status' || a.key === 'Áä∂ÊÄÅ');
    
    if (statusAttr) {
      const status = statusAttr.value;
      
      // Check for not manufacturable status first (both Chinese and English)
      if (status === 'Êó†Ê≥ïÂä†Â∑•' || status === 'Not manufacturable') {
        return {
          text: 'Not manufacturable',
          className: 'status-rejected'
        };
      }
      if (status === 'Â∑≤Êä•‰ª∑' || status === 'Quoted') {
        return {
          text: 'Quoted',
          className: 'status-quoted'
        };
      }
    }
  }
  
  // Fallback to totalPrice
  const totalPrice = parseFloat(order.totalPrice || 0);
  
  if (totalPrice > 0) {
    return {
      text: 'Quoted',
      className: 'status-quoted'
    };
  } else {
    return {
      text: 'Pending',
      className: 'status-pending'
    };
  }
}

// Format date
function formatDate(dateString) {
  if (!dateString) return '--';
  
  try {
    const date = new Date(dateString);
    return date.toLocaleString('en-US', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit'
    });
  } catch (error) {
    console.error('Date formatting failed:', error);
    return '--';
  }
}

// Proceed to checkout
async function placeOrder() {
  const order = window.currentDraftOrder;
  
  if (!order) {
    alert('Quote data is not loaded. Please refresh and try again.');
    return;
  }
  
  const totalPrice = parseFloat(order.totalPrice || 0);
  
  if (totalPrice <= 0) {
    alert('This quote is not priced yet. Please wait until it is quoted.');
    return;
  }

  // If an invoice URL exists, redirect to avoid completing twice
  if (order.invoiceUrl) {
    if (confirm('A checkout link already exists for this quote. Continue to checkout?')) {
      window.location.href = order.invoiceUrl;
      return;
    }
  }
  
  // Confirm
  if (!confirm(`Proceed to checkout?\n\nTotal: $${totalPrice.toFixed(2)}\n\nYou will be redirected to checkout.`)) {
    return;
  }
  
    try {
      // Prepare cart items
    const cartItems = [];
    
    if (order.lineItems && order.lineItems.length > 0) {
      for (const item of order.lineItems) {
        const attrs = item.customAttributes || [];
        
        // Build properties payload
        const properties = {
          'Order Type': '3D Model Quote',
          'Draft Order ID': draftOrderId,
          'Quote Status': 'Quoted'
        };
        
        // Copy all custom attributes
        attrs.forEach(attr => {
          properties[attr.key] = attr.value;
        });
        
        // Attach quoted price
        properties['Quoted Price'] = String(item.price || 0);
        
        cartItems.push({
          id: 0, // Use invalid id to trigger fallback logic
          quantity: item.quantity || 1,
          properties: properties
        });
      }
    }
    
    // Resolve product id
    const hasValidProductId = cartItems.some(item => item.id && item.id !== 0);
    
    if (!hasValidProductId) {
      // Resolve variant id using multiple strategies
      let genericProductId = null;
      
      // Method 1: global
      if (window.theme && window.theme.defaultVariantId) {
        genericProductId = window.theme.defaultVariantId;
      }
      
      // Method 2: page JSON
      if (!genericProductId) {
        const productData = document.querySelector('[data-product-json]');
        if (productData) {
          try {
            const product = JSON.parse(productData.textContent);
            if (product && product.selected_or_first_available_variant) {
              genericProductId = product.selected_or_first_available_variant.id.toString();
            }
          } catch (e) {
            // Ignore and continue
          }
        }
      }
      
      // Method 3: hard-coded fallback variant id
      if (!genericProductId) {
        // Variant id for your "3D model quote" service product
        genericProductId = '51217840308511';
      }
      
      if (!genericProductId) {
        alert('Configuration error: unable to resolve product ID. Please contact support.');
        return;
      }
      
      // Use complete-draft-order API to avoid cart price issues
      try {
        const completeResponse = await fetch(`${API_BASE}/complete-draft-order`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            draftOrderId: draftOrderId
          })
        });
        
        if (completeResponse.ok) {
          const completeResult = await completeResponse.json();
          
          if (completeResult.success) {
            alert(`Your order is ready.\n\nOrder: ${completeResult.draftOrder.name}\nAmount: $${totalPrice}\n\nRedirecting to checkout...`);
            
            if (completeResult.draftOrder.invoiceUrl) {
              window.location.href = completeResult.draftOrder.invoiceUrl;
            } else {
              window.location.href = `/account/orders`;
            }
            return;
          }
        }
        
        // If complete fails, throw
        throw new Error('Failed to complete draft order');
        
      } catch (error) {
        console.error('‚ùå Failed to complete draft order:', error);
        
        // Fallback instructions
        const orderInfo = `
We couldn‚Äôt complete this order automatically. Please contact support:

Quote details:
- Quote: ${order.name}
- Email: ${order.email}
- Amount: $${totalPrice}
- File: ${order.lineItems?.[0]?.title || '3D Model'}

Support: support@example.com
        `;
        
        alert(orderInfo);
        return;
      }
    }
    
  } catch (error) {
    console.error('Checkout failed:', error);
    alert('Checkout failed: ' + error.message);
  }
}

// Load quotes list
async function loadAllOrders() {
  try {
    const response = await fetch(`${API_BASE}/get-draft-orders?${authQuery}`);
    
    if (!response.ok) {
      throw new Error(`API request failed: ${response.status}`);
    }
    
    const data = await response.json();
    
    if (data.success && data.draftOrders.length > 0) {
      renderOrdersList(data.draftOrders);
    } else {
      showEmptyState();
    }
  } catch (error) {
    console.error('Failed to load quotes list:', error);
    showError('Failed to load quotes: ' + error.message);
  }
}

// Render quotes list
function renderOrdersList(orders) {
  // Hide single quote view
  document.getElementById('quote-detail').style.display = 'none';
  document.getElementById('loading-state').style.display = 'none';
  
  // Sort by created date (newest first)
  const sortedOrders = [...orders].sort((a, b) => {
    const dateA = new Date(a.createdAt || 0);
    const dateB = new Date(b.createdAt || 0);
    return dateB - dateA;
  });
  
  // Show list container
  let ordersListContainer = document.getElementById('orders-list-container');
  if (!ordersListContainer) {
    ordersListContainer = document.createElement('div');
    ordersListContainer.id = 'orders-list-container';
    ordersListContainer.className = 'orders-list-container';
    
    // Insert into page
    const mainContent = document.querySelector('.quote-detail-container');
    if (mainContent) {
      mainContent.appendChild(ordersListContainer);
    } else {
      console.error('Could not find .quote-detail-container element');
      document.body.appendChild(ordersListContainer);
    }
  }
  
  ordersListContainer.innerHTML = `
    <div class="orders-list-header">
      <h2>My Quotes</h2>
      <p>Click a quote to view details</p>
    </div>
    <div class="orders-list">
      ${sortedOrders.map(order => createOrderCard(order)).join('')}
    </div>
  `;
  
  ordersListContainer.style.display = 'block';
}

// Create quote card
function createOrderCard(order) {
  const status = getOrderStatus(order);
  const date = formatDate(order.createdAt);
  
  return `
    <div class="order-card" onclick="viewOrder('${order.id}')">
      <div class="order-card-header">
        <div class="order-number">${order.name}</div>
        <div class="order-status ${status.className}">${status.text}</div>
      </div>
      <div class="order-card-body">
        <div class="order-info">
          <div class="order-date">Created: ${date}</div>
          <div class="order-total">${order.totalPrice ? `$${parseFloat(order.totalPrice).toFixed(2)}` : 'Pending'}</div>
        </div>
        ${order.lineItems && order.lineItems.length > 0 ? `
          <div class="order-items">
            ${order.lineItems.slice(0, 2).map(item => `
              <div class="order-item">
                ${item.title} ${item.quantity > 1 ? `√ó${item.quantity}` : ''}
              </div>
            `).join('')}
            ${order.lineItems.length > 2 ? `<div class="order-item-more">...and ${order.lineItems.length - 2} more</div>` : ''}
          </div>
        ` : ''}
      </div>
      <div class="order-card-actions">
        <button class="btn btn-primary" onclick="event.stopPropagation(); viewOrder('${order.id}')">
          View
        </button>
        <button class="btn btn-danger" onclick="event.stopPropagation(); deleteOrder('${order.id}')">
          Delete
        </button>
      </div>
    </div>
  `;
}

// View quote
function viewOrder(orderId) {
  window.location.href = `${window.location.pathname}?id=${encodeURIComponent(orderId)}`;
}

// Delete quote
async function deleteOrder(orderId) {
  if (!confirm('Delete this quote? This action cannot be undone.')) {
    return;
  }
  
  try {
    const response = await fetch(`${API_BASE}/delete-draft-order`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ 
        draftOrderId: orderId,
        email: customerEmail,
        admin: isAdmin ? '1' : '0'
      })
    });
    
    const data = await response.json();
    
    if (data.success) {
      showSuccessMessage('Quote deleted.');
      // Reload list
      setTimeout(() => {
        loadAllOrders();
      }, 1000);
    } else {
      throw new Error(data.error || 'Delete failed');
    }
  } catch (error) {
    console.error('Delete failed:', error);
    showError('Delete failed: ' + error.message);
  }
}

// Show empty state
function showEmptyState() {
  // Hide other views
  document.getElementById('quote-detail').style.display = 'none';
  document.getElementById('loading-state').style.display = 'none';
  
  let emptyState = document.getElementById('empty-state');
  if (!emptyState) {
    emptyState = document.createElement('div');
    emptyState.id = 'empty-state';
    emptyState.className = 'empty-state';
    
    const mainContent = document.querySelector('.quote-detail-container');
    if (mainContent) {
      mainContent.appendChild(emptyState);
    } else {
      console.error('Could not find .quote-detail-container element');
      document.body.appendChild(emptyState);
    }
  }
  
  emptyState.innerHTML = `
    <div class="empty-state-content">
      <div class="empty-state-icon">üìã</div>
      <h3>No quotes yet</h3>
      <p>You haven‚Äôt submitted an RFQ.</p>
      <a href="/pages/quote-request" class="btn btn-primary">
        Request a Quote
      </a>
    </div>
  `;
  
  emptyState.style.display = 'block';
}

// Show success toast
function showSuccessMessage(message, duration = 3000) {
  // Create toast element
  const successMsg = document.createElement('div');
  successMsg.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: #28a745;
    color: white;
    padding: 12px 20px;
    border-radius: 6px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 10000;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.3s ease;
  `;
  successMsg.textContent = message;
  
  document.body.appendChild(successMsg);
  
  // Auto-remove
  setTimeout(() => {
    successMsg.style.opacity = '0';
    successMsg.style.transform = 'translateX(100%)';
    setTimeout(() => {
      if (successMsg.parentNode) {
        successMsg.parentNode.removeChild(successMsg);
      }
    }, 300);
  }, duration);
}

// Show error
function showError(message) {
  document.getElementById('loading-state').style.display = 'none';
  document.getElementById('quote-detail').style.display = 'none';
  document.getElementById('error-state').style.display = 'block';
  document.getElementById('error-message').textContent = message;
  
  // If quote does not exist, show recreate CTA
  if (message.toLowerCase().includes('no longer exists') || message.toLowerCase().includes('does not exist')) {
    document.getElementById('retry-create-btn').style.display = 'inline-block';
  }
}

// Recreate quote
async function retryCreateOrder() {
  const retryBtn = document.getElementById('retry-create-btn');
  retryBtn.disabled = true;
  retryBtn.textContent = 'Creating...';
  
  try {
    // Redirect to upload for a new RFQ
    alert('This quote does not exist. Redirecting you to upload to create a new RFQ.\n\nPlease re-upload files and fill in the specs.');
    window.location.href = '/pages/model-uploader';
  } catch (error) {
    console.error('Failed to recreate quote:', error);
    retryBtn.disabled = false;
    retryBtn.textContent = 'Recreate quote';
    alert('Redirect failed. Please open the upload page manually.');
  }
}


// Email validation helper (legacy)
function filterOrdersByCustomerEmail() {
  const customerEmailDiv = document.querySelector('.customer-authenticated');
  if (!customerEmailDiv) return null;
  
  const customerEmail = customerEmailDiv.getAttribute('data-customer-email');
  return customerEmail;
}

// Patch loadDraftOrders (legacy)
const originalLoadDraftOrders = window.loadDraftOrders;
if (originalLoadDraftOrders) {
  window.loadDraftOrders = async function() {
    const customerEmail = filterOrdersByCustomerEmail();
    if (!customerEmail) {
      console.error('Customer email not found; unable to load quotes');
      return;
    }
    
    // Call original loader
    await originalLoadDraftOrders();
    
    // Filter: only show current customer's quotes
    const allOrders = document.querySelectorAll('.order-card');
    allOrders.forEach(orderCard => {
      const emailElement = orderCard.querySelector('[data-order-email]');
      if (emailElement) {
        const orderEmail = emailElement.getAttribute('data-order-email');
        if (orderEmail !== customerEmail) {
          // Hide quotes that do not belong to current customer
          orderCard.style.display = 'none';
        }
      }
    });
  };
}
</script>

</div>
<!-- End customer-authenticated wrapper -->
{% endunless %}
