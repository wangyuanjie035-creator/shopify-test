<!DOCTYPE html>
<html>
<head>
    <title>æ–‡ä»¶å¤§å°ä¸€è‡´æ€§æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { border: 1px solid #ddd; padding: 20px; margin: 20px 0; border-radius: 8px; }
        .success { border-color: #4CAF50; background-color: #f1f8e9; }
        .error { border-color: #f44336; background-color: #ffebee; }
        .info { border-color: #2196F3; background-color: #e3f2fd; }
        button { padding: 10px 20px; margin: 10px 5px; border: none; border-radius: 4px; cursor: pointer; }
        .primary { background-color: #2196F3; color: white; }
        .success { background-color: #4CAF50; color: white; }
        .warning { background-color: #ff9800; color: white; }
        #result { margin-top: 20px; padding: 15px; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>æ–‡ä»¶å¤§å°ä¸€è‡´æ€§æµ‹è¯•</h1>
    
    <div class="test-section info">
        <h3>ğŸ“‹ æµ‹è¯•è¯´æ˜</h3>
        <p>æ­¤æµ‹è¯•éªŒè¯æ–‡ä»¶ä¸Šä¼ å’Œä¸‹è½½è¿‡ç¨‹ä¸­çš„å¤§å°ä¸€è‡´æ€§ï¼š</p>
        <ol>
            <li>ä¸Šä¼ æ–‡ä»¶åˆ° Shopify Files</li>
            <li>ä¸‹è½½æ–‡ä»¶å¹¶éªŒè¯å¤§å°</li>
            <li>å¯¹æ¯”åŸå§‹å¤§å°å’Œä¸‹è½½å¤§å°</li>
            <li>ç¡®ä¿æ–‡ä»¶å®Œæ•´æ€§</li>
        </ol>
    </div>

    <div class="test-section">
        <h3>ğŸ“ æ–‡ä»¶é€‰æ‹©</h3>
        <input type="file" id="fileInput" accept=".stp,.step,.stl,.obj">
        <button class="primary" onclick="startTest()">å¼€å§‹æµ‹è¯•</button>
        <button class="warning" onclick="clearResults()">æ¸…é™¤ç»“æœ</button>
    </div>

    <div id="result"></div>

    <script>
        let originalFile = null;

        async function startTest() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                showResult('è¯·é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶è¿›è¡Œæµ‹è¯•', 'error');
                return;
            }

            originalFile = file;
            showResult(`ğŸ“ å¼€å§‹æµ‹è¯•æ–‡ä»¶: ${file.name}<br>ğŸ“Š åŸå§‹å¤§å°: ${file.size} å­—èŠ‚ (${(file.size / 1024).toFixed(2)} KB)`, 'info');

            try {
                // æ­¥éª¤1: ä¸Šä¼ æ–‡ä»¶åˆ° Shopify Files
                showResult('ğŸ”„ æ­¥éª¤1: ä¸Šä¼ æ–‡ä»¶åˆ° Shopify Files...', 'info');
                
                const fileData = await readFileAsBase64(file);
                const uploadResponse = await fetch('https://shopify-13s4.vercel.app/api/store-file-real', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        fileData: fileData,
                        fileName: file.name,
                        fileType: file.type || 'application/octet-stream'
                    })
                });

                if (!uploadResponse.ok) {
                    throw new Error(`ä¸Šä¼ å¤±è´¥: ${uploadResponse.status}`);
                }

                const uploadResult = await uploadResponse.json();
                
                if (!uploadResult.success) {
                    throw new Error(`ä¸Šä¼ å¤±è´¥: ${uploadResult.message}`);
                }

                showResult(`âœ… ä¸Šä¼ æˆåŠŸ!<br>
                    ğŸ“‹ æ–‡ä»¶ID: ${uploadResult.fileId}<br>
                    ğŸ†” Shopifyæ–‡ä»¶ID: ${uploadResult.shopifyFileId}<br>
                    ğŸ“Š ä¸Šä¼ å¤§å°: ${uploadResult.uploadedFileSize} å­—èŠ‚<br>
                    ğŸ“Š Shopifyè®°å½•å¤§å°: ${uploadResult.originalFileSize} å­—èŠ‚<br>
                    âœ… å¤§å°åŒ¹é…: ${uploadResult.sizeMatch ? 'æ˜¯' : 'å¦'}`, 'success');

                // æ­¥éª¤2: ä¸‹è½½æ–‡ä»¶
                showResult('ğŸ”„ æ­¥éª¤2: ä» Shopify Files ä¸‹è½½æ–‡ä»¶...', 'info');

                const downloadResponse = await fetch(`https://shopify-13s4.vercel.app/api/download-file-real?id=${uploadResult.shopifyFileId}`);
                
                if (!downloadResponse.ok) {
                    throw new Error(`ä¸‹è½½å¤±è´¥: ${downloadResponse.status}`);
                }

                const downloadedBlob = await downloadResponse.blob();
                const downloadedSize = downloadedBlob.size;
                
                // è·å–å“åº”å¤´ä¸­çš„å¤§å°ä¿¡æ¯
                const originalSize = downloadResponse.headers.get('X-Original-File-Size');
                const downloadedSizeHeader = downloadResponse.headers.get('X-Downloaded-File-Size');
                const sizeMatch = downloadResponse.headers.get('X-Size-Match');

                // æ­¥éª¤3: éªŒè¯å¤§å°ä¸€è‡´æ€§
                const sizeConsistent = originalFile.size === downloadedSize;
                
                showResult(`âœ… ä¸‹è½½å®Œæˆ!<br>
                    ğŸ“ æ–‡ä»¶å: ${file.name}<br>
                    ğŸ“Š åŸå§‹å¤§å°: ${originalFile.size} å­—èŠ‚ (${(originalFile.size / 1024).toFixed(2)} KB)<br>
                    ğŸ“Š ä¸‹è½½å¤§å°: ${downloadedSize} å­—èŠ‚ (${(downloadedSize / 1024).toFixed(2)} KB)<br>
                    ğŸ“Š ShopifyåŸå§‹å¤§å°: ${originalSize || 'æœªçŸ¥'} å­—èŠ‚<br>
                    ğŸ“Š æœåŠ¡å™¨ä¸‹è½½å¤§å°: ${downloadedSizeHeader || 'æœªçŸ¥'} å­—èŠ‚<br>
                    âœ… å¤§å°ä¸€è‡´æ€§: ${sizeConsistent ? 'âœ… ä¸€è‡´' : 'âŒ ä¸ä¸€è‡´'}<br>
                    âœ… æœåŠ¡å™¨éªŒè¯: ${sizeMatch === 'true' ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥'}`, 
                    sizeConsistent ? 'success' : 'error');

                // æ­¥éª¤4: æä¾›ä¸‹è½½é“¾æ¥
                const downloadLink = document.createElement('a');
                downloadLink.href = URL.createObjectURL(downloadedBlob);
                downloadLink.download = `downloaded_${file.name}`;
                downloadLink.textContent = 'ğŸ“¥ ä¸‹è½½æµ‹è¯•æ–‡ä»¶';
                downloadLink.className = 'primary';
                downloadLink.style.display = 'inline-block';
                downloadLink.style.marginTop = '10px';
                
                document.getElementById('result').appendChild(downloadLink);

            } catch (error) {
                showResult(`âŒ æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                console.error('æµ‹è¯•é”™è¯¯:', error);
            }
        }

        function readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = () => reject(new Error('æ–‡ä»¶è¯»å–å¤±è´¥'));
                reader.readAsDataURL(file);
            });
        }

        function showResult(message, type) {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = message;
            resultDiv.className = `test-section ${type}`;
        }

        function clearResults() {
            document.getElementById('result').innerHTML = '';
            document.getElementById('result').className = '';
            document.getElementById('fileInput').value = '';
            originalFile = null;
        }
    </script>
</body>
</html>
