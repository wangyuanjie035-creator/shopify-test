{% comment %}
  åå°æ–‡ä»¶ç®¡ç†é¡µé¢ - ç”¨äºå‘˜å·¥ä¸‹è½½å®¢æˆ·ä¸Šä¼ çš„æ–‡ä»¶
  åªæœ‰é€šè¿‡èº«ä»½éªŒè¯çš„å®¢æœäººå‘˜æ‰èƒ½è®¿é—®
{% endcomment %}

<!-- åŠ è½½ç™»å½•ç®¡ç†ç³»ç»Ÿ -->
<script src="{{ 'login-manager.js' | asset_url }}" defer></script>

<!-- æŠ¥ä»·ä¸­å¿ƒAPIå®¢æˆ·ç«¯ï¼ˆApp Proxyï¼‰ -->
<script src="{{ 'quote-api.js' | asset_url }}" defer></script>

<!-- åŠ è½½æ–‡ä»¶å­˜å‚¨ç®¡ç†å™¨ -->
<script src="{{ 'file-storage.js' | asset_url }}" defer></script>

<div class="admin-file-manager" id="admin-file-manager" style="display: none;">
  <div class="admin-header">
    <h1>å®¢æˆ·å†å²è®¢å•è®°å½•</h1>
    <p>æŸ¥çœ‹å®¢æˆ·çš„å†å²è¯¢ä»·è®¢å•å’Œæ–‡ä»¶ä¿¡æ¯</p>
  </div>

  <div class="admin-controls">
    <div class="search-filters">
      <input type="text" id="search-files" placeholder="æœç´¢æ–‡ä»¶åæˆ–å®¢æˆ·ä¿¡æ¯..." class="search-input">
      <select id="filter-type" class="filter-select">
        <option value="">æ‰€æœ‰æ–‡ä»¶ç±»å‹</option>
        <option value="3d">3Dæ–‡ä»¶</option>
        <option value="2d">2Dæ–‡ä»¶</option>
        <option value="zip">å‹ç¼©åŒ…</option>
      </select>
      <select id="filter-date" class="filter-select">
        <option value="">æ‰€æœ‰æ—¶é—´</option>
        <option value="today">ä»Šå¤©</option>
        <option value="week">æœ¬å‘¨</option>
        <option value="month">æœ¬æœˆ</option>
      </select>
    </div>
    
    <div class="bulk-actions">
      <button id="refresh-files" class="btn btn--primary">ğŸ”„ åˆ·æ–°æ–‡ä»¶åˆ—è¡¨</button>
      <button id="select-all" class="btn btn--ghost">å…¨é€‰</button>
      <button id="download-selected" class="btn btn--primary" disabled>ä¸‹è½½é€‰ä¸­æ–‡ä»¶</button>
      <button id="export-list" class="btn btn--ghost">å¯¼å‡ºåˆ—è¡¨</button>
    </div>
  </div>

  <div class="files-table-container">
    <table class="files-table" id="files-table">
      <thead>
        <tr>
          <th class="checkbox-col">
            <input type="checkbox" id="select-all-checkbox">
          </th>
          <th class="file-col">æ–‡ä»¶ä¿¡æ¯</th>
          <th class="type-col">ç±»å‹</th>
          <th class="size-col">å¤§å°</th>
          <th class="customer-col">å®¢æˆ·ä¿¡æ¯</th>
          <th class="date-col">ä¸Šä¼ æ—¶é—´</th>
          <th class="status-col">çŠ¶æ€</th>
          <th class="actions-col">æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="files-tbody">
        <!-- æ–‡ä»¶åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
      </tbody>
    </table>
  </div>

  <div class="pagination" id="pagination">
    <!-- åˆ†é¡µæ§ä»¶ -->
  </div>

  <!-- æ–‡ä»¶é¢„è§ˆæ¨¡æ€æ¡† -->
  <div id="file-preview-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="preview-title">æ–‡ä»¶é¢„è§ˆ</h3>
        <button class="modal-close" id="close-preview">&times;</button>
      </div>
      <div class="modal-body">
        <div id="preview-content">
          <!-- é¢„è§ˆå†…å®¹ -->
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn--primary" id="download-preview-file">ä¸‹è½½æ–‡ä»¶</button>
        <button class="btn btn--ghost" id="close-preview-btn">å…³é—­</button>
      </div>
    </div>
  </div>

  <!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
  <div id="loading-indicator" class="loading-indicator" style="display: none;">
    <div class="spinner"></div>
    <p>æ­£åœ¨åŠ è½½æ–‡ä»¶åˆ—è¡¨...</p>
  </div>
</div>

<style>
.admin-file-manager {
  max-width: 1400px;
  margin: 0 auto;
  padding: 24px;
  background: #f8f9fa;
  min-height: 100vh;
}

.admin-header {
  background: white;
  padding: 32px;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  margin-bottom: 24px;
  text-align: center;
}

.admin-header h1 {
  color: #333;
  margin: 0 0 8px 0;
  font-size: 28px;
  font-weight: 700;
}

.admin-header p {
  color: #666;
  margin: 0;
  font-size: 16px;
}

.admin-controls {
  background: white;
  padding: 24px;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  margin-bottom: 24px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 16px;
}

.search-filters {
  display: flex;
  gap: 12px;
  align-items: center;
  flex-wrap: wrap;
}

.search-input, .filter-select {
  padding: 10px 12px;
  border: 1px solid #e0e0e0;
  border-radius: 6px;
  font-size: 14px;
  min-width: 200px;
}

.search-input:focus, .filter-select:focus {
  outline: none;
  border-color: #1976d2;
  box-shadow: 0 0 0 2px rgba(25, 118, 210, 0.1);
}

.bulk-actions {
  display: flex;
  gap: 8px;
  align-items: center;
}

.files-table-container {
  background: white;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  overflow: hidden;
  margin-bottom: 24px;
}

.files-table {
  width: 100%;
  border-collapse: collapse;
}

.files-table th {
  background: #f8f9fa;
  padding: 16px 12px;
  text-align: left;
  font-weight: 600;
  color: #333;
  border-bottom: 1px solid #e0e0e0;
  font-size: 14px;
}

.files-table td {
  padding: 16px 12px;
  border-bottom: 1px solid #f0f0f0;
  font-size: 14px;
  vertical-align: middle;
}

.files-table tr:hover {
  background: #f8f9fa;
}

.checkbox-col { width: 40px; }
.file-col { width: 300px; }
.type-col { width: 80px; }
.size-col { width: 100px; }
.customer-col { width: 200px; }
.date-col { width: 150px; }
.status-col { width: 100px; }
.actions-col { width: 120px; }

.file-info {
  display: flex;
  align-items: center;
  gap: 12px;
}

.file-icon {
  width: 32px;
  height: 32px;
  background: #e3f2fd;
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #1976d2;
  font-size: 14px;
  font-weight: bold;
}

.file-details h4 {
  margin: 0 0 4px 0;
  color: #333;
  font-size: 14px;
  font-weight: 600;
}

.file-details p {
  margin: 0;
  color: #666;
  font-size: 12px;
}

.file-type {
  display: inline-block;
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 500;
}

.file-type.3d { background: #e8f5e8; color: #2e7d32; }
.file-type.2d { background: #fff3e0; color: #f57c00; }
.file-type.zip { background: #e3f2fd; color: #1976d2; }

.file-size {
  color: #666;
  font-size: 13px;
}

.customer-info {
  color: #333;
  font-size: 13px;
}

.upload-time {
  color: #666;
  font-size: 13px;
}

.status-badge {
  display: inline-block;
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 500;
}

.status-badge.pending { background: #fff3e0; color: #f57c00; }
.status-badge.processing { background: #e3f2fd; color: #1976d2; }
.status-badge.completed { background: #e8f5e8; color: #2e7d32; }
.status-badge.error { background: #ffebee; color: #c62828; }

.action-buttons {
  display: flex;
  gap: 4px;
}

.action-btn {
  padding: 6px 8px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 12px;
  transition: all 0.3s ease;
}

.action-btn.download {
  background: #e3f2fd;
  color: #1976d2;
}

.action-btn.download:hover {
  background: #1976d2;
  color: white;
}

.action-btn.preview {
  background: #f3e5f5;
  color: #7b1fa2;
}

.action-btn.preview:hover {
  background: #7b1fa2;
  color: white;
}

.action-btn.delete {
  background: #ffebee;
  color: #c62828;
}

.action-btn.delete:hover {
  background: #c62828;
  color: white;
}

/* æ¨¡æ€æ¡†æ ·å¼ */
.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
}

.modal-content {
  background: white;
  margin: 5% auto;
  padding: 0;
  border-radius: 12px;
  width: 90%;
  max-width: 800px;
  max-height: 80vh;
  overflow: hidden;
  box-shadow: 0 8px 32px rgba(0,0,0,0.3);
}

.modal-header {
  padding: 20px 24px;
  border-bottom: 1px solid #e0e0e0;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-header h3 {
  margin: 0;
  color: #333;
  font-size: 18px;
  font-weight: 600;
}

.modal-close {
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
  color: #666;
  padding: 0;
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: all 0.3s ease;
}

.modal-close:hover {
  background: #f0f0f0;
  color: #333;
}

.modal-body {
  padding: 24px;
  max-height: 60vh;
  overflow-y: auto;
}

.modal-footer {
  padding: 20px 24px;
  border-top: 1px solid #e0e0e0;
  display: flex;
  justify-content: flex-end;
  gap: 12px;
}

/* åŠ è½½æŒ‡ç¤ºå™¨ */
.loading-indicator {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: white;
  padding: 32px;
  border-radius: 12px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.3);
  text-align: center;
  z-index: 1001;
}

.spinner {
  width: 40px;
  height: 40px;
  border: 4px solid #f0f0f0;
  border-top: 4px solid #1976d2;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin: 0 auto 16px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* åˆ†é¡µæ ·å¼ */
.pagination {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 8px;
  margin-top: 24px;
}

.pagination button {
  padding: 8px 12px;
  border: 1px solid #e0e0e0;
  background: white;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.3s ease;
}

.pagination button:hover:not(:disabled) {
  background: #f0f0f0;
  border-color: #ccc;
}

.pagination button.active {
  background: #1976d2;
  color: white;
  border-color: #1976d2;
}

.pagination button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
  .admin-controls {
    flex-direction: column;
    align-items: stretch;
  }
  
  .search-filters {
    flex-direction: column;
  }
  
  .search-input, .filter-select {
    min-width: auto;
  }
  
  .files-table-container {
    overflow-x: auto;
  }
  
  .files-table {
    min-width: 800px;
  }
}
</style>

<script>
// åå°æ–‡ä»¶ç®¡ç†JavaScript
document.addEventListener('DOMContentLoaded', function() {
  const filesTable = document.getElementById('files-tbody');
  const searchInput = document.getElementById('search-files');
  const filterType = document.getElementById('filter-type');
  const filterDate = document.getElementById('filter-date');
  const refreshFilesBtn = document.getElementById('refresh-files');
  const selectAllCheckbox = document.getElementById('select-all-checkbox');
  const selectAllBtn = document.getElementById('select-all');
  const downloadSelectedBtn = document.getElementById('download-selected');
  const exportListBtn = document.getElementById('export-list');
  const loadingIndicator = document.getElementById('loading-indicator');
  const previewModal = document.getElementById('file-preview-modal');
  
  let allFiles = [];
  let filteredFiles = [];
  let selectedFiles = new Set();
  
  // è·å–å®¢æˆ·ä¿¡æ¯
  async function getCustomerInfo() {
    try {
      // é¦–å…ˆå°è¯•ä»å…¨å±€å®¢æˆ·çŠ¶æ€è·å–
      if (window.customerState && window.customerState.loggedIn) {
        return {
          name: window.customerState.customerName || 'ç™»å½•ç”¨æˆ·',
          email: window.customerState.email || ''
        };
      }
      
      // å°è¯•ä»è´­ç‰©è½¦APIè·å–å®¢æˆ·ä¿¡æ¯
      try {
        const response = await fetch('/cart.js');
        const cart = await response.json();
        
        console.log('è´­ç‰©è½¦å®¢æˆ·ä¿¡æ¯æ£€æŸ¥:', {
          attributes: cart.attributes,
          note: cart.note,
          customer: cart.customer
        });
        
        // æ£€æŸ¥è´­ç‰©è½¦ä¸­æ˜¯å¦æœ‰å®¢æˆ·ä¿¡æ¯
        if (cart.attributes && cart.attributes.customer_email) {
          return {
            name: cart.attributes.customer_name || 'è´­ç‰©è½¦å®¢æˆ·',
            email: cart.attributes.customer_email
          };
        }
        
        // æ£€æŸ¥è´­ç‰©è½¦noteä¸­æ˜¯å¦æœ‰å®¢æˆ·ä¿¡æ¯
        if (cart.note) {
          try {
            const noteData = JSON.parse(cart.note);
            if (noteData.customer_email) {
              return {
                name: noteData.customer_name || 'è´­ç‰©è½¦å®¢æˆ·',
                email: noteData.customer_email
              };
            }
          } catch (parseError) {
            console.log('è´­ç‰©è½¦noteä¸æ˜¯JSONæ ¼å¼');
          }
        }
      } catch (cartError) {
        console.log('è´­ç‰©è½¦APIæœªæä¾›å®¢æˆ·ä¿¡æ¯');
      }
      
      // å°è¯•ä»å½“å‰é¡µé¢è·å–å®¢æˆ·ä¿¡æ¯
      const customerScript = document.querySelector('script[data-customer]');
      if (customerScript) {
        try {
          const customerData = JSON.parse(customerScript.textContent);
          return {
            name: customerData.first_name + ' ' + customerData.last_name || 'å®¢æˆ·',
            email: customerData.email || ''
          };
        } catch (parseError) {
          console.log('æ— æ³•è§£æå®¢æˆ·æ•°æ®');
        }
      }
      
      // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ä»»ä½•å®¢æˆ·ä¿¡æ¯ï¼Œè¿”å›é»˜è®¤å€¼
      return {
        name: 'æœªçŸ¥å®¢æˆ·',
        email: ''
      };
    } catch (error) {
      console.error('è·å–å®¢æˆ·ä¿¡æ¯å¤±è´¥:', error);
      return {
        name: 'æœªçŸ¥å®¢æˆ·',
        email: ''
      };
    }
  }

  // ä»æŠ¥ä»·ä¸­å¿ƒAPIè·å–æ–‡ä»¶æ•°æ®ï¼ˆä¼˜å…ˆï¼‰ï¼Œå¤±è´¥åˆ™å›é€€åˆ°è´­ç‰©è½¦API
  async function fetchCartFiles() {
    try {
      if (window.quoteApi) {
        const list = await window.quoteApi.list();
        const files = [];
        let fileId = 1;
        (list.records || list || []).forEach(r => {
          const name = r.file_name || 'æœªçŸ¥æ–‡ä»¶';
          const ext = name.split('.').pop().toLowerCase();
          let type = 'other';
          if (['stp','step'].includes(ext)) type = '3d';
          else if (['dwg','dxf','pdf'].includes(ext)) type = '2d';
          else if (ext === 'zip') type = 'zip';
          files.push({
            id: fileId++,
            name,
            type,
            size: 0,
            customer: r.customer_name || 'æœªçŸ¥å®¢æˆ·',
            email: r.customer_email || '',
            uploadTime: r.created_at ? new Date(r.created_at).toLocaleString('zh-CN') : new Date().toLocaleString('zh-CN'),
            status: (r.status === 'Quoted' ? 'completed' : 'processing'),
            downloadUrl: r.file_url || '',
            cartItemKey: r.cart_item_key || '',
            uuid: r.uuid || r.id
          });
        });
        return files;
      }
      const response = await fetch('/cart.js');
      const cart = await response.json();
      
      // è·å–å®¢æˆ·ä¿¡æ¯
      const customerInfo = await getCustomerInfo();
      console.log('è·å–åˆ°çš„å®¢æˆ·ä¿¡æ¯:', customerInfo);
      console.log('è´­ç‰©è½¦æ•°æ®:', cart);
      
      const files = [];
      let fileId = 1;
      
      cart.items.forEach(item => {
        // æ£€æŸ¥æ˜¯å¦æ˜¯æŠ¥ä»·è®¢å•
        let isQuoteOrder = false;
        let customerName = '';
        let customerEmail = '';
        let uploadedFiles = [];
        let uploadTime = '';
        let quoteStatus = 'Pending';
        
        // è§£æå•†å“å±æ€§
        if (item.properties) {
          console.log('å•†å“å±æ€§:', item.properties);
          for (const [key, value] of Object.entries(item.properties)) {
            if (key === 'Order Type' && value === '3D Model Quote') {
              isQuoteOrder = true;
            }
            // åªä½¿ç”¨ä¸€ä¸ªæ–‡ä»¶åå±æ€§ï¼Œé¿å…é‡å¤
            if (key === 'é›¶ä»¶åç§°' && value) {
              uploadedFiles.push(value);
            }
            if (key === 'å®¢æˆ·å§“å' || key === 'Customer Name') {
              customerName = value;
            }
            if (key === 'å®¢æˆ·é‚®ç®±' || key === 'Customer Email') {
              customerEmail = value;
            }
            if (key === 'Quote Status') {
              quoteStatus = value;
            }
            if (key === '_uuid') {
              // ä»UUIDä¸­æå–æ—¶é—´æˆ³ä½œä¸ºä¸Šä¼ æ—¶é—´
              const timestamp = parseInt(value.split('-')[0]);
              if (timestamp) {
                uploadTime = new Date(timestamp).toLocaleString('zh-CN');
              }
            }
          }
        }
        
        // å¦‚æœæ²¡æœ‰æ‰¾åˆ°å®¢æˆ·ä¿¡æ¯ï¼Œä½¿ç”¨é»˜è®¤çš„å®¢æˆ·ä¿¡æ¯
        if (!customerName) {
          customerName = customerInfo.name;
        }
        if (!customerEmail) {
          customerEmail = customerInfo.email;
        }
        
        // å¦‚æœæ˜¯æŠ¥ä»·è®¢å•ä¸”æœ‰ä¸Šä¼ æ–‡ä»¶ï¼Œæ·»åŠ åˆ°æ–‡ä»¶åˆ—è¡¨
        if (isQuoteOrder && uploadedFiles.length > 0) {
          // å»é‡ï¼šåªå¤„ç†å”¯ä¸€çš„æ–‡ä»¶å
          const uniqueFiles = [...new Set(uploadedFiles)];
          
          uniqueFiles.forEach(fileName => {
            const fileExtension = fileName.split('.').pop().toLowerCase();
            let fileType = 'other';
            
            if (['stp', 'step'].includes(fileExtension)) {
              fileType = '3d';
            } else if (['dwg', 'dxf', 'pdf'].includes(fileExtension)) {
              fileType = '2d';
            } else if (fileExtension === 'zip') {
              fileType = 'zip';
            }
            
            files.push({
              id: fileId++,
              name: fileName,
              type: fileType,
              size: 0, // è´­ç‰©è½¦APIä¸æä¾›æ–‡ä»¶å¤§å°
              customer: customerName || customerInfo.name,
              email: customerEmail || customerInfo.email,
              uploadTime: uploadTime || new Date().toLocaleString('zh-CN'),
              status: quoteStatus === 'Quoted' ? 'completed' : 'processing',
              downloadUrl: '', // éœ€è¦ä»å…¶ä»–åœ°æ–¹è·å–ä¸‹è½½é“¾æ¥
              cartItemKey: item.key,
              uuid: item.properties?._uuid || ''
            });
          });
        }
      });
      
      // å…¨å±€å»é‡ï¼šåŸºäºæ–‡ä»¶åå’ŒUUIDå»é‡
      const uniqueFiles = [];
      const seenFiles = new Set();
      
      files.forEach(file => {
        const key = `${file.name}-${file.uuid}`;
        if (!seenFiles.has(key)) {
          seenFiles.add(key);
          uniqueFiles.push(file);
        }
      });
      
      return uniqueFiles;
    } catch (error) {
      console.error('è·å–æ–‡ä»¶å¤±è´¥:', error);
      return [];
    }
  }
  
  // åˆå§‹åŒ–
  async function init() {
    loadingIndicator.style.display = 'block';
    try {
      allFiles = await fetchCartFiles();
    filteredFiles = [...allFiles];
    renderFiles();
    } catch (error) {
      console.error('åˆå§‹åŒ–å¤±è´¥:', error);
      allFiles = [];
      filteredFiles = [];
      renderFiles();
    } finally {
      loadingIndicator.style.display = 'none';
    }
    setupEventListeners();
  }
  
  // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
  function setupEventListeners() {
    refreshFilesBtn.addEventListener('click', async () => {
      loadingIndicator.style.display = 'block';
      try {
        allFiles = await fetchCartFiles();
        filteredFiles = [...allFiles];
        renderFiles();
      } catch (error) {
        console.error('åˆ·æ–°æ–‡ä»¶åˆ—è¡¨å¤±è´¥:', error);
        alert('åˆ·æ–°æ–‡ä»¶åˆ—è¡¨å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
      } finally {
        loadingIndicator.style.display = 'none';
      }
    });
    
    searchInput.addEventListener('input', handleSearch);
    filterType.addEventListener('change', handleFilter);
    filterDate.addEventListener('change', handleFilter);
    selectAllCheckbox.addEventListener('change', handleSelectAll);
    selectAllBtn.addEventListener('click', handleSelectAllClick);
    downloadSelectedBtn.addEventListener('click', handleDownloadSelected);
    exportListBtn.addEventListener('click', handleExportList);
    
    // æ¨¡æ€æ¡†äº‹ä»¶
    document.getElementById('close-preview').addEventListener('click', closePreviewModal);
    document.getElementById('close-preview-btn').addEventListener('click', closePreviewModal);
    document.getElementById('download-preview-file').addEventListener('click', downloadPreviewFile);
    
    // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
    previewModal.addEventListener('click', function(e) {
      if (e.target === previewModal) {
        closePreviewModal();
      }
    });
  }
  
  // æ¸²æŸ“æ–‡ä»¶åˆ—è¡¨
  function renderFiles() {
    if (filteredFiles.length === 0) {
      filesTable.innerHTML = `
        <tr>
          <td colspan="8" style="text-align: center; padding: 40px; color: #666;">
            ${allFiles.length === 0 ? 'æš‚æ— ä¸Šä¼ çš„æ–‡ä»¶' : 'æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„æ–‡ä»¶'}
          </td>
        </tr>
      `;
      return;
    }
    
    filesTable.innerHTML = filteredFiles.map(file => `
      <tr>
        <td>
          <input type="checkbox" class="file-checkbox" data-file-id="${file.id}" 
                 ${selectedFiles.has(file.id) ? 'checked' : ''}>
        </td>
        <td>
          <div class="file-info">
            <div class="file-icon">${getFileIcon(file.type)}</div>
            <div class="file-details">
              <h4>${file.name}</h4>
              <p>${file.email || 'æœªæä¾›é‚®ç®±'}</p>
            </div>
          </div>
        </td>
        <td>
          <span class="file-type ${file.type}">${getTypeLabel(file.type)}</span>
        </td>
        <td>
          <span class="file-size">${file.size > 0 ? formatFileSize(file.size) : 'æœªçŸ¥å¤§å°'}</span>
        </td>
        <td>
          <div class="customer-info">
            <div>${file.customer}</div>
            <div style="color: #666; font-size: 12px;">${file.email || 'æœªæä¾›é‚®ç®±'}</div>
          </div>
        </td>
        <td>
          <span class="upload-time">${file.uploadTime}</span>
        </td>
        <td>
          <span class="status-badge ${file.status}">${getStatusLabel(file.status)}</span>
        </td>
        <td>
          <div class="action-buttons">
            <button class="action-btn download" data-uuid="${file.uuid}" title="ä¸‹è½½">
              â¬‡ï¸
            </button>
            <button class="action-btn preview" data-uuid="${file.uuid}" title="é¢„è§ˆ">
              ğŸ‘ï¸
            </button>
            <button class="action-btn delete" data-uuid="${file.uuid}" title="åˆ é™¤">
              ğŸ—‘ï¸
            </button>
          </div>
        </td>
      </tr>
    `).join('');
    
    // æ›´æ–°å…¨é€‰çŠ¶æ€
    updateSelectAllState();
    
    // ç»‘å®šæ“ä½œæŒ‰é’®äº‹ä»¶
    bindActionButtons();
  }
  
  // ç»‘å®šæ“ä½œæŒ‰é’®äº‹ä»¶
  function bindActionButtons() {
    // ä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç†åŠ¨æ€ç”Ÿæˆçš„æŒ‰é’®
    filesTable.addEventListener('click', function(e) {
      const button = e.target.closest('.action-btn');
      if (!button) return;
      
      const uuid = button.dataset.uuid;
      if (!uuid) return;
      
      if (button.classList.contains('download')) {
        downloadFile(uuid);
      } else if (button.classList.contains('preview')) {
        previewFile(uuid);
      } else if (button.classList.contains('delete')) {
        deleteFile(uuid);
      }
    });
  }
  
  // æœç´¢å¤„ç†
  function handleSearch() {
    const query = searchInput.value.toLowerCase();
    filteredFiles = allFiles.filter(file => 
      file.name.toLowerCase().includes(query) ||
      file.customer.toLowerCase().includes(query) ||
      file.email.toLowerCase().includes(query)
    );
    renderFiles();
  }
  
  // ç­›é€‰å¤„ç†
  function handleFilter() {
    const typeFilter = filterType.value;
    const dateFilter = filterDate.value;
    
    filteredFiles = allFiles.filter(file => {
      let matches = true;
      
      if (typeFilter && file.type !== typeFilter) {
        matches = false;
      }
      
      if (dateFilter) {
        const fileDate = new Date(file.uploadTime);
        const now = new Date();
        
        switch (dateFilter) {
          case 'today':
            matches = matches && fileDate.toDateString() === now.toDateString();
            break;
          case 'week':
            const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            matches = matches && fileDate >= weekAgo;
            break;
          case 'month':
            const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
            matches = matches && fileDate >= monthAgo;
            break;
        }
      }
      
      return matches;
    });
    
    renderFiles();
  }
  
  // å…¨é€‰å¤„ç†
  function handleSelectAll() {
    const isChecked = selectAllCheckbox.checked;
    const checkboxes = filesTable.querySelectorAll('.file-checkbox');
    
    checkboxes.forEach(checkbox => {
      checkbox.checked = isChecked;
      const fileId = parseInt(checkbox.dataset.fileId);
      if (isChecked) {
        selectedFiles.add(fileId);
      } else {
        selectedFiles.delete(fileId);
      }
    });
    
    updateDownloadButton();
  }
  
  // å…¨é€‰æŒ‰é’®ç‚¹å‡»
  function handleSelectAllClick() {
    selectAllCheckbox.checked = !selectAllCheckbox.checked;
    handleSelectAll();
  }
  
  // æ›´æ–°å…¨é€‰çŠ¶æ€
  function updateSelectAllState() {
    const checkboxes = filesTable.querySelectorAll('.file-checkbox');
    const checkedCount = filesTable.querySelectorAll('.file-checkbox:checked').length;
    
    selectAllCheckbox.checked = checkedCount === checkboxes.length && checkboxes.length > 0;
    selectAllCheckbox.indeterminate = checkedCount > 0 && checkedCount < checkboxes.length;
  }
  
  // æ›´æ–°ä¸‹è½½æŒ‰é’®çŠ¶æ€
  function updateDownloadButton() {
    downloadSelectedBtn.disabled = selectedFiles.size === 0;
  }
  
  // ä¸‹è½½é€‰ä¸­æ–‡ä»¶
  function handleDownloadSelected() {
    if (selectedFiles.size === 0) return;
    
    const selectedFileIds = Array.from(selectedFiles);
    const selectedFileData = allFiles.filter(file => selectedFileIds.includes(file.id));
    
    // åˆ›å»ºZIPä¸‹è½½ï¼ˆå®é™…åº”ç”¨ä¸­éœ€è¦æœåŠ¡å™¨ç«¯æ”¯æŒï¼‰
    downloadFilesAsZip(selectedFileData);
  }
  
  // å¯¼å‡ºåˆ—è¡¨
  function handleExportList() {
    const csvContent = generateCSV(filteredFiles);
    downloadCSV(csvContent, 'å®¢æˆ·æ–‡ä»¶åˆ—è¡¨.csv');
  }
  
  // ç”ŸæˆCSVå†…å®¹
  function generateCSV(files) {
    const headers = ['æ–‡ä»¶å', 'ç±»å‹', 'å¤§å°', 'å®¢æˆ·', 'é‚®ç®±', 'ä¸Šä¼ æ—¶é—´', 'çŠ¶æ€'];
    const rows = files.map(file => [
      file.name,
      getTypeLabel(file.type),
      formatFileSize(file.size),
      file.customer,
      file.email,
      file.uploadTime,
      getStatusLabel(file.status)
    ]);
    
    return [headers, ...rows].map(row => row.join(',')).join('\n');
  }
  
  // ä¸‹è½½CSVæ–‡ä»¶
  function downloadCSV(content, filename) {
    const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    link.click();
  }
  
  // å…³é—­é¢„è§ˆæ¨¡æ€æ¡†
  function closePreviewModal() {
    previewModal.style.display = 'none';
  }
  
  // ä¸‹è½½é¢„è§ˆæ–‡ä»¶
  function downloadPreviewFile() {
    const fileId = previewModal.dataset.fileId;
    const file = allFiles.find(f => f.id == fileId);
    if (file) {
      downloadFile(file.uuid);
    }
  }
  
  // å·¥å…·å‡½æ•°
  function getFileIcon(type) {
    const icons = {
      '3d': 'ğŸ“¦',
      '2d': 'ğŸ“„',
      'zip': 'ğŸ—œï¸'
    };
    return icons[type] || 'ğŸ“';
  }
  
  function getTypeLabel(type) {
    const labels = {
      '3d': '3D',
      '2d': '2D',
      'zip': 'ZIP'
    };
    return labels[type] || type.toUpperCase();
  }
  
  function getStatusLabel(status) {
    const labels = {
      'pending': 'å¾…å¤„ç†',
      'processing': 'å¤„ç†ä¸­',
      'completed': 'å·²å®Œæˆ',
      'error': 'é”™è¯¯'
    };
    return labels[status] || status;
  }
  
  function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  }
  
  // å…¨å±€å‡½æ•°ï¼ˆä¾›HTMLè°ƒç”¨ï¼‰
  window.downloadFile = function(fileId) {
    const file = allFiles.find(f => f.id === fileId);
    if (file) {
      // å®é™…åº”ç”¨ä¸­åº”è¯¥è°ƒç”¨æœåŠ¡å™¨API
      console.log('ä¸‹è½½æ–‡ä»¶:', file.name);
      // æ¨¡æ‹Ÿä¸‹è½½
      const link = document.createElement('a');
      link.href = file.downloadUrl;
      link.download = file.name;
      link.click();
    }
  };
  
  window.previewFile = function(fileId) {
    const file = allFiles.find(f => f.id === fileId);
    if (file) {
      previewModal.dataset.fileId = fileId;
      document.getElementById('preview-title').textContent = `é¢„è§ˆ: ${file.name}`;
      document.getElementById('preview-content').innerHTML = `
        <div style="text-align: center; padding: 40px;">
          <div style="font-size: 48px; margin-bottom: 16px;">${getFileIcon(file.type)}</div>
          <h4>${file.name}</h4>
          <p>ç±»å‹: ${getTypeLabel(file.type)}</p>
          <p>å¤§å°: ${formatFileSize(file.size)}</p>
          <p>å®¢æˆ·: ${file.customer}</p>
          <p>ä¸Šä¼ æ—¶é—´: ${file.uploadTime}</p>
          <p>çŠ¶æ€: ${getStatusLabel(file.status)}</p>
        </div>
      `;
      previewModal.style.display = 'block';
    }
  };
  
  window.deleteFile = function(fileId) {
    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ–‡ä»¶å—ï¼Ÿ')) {
      allFiles = allFiles.filter(f => f.id !== fileId);
      filteredFiles = filteredFiles.filter(f => f.id !== fileId);
      selectedFiles.delete(fileId);
      renderFiles();
      updateDownloadButton();
    }
  };
  
  // ä¸‹è½½æ–‡ä»¶
  async function downloadFile(uuid) {
    const file = allFiles.find(f => f.uuid === uuid);
    if (!file) {
      alert('æ–‡ä»¶ä¸å­˜åœ¨');
      return;
    }
    
    try {
      // è·å–å®Œæ•´çš„æ–‡ä»¶å‚æ•°ä¿¡æ¯
      const fileParams = await getFileParameters(uuid);
      
      // æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶URL
      if (fileParams.fileUrl) {
        // æœ‰æ–‡ä»¶URLï¼Œç›´æ¥ä¸‹è½½å®é™…æ–‡ä»¶
        downloadActualFile(fileParams.fileUrl, file.name);
      } else {
        // æ²¡æœ‰æ–‡ä»¶URLï¼Œä¸‹è½½æ–‡ä»¶ä¿¡æ¯
        downloadFileInfo(file, fileParams);
      }
    } catch (error) {
      console.error('ä¸‹è½½æ–‡ä»¶å¤±è´¥:', error);
      alert('ä¸‹è½½å¤±è´¥: ' + error.message);
    }
  }
  
  // ä¸‹è½½å®é™…æ–‡ä»¶
  function downloadActualFile(fileUrl, fileName) {
    try {
      // æ£€æŸ¥æ˜¯å¦æ˜¯Data URL
      if (fileUrl.startsWith('data:')) {
        // ä½¿ç”¨æ–‡ä»¶å­˜å‚¨ç®¡ç†å™¨ä¸‹è½½
        if (window.fileStorageManager) {
          window.fileStorageManager.downloadFile(fileUrl, fileName);
        } else {
          // å¤‡ç”¨æ–¹æ¡ˆï¼šç›´æ¥ä¸‹è½½
          const link = document.createElement('a');
          link.href = fileUrl;
          link.download = fileName;
          link.target = '_blank';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        }
      } else {
        // å¤–éƒ¨URLï¼Œé€šè¿‡ä¸‹è½½é¡µé¢
        const downloadUrl = `/pages/file-download?file_url=${encodeURIComponent(fileUrl)}&file_name=${encodeURIComponent(fileName)}&auto_download=true`;
        window.open(downloadUrl, '_blank');
      }
    } catch (error) {
      console.error('ä¸‹è½½æ–‡ä»¶å¤±è´¥:', error);
      alert('ä¸‹è½½å¤±è´¥: ' + error.message);
    }
  }
  
  // ä¸‹è½½æ–‡ä»¶ä¿¡æ¯
  function downloadFileInfo(file, fileParams) {
    const fileInfo = {
      fileName: file.name,
      fileType: file.type,
      customer: file.customer,
      email: file.email,
      uploadTime: file.uploadTime,
      status: file.status,
      uuid: file.uuid,
      ...fileParams
    };
    
    const content = `æ–‡ä»¶ä¿¡æ¯è¯¦æƒ…\n` +
      `==================\n\n` +
      `åŸºæœ¬ä¿¡æ¯:\n` +
      `æ–‡ä»¶å: ${fileInfo.fileName}\n` +
      `ç±»å‹: ${fileInfo.fileType}\n` +
      `å®¢æˆ·: ${fileInfo.customer}\n` +
      `é‚®ç®±: ${fileInfo.email}\n` +
      `ä¸Šä¼ æ—¶é—´: ${fileInfo.uploadTime}\n` +
      `çŠ¶æ€: ${fileInfo.status}\n` +
      `UUID: ${fileInfo.uuid}\n\n` +
      `æ–‡ä»¶å‚æ•°:\n` +
      `æ•°é‡: ${fileInfo.quantity}\n` +
      `å•ä½: ${fileInfo.unit}\n` +
      `ææ–™: ${fileInfo.material}\n` +
      `é¢œè‰²ä¸è¡¨é¢: ${fileInfo.finish}\n` +
      `ç²¾åº¦ç­‰çº§: ${fileInfo.precision}\n` +
      `å…¬å·®æ ‡å‡†: ${fileInfo.tolerance}\n` +
      `è¡¨é¢ç²—ç³™åº¦: ${fileInfo.roughness}\n` +
      `æ˜¯å¦æœ‰èºçº¹: ${fileInfo.hasThread}\n` +
      `æ˜¯å¦æœ‰è£…é…æ ‡è®°: ${fileInfo.hasAssembly}\n` +
      `ç¼©æ”¾æ¯”ä¾‹: ${fileInfo.scale}%\n` +
      `å°ºå¯¸: ${fileInfo.dimensions}\n` +
      `å¤‡æ³¨: ${fileInfo.note}\n` +
      `æ–‡ä»¶ID: ${fileInfo.fileId}\n\n` +
      `æ³¨æ„ï¼šå®é™…æ–‡ä»¶éœ€è¦ä»æœåŠ¡å™¨æ–‡ä»¶å­˜å‚¨ä½ç½®è·å–ã€‚`;
    
    const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `${file.name}_è¯¦æƒ….txt`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(link.href);
  }

  // é¢„è§ˆæ–‡ä»¶
  async function previewFile(uuid) {
    const file = allFiles.find(f => f.uuid === uuid);
    if (file) {
      previewModal.dataset.fileId = file.id;
      document.getElementById('preview-title').textContent = file.name;
      
      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      document.getElementById('preview-content').innerHTML = `
        <div style="text-align: center; padding: 40px;">
          <div style="font-size: 24px; margin-bottom: 16px;">â³</div>
          <p>æ­£åœ¨åŠ è½½æ–‡ä»¶å‚æ•°...</p>
        </div>
      `;
      previewModal.style.display = 'block';
      
      // è·å–å®Œæ•´çš„æ–‡ä»¶å‚æ•°ä¿¡æ¯
      const fileParams = await getFileParameters(uuid);
      
      document.getElementById('preview-content').innerHTML = `
        <div style="padding: 20px;">
          <div style="text-align: center; margin-bottom: 20px;">
            <div style="font-size: 48px; margin-bottom: 16px;">${getFileIcon(file.type)}</div>
            <h3 style="margin: 0 0 8px 0;">${file.name}</h3>
            <p style="margin: 0; color: #666;">${getTypeLabel(file.type)} æ–‡ä»¶</p>
          </div>
          
          <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
            <h4 style="margin: 0 0 12px 0; color: #333;">å®¢æˆ·ä¿¡æ¯</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 14px; margin-bottom: 16px;">
              <div><strong>å®¢æˆ·å§“å:</strong> ${file.customer}</div>
              <div><strong>é‚®ç®±:</strong> ${file.email || 'æœªæä¾›'}</div>
              <div><strong>ä¸Šä¼ æ—¶é—´:</strong> ${file.uploadTime}</div>
              <div><strong>çŠ¶æ€:</strong> <span class="status-badge ${file.status}">${getStatusLabel(file.status)}</span></div>
            </div>
          </div>
          
          <div style="background: #fff3e0; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
            <h4 style="margin: 0 0 12px 0; color: #333;">æ–‡ä»¶å‚æ•°</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 14px;">
              <div><strong>æ•°é‡:</strong> ${fileParams.quantity || '1'}</div>
              <div><strong>å•ä½:</strong> ${fileParams.unit || 'ä»¶'}</div>
              <div><strong>ææ–™:</strong> ${fileParams.material || 'æœªæŒ‡å®š'}</div>
              <div><strong>é¢œè‰²ä¸è¡¨é¢:</strong> ${fileParams.finish || 'æœªæŒ‡å®š'}</div>
              <div><strong>ç²¾åº¦ç­‰çº§:</strong> ${fileParams.precision || 'æœªæŒ‡å®š'}</div>
              <div><strong>å…¬å·®æ ‡å‡†:</strong> ${fileParams.tolerance || 'æœªæŒ‡å®š'}</div>
              <div><strong>è¡¨é¢ç²—ç³™åº¦:</strong> ${fileParams.roughness || 'æœªæŒ‡å®š'}</div>
              <div><strong>æ˜¯å¦æœ‰èºçº¹:</strong> ${fileParams.hasThread || 'å¦'}</div>
              <div><strong>æ˜¯å¦æœ‰è£…é…æ ‡è®°:</strong> ${fileParams.hasAssembly || 'å¦'}</div>
              <div><strong>ç¼©æ”¾æ¯”ä¾‹:</strong> ${fileParams.scale || '100'}%</div>
              <div><strong>å°ºå¯¸:</strong> ${fileParams.dimensions || 'æœªè®¡ç®—'}</div>
              <div><strong>å¤‡æ³¨:</strong> ${fileParams.note || 'æ— '}</div>
            </div>
          </div>
          
          <div style="background: #e8f5e8; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
            <h4 style="margin: 0 0 12px 0; color: #333;">æŠ€æœ¯ä¿¡æ¯</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 14px;">
              <div><strong>æ–‡ä»¶ID:</strong> ${fileParams.fileId || 'æœªçŸ¥'}</div>
              <div><strong>UUID:</strong> ${file.uuid}</div>
              <div><strong>è´­ç‰©è½¦é¡¹:</strong> ${file.cartItemKey}</div>
              <div><strong>æ–‡ä»¶å¤§å°:</strong> ${file.size > 0 ? formatFileSize(file.size) : 'æœªçŸ¥'}</div>
            </div>
          </div>
          
          <div style="background: #e3f2fd; padding: 12px; border-radius: 6px; border-left: 4px solid #1976d2;">
            <p style="margin: 0; color: #1976d2; font-size: 14px;">
              <strong>æ³¨æ„ï¼š</strong>è¿™æ˜¯ä»è´­ç‰©è½¦è·å–çš„å®Œæ•´æ–‡ä»¶ä¿¡æ¯ã€‚å®é™…æ–‡ä»¶é¢„è§ˆéœ€è¦é…ç½®æ–‡ä»¶å­˜å‚¨æœåŠ¡æ”¯æŒã€‚
            </p>
          </div>
        </div>
      `;
      previewModal.style.display = 'block';
    }
  }
  
  // è·å–æ–‡ä»¶å‚æ•°ä¿¡æ¯
  async function getFileParameters(uuid) {
    try {
      // ä»è´­ç‰©è½¦APIè·å–æœ€æ–°çš„æ•°æ®
      const response = await fetch('/cart.js');
      const cart = await response.json();
      
      // æŸ¥æ‰¾åŒ¹é…çš„å•†å“é¡¹
      const item = cart.items.find(item => 
        item.properties && item.properties._uuid === uuid
      );
      
      if (item && item.properties) {
        return {
          quantity: item.quantity || '1',
          unit: item.properties.å•ä½ || 'ä»¶',
          material: item.properties.ææ–™ || 'æœªæŒ‡å®š',
          finish: item.properties['é¢œè‰²ä¸è¡¨é¢'] || 'æœªæŒ‡å®š',
          precision: item.properties.ç²¾åº¦ç­‰çº§ || 'æœªæŒ‡å®š',
          tolerance: item.properties.å…¬å·®æ ‡å‡† || 'æœªæŒ‡å®š',
          roughness: item.properties.è¡¨é¢ç²—ç³™åº¦ || 'æœªæŒ‡å®š',
          hasThread: item.properties.æ˜¯å¦æœ‰èºçº¹ || 'å¦',
          hasAssembly: item.properties.æ˜¯å¦æœ‰è£…é…æ ‡è®° || 'å¦',
          scale: item.properties.ç¼©æ”¾æ¯”ä¾‹ || '100',
          dimensions: item.properties.å°ºå¯¸ || 'æœªè®¡ç®—',
          note: item.properties.å¤‡æ³¨ || 'æ— ',
          fileId: item.properties.æ–‡ä»¶ID || 'æœªçŸ¥',
          fileUrl: item.properties.æ–‡ä»¶URL || item.properties['ä¸Šä¼ æ–‡ä»¶'] || null
        };
      }
    } catch (error) {
      console.error('è·å–æ–‡ä»¶å‚æ•°å¤±è´¥:', error);
    }
    
    // å¦‚æœè·å–å¤±è´¥ï¼Œè¿”å›é»˜è®¤å€¼
    return {
      quantity: '1',
      unit: 'ä»¶',
      material: 'æœªæŒ‡å®š',
      finish: 'æœªæŒ‡å®š',
      precision: 'æœªæŒ‡å®š',
      tolerance: 'æœªæŒ‡å®š',
      roughness: 'æœªæŒ‡å®š',
      hasThread: 'å¦',
      hasAssembly: 'å¦',
      scale: '100',
      dimensions: 'æœªè®¡ç®—',
      note: 'æ— ',
      fileId: 'æœªçŸ¥'
    };
  }

  // åˆ é™¤æ–‡ä»¶
  async function deleteFile(uuid) {
    const file = allFiles.find(f => f.uuid === uuid);
    if (!file) {
      alert('æ–‡ä»¶ä¸å­˜åœ¨');
      return;
    }
    
    if (confirm(`ç¡®å®šè¦åˆ é™¤æ–‡ä»¶ "${file.name}" å—ï¼Ÿ\n\nè¿™å°†ä»è´­ç‰©è½¦ä¸­ç§»é™¤å¯¹åº”çš„å•†å“é¡¹ã€‚`)) {
      try {
        // ä»è´­ç‰©è½¦ä¸­åˆ é™¤å¯¹åº”çš„å•†å“é¡¹
        const response = await fetch('/cart/change.js', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify({
            id: file.cartItemKey,
            quantity: 0
          })
        });
        
        if (response.ok) {
          // ä»æœ¬åœ°åˆ—è¡¨ä¸­ç§»é™¤
          allFiles = allFiles.filter(f => f.uuid !== uuid);
          filteredFiles = allFiles.filter(file => {
            const query = searchInput.value.toLowerCase();
            const typeFilter = filterType.value;
            const dateFilter = filterDate.value;
            
            let matches = true;
            
            if (query && !file.name.toLowerCase().includes(query) && 
                !file.customer.toLowerCase().includes(query) && 
                !file.email.toLowerCase().includes(query)) {
              matches = false;
            }
            
            if (typeFilter && file.type !== typeFilter) {
              matches = false;
            }
            
            if (dateFilter) {
              const fileDate = new Date(file.uploadTime);
              const now = new Date();
              
              switch (dateFilter) {
                case 'today':
                  matches = matches && fileDate.toDateString() === now.toDateString();
                  break;
                case 'week':
                  const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                  matches = matches && fileDate >= weekAgo;
                  break;
                case 'month':
                  const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                  matches = matches && fileDate >= monthAgo;
                  break;
              }
            }
            
            return matches;
          });
          renderFiles();
          alert('æ–‡ä»¶å·²æˆåŠŸåˆ é™¤');
        } else {
          throw new Error('åˆ é™¤å¤±è´¥');
        }
      } catch (error) {
        console.error('åˆ é™¤æ–‡ä»¶å¤±è´¥:', error);
        alert('åˆ é™¤æ–‡ä»¶å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
      }
    }
  }

  // ä¸‹è½½æ–‡ä»¶ä¸ºZIP
  function downloadFilesAsZip(files) {
    alert('æ‰¹é‡ä¸‹è½½åŠŸèƒ½éœ€è¦æœåŠ¡å™¨ç«¯æ”¯æŒã€‚\n\nå½“å‰å¯ä»¥å•ç‹¬ä¸‹è½½æ–‡ä»¶ï¼Œæˆ–å¯¼å‡ºæ–‡ä»¶åˆ—è¡¨ã€‚');
  }

  // æ£€æŸ¥å®¢æœèº«ä»½éªŒè¯
  function checkAdminAuth() {
    if (!window.loginManager) {
      console.error('ç™»å½•ç®¡ç†ç³»ç»ŸæœªåŠ è½½');
      showAuthRequired();
      return false;
    }
    
    const hasAccess = window.loginManager.hasAdminAccess();
    
    if (!hasAccess) {
      showAuthRequired();
      return false;
    }
    
    return true;
  }
  
  // æ˜¾ç¤ºéœ€è¦èº«ä»½éªŒè¯çš„æç¤º
  function showAuthRequired() {
    document.body.innerHTML = `
      <div style="
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        background: #f5f7fa;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      ">
        <div style="
          background: white;
          padding: 40px;
          border-radius: 12px;
          box-shadow: 0 20px 40px rgba(0,0,0,0.1);
          text-align: center;
          max-width: 400px;
        ">
          <div style="font-size: 48px; margin-bottom: 20px;">ğŸ”</div>
          <h1 style="margin-bottom: 15px; color: #333;">éœ€è¦å®¢æœèº«ä»½éªŒè¯</h1>
          <p style="color: #666; margin-bottom: 30px;">æ­¤é¡µé¢ä»…é™å®¢æœäººå‘˜è®¿é—®</p>
          <button onclick="window.location.href='/pages/admin-login'" style="
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
          ">å‰å¾€ç™»å½•</button>
        </div>
      </div>
    `;
  }
  
  // åˆå§‹åŒ–åº”ç”¨
  // ç­‰å¾…ç™»å½•ç®¡ç†ç³»ç»ŸåŠ è½½
  setTimeout(() => {
    if (checkAdminAuth()) {
      document.getElementById('admin-file-manager').style.display = 'block';
      init();
    }
  }, 100);
});
</script>
